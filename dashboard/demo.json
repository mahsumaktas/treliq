{
  "repo": "openclaw/openclaw",
  "scannedAt": "2026-02-15T19:58:30.813Z",
  "totalPRs": 51,
  "spamCount": 0,
  "duplicateClusters": [
    {
      "id": 0,
      "prs": [
        {
          "number": 17459,
          "title": "feat(cron): support multiple schedules and priority guardrails",
          "body": "# OpenClaw Cron: Stability + Feature Update Notes\r\n\r\nThis document summarizes the implemented work for roadmap priorities:\r\n\r\n- `1` Cron stability fixes\r\n- `2` Cron enhancements (multi-schedule, per-job timeout hardening, isolated announce reliability)\r\n- `3` Security, orchestration, and memory-quality guardrails\r\n\r\n## Priority 1: Stability Fixes\r\n\r\n### 1) Windows cron store write resilience (`EBUSY`/`EPERM`/`ENOTEMPTY`)\r\n\r\n- Added atomic rename retry with backoff for cron store writes.\r\n- Added temp-file cleanup in `finally` to avoid leftover `.tmp` files on failures.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/store.ts`\r\n- `openclaw/src/cron/store.test.ts`\r\n\r\n### 2) Timer re-arm and spin-loop prevention improvements\r\n\r\n- `nextWakeAtMs` now ignores jobs currently marked `runningAtMs`.\r\n- When all enabled jobs are blocked by `runningAtMs`, scheduler now arms a maintenance tick (60s) instead of skipping/spinning.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/service/jobs.ts`\r\n- `openclaw/src/cron/service/timer.ts`\r\n- `openclaw/src/cron/service.rearm-timer-when-running.test.ts`\r\n\r\n## Priority 2: Enhancements\r\n\r\n### 1) Multi-schedule support per job (`schedules[]`)\r\n\r\n- Added support for multiple schedules on a single job while preserving backward compatibility with `schedule`.\r\n- `nextRunAtMs` now resolves to the earliest next run across all configured schedules.\r\n- Update path supports patching `schedules[]`.\r\n- Store migration/normalization keeps `schedule` and `schedules[0]` in sync for compatibility.\r\n- Protocol schema now accepts `schedules[]` in add/update payloads.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/types.ts`\r\n- `openclaw/src/cron/service/jobs.ts`\r\n- `openclaw/src/cron/service/ops.ts`\r\n- `openclaw/src/cron/service/store.ts`\r\n- `openclaw/src/cron/normalize.ts`\r\n- `openclaw/src/gateway/protocol/schema/cron.ts`\r\n- `openclaw/src/cron/service.issue-regressions.test.ts`\r\n- `openclaw/src/cron/normalize.test.ts`\r\n\r\n### 2) Per-job timeout hardening\r\n\r\n- Added timeout normalization/clamping in timer execution path:\r\n  - minimum: 1 second\r\n  - maximum cap: 24 hours\r\n  - default fallback remains 10 minutes when unset/invalid\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/service/timer.ts`\r\n\r\n### 3) Isolated announce reliability fallback\r\n\r\n- When subagent announce flow fails, isolated cron now attempts one direct outbound fallback delivery before failing.\r\n- This improves reliability for cases where announce orchestration fails but direct delivery can still succeed.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/isolated-agent/run.ts`\r\n\r\n## Priority 3: Security + Intelligence Guardrails\r\n\r\n### 1) Secrets manager integration (`op://` and `vault://`)\r\n\r\n- Added config-time secret URI resolution support:\r\n  - `op://...` via `op read <ref>`\r\n  - `vault://path#field` via `vault kv get -field=<field> <path>`\r\n- Resolution runs during config load, after `${ENV}` substitution.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/config/secret-resolver.ts`\r\n- `openclaw/src/config/io.ts`\r\n- `openclaw/src/config/secret-resolver.test.ts`\r\n\r\n### 2) Membrane-style tool boundary enforcement\r\n\r\n- Added optional pre-tool-call membrane checks:\r\n  - hard deny specific tools\r\n  - deny exec calls containing blocked command substrings\r\n- Denials include explicit membrane tags in block reasons.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/agents/pi-tools.before-tool-call.ts`\r\n- `openclaw/src/agents/pi-tools.ts`\r\n- `openclaw/src/config/types.tools.ts`\r\n- `openclaw/src/config/zod-schema.agent-runtime.ts`\r\n- `openclaw/src/agents/pi-tools.before-tool-call.e2e.test.ts`\r\n\r\n### 3) Smart model routing (simple vs complex messages)\r\n\r\n- Added optional per-agent routing config to select cheaper model for simple tasks and stronger model for complex tasks.\r\n- Integrated into isolated cron agent-turn model selection path.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/agents/model-routing.ts`\r\n- `openclaw/src/agents/model-routing.test.ts`\r\n- `openclaw/src/config/types.agent-defaults.ts`\r\n- `openclaw/src/config/zod-schema.agent-defaults.ts`\r\n- `openclaw/src/cron/isolated-agent/run.ts`\r\n\r\n### 4) Fact-check gate for session-memory hook writes\r\n\r\n- Added optional hook-level fact-check thresholds before writing session memory snapshots.\r\n- Can require minimum user/assistant evidence before persisting.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/hooks/bundled/session-memory/handler.ts`\r\n- `openclaw/src/hooks/bundled/session-memory/handler.test.ts`\r\n\r\n## Validation\r\n\r\nExecuted targeted tests:\r\n\r\n```powershell\r\npnpm -C openclaw test:fast -- `\r\n  src/cron/store.test.ts `\r\n  src/cron/service.rearm-timer-when-running.test.ts `\r\n  src/cron/service.issue-13992-regression.test.ts `\r\n  src/cron/service.issue-16156-list-skips-cron.test.ts `\r\n  src/cron/service.issue-regressions.test.ts\r\n```\r\n\r\n```powershell\r\npnpm -C openclaw test:fast -- `\r\n  src/cron/service.issue-regressions.test.ts `\r\n  src/cron/normalize.test.ts `\r\n  src/cron/store.test.ts `\r\n  src/cron/service.store-migration.test.ts `\r\n  src/cron/service.store.migration.test.ts `\r\n  src/cron/service.delivery-plan.test.ts\r\n```\r\n\r\nAll passed in the latest run.\r\n\r\nAdditional priority-3 verification:\r\n\r\n```powershell\r\npnpm -C openclaw test:fast -- `\r\n  src/config/secret-resolver.test.ts `\r\n  src/hooks/bundled/session-memory/handler.test.ts `\r\n  src/agents/model-routing.test.ts\r\n```\r\n\r\n```powershell\r\npnpm -C openclaw exec vitest run --config vitest.e2e.config.ts `\r\n  src/agents/pi-tools.before-tool-call.e2e.test.ts\r\n```\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR implements comprehensive cron system improvements across three areas: stability fixes, feature enhancements, and security guardrails.\n\n**Priority 1 - Stability Fixes:**\n- Atomic rename retry logic with exponential backoff for Windows file-lock races (`EBUSY`/`EPERM`/`ENOTEMPTY`)\n- Timer re-arm improvements to prevent scheduler deadlock when jobs are blocked by `runningAtMs` markers\n- Added 60s maintenance tick when all enabled jobs are running to avoid spin-loops\n\n**Priority 2 - Feature Enhancements:**\n- Multi-schedule support per job with backward-compatible migration (keeps `schedule` and `schedules[0]` in sync)\n- Per-job timeout normalization with 1s minimum and 24h maximum safety cap\n- Isolated announce fallback that attempts direct delivery when subagent announce flow fails\n- Telegram poll support with answer caching and system event integration\n\n**Priority 3 - Security & Intelligence Guardrails:**\n- Secrets manager integration for `op://` (1Password) and `vault://` (HashiCorp Vault) URIs\n- Membrane-style tool boundary enforcement with configurable deny lists for tools and command substrings\n- Smart model routing to select cheaper models for simple tasks vs complex tasks\n- Fact-check gate for session-memory hook writes requiring minimum message thresholds\n\nThe implementation includes comprehensive test coverage and proper migration/normalization logic to maintain backward compatibility.\n\n<h3>Confidence Score: 4/5</h3>\n\n- Safe to merge with minor considerations around scope and testing\n- The PR includes well-tested stability fixes and features with comprehensive test coverage. The multi-schedule implementation properly maintains backward compatibility through migration logic. Security features use standard subprocess execution patterns. Score reflects broad scope mixing unrelated features (Telegram polls alongside cron fixes) and the inherent complexity of scheduler state management, though tests demonstrate correctness.\n- No files require special attention\n\n<sub>Last reviewed commit: 086efd4</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(3/5) Reply to the agent's comments like \"Can you suggest a fix for this @greptileai?\" or ask follow-up questions!</sub>\n\n<!-- /greptile_comment -->",
          "author": "akyourowngames",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:45:20Z",
          "updatedAt": "2026-02-15T19:55:50Z",
          "headRef": "feat/cron-multi-schedule",
          "baseRef": "main",
          "filesChanged": 51,
          "additions": 1955,
          "deletions": 382,
          "commits": 13,
          "labels": [
            "docs",
            "channel: telegram",
            "app: web-ui",
            "gateway",
            "scripts",
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "CRON_STABILIZATION_AND_FEATURES_README.md",
            "README.md",
            "docs/gateway/configuration-examples.md",
            "docs/gateway/configuration.md",
            "package.json",
            "pnpm-lock.yaml",
            "scripts/run-skill-scan.ts",
            "skills/poll-confirmation/SKILL.md",
            "src/agents/model-routing.test.ts",
            "src/agents/model-routing.ts",
            "src/agents/pi-tools.before-tool-call.e2e.test.ts",
            "src/agents/pi-tools.before-tool-call.ts",
            "src/agents/pi-tools.ts",
            "src/agents/tools/message-tool.e2e.test.ts",
            "src/agents/tools/message-tool.ts",
            "src/agents/tools/telegram-actions.ts",
            "src/channels/plugins/actions/telegram.test.ts",
            "src/channels/plugins/actions/telegram.ts",
            "src/channels/plugins/outbound/telegram.test.ts",
            "src/channels/plugins/outbound/telegram.ts",
            "src/config/io.ts",
            "src/config/secret-resolver.test.ts",
            "src/config/secret-resolver.ts",
            "src/config/types.agent-defaults.ts",
            "src/config/types.tools.ts",
            "src/config/zod-schema.agent-defaults.ts",
            "src/config/zod-schema.agent-runtime.ts",
            "src/cron/isolated-agent/run.ts",
            "src/cron/normalize.test.ts",
            "src/cron/normalize.ts",
            "src/cron/service.issue-regressions.test.ts",
            "src/cron/service.rearm-timer-when-running.test.ts",
            "src/cron/service/jobs.ts",
            "src/cron/service/ops.ts",
            "src/cron/service/store.ts",
            "src/cron/service/timer.ts",
            "src/cron/store.test.ts",
            "src/cron/store.ts",
            "src/cron/types.ts",
            "src/gateway/protocol/schema/cron.ts",
            "src/hooks/bundled/session-memory/handler.test.ts",
            "src/hooks/bundled/session-memory/handler.ts",
            "src/telegram/allowed-updates.test.ts",
            "src/telegram/allowed-updates.ts",
            "src/telegram/bot.ts",
            "src/telegram/bot/helpers.test.ts",
            "src/telegram/bot/helpers.ts",
            "src/telegram/poll-answer-cache.test.ts",
            "src/telegram/poll-answer-cache.ts",
            "src/telegram/send.poll.test.ts",
            "src/telegram/send.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17459.diff",
          "totalScore": 70,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 30,
              "weight": 0.1,
              "reason": "2337 lines changed (1955+/382-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "akyourowngames (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "The PR addresses stability, enhancements, and guardrails for the cron service. It includes fixes for Windows write resilience and timer re-arming, along with new features like multi-schedule support and per-job timeout hardening. The documentation is thorough, and the inclusion of tests is a positive sign. The risk is medium due to the scope of changes and the potential for regressions in a critical component like the cron service, especially with the introduction of multi-schedule support and store migrations. The large number of files touched also increases the risk.",
          "duplicateGroup": 0
        },
        {
          "number": 8427,
          "title": "[FEATURE] feat(spool): add spool event dispatch system with shared agent turn infrastructure",
          "body": "## Summary\n\nAdds the **spool event dispatch system** \u2014 a file-based queue for running agent turns asynchronously with retry logic, expiration, and dead-letter handling.\n\n> **Discussion:** https://github.com/openclaw/openclaw/discussions/12036\n\n### Why Spool?\n\nIn multi-agent setups \u2014 such as the [Mission Control pattern](https://www.sitegpt.ai/blog/building-mission-control-ai-agent-squad) where 10+ agents collaborate as a team \u2014 each agent wakes on a fixed cron schedule (e.g. every 15 minutes) to poll for work. This heartbeat approach has clear limitations: agents burn API credits on empty polls, work sits idle for up to 15 minutes, and nothing survives a gateway restart.\n\nThe spool system shifts from **polling to event-driven dispatch**: instead of agents asking \"is there work?\", work is queued and pushed to agents when it arrives.\n\nSpecifically, the spool enables:\n- **Async agent execution** \u2014 Queue agent turns without blocking\n- **Reliability** \u2014 Automatic retries with configurable limits\n- **Persistence** \u2014 Events survive gateway restarts\n- **Observability** \u2014 Dead-letter queue for failed events\n\n### What's Included\n\n**Spool event system** (`src/spool/`)\n- Event types with priority levels (high/normal/low/background)\n- File-based persistence with JSON schema validation  \n- Retry logic with configurable max retries and expiration\n- Dead-letter queue for failed events\n- Chokidar-based watcher with debouncing\n\n**CLI commands**\n- `spool enqueue` \u2014 queue agent turn events\n- `spool status` \u2014 view queue and dead-letter status\n\n**Gateway integration**\n- Spool watcher starts/stops with gateway lifecycle\n- Processes existing events on startup\n\n### Implementation Detail: Shared Agent Turn Infrastructure\n\nTo avoid duplicating the ~450-line agent turn execution logic between cron and spool, we extracted it into a shared module (`src/agents/isolated-turn/`). Both cron and spool now use thin wrappers (~60-70 lines each) that convert their source-specific params to a generic `IsolatedAgentTurnParams` interface.\n\n```\nsrc/agents/isolated-turn/       # Shared infrastructure\n  \u251c\u2500\u2500 run.ts                    # runIsolatedAgentTurn() - core logic\n  \u251c\u2500\u2500 types.ts                  # IsolatedAgentTurnSource: \"cron\" | \"spool\"\n  \u2514\u2500\u2500 helpers.ts, session.ts, delivery-target.ts\n\nsrc/cron/isolated-agent/run.ts  # Thin wrapper: CronJob \u2192 params\nsrc/spool/isolated-agent/run.ts # Thin wrapper: SpoolEvent \u2192 params\n```\n\n## Test Plan\n\n- [x] All existing cron tests pass (52 tests)\n- [x] New shared isolated-turn tests (19 tests)\n- [x] New spool tests (68 tests)\n- [x] Type checking passes (`pnpm tsgo`)\n- [x] CI checks pass",
          "author": "mcaxtr",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-04T01:31:27Z",
          "updatedAt": "2026-02-15T19:24:50Z",
          "headRef": "feature/spool-event-dispatch",
          "baseRef": "main",
          "filesChanged": 46,
          "additions": 4973,
          "deletions": 0,
          "commits": 5,
          "labels": [
            "gateway",
            "cli",
            "agents",
            "size: XL",
            "trusted-contributor",
            "experienced-contributor"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/agents/isolated-turn/delivery-target.ts",
            "src/agents/isolated-turn/helpers.test.ts",
            "src/agents/isolated-turn/helpers.ts",
            "src/agents/isolated-turn/index.ts",
            "src/agents/isolated-turn/run.ts",
            "src/agents/isolated-turn/session.test.ts",
            "src/agents/isolated-turn/session.ts",
            "src/agents/isolated-turn/types.ts",
            "src/cli/program/register.subclis.ts",
            "src/cli/spool-cli.ts",
            "src/cli/spool-cli/enqueue.ts",
            "src/cli/spool-cli/register.ts",
            "src/cli/spool-cli/status.ts",
            "src/config/types.openclaw.ts",
            "src/config/types.spool.ts",
            "src/config/types.ts",
            "src/config/zod-schema.ts",
            "src/gateway/config-reload.ts",
            "src/gateway/server-close.ts",
            "src/gateway/server-methods-list.ts",
            "src/gateway/server-reload-handlers.ts",
            "src/gateway/server-spool.ts",
            "src/gateway/server.impl.ts",
            "src/spool/dead-letter.test.ts",
            "src/spool/dead-letter.ts",
            "src/spool/dispatcher.test.ts",
            "src/spool/dispatcher.ts",
            "src/spool/index.ts",
            "src/spool/isolated-agent/index.ts",
            "src/spool/isolated-agent/run.test.ts",
            "src/spool/isolated-agent/run.ts",
            "src/spool/paths.test.ts",
            "src/spool/paths.ts",
            "src/spool/reader.test.ts",
            "src/spool/reader.ts",
            "src/spool/schema.test.ts",
            "src/spool/schema.ts",
            "src/spool/types.test.ts",
            "src/spool/types.ts",
            "src/spool/watcher.concurrent-events.test.ts",
            "src/spool/watcher.dead-letter.test.ts",
            "src/spool/watcher.lifecycle.test.ts",
            "src/spool/watcher.processes-existing.test.ts",
            "src/spool/watcher.ts",
            "src/spool/writer.test.ts",
            "src/spool/writer.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/8427.diff",
          "totalScore": 70,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 30,
              "weight": 0.1,
              "reason": "4973 lines changed (4973+/0-)"
            },
            {
              "name": "commit_quality",
              "score": 50,
              "weight": 0.05,
              "reason": "Non-standard title"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "mcaxtr (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "Comprehensive feature with good documentation and testing. The risk is medium due to the complexity of the new spool system and its integration with the existing gateway. Thorough review and testing are crucial to ensure stability and prevent unexpected issues.",
          "duplicateGroup": 0
        },
        {
          "number": 3527,
          "title": "fix: detect and manage systemd system services",
          "body": "## Problem\n\nThe CLI only detected and managed systemd user services (~/.config/systemd/user/), which failed on VPS/server installs where the gateway runs as a system service (/etc/systemd/system/).\n\nThis caused:\n- clawdbot status to incorrectly report \"Gateway service | systemd not installed\"\n- clawdbot gateway restart to fail with \"systemctl --user unavailable\"\n\nFixes #1818\n\n## Related Work\n\nComplements PR #3440 which adds systemd templates for production deployment. This PR makes the CLI actually detect and manage those system services once installed.\n\n## Changes\n\n- Check both user and system service paths for unit files\n- Try user service first, fall back to system service with sudo\n- Update isSystemdServiceEnabled to check both locations\n- Update readSystemdServiceRuntime to read from both locations  \n- Update stop/restart to work with both service types\n- Add resolveSystemdSystemUnitPathForName helper\n\n## Testing\n\n- [ ] Test on system with user service (should work as before)\n- [ ] Test on system with system service (should now detect correctly)\n- [ ] Test clawdbot status shows correct service status\n- [ ] Test service management commands work with system service\n\n## Backwards Compatibility\n\nUser services are still preferred. The changes only add fallback to system services when user services aren't found or accessible.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR updates the Linux/systemd service management helpers to support gateway installs as **system services** (e.g. `/etc/systemd/system/*.service`) in addition to the existing **user service** support (`~/.config/systemd/user`). It adds a system unit path resolver, makes exec-start reading try user then system unit files, and updates stop/restart/is-enabled/runtime reads to attempt `systemctl --user ...` first and fall back to `sudo systemctl ...` for system units.\n\nNon-systemd changes are minor: a small type change in the Google Chat extension account config lookup, a quick-replies refactor in the LINE extension, and a reorder of the `package.json` publish `files` list.\n\nMain integration point is `src/daemon/service.ts`, which delegates all Linux gateway service operations to `src/daemon/systemd.ts`. These changes therefore affect `openclaw gateway status/restart/stop` flows on Linux.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR is directionally correct but has a few behavioral/typing issues that could break non-interactive environments and degrade runtime/status reporting.\n- Score lowered due to new `sudo`-based fallback that may block waiting for a password (no `-n`), a likely runtime field mismatch (`lastExitReason` vs `lastRunResult`) affecting status display, and type-safety regressions in extension config access. The rest of the changes are localized and understandable.\n- src/daemon/systemd.ts (sudo fallback + runtime fields), src/cli/daemon-cli/shared.ts (Linux log hints), extensions/googlechat/src/accounts.ts (config typing), extensions/line/src/channel.ts (quickReplies typing).\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "growthringsadvisory",
          "authorAssociation": "NONE",
          "createdAt": "2026-01-28T18:57:36Z",
          "updatedAt": "2026-02-15T19:53:51Z",
          "headRef": "fix/system-service-detection",
          "baseRef": "main",
          "filesChanged": 39,
          "additions": 254,
          "deletions": 124,
          "commits": 27,
          "labels": [
            "channel: googlechat",
            "channel: whatsapp-web",
            "app: macos",
            "gateway",
            "cli",
            "size: M"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            1818
          ],
          "changedFiles": [
            ".swiftformat",
            "apps/macos/Tests/OpenClawIPCTests/AgentEventStoreTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/AnyCodableEncodingTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/CameraCaptureServiceTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/CameraIPCTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/CanvasIPCTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/CanvasWindowSmokeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/CommandResolverTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/CronJobEditorSmokeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayChannelConfigureTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayChannelConnectTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayChannelRequestTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayChannelShutdownTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayConnectionControlTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayFrameDecodeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/GatewayProcessManagerTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/HealthDecodeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/HealthStoreStateTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/LogLocatorTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/LowCoverageHelperTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/LowCoverageViewSmokeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/MacNodeRuntimeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/OpenClawOAuthStoreTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/PermissionManagerLocationTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/PermissionManagerTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/UtilitiesTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/VoicePushToTalkHotkeyTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/VoiceWakeGlobalSettingsSyncTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/WebChatSwiftUISmokeTests.swift",
            "apps/macos/Tests/OpenClawIPCTests/WorkActivityStoreTests.swift",
            "extensions/googlechat/src/accounts.ts",
            "src/browser/server.post-tabs-open-profile-unknown-returns-404.test.ts",
            "src/cli/daemon-cli/shared.ts",
            "src/cron/service/store.ts",
            "src/daemon/service-runtime.ts",
            "src/daemon/systemd.ts",
            "src/gateway/server-runtime-config.test.ts",
            "src/security/windows-acl.test.ts",
            "src/web/media.test.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/3527.diff",
          "totalScore": 78,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "378 lines changed (254+/124-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "growthringsadvisory (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #1818"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 90,
          "llmRisk": "low",
          "llmReason": "The PR addresses a significant issue by enabling the CLI to manage systemd system services, which is crucial for VPS/server deployments. The changes are well-explained, and the testing plan covers both user and system service scenarios. The backwards compatibility considerations are also well-addressed. The risk is low because the changes primarily add functionality and fallback mechanisms, minimizing the potential for regressions. The greptile summary confirms the changes are focused and well-defined.",
          "duplicateGroup": 0
        },
        {
          "number": 11974,
          "title": "[FEATURE] feat: integrate systemd WatchdogSec for gateway hang detection",
          "body": "## Summary\n\n- Add `sd-notify` wrapper (`src/infra/sd-notify.ts`) that sends `READY=1` on startup and `WATCHDOG=1` heartbeats every 30s via the existing tick interval\n- Update the generated systemd unit with `Type=notify`, `NotifyAccess=all`, and `WatchdogSec=90` so systemd automatically kills and restarts the gateway if the event loop freezes\n- All calls are no-ops when `$NOTIFY_SOCKET` is unset (macOS, manual dev, tests)\n\nFixes #11973\nDiscussion: https://github.com/openclaw/openclaw/discussions/12026\n\n## Review fixes\n\nAddressed functional regressions flagged during code review:\n\n- **[P1] Chat routing**: Restored canonical session key destructuring from `loadSessionEntry()` so `resolveSessionAgentId` and `resolveSendPolicy` use the resolved key instead of raw aliases (`chat.ts`)\n- **[P1] iOS disconnect recovery**: Restored `handleChannelDisconnected` to call `resetConnectionState()` before `onDisconnected`, so `notifyConnectedIfNeeded()` re-fires after reconnect (`GatewayNodeSession.swift`)\n- **[P2] UI state clobbering**: Added connected short-circuit in the reconnection loop so a healthy connection isn't repeatedly shown as \"Connecting\u2026\" (`NodeAppModel.swift`)\n- **[P2] Challenge timeout**: Restored `connectChallengeTimeoutSeconds` from 0.75s to 3.0s to avoid nonce handshake failures on remote/Tailscale links (`GatewayChannel.swift`)\n\n## Test plan\n\n- [x] `sdNotifyReady()` is a no-op when `NOTIFY_SOCKET` is not set\n- [x] `sdNotifyReady()` calls `systemd-notify --ready` when `NOTIFY_SOCKET` is set\n- [x] `sdNotifyWatchdog()` is a no-op when `NOTIFY_SOCKET` is not set\n- [x] `sdNotifyWatchdog()` calls `systemd-notify WATCHDOG=1` when `NOTIFY_SOCKET` is set\n- [x] Generated systemd unit includes `Type=notify`\n- [x] Generated systemd unit includes `NotifyAccess=all`\n- [x] Generated systemd unit includes `WatchdogSec=90`\n- [x] All directives placed in `[Service]` section\n- [x] All 8 new tests fail before implementation, pass after\n- [x] `pnpm build` compiles cleanly\n- [x] `pnpm check` passes (types, lint, format)\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR adds a new `sd-notify` wrapper (`src/infra/sd-notify.ts`) and integrates it into the gateway startup/shutdown path to support `Type=notify` readiness notifications and periodic `WATCHDOG=1` heartbeats. It also threads an opt-in `watchdog` flag through gateway systemd installation/update flows so generated user units include `Type=notify`, `NotifyAccess=all`, and `WatchdogSec=90`, and adjusts systemd unit naming resolution to respect `OPENCLAW_SYSTEMD_UNIT` consistently during install/uninstall.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR looks safe to merge with minimal risk.\n- Reviewed the diffs around systemd unit generation, unit name resolution, and gateway startup/shutdown integration. The sd-notify helper is gated on NOTIFY_SOCKET/WATCHDOG_USEC, watchdog calls are cleaned up on shutdown, and install/uninstall now consistently respect OPENCLAW_SYSTEMD_UNIT to avoid competing units. No definite functional regressions were found in the changed code paths.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "mcaxtr",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-08T16:52:37Z",
          "updatedAt": "2026-02-15T19:25:23Z",
          "headRef": "feat/11973-sd-notify-watchdog",
          "baseRef": "main",
          "filesChanged": 14,
          "additions": 504,
          "deletions": 7,
          "commits": 3,
          "labels": [
            "gateway",
            "cli",
            "commands",
            "size: L",
            "trusted-contributor",
            "experienced-contributor"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            11973
          ],
          "changedFiles": [
            "src/cli/daemon-cli/install.ts",
            "src/commands/configure.daemon.ts",
            "src/commands/doctor-gateway-daemon-flow.ts",
            "src/commands/doctor-gateway-services.ts",
            "src/commands/onboard-non-interactive/local/daemon-install.ts",
            "src/daemon/service.ts",
            "src/daemon/systemd-unit.test.ts",
            "src/daemon/systemd-unit.ts",
            "src/daemon/systemd.ts",
            "src/gateway/server-close.ts",
            "src/gateway/server.impl.ts",
            "src/infra/sd-notify.test.ts",
            "src/infra/sd-notify.ts",
            "src/wizard/onboarding.finalize.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/11974.diff",
          "totalScore": 75,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "511 lines changed (504+/7-)"
            },
            {
              "name": "commit_quality",
              "score": 50,
              "weight": 0.05,
              "reason": "Non-standard title"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "mcaxtr (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #11973"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "This PR introduces systemd watchdog functionality, which is a valuable addition for gateway hang detection and recovery. The code includes a wrapper for `sd-notify`, updates the systemd unit file, and provides comprehensive tests. The review fixes address functional regressions, indicating a thorough review process. However, the risk is medium due to the potential for unexpected interactions with the existing system and the reliance on systemd, which may not be available in all environments. The large number of files touched also increases the risk of introducing unintended side effects.",
          "duplicateGroup": 0
        }
      ],
      "bestPR": 3527,
      "similarity": 0.8188660402548779,
      "reason": "4 similar PRs (avg similarity: 81.9%)"
    },
    {
      "id": 1,
      "prs": [
        {
          "number": 17431,
          "title": "ci: Fix Ubuntu CI failing... again.",
          "body": "# What\u2019s Happened\r\n\r\nCI was flaking because Node kept running out of memory during the build.\r\n\r\n# What Changed\r\n\r\nI bumped the Node.js heap size so the build has enough room to breathe instead of crashing halfway through. This just affects CI/runtime config, no functional changes.\r\n\r\n# Why\r\n\r\nWithout this, Node hits its default heap limit and OOMs in CI. With the increased heap, the jobs run cleanly and consistently.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdds `NODE_OPTIONS: --max-old-space-size=4096` to the Ubuntu `checks` job to prevent Node.js OOM crashes during CI test runs. This brings the Ubuntu job in line with the Windows and macOS jobs, which already had this setting.\n\n- Sets Node.js heap limit to 4096 MB at the job level for the `checks` matrix (test, protocol, bun test)\n- No functional code changes; CI-only configuration fix\n- The `build-artifacts` and `check` jobs still don't set this env var \u2014 worth monitoring if they also start OOM-ing\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge \u2014 it's a minimal CI configuration change with no functional code impact.\n- The change adds a single environment variable to a CI job, matching the existing pattern already used by the Windows and macOS jobs. It addresses a known OOM issue (referenced in #17341) with a standard Node.js memory configuration. No application code is modified.\n- No files require special attention.\n\n<sub>Last reviewed commit: d22a7a4</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
          "author": "thesomewhatyou",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T19:02:30Z",
          "updatedAt": "2026-02-15T19:55:46Z",
          "headRef": "main",
          "baseRef": "main",
          "filesChanged": 1,
          "additions": 2,
          "deletions": 0,
          "commits": 8,
          "labels": [
            "size: XS"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            ".github/workflows/ci.yml"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17431.diff",
          "totalScore": 74,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 20,
              "weight": 0.1,
              "reason": "2 lines changed (2+/0-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "thesomewhatyou (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 50,
              "weight": 0.15,
              "reason": "<3 lines, No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 90,
          "llmRisk": "low",
          "llmReason": "Addresses a known CI issue (OOM errors) with a targeted configuration change. The change is well-explained, and the Greptile summary provides additional context and confidence. The risk is low because it's a CI-only change with no functional impact. The score is high, but not perfect, because the 'build-artifacts' and 'check' jobs are not addressed, and may need to be in the future.",
          "duplicateGroup": 1
        },
        {
          "number": 17420,
          "title": "fix(ci): add NODE_OPTIONS to Linux checks job and fix media test cross-platform",
          "body": "## Summary\n- Add `NODE_OPTIONS: --max-old-space-size=4096` and `OPENCLAW_TEST_WORKERS: 2` to the Linux `checks` job in CI, matching what Windows/macOS already have. This prevents OOM crashes during test runs on Linux.\n- Fix `media.test.ts` platform-dependent test failure: on Linux CI, `STATE_DIR` lives under `/tmp` which is in the default `localRoots` via `os.tmpdir()`, so `workspace-clawdy` paths were inadvertently allowed. The test now passes explicit `localRoots` without `os.tmpdir()` to be deterministic across platforms.\n\n## Test plan\n- [x] `src/web/media.test.ts` passes locally (22/22 tests)\n- [ ] Linux CI `checks` jobs should no longer OOM\n- [ ] Bun test should no longer fail on `media.test.ts:407`\n\n\ud83e\udd16 Generated with [Claude Code](https://claude.com/claude-code)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR includes multiple features and fixes: CI memory configuration, cross-platform test fix, Discord components v2 support, and entry requirements refactoring.\n\n**Key changes:**\n- Added `NODE_OPTIONS` and `OPENCLAW_TEST_WORKERS` to Linux CI checks job to match Windows/macOS configuration and prevent OOM crashes\n- Fixed `media.test.ts` platform-dependent failure by passing explicit `localRoots` without `os.tmpdir()` to avoid Linux CI path overlap issues\n- Added comprehensive Discord components v2 support with buttons, selects, modals, and rich UI blocks (`src/discord/components.ts`, 1088 lines)\n- Implemented in-memory component registry with 30-minute TTL for ephemeral UI state tracking\n- Refactored entry requirements evaluation into shared `evaluateEntryMetadataRequirements` function to reduce duplication between skills and hooks status modules\n- Removed reverted role allowlist changelog entry for cleanup\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with low risk, pending CI validation\n- The changes are well-structured and follow existing patterns. The CI configuration aligns with Windows/macOS settings, the media test fix addresses a real cross-platform issue with explicit path configuration, and the Discord components implementation includes comprehensive validation logic and test coverage. The entry requirements refactoring properly extracts shared logic without changing behavior. Main risk is CI validation of the OOM fix and cross-platform test behavior.\n- Pay close attention to CI test results to verify the OOM fix and cross-platform media test behavior\n\n<sub>Last reviewed commit: 9ce3e14</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "BinHPdev",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T18:50:39Z",
          "updatedAt": "2026-02-15T19:21:27Z",
          "headRef": "fix/ci-oom-media-test-cross-platform",
          "baseRef": "main",
          "filesChanged": 21,
          "additions": 2835,
          "deletions": 162,
          "commits": 6,
          "labels": [
            "docs",
            "channel: discord",
            "channel: whatsapp-web",
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            ".github/workflows/ci.yml",
            "CHANGELOG.md",
            "docs/channels/discord.md",
            "extensions/discord/src/channel.ts",
            "src/agents/skills-status.ts",
            "src/agents/tools/discord-actions-messaging.ts",
            "src/agents/tools/message-tool.ts",
            "src/channels/plugins/actions/discord/handle-action.ts",
            "src/discord/components-registry.ts",
            "src/discord/components.test.ts",
            "src/discord/components.ts",
            "src/discord/monitor/agent-components.test.ts",
            "src/discord/monitor/agent-components.ts",
            "src/discord/monitor/message-handler.preflight.test.ts",
            "src/discord/monitor/provider.ts",
            "src/discord/send.components.ts",
            "src/discord/send.ts",
            "src/hooks/hooks-status.ts",
            "src/infra/outbound/message-action-runner.ts",
            "src/shared/entry-status.ts",
            "src/web/media.test.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17420.diff",
          "totalScore": 76,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 30,
              "weight": 0.1,
              "reason": "2997 lines changed (2835+/162-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "BinHPdev (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "The PR addresses a CI stability issue and a cross-platform test failure, which are positive. It also introduces significant new functionality with Discord components v2. The risk is medium because of the large scope of changes, especially the new Discord components, which require careful review and testing to ensure stability and security. The test plan is not fully complete, as it only checks local tests and CI stability, but doesn't explicitly mention testing the new Discord components.",
          "duplicateGroup": 1
        },
        {
          "number": 17456,
          "title": "fix(test): stabilize media root guard test against tmpdir HOME overlap",
          "body": "## fix(test): stabilize media root guard test\n\n### Problem\n\nThe test `rejects default OpenClaw state per-agent workspace-* roots without explicit local roots` in `src/web/media.test.ts` **fails on every CI run** (bun + node), including on `main`.\n\n### Root Cause\n\nThe test harness sets `HOME` to a temp directory under `os.tmpdir()`:\n\n```\nHOME=/tmp/openclaw-test-home-xC06Jb\n```\n\nSince `os.tmpdir()` (`/tmp`) is a default allowed media root, **all paths** under the test's `HOME` directory match the tmpdir root:\n\n```\ntestPath: /tmp/openclaw-test-home-xC06Jb/.openclaw-guard-reject-test/workspace-clawdy/tmp/render.bin\nroot /tmp \u2192 MATCH (startsWith /tmp/)\n```\n\nThe test expects a rejection but gets a successful resolve because the path is \"allowed\" via tmpdir.\n\n### Fix\n\nPin `OPENCLAW_STATE_DIR` to `/var/openclaw-guard-reject-test` (outside `/tmp`) for the duration of the test. This is the same pattern used in `be9b5cefb` for the `web media loading` describe block, which was missing from the separate `local media root guard` describe block.\n\n### Changed Files\n\n| File | Change |\n|------|--------|\n| `src/web/media.test.ts` | Pin OPENCLAW_STATE_DIR in the failing test |\n\n### Testing\n\n- All 22 media tests pass (previously 21 pass / 1 fail)\n- This fixes the CI failure visible on `main` and all open PRs\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nFixes test flakiness by pinning `OPENCLAW_STATE_DIR` to `/var/openclaw-guard-reject-test` (outside `/tmp`) for the duration of the test. The test was failing because the harness sets `HOME` to a temp directory under `os.tmpdir()` (`/tmp`), and since `/tmp` is a default allowed media root, all paths under the test's `HOME` were incorrectly matching the tmpdir root instead of being rejected as expected.\n\n- Correctly isolates the test environment to ensure the rejection path is tested\n- Properly restores previous `OPENCLAW_STATE_DIR` value after the test\n- Follows the pattern established for similar tests in the same file\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The change is narrowly scoped to a single test, uses established patterns from the same file, properly handles cleanup, and directly addresses the root cause of the test failure. The fix isolates the test environment correctly without affecting production code or other tests.\n- No files require special attention\n\n<sub>Last reviewed commit: ebbcfe6</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "widingmarcus-cyber",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T19:40:49Z",
          "updatedAt": "2026-02-15T19:44:48Z",
          "headRef": "fix/media-test-state-dir-isolation-17445",
          "baseRef": "main",
          "filesChanged": 1,
          "additions": 22,
          "deletions": 10,
          "commits": 1,
          "labels": [
            "channel: whatsapp-web",
            "size: XS"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/web/media.test.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17456.diff",
          "totalScore": 79,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 70,
              "weight": 0.1,
              "reason": "32 lines changed (22+/10-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "widingmarcus-cyber (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "The PR addresses a flaky test by correctly isolating the test environment. The fix is well-explained, targeted, and includes testing to confirm the resolution. The change is small and localized, reducing the risk of unintended consequences. The use of a pattern already established in the same file further reduces risk.",
          "duplicateGroup": 1
        }
      ],
      "bestPR": 17456,
      "similarity": 0.8255634563708143,
      "reason": "3 similar PRs (avg similarity: 82.6%)"
    },
    {
      "id": 2,
      "prs": [
        {
          "number": 17452,
          "title": "ci: Grant write perms for Issues for formal-conformance.yml",
          "body": "This pull request makes a minor update to the GitHub Actions workflow configuration by adjusting permissions to ensure proper functionality.\r\n\r\n* Updated the `.github/workflows/formal-conformance.yml` workflow to explicitly add `issues: write` permission, which is required for the workflow to function correctly.\r\n\r\nThat's it.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded `issues: write` permission to the formal-conformance workflow, which is required for the workflow to post comments on pull requests using `github.rest.issues.createComment()` (line 126).\n\n- The permission is necessary because GitHub treats PR comments as issue comments in the REST API\n- Without this permission, the workflow would fail when attempting to post the drift detection comment\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- Single-line addition of a required permission for an existing API call; the change is necessary for correct workflow functionality and carries no risk\n- No files require special attention\n\n<sub>Last reviewed commit: badca70</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
          "author": "thesomewhatyou",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T19:33:13Z",
          "updatedAt": "2026-02-15T19:55:40Z",
          "headRef": "patch-1",
          "baseRef": "main",
          "filesChanged": 1,
          "additions": 1,
          "deletions": 0,
          "commits": 3,
          "labels": [
            "size: XS"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            ".github/workflows/formal-conformance.yml"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17452.diff",
          "totalScore": 77,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 20,
              "weight": 0.1,
              "reason": "1 lines changed (1+/0-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "thesomewhatyou (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 50,
              "weight": 0.15,
              "reason": "<3 lines, No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "The PR adds a necessary permission for a workflow to function correctly. The change is small, well-explained, and the Greptile summary confirms its purpose and safety. High confidence and minimal risk.",
          "duplicateGroup": 2
        },
        {
          "number": 17426,
          "title": "ci(formal): don't fail on fork PRs when PR comment is blocked",
          "body": "This workflow is informational, but currently fails on fork PRs when the comment step hits GitHub's token restrictions (403: \"Resource not accessible by integration\").\n\nChanges:\n- Add `issues: write` permission (comment uses the issues API)\n- Skip commenting on fork PRs (where token restrictions commonly apply)\n- Wrap comment in try/catch + `continue-on-error: true` so the job remains informational\n\nThis should keep CI green for docs-only/community PRs while still uploading the drift artifact.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nHardens the `formal-conformance` workflow so it no longer fails on fork PRs when the GitHub token lacks permission to post PR comments. Three defensive layers are added: the `issues: write` permission (needed by the `createComment` API), an early return for fork PRs, and a try/catch with `continue-on-error: true` on the comment step.\n\n- Added `issues: write` permission, consistent with other workflows in the repo (`stale.yml`, `labeler.yml`, `auto-response.yml`)\n- Fork PRs are detected via `pr?.head?.repo?.fork` and skip commenting early\n- The `createComment` call is wrapped in try/catch so any remaining API failures are logged but don't fail the job\n- `continue-on-error: true` provides an additional safety net at the step level\n- No functional changes to the drift detection, model checking, or artifact upload logic\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge \u2014 it only adds defensive error handling to an informational CI step.\n- The changes are limited to a single workflow file, only affect the PR commenting step (which is explicitly informational), and add multiple layers of defensive handling (permission, early return, try/catch, continue-on-error). No functional logic is altered. The refactoring of `context.payload.pull_request.number` to `pr.number` is correct.\n- No files require special attention.\n\n<sub>Last reviewed commit: 6375924</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "mitre88",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T18:59:47Z",
          "updatedAt": "2026-02-15T19:30:41Z",
          "headRef": "chore/formal-conformance-fork-safe",
          "baseRef": "main",
          "filesChanged": 2,
          "additions": 25,
          "deletions": 6,
          "commits": 2,
          "labels": [
            "size: XS"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            ".github/workflows/ci.yml",
            ".github/workflows/formal-conformance.yml"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17426.diff",
          "totalScore": 74,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 70,
              "weight": 0.1,
              "reason": "31 lines changed (25+/6-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "mitre88 (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "The PR addresses a known issue with CI failing on fork PRs due to token restrictions. It implements multiple layers of defense: adding necessary permissions, skipping the comment step on fork PRs, and wrapping the comment in a try/catch block with `continue-on-error`. The changes are isolated to a single workflow file and don't affect core functionality. The Greptile summary confirms the safety and limited scope of the changes.",
          "duplicateGroup": 2
        }
      ],
      "bestPR": 17452,
      "similarity": 0.8956233821237056,
      "reason": "2 similar PRs (avg similarity: 89.6%)"
    },
    {
      "id": 3,
      "prs": [
        {
          "number": 17470,
          "title": "feat(cache): per-agent params for cacheRetention control",
          "body": "## Summary\n\n- Add optional `params` field to `AgentConfig` type for per-agent stream param overrides\n- Extend `resolveExtraParams()` to look up agent-specific params from `agents.list[].params` and merge them over global model defaults\n- Pass `sessionAgentId` through to `applyExtraParamsToAgent()` in `attempt.ts`\n\nThis lets individual agents override cacheRetention (or other stream params) without affecting other agents. Useful for disabling caching on low-traffic agents like cron jobs where cache writes ($1.25/MTok) expire before reuse.\n\n**Config example:**\n```json\n{\n  \"agents\": {\n    \"list\": [{\n      \"id\": \"risk-reviewer\",\n      \"params\": { \"cacheRetention\": \"none\" }\n    }]\n  }\n}\n```\n\nFixes #17112\n\n## Test plan\n\n- [x] Added test: per-agent params returned when agentId matches\n- [x] Added test: agent params merge over global model defaults (agent wins)\n- [x] Added test: unmatched agentId returns undefined (no side effects)",
          "author": "rrenamed",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:54:37Z",
          "updatedAt": "2026-02-15T19:54:49Z",
          "headRef": "feat/per-agent-cache-retention",
          "baseRef": "main",
          "filesChanged": 4,
          "additions": 97,
          "deletions": 1,
          "commits": 1,
          "labels": [
            "agents",
            "size: S"
          ],
          "ciStatus": "pending",
          "hasIssueRef": true,
          "issueNumbers": [
            17112
          ],
          "changedFiles": [
            "src/agents/pi-embedded-runner-extraparams.e2e.test.ts",
            "src/agents/pi-embedded-runner/extra-params.ts",
            "src/agents/pi-embedded-runner/run/attempt.ts",
            "src/config/types.agents.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17470.diff",
          "totalScore": 82,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "98 lines changed (97+/1-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "rrenamed (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #17112"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 90,
          "llmRisk": "low",
          "llmReason": "Well-defined feature with clear use case, config example, and comprehensive tests. Addresses a specific issue and provides a targeted solution. Changes are localized and the risk of unintended consequences is low.",
          "duplicateGroup": 3
        },
        {
          "number": 17462,
          "title": "fix(cache): enable cache retention for Google Vertex AI",
          "body": "## Summary\n\n- Add `google-vertex` to the provider check in `resolveCacheRetention()` so Vertex AI users get prompt caching via the `cacheRetention` stream option\n- Add `google-vertex` to `isCacheTtlEligibleProvider()` so cache-TTL context pruning works for Vertex AI sessions\n- Add test coverage for Vertex AI caching and `isCacheTtlEligibleProvider`\n\nVertex AI uses the Anthropic Messages API natively and supports `cacheRetention`, but was excluded from both checks \u2014 meaning Vertex AI users got no prompt caching despite the API supporting it.\n\nFixes #15525\n\n## Test plan\n\n- [x] Added e2e tests verifying `cacheRetention` is applied for `google-vertex` provider\n- [x] Added e2e tests verifying `cacheRetention` is NOT applied for non-Anthropic providers (e.g., `openai`)\n- [x] Added unit tests for `isCacheTtlEligibleProvider` covering `anthropic`, `google-vertex`, `openrouter` (with/without anthropic model), and case insensitivity\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nExtended prompt caching support to Google Vertex AI provider by adding `google-vertex` to the eligible provider checks in both `resolveCacheRetention()` and `isCacheTtlEligibleProvider()`. Since Vertex AI uses the Anthropic Messages API natively, it supports the same `cacheRetention` stream option as the direct Anthropic provider.\n\n- Added `google-vertex` provider to cache retention logic in `extra-params.ts:51`\n- Added `google-vertex` provider to cache-TTL eligibility check in `cache-ttl.ts:14`\n- Added comprehensive e2e tests verifying `cacheRetention` is applied for Vertex AI\n- Added unit tests covering all providers including case-insensitivity\n- Updated inline comments to clarify both Anthropic and Vertex AI are supported\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The changes are minimal, well-tested, and logically sound. The PR adds `google-vertex` to two provider eligibility checks to enable prompt caching for Vertex AI, which already uses the Anthropic Messages API. The implementation is consistent with existing patterns, includes comprehensive test coverage (both e2e and unit tests), and updates documentation. No edge cases or breaking changes detected.\n- No files require special attention\n\n<sub>Last reviewed commit: afe01c7</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "rrenamed",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:50:04Z",
          "updatedAt": "2026-02-15T19:52:08Z",
          "headRef": "fix/vertex-ai-cache-retention",
          "baseRef": "main",
          "filesChanged": 3,
          "additions": 112,
          "deletions": 4,
          "commits": 1,
          "labels": [
            "agents",
            "size: S"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            15525
          ],
          "changedFiles": [
            "src/agents/pi-embedded-runner-extraparams.e2e.test.ts",
            "src/agents/pi-embedded-runner/cache-ttl.ts",
            "src/agents/pi-embedded-runner/extra-params.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17462.diff",
          "totalScore": 81,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "116 lines changed (112+/4-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "rrenamed (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #15525"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "This PR correctly identifies and fixes a missing provider in the cache retention logic. The changes are small, well-tested with both e2e and unit tests, and the description is clear. The Greptile summary confirms the changes are logically sound and low risk.",
          "duplicateGroup": 3
        }
      ],
      "bestPR": 17470,
      "similarity": 0.8239574621176468,
      "reason": "2 similar PRs (avg similarity: 82.4%)"
    },
    {
      "id": 4,
      "prs": [
        {
          "number": 17435,
          "title": "fix(debounce): retry flush with exponential backoff to prevent silent message loss",
          "body": "## fix(debounce): retry inbound flush on lock contention\n\nFixes #17421\n\n### Problem\n\nWhen the inbound debounce timer fires and `onFlush` fails (e.g. due to session store lock contention with a concurrent cron job), the buffered messages are **permanently and silently lost**:\n\n```\ntelegram debounce flush failed: Error: timeout acquiring session store lock\n```\n\nThe user sees blue checkmarks on Telegram, but the agent never receives the message. Neither side knows anything was lost.\n\nFrom the bug report: **5 messages dropped in 2 days** during normal operation.\n\n### Root Cause\n\n`flushBuffer()` in `inbound-debounce.ts` catches the error and calls `onError()`, but all channel handlers (`telegram`, `discord`, `signal`, `slack`, `imessage`) only log the error \u2014 the buffered items are discarded with no retry.\n\n### Fix\n\nAdd retry with exponential backoff to `flushBuffer()`:\n\n```typescript\n// Retry loop (default: 3 attempts, 500ms base backoff)\nfor (let attempt = 0; attempt <= retryAttempts; attempt++) {\n  try {\n    await params.onFlush(buffer.items);\n    return; // success\n  } catch (err) {\n    lastErr = err;\n    if (attempt < retryAttempts) {\n      await delay(retryBaseMs * 2 ** attempt);\n      // 500ms \u2192 1000ms \u2192 2000ms\n    }\n  }\n}\nparams.onError?.(lastErr, buffer.items); // only after all retries exhausted\n```\n\nNew configurable options (backwards compatible):\n- `retryAttempts`: max retry count (default: 3)\n- `retryBaseMs`: base delay for exponential backoff (default: 500ms)\n\n### Changed Files\n\n| File | Change |\n|------|--------|\n| `src/auto-reply/inbound-debounce.ts` | Add retry loop to `flushBuffer()` |\n| `src/auto-reply/inbound-debounce.retries-on-flush-failure.test.ts` | 3 new tests |\n\n### Testing\n\n- 3 new tests (retry success, retry exhaustion, no-retry path)\n- All 659 auto-reply tests pass\n- Lint + format clean\n\n### Impact\n\nAffects ALL channels: Telegram, Discord, Signal, Slack, iMessage. Any channel using inbound debounce benefits from this fix without code changes \u2014 the retry is in the shared debouncer.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded retry logic with exponential backoff to prevent silent message loss when debounced message flushes fail due to session store lock contention.\n\n**Key changes:**\n- Added configurable retry parameters (`retryAttempts`: default 3, `retryBaseMs`: default 500ms) to `createInboundDebouncer`\n- Implemented exponential backoff retry loop in `flushBuffer` (500ms \u2192 1000ms \u2192 2000ms)\n- Only calls `onError` after all retries are exhausted\n- Added comprehensive test coverage for retry success, exhaustion, and no-retry paths\n\n**Issue found:**\n- Non-debounced messages (line 116 in `enqueue`) still bypass retry logic - messages with media or control commands can be lost if lock contention occurs during their immediate flush\n\n<h3>Confidence Score: 3/5</h3>\n\n- Safe to merge with one critical limitation that should be addressed\n- The implementation is solid and well-tested for the debounced path, but the non-debounced path (line 116) still lacks retry protection, leaving a gap in the fix for messages with media or control commands\n- Pay attention to `src/auto-reply/inbound-debounce.ts` line 116 where non-debounced messages bypass retry logic\n\n<sub>Last reviewed commit: 9102b0c</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "widingmarcus-cyber",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T19:07:39Z",
          "updatedAt": "2026-02-15T19:54:22Z",
          "headRef": "fix/debounce-retry-on-lock-failure-17421",
          "baseRef": "main",
          "filesChanged": 4,
          "additions": 135,
          "deletions": 15,
          "commits": 2,
          "labels": [
            "channel: whatsapp-web",
            "size: S"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            17421
          ],
          "changedFiles": [
            "openclaw-2026-02-15.log",
            "src/auto-reply/inbound-debounce.retries-on-flush-failure.test.ts",
            "src/auto-reply/inbound-debounce.ts",
            "src/web/media.test.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17435.diff",
          "totalScore": 84,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "150 lines changed (135+/15-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "widingmarcus-cyber (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #17421"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "The PR addresses a critical issue of silent message loss due to lock contention during debounce flushing. The fix implements a retry mechanism with exponential backoff, which is a robust approach. The changes are well-documented, include new tests covering different scenarios, and are backwards compatible. The impact is significant, affecting all channels using inbound debounce. The risk is low due to the thorough testing and clear explanation of the problem and solution.",
          "duplicateGroup": 4
        },
        {
          "number": 17433,
          "title": "fix(telegram): omit message_thread_id for private chats to prevent silent message drops",
          "body": "## fix(telegram): omit message_thread_id for private chats\n\nFixes #17242\n\n### Problem\n\nWhen delivering messages to Telegram private chats, the outbound send functions hardcode `scope: 'forum'` in the thread spec:\n\n```typescript\n// Before:\nconst threadSpec = messageThreadId != null\n  ? { id: messageThreadId, scope: \"forum\" as const }\n  : undefined;\n```\n\nPrivate chats (positive chatId) don't support forum topics. Telegram rejects the API call with `400: Bad Request: message thread not found`, and the message is **silently dropped** \u2014 the user sees blue checkmarks but the agent never receives/sends the message.\n\nFrom the bug report: **111 failures over 4 days** (81 on Feb 11 alone).\n\n### Root Cause\n\n`sendMessageTelegram`, `sendStickerTelegram`, and `sendPollTelegram` all construct the thread spec with `scope: 'forum'` regardless of whether the chat is a private chat or a group. The existing `buildTelegramThreadParams()` helper already correctly filters out `scope: 'dm'`, but it never sees `scope: 'dm'` because the callers always pass `'forum'`.\n\n### Fix\n\nAdd `inferThreadScope(chatId)` helper that determines scope from the chatId:\n- **Positive numeric IDs** \u2192 `'dm'` (private chat)\n- **`@`-usernames** \u2192 `'dm'` (private chat / channel)\n- **Negative numeric IDs** \u2192 `'forum'` (group/supergroup, may be forum)\n\n```typescript\n// After:\nconst threadSpec = messageThreadId != null\n  ? { id: messageThreadId, scope: inferThreadScope(chatId) }\n  : undefined;\n```\n\nThis lets the existing `buildTelegramThreadParams()` guard properly omit `message_thread_id` for private chats.\n\n### Changed Files\n\n| File | Change |\n|------|--------|\n| `src/telegram/send.ts` | Add `inferThreadScope()`; fix all 3 send functions |\n| `src/telegram/send.returns-undefined-empty-input.test.ts` | Update retry tests to use group chatIds |\n| `src/telegram/send.poll.test.ts` | Update retry test + add private chat assertion |\n\n### Testing\n\n- All 447 Telegram tests pass\n- Added new test: `omits message_thread_id for private chats (positive chatId)`\n- Existing retry tests updated to use negative chatIds (groups)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR fixes silent message drops in Telegram private chats by adding an `inferThreadScope(chatId)` helper that determines whether a chat supports forum topics based on the chat ID format. Previously, all three outbound send functions (`sendMessageTelegram`, `sendStickerTelegram`, `sendPollTelegram`) hardcoded `scope: \"forum\"` when constructing thread specs, causing `buildTelegramThreadParams()` to include `message_thread_id` even for private chats \u2014 which Telegram rejects with a 400 error.\n\n- **Root cause fix**: `inferThreadScope()` maps positive numeric IDs to `\"dm\"` and negative IDs to `\"forum\"`, letting the existing `buildTelegramThreadParams()` guard correctly omit `message_thread_id` for private chats\n- **Test updates**: Retry tests updated to use negative (group) chatIds since private chats no longer include `message_thread_id`; new test added for the private chat omission behavior\n- **Minor note**: `@`-usernames are treated as `\"dm\"` but can theoretically refer to public forum groups \u2014 unlikely to cause issues in practice since session routing uses numeric IDs\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge \u2014 it fixes a real production bug with a targeted, well-tested change\n- The fix correctly addresses the root cause identified in #17242. The approach leverages the existing `buildTelegramThreadParams()` guard rather than duplicating logic. All three affected send functions are updated consistently. Tests cover the new behavior. The only minor concern is the @-username edge case for public forum groups, which is unlikely to occur in practice but is worth noting.\n- No files require special attention \u2014 `src/telegram/send.ts` has a minor edge case with @-usernames documented in the inline comment\n\n<sub>Last reviewed commit: 7154157</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "widingmarcus-cyber",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T19:05:14Z",
          "updatedAt": "2026-02-15T19:54:13Z",
          "headRef": "fix/telegram-thread-id-private-chats-17242",
          "baseRef": "main",
          "filesChanged": 5,
          "additions": 125,
          "deletions": 17,
          "commits": 2,
          "labels": [
            "channel: telegram",
            "channel: whatsapp-web",
            "size: S"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            17242
          ],
          "changedFiles": [
            "openclaw-2026-02-15.log",
            "src/telegram/send.poll.test.ts",
            "src/telegram/send.returns-undefined-empty-input.test.ts",
            "src/telegram/send.ts",
            "src/web/media.test.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17433.diff",
          "totalScore": 84,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "142 lines changed (125+/17-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "widingmarcus-cyber (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #17242"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "The PR addresses a critical bug causing silent message drops in Telegram private chats. The fix is well-explained, includes a new helper function to correctly infer the thread scope, and updates the tests to cover both group and private chat scenarios. The changes are isolated to the telegram module, minimizing the risk of introducing regressions elsewhere. The provided context is thorough and includes the number of failures observed. The tests passing and the addition of a new test for private chats increases confidence.",
          "duplicateGroup": 4
        },
        {
          "number": 17432,
          "title": "fix(telegram): skip message_thread_id for private chats in sticker/poll sends",
          "body": "## Summary\nPrivate chats (chatId > 0) don't support `message_thread_id`. This was fixed for `sendMessageTelegram` but not for `sendStickerTelegram` and `sendPollTelegram`, causing 'message thread not found' errors in DMs.\n\n## Changes\nNow all three functions check if chatId is positive (private chat) and use scope `'dm'` instead of `'forum'` so `buildTelegramThreadParams` returns undefined and skips the thread parameter.\n\nThis is a **proactive fix** that prevents the error entirely, rather than relying on the `sendWithThreadFallback` retry mechanism.\n\n## Test Plan\n- Updated existing tests to use negative chatIds (group chats) for testing thread fallback\n- Added new test `skips message_thread_id for private chats` in poll tests\n- All 65 telegram send tests pass\n\n## Related\nCompletes the fix from PR #17252 which only addressed `sendMessageTelegram`.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nExtends private chat thread handling from `sendMessageTelegram` to `sendStickerTelegram` and `sendPollTelegram`. All three functions now check if `chatId > 0` (private chat) and use `scope: 'dm'` to proactively skip `message_thread_id`, preventing \"message thread not found\" errors in DMs.\n\n- Consistent implementation across all three send functions\n- Prevents errors proactively rather than relying on retry fallback\n- Test coverage added for polls; existing thread fallback tests updated to use group chats (negative chatIds)\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with minimal risk - it's a focused bug fix with consistent implementation\n- The implementation correctly applies the same pattern across all three send functions, with clear logic that prevents errors proactively. Tests are comprehensive for polls and message sends, though sticker sends could benefit from an additional explicit private chat test. The fix is well-documented with comments and aligns with the existing `buildTelegramThreadParams` helper logic\n- No files require special attention\n\n<sub>Last reviewed commit: e4ed141</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "clawinho",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:02:40Z",
          "updatedAt": "2026-02-15T19:25:02Z",
          "headRef": "fix/telegram-private-chat-thread-id",
          "baseRef": "main",
          "filesChanged": 3,
          "additions": 65,
          "deletions": 7,
          "commits": 2,
          "labels": [
            "channel: telegram",
            "size: S"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/telegram/send.poll.test.ts",
            "src/telegram/send.returns-undefined-empty-input.test.ts",
            "src/telegram/send.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17432.diff",
          "totalScore": 80,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "72 lines changed (65+/7-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "clawinho (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "Comprehensive fix addressing a known issue across multiple functions. Includes proactive error prevention and thorough testing, including new tests for polls and updates to existing tests. The Greptile summary confirms the consistency and safety of the changes. Minor suggestion to add an explicit private chat test for sticker sends, but overall, a well-executed PR.",
          "duplicateGroup": 4
        },
        {
          "number": 17357,
          "title": "feat(telegram): implement telegram poll action,persistent answer routing, fixed some vulnerabilities ",
          "body": "# Openclaw Contribution\r\n\r\nThis file summarizes the changes made to the Openclaw project.\r\n\r\n## Vulnerability Fix\r\n\r\nA medium-severity vulnerability was identified in the `request` package. This package was a transitive dependency of the `matrix` extension. The `request` package is deprecated and has a known Server-Side Request Forgery (SSRF) vulnerability (GHSA-p8p7-x288-28g6).\r\n\r\nTo mitigate this vulnerability, the `request` package was replaced with the `got` package using a `pnpm` override in the root `package.json` file.\r\n\r\n### Verification\r\n\r\nThe following steps were taken to verify the fix:\r\n\r\n1.  **Tests:** The extension test suite was run to ensure that the change did not break any existing functionality. All tests passed.\r\n2.  **Audit:** `pnpm audit` was run after the change to confirm that the vulnerability was no longer present. The audit reported no vulnerabilities.\r\n\r\n\r\n\r\n## Telegram Poll Plugin Verification\r\n\r\nUse these steps to verify the Telegram poll plugin flow end-to-end.\r\n\r\n### 1. Configure Telegram and start gateway\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw config set channels.telegram.botToken \"<YOUR_BOT_TOKEN>\"\r\nopenclaw config set channels.telegram.enabled true\r\npnpm dev\r\n```\r\n\r\n### 2. Check channel health\r\n\r\nIn a second terminal:\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw channels status --probe\r\n```\r\n\r\nExpected: Telegram account is configured/enabled/connected.\r\n\r\n### 3. Send a basic poll from CLI\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat_id_or_telegram:chat_id>\" --poll-question \"Lunch?\" --poll-option \"Pizza\" --poll-option \"Sushi\"\r\n```\r\n\r\nExpected: poll appears in Telegram chat.\r\n\r\n### 4. Verify Telegram poll options\r\n\r\nSilent delivery:\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Silent test?\" --poll-option \"A\" --poll-option \"B\" --silent\r\n```\r\n\r\nDuration in seconds (valid range 5-600):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Duration?\" --poll-option \"A\" --poll-option \"B\" --poll-duration-seconds 60\r\n```\r\n\r\nAnonymous poll:\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Anon?\" --poll-option \"Yes\" --poll-option \"No\" --poll-anonymous\r\n```\r\n\r\nPublic poll (if exposed in your CLI surface):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Public?\" --poll-option \"Yes\" --poll-option \"No\" --poll-public\r\n```\r\n\r\n### 5. Vote in Telegram and confirm inbound handling\r\n\r\n1. Vote on the poll in Telegram.\r\n2. Confirm bot sends an acknowledgement message (\"Got it. You selected: ...\").\r\n3. Confirm poll-answer event is routed into OpenClaw session/system events.\r\n\r\n### 6. Check logs for handler errors\r\n\r\nLook at gateway logs and ensure there are no poll handler errors such as:\r\n\r\n`telegram poll answer handler failed`\r\n\r\n### 7. Negative validation checks\r\n\r\nOne option only (should fail):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Bad\" --poll-option \"OnlyOne\"\r\n```\r\n\r\nExpected: validation error requiring at least two options.\r\n\r\nOut-of-range duration (should fail):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Bad duration\" --poll-option \"A\" --poll-option \"B\" --poll-duration-seconds 601\r\n```\r\n\r\nExpected: validation error for duration range.\r\n\r\n### 8. Optional local test suite verification\r\n\r\n```powershell\r\ncd openclaw\r\npnpm -s vitest run src/telegram/send.poll.test.ts src/telegram/allowed-updates.test.ts src/telegram/poll-answer-cache.test.ts src/channels/plugins/actions/telegram.test.ts src/channels/plugins/outbound/telegram.test.ts\r\npnpm -s tsc -p tsconfig.json --noEmit\r\n```\r\n\r\n\r\nsuccessfully created one and one poll cast feature, for agent, where agent have access to what user casted!!\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds Telegram poll action support (send polls, receive poll answers, route answers back to agent sessions), changes the default stream mode from `\"partial\"` to `\"off\"`, changes the default poll anonymity from anonymous to public, and overrides the deprecated `request` package with `got` to fix an SSRF vulnerability.\n\n- **Poll action flow**: New `sendPoll` action wired through action adapter \u2192 telegram-actions \u2192 `sendPollTelegram`. Poll answers are received via a new `poll_answer` bot handler, cached in an in-memory store with TTL, and routed as system events to the originating session. Acknowledgement messages are sent back to the chat.\n- **`durationHours` conversion bug**: The `durationHours` \u2192 seconds conversion (`hours * 3600`) always produces values \u22653600, which always exceeds Telegram's 600-second `open_period` limit. This makes `durationHours` unusable with a confusing error message. The previous behavior had a clearer rejection.\n- **`request` \u2192 `got` override risk**: The pnpm override `\"request\": \"npm:got@^11.8.3\"` replaces a callback-based HTTP library with a promise-based one that has an incompatible API. `request-promise` (used by `@vector-im/matrix-bot-sdk`) wraps `request`'s callback interface and will likely fail at runtime. This needs verification or an alternative approach.\n- **Stream mode default change**: `resolveTelegramStreamMode` now defaults to `\"off\"` instead of `\"partial\"`, aligning with the repo guideline against streaming to external messaging surfaces. This is a behavioral change for users who haven't explicitly configured `streamMode`.\n- **Poll anonymity default**: Polls now default to `is_anonymous: false` (public votes) instead of Telegram's default of `true`. This is intentional per commit message but diverges from Telegram's API default.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR has two issues that need attention: the `request` \u2192 `got` override may break the matrix extension at runtime, and the `durationHours` conversion is logically broken.\n- Score of 2 reflects two concrete issues: (1) the `request` \u2192 `got` pnpm override replaces a callback-based API with an incompatible promise-based API, which will break `request-promise` used by the matrix bot SDK at runtime; (2) the `durationHours` conversion always produces out-of-range values for Telegram's 5-600s limit, making the parameter unusable with a misleading error. The core poll feature implementation is well-structured and follows existing patterns, but these two issues need resolution before merge.\n- `package.json` (request \u2192 got override compatibility), `src/telegram/send.ts` (durationHours conversion logic)\n\n<sub>Last reviewed commit: 5be3ccb</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "akyourowngames",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T17:43:56Z",
          "updatedAt": "2026-02-15T19:45:54Z",
          "headRef": "main",
          "baseRef": "main",
          "filesChanged": 20,
          "additions": 761,
          "deletions": 265,
          "commits": 11,
          "labels": [
            "channel: telegram",
            "scripts",
            "agents",
            "size: L"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "package.json",
            "pnpm-lock.yaml",
            "scripts/run-skill-scan.ts",
            "skills/poll-confirmation/SKILL.md",
            "src/agents/tools/message-tool.e2e.test.ts",
            "src/agents/tools/message-tool.ts",
            "src/agents/tools/telegram-actions.ts",
            "src/channels/plugins/actions/telegram.test.ts",
            "src/channels/plugins/actions/telegram.ts",
            "src/channels/plugins/outbound/telegram.test.ts",
            "src/channels/plugins/outbound/telegram.ts",
            "src/telegram/allowed-updates.test.ts",
            "src/telegram/allowed-updates.ts",
            "src/telegram/bot.ts",
            "src/telegram/bot/helpers.test.ts",
            "src/telegram/bot/helpers.ts",
            "src/telegram/poll-answer-cache.test.ts",
            "src/telegram/poll-answer-cache.ts",
            "src/telegram/send.poll.test.ts",
            "src/telegram/send.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17357.diff",
          "totalScore": 68,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "1026 lines changed (761+/265-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "akyourowngames (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "The PR addresses a medium-severity vulnerability and introduces a new feature (Telegram poll plugin). The vulnerability fix seems well-handled with verification steps. The new feature includes verification steps and tests. The risk is medium due to the introduction of new functionality and potential unforeseen issues with the Telegram integration, despite the provided tests and verification steps. The large number of files changed also contributes to the medium risk.",
          "duplicateGroup": 4
        },
        {
          "number": 17441,
          "title": "feat(telegram): add poll action support",
          "body": "## Summary\nWire up `sendPoll` action for Telegram provider using existing `sendPollTelegram` infrastructure.\n\n## Changes\n- Add `polls` to `TelegramActionConfig` type (`src/config/types.telegram.ts`)\n- Add poll action to telegram actions router - `listActions` + `handleAction` (`src/channels/plugins/actions/telegram.ts`)\n- Add `sendPoll` handler to `handleTelegramAction` (`src/agents/tools/telegram-actions.ts`)\n\n## Features\n- Question with 2-10 options (Telegram limit)\n- Multi-select support (`pollMulti`)\n- Duration/timeout\n- Anonymous mode\n- Forum topic threading\n- Silent sends\n\n## Usage\n```yaml\nchannels:\n  telegram:\n    actions:\n      polls: true  # Enable poll support\n```\n\nThen use via message tool:\n```\nmessage action:poll to:CHAT_ID pollQuestion:\"Which option?\" pollOption:[\"A\",\"B\",\"C\"]\n```\n\n## Testing\nVerified TypeScript compiles without poll-related errors (other errors are missing dependencies in dev environment).\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nWires up `sendPoll` action for the Telegram channel by adding a `polls` gate to `TelegramActionConfig`, registering the \"poll\" action in the actions router, and adding a `sendPoll` handler in `handleTelegramAction` that delegates to the existing `sendPollTelegram` infrastructure.\n\n- Adds `polls?: boolean` to `TelegramActionConfig` type\n- Registers \"poll\" in `listActions` with a `gate(\"polls\")` check (enabled by default, consistent with Discord)\n- Implements poll parameter parsing in the router: question, options, multi-select, duration, threading, silent, anonymous\n- Normalizes poll input via shared `normalizePollInput` (validates 2-10 options for Telegram)\n- Adds `sendPoll` handler in `telegram-actions.ts` that resolves token, validates the action gate, and delegates to `sendPollTelegram`\n- No tests were added for the new poll action handler or router branch; existing tests in `send.poll.test.ts` cover only the lower-level `sendPollTelegram` function\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge \u2014 it follows established patterns and delegates to well-tested existing infrastructure.\n- Score of 4 reflects that the code is well-structured, follows existing action patterns (sendMessage, sendSticker), and reuses the shared `normalizePollInput` and `sendPollTelegram` infrastructure. The only concern is the lack of test coverage for the new router and handler code paths. No logical bugs or security issues were found.\n- No files require special attention \u2014 all changes follow established patterns. `src/channels/plugins/actions/telegram.ts` has a minor style inconsistency (reading `threadId` as string vs number) but it's functionally correct.\n\n<sub>Last reviewed commit: a6f2d24</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "iacosta3994",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:21:31Z",
          "updatedAt": "2026-02-15T19:25:28Z",
          "headRef": "feature/telegram-poll-support",
          "baseRef": "main",
          "filesChanged": 3,
          "additions": 82,
          "deletions": 0,
          "commits": 1,
          "labels": [
            "agents",
            "size: S"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/agents/tools/telegram-actions.ts",
            "src/channels/plugins/actions/telegram.ts",
            "src/config/types.telegram.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17441.diff",
          "totalScore": 64,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "82 lines changed (82+/0-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "iacosta3994 (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 75,
          "llmRisk": "medium",
          "llmReason": "The PR adds a new feature (Telegram poll support) with good documentation and usage examples. The code changes seem well-structured and leverage existing infrastructure. However, the lack of specific tests for the new action handler and router branch is a concern. While existing tests cover the underlying `sendPollTelegram` function, integration tests are needed to ensure the entire flow works correctly. The risk is medium because the core functionality is likely working, but edge cases or integration issues might exist due to the missing tests.",
          "duplicateGroup": 4
        }
      ],
      "bestPR": 17435,
      "similarity": 0.8406862873031851,
      "reason": "5 similar PRs (avg similarity: 84.1%)"
    },
    {
      "id": 5,
      "prs": [
        {
          "number": 16562,
          "title": "fix(signal): preserve case for group and username targets",
          "body": "## Summary\r\n\r\n  - Problem: Signal target normalization lowercased group: and username: target values.\r\n  - Why it matters: Case-sensitive identifiers can be mutated, causing misrouting or failed target resolution. In particular, it failed doing emoji reactions on group messages.\r\n  - What changed: normalizeSignalMessagingTarget now preserves value casing for group: and username: while still\r\n    recognizing prefixes.\r\n  - What did NOT change (scope boundary): UUID normalization paths and other channel normalizers remain unchanged.\r\n\r\n  ## Change Type (select all)\r\n\r\n  - [x] Bug fix\r\n  - [ ] Feature\r\n  - [ ] Refactor\r\n  - [ ] Docs\r\n  - [ ] Security hardening\r\n  - [ ] Chore/infra\r\n\r\n  ## Scope (select all touched areas)\r\n\r\n  - [ ] Gateway / orchestration\r\n  - [ ] Skills / tool execution\r\n  - [ ] Auth / tokens\r\n  - [ ] Memory / storage\r\n  - [x] Integrations\r\n  - [ ] API / contracts\r\n  - [ ] UI / DX\r\n  - [ ] CI/CD / infra\r\n\r\n  ## Linked Issue/PR\r\n\r\n  - Closes #\r\n  - Related #\r\n  - If #12793 covers this exact normalization path, I\u2019m happy to close this as duplicate.\r\n\r\n  ## User-visible / Behavior Changes\r\n\r\n  Signal group: and username: target values keep original case after normalization.\r\n  Previously they were lowercased.\r\n\r\n  ## Security Impact (required)\r\n\r\n  - New permissions/capabilities? (No)\r\n  - Secrets/tokens handling changed? (No)\r\n  - New/changed network calls? (No)\r\n  - Command/tool execution surface changed? (No)\r\n  - Data access scope changed? (No)\r\n  - If any Yes, explain risk + mitigation:\r\n\r\n  ## Repro + Verification\r\n\r\n  ### Environment\r\n\r\n  - OS: macOS\r\n  - Runtime/container: local dev runtime\r\n  - Model/provider: N/A\r\n  - Integration/channel (if any): Signal\r\n  - Relevant config (redacted): Signal target values using group: and username: prefixes\r\n\r\n  ### Steps\r\n\r\n  1. Call normalizeSignalMessagingTarget(\"group:AbC123-CaseSensitive\").\r\n  2. Call normalizeSignalMessagingTarget(\"username:MyMixedCaseUser\").\r\n  3. Compare normalized outputs.\r\n\r\n  ### Expected\r\n\r\n  - group:AbC123-CaseSensitive\r\n  - username:MyMixedCaseUser\r\n\r\n  ### Actual\r\n\r\n  - Before fix: values were lowercased.\r\n  - After fix: original case is preserved.\r\n\r\n  ## Evidence\r\n\r\n  Attach at least one:\r\n\r\n  - [x] Failing test/log before + passing after\r\n  - [ ] Trace/log snippets\r\n  - [ ] Screenshot/recording\r\n  - [ ] Perf numbers (if relevant)\r\n\r\n  ## Human Verification (required)\r\n\r\n  - Verified scenarios:\r\n      - Added tests in src/channels/plugins/normalize/signal.test.ts for case preservation.\r\n      - Ran pnpm test -- src/channels/plugins/normalize/signal.test.ts (passing).\r\n  - Edge cases checked:\r\n      - Existing UUID normalization tests still pass.\r\n  - What you did not verify:\r\n      - Full end-to-end Signal daemon flow in production-like environment.\r\n\r\n  ## Compatibility / Migration\r\n\r\n  - Backward compatible? (Yes)\r\n  - Config/env changes? (No)\r\n  - Migration needed? (No)\r\n  - If yes, exact upgrade steps:\r\n\r\n  ## Failure Recovery (if this breaks)\r\n\r\n  - How to disable/revert this change quickly: Revert commit fix(signal): preserve case for group and username targets.\r\n  - Files/config to restore: src/channels/plugins/normalize/signal.ts, src/channels/plugins/normalize/signal.test.ts\r\n  - Known bad symptoms reviewers should watch for:\r\n      - Unexpected lowercasing reappearing for group: or username: targets.\r\n\r\n  ## Risks and Mitigations\r\n\r\n  - Risk: Downstream logic may have implicitly relied on lowercased group:/username: values.\r\n      - Mitigation: Change is narrowly scoped; UUID normalization behavior unchanged; regression tests added.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR fixes a bug where `normalizeSignalMessagingTarget` was lowercasing `group:` and `username:` target values, which broke case-sensitive identifiers (e.g., emoji reactions on group messages). The fix correctly removes `.toLowerCase()` from the `group:` and `username:` normalization paths while keeping UUID normalization unchanged.\n\n- Preserves original casing for `group:` and `username:` prefixed Signal targets\n- Adds two regression tests for case preservation\n- **Issue**: The `u:` shorthand prefix (a shorthand for `username:`) still applies `.toLowerCase()`, creating an inconsistency where `u:MyUser` normalizes to `username:myuser` while `username:MyUser` normalizes to `username:MyUser`. Since downstream routing uses strict equality (`===`) on peer IDs, these would not match each other.\n\n<h3>Confidence Score: 3/5</h3>\n\n- The core fix is correct but the `u:` shorthand path has been left inconsistent, which could cause misrouted messages when the shorthand is used.\n- The `group:` and `username:` fixes are sound and well-tested. However, the `u:` shorthand\u2014which is an alias for `username:`\u2014still lowercases, creating a behavioral inconsistency. This is a functional issue since downstream routing uses strict equality on normalized IDs.\n- `src/channels/plugins/normalize/signal.ts` \u2014 the `u:` prefix handler at lines 22-25 needs the same case-preservation treatment as the `username:` handler.\n\n<sub>Last reviewed commit: 138954e</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "akalypse",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-14T21:38:36Z",
          "updatedAt": "2026-02-15T19:46:24Z",
          "headRef": "fix/signal-target-normalization-case",
          "baseRef": "main",
          "filesChanged": 2,
          "additions": 25,
          "deletions": 3,
          "commits": 2,
          "labels": [
            "size: XS"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/channels/plugins/normalize/signal.test.ts",
            "src/channels/plugins/normalize/signal.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/16562.diff",
          "totalScore": 75,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 70,
              "weight": 0.1,
              "reason": "28 lines changed (25+/3-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "akalypse (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 90,
          "llmRisk": "low",
          "llmReason": "The PR addresses a clear bug with a focused fix. The description is well-written, explaining the problem, solution, and scope. The change type and scope are clearly marked. Security impact is considered and deemed negligible. Repro steps are provided. The only minor deduction is due to the lack of a linked issue (though it mentions a potential duplicate). The test file indicates good test coverage.",
          "duplicateGroup": 5
        },
        {
          "number": 17453,
          "title": "fix(signal): make group reactions deterministic from inbound sender metadata",
          "body": "## Summary\r\n\r\n  Describe the problem and fix in 2\u20135 bullets:\r\n\r\n  - Problem: Signal group reactions were unreliable because targetAuthor/targetAuthorUuid was often missing or model-\r\n    guessed, causing reactions to fail or be accepted without visible UI effect.\r\n  - Why it matters: Group reaction behavior must deterministically target the exact inbound message author; otherwise\r\n    reactions are flaky in real group chats.\r\n  - What changed: Added an inbound reaction-target cache (groupId + messageId -> sender uuid/e164), populated it in\r\n    Signal inbound handling, and used it in outbound react action prep when targetAuthor* is not provided. Also\r\n    tightened reaction payload shaping to prefer UUID and set recipients for group reactions/removals.\r\n  - What did NOT change (scope boundary): No changes to non-Signal channels, no new external services, no schema/API\r\n    contract changes, and no config migration.\r\n\r\n  ## Change Type (select all)\r\n\r\n  - [x] Bug fix\r\n  - [ ] Feature\r\n  - [ ] Refactor\r\n  - [ ] Docs\r\n  - [ ] Security hardening\r\n  - [ ] Chore/infra\r\n\r\n  ## Scope (select all touched areas)\r\n\r\n  - [x] Gateway / orchestration\r\n  - [ ] Skills / tool execution\r\n  - [ ] Auth / tokens\r\n  - [x] Memory / storage\r\n  - [x] Integrations\r\n  - [ ] API / contracts\r\n  - [ ] UI / DX\r\n  - [ ] CI/CD / infra\r\n\r\n  ## Linked Issue/PR\r\n\r\n  - Closes #\r\n  - Related #\r\n\r\n  ## User-visible / Behavior Changes\r\n\r\n  - Signal group \u201creact to this message\u201d is now more reliable when messageId is known but targetAuthor* is omitted.\r\n  - For group reactions/removals, UUID targeting is preferred and recipient shaping is more consistent.\r\n  - No new user-facing config required.\r\n\r\n  ## Security Impact (required)\r\n\r\n  - New permissions/capabilities? (No)\r\n  - Secrets/tokens handling changed? (No)\r\n  - New/changed network calls? (No)\r\n  - Command/tool execution surface changed? (No)\r\n  - Data access scope changed? (Yes)\r\n  - If any Yes, explain risk + mitigation:\r\n      - Added a small in-memory cache of inbound group reaction metadata (sender identifier keyed by group/message) with\r\n        TTL and size cap.\r\n      - Mitigations: bounded cache (MAX_ENTRIES), expiration (TTL_MS), no persistence to disk, no secret material.\r\n\r\n  ## Repro + Verification\r\n\r\n  ### Environment\r\n\r\n  - OS: macOS\r\n  - Runtime/container: Docker Compose (openclaw-gateway + signal-cli-daemon)\r\n  - Model/provider: OpenAI Codex (gpt-5.3-codex)\r\n  - Integration/channel (if any): Signal group + direct chat\r\n  - Relevant config (redacted): channels.signal.reactionLevel=minimal, actions.reactions=true\r\n\r\n  ### Steps\r\n\r\n  1. Receive a Signal group inbound message and ask agent to react to that message.\r\n  2. Trigger message.react without explicitly forcing targetAuthorUuid.\r\n  3. Observe gateway logs and Signal UI behavior.\r\n\r\n  ### Expected\r\n\r\n  - Group reaction resolves to exact inbound sender and appears in Signal UI.\r\n\r\n  ### Actual\r\n\r\n  - Before fix: reactions frequently failed (targetAuthor required) or reported success but were not visible.\r\n  - After fix: deterministic sender targeting is applied via inbound cache; reactions are consistently resolved.\r\n\r\n  ## Evidence\r\n\r\n  Attach at least one:\r\n\r\n  - [x] Failing test/log before + passing after\r\n  - [x] Trace/log snippets\r\n  - [ ] Screenshot/recording\r\n  - [ ] Perf numbers (if relevant)\r\n\r\n  ## Human Verification (required)\r\n\r\n  What you personally verified (not just CI), and how:\r\n\r\n  - Verified scenarios:\r\n      - Group reaction target hydration from inbound metadata cache.\r\n      - UUID-preferred target selection.\r\n      - Group removal payload shaping using resolved target.\r\n  - Edge cases checked:\r\n      - Missing targetAuthor* with valid groupId + messageId.\r\n      - UUID vs E.164 fallback behavior.\r\n  - What you did not verify:\r\n      - Full matrix across all Signal daemon versions and multi-device clients.\r\n\r\n  ## Compatibility / Migration\r\n\r\n  - Backward compatible? (Yes)\r\n  - Config/env changes? (No)\r\n  - Migration needed? (No)\r\n  - If yes, exact upgrade steps:\r\n\r\n  ## Failure Recovery (if this breaks)\r\n\r\n  - How to disable/revert this change quickly:\r\n      - Revert commit cda8b78bbd8d76001d2331596038babb3cb82763.\r\n  - Files/config to restore:\r\n      - src/infra/outbound/message-action-runner.ts\r\n      - src/signal/monitor/event-handler.ts\r\n      - src/signal/send-reactions.ts\r\n      - remove src/signal/reaction-target-cache.ts\r\n  - Known bad symptoms reviewers should watch for:\r\n      - Group react regression to targetAuthor is required errors.\r\n      - Group reactions accepted but not visible in Signal UI.\r\n\r\n  ## Risks and Mitigations\r\n\r\n  - Risk:\r\n      - Stale cache entry could map message->author incorrectly if identifiers collide.\r\n      - Mitigation:\r\n          - Keyed by exact groupId + messageId, bounded size, TTL expiry, and no cross-group reuse.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdds deterministic Signal group reaction targeting by caching inbound sender metadata (UUID/E.164) keyed by `groupId + messageId`. When reacting without explicit `targetAuthor*`, the system now hydrates from cache instead of failing or guessing.\n\nKey changes:\n- New `reaction-target-cache.ts` with bounded in-memory cache (5000 entries, 24h TTL)\n- `event-handler.ts` records sender metadata on group message receipt\n- `message-action-runner.ts` hydrates `targetAuthorUuid`/`targetAuthor` from cache when missing\n- `send-reactions.ts` prefers UUID over E.164 and shapes recipients array for group reactions/removals\n- Tests cover cache behavior, UUID preference, and target hydration\n\n<h3>Confidence Score: 4/5</h3>\n\n- Safe to merge with one minor overflow calculation bug in cache pruning\n- The implementation is sound with proper bounds, TTL, and test coverage. UUID preference ordering is correct, cache hydration logic works as intended, and the change is backward compatible. One bug in pruning overflow calculation uses sorted array length instead of current map size after expired entries are deleted, but this has minimal impact (slight over-pruning at most)\n- Pay attention to `src/signal/reaction-target-cache.ts` line 74 overflow calculation\n\n<sub>Last reviewed commit: cda8b78</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
          "author": "akalypse",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:36:47Z",
          "updatedAt": "2026-02-15T19:39:39Z",
          "headRef": "fix/signal-group-reaction-deterministic",
          "baseRef": "main",
          "filesChanged": 7,
          "additions": 336,
          "deletions": 6,
          "commits": 1,
          "labels": [
            "channel: signal",
            "size: M"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/infra/outbound/message-action-runner.threading.test.ts",
            "src/infra/outbound/message-action-runner.ts",
            "src/signal/monitor/event-handler.ts",
            "src/signal/reaction-target-cache.test.ts",
            "src/signal/reaction-target-cache.ts",
            "src/signal/send-reactions.test.ts",
            "src/signal/send-reactions.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17453.diff",
          "totalScore": 74,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "342 lines changed (336+/6-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "akalypse (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "The PR addresses a significant bug in Signal group reactions, improving reliability and user experience. The description is clear and well-structured, outlining the problem, solution, and scope. The inclusion of tests and a reaction-target cache demonstrates good engineering practices. The 'Data access scope changed' flag, even with the explanation of a small in-memory cache, introduces a moderate risk that needs careful review. The risk is medium because the cache is in-memory and the scope is limited, but potential memory usage and concurrency issues need to be considered.",
          "duplicateGroup": 5
        }
      ],
      "bestPR": 16562,
      "similarity": 0.8420455099397139,
      "reason": "2 similar PRs (avg similarity: 84.2%)"
    },
    {
      "id": 6,
      "prs": [
        {
          "number": 16677,
          "title": "feat(routing): intelligent model routing via pre-route hook ",
          "body": "AI Assistance used in this PR. Human testing performed on both local and cloud routing endpoints.  \r\n\r\n## Summary\r\n\r\n  - **Problem:** Users pay premium model prices for simple messages (\"hey\", \"ok\", \"read that file\") because there's no automatic complexity-based routing. Manual `/model` switching is tedious and error-prone.\r\n  - **Why it matters:** Simple messages can be 90%+ of volume in some workflows. Routing them to cheap/fast models saves significant cost without degrading quality on complex tasks.\r\n  - **What changed:** Added a pre-route hook that classifies each message with a lightweight LLM (~300 tokens) and routes to a configured model tier before the agent runs. Supports local Ollama and any OpenAI-compatible API. UI shows routed model as a badge. Classification prompt is user-editable at `~/.openclaw/router/ROUTER.md`.\r\n  - **What did NOT change (scope boundary):** No changes to the agent execution pipeline itself, model provider resolution, auth system, or any existing routing logic. The router is a pure pre-hook that optionally overrides the model ref before the agent starts. Disabled by default.\r\n\r\n  ## Change Type (select all)\r\n\r\n  - [ ] Bug fix\r\n  - [x] Feature\r\n  - [ ] Refactor\r\n  - [x] Docs\r\n  - [ ] Security hardening\r\n  - [ ] Chore/infra\r\n\r\n  ## Scope (select all touched areas)\r\n\r\n  - [x] Gateway / orchestration\r\n  - [ ] Skills / tool execution\r\n  - [ ] Auth / tokens\r\n  - [ ] Memory / storage\r\n  - [ ] Integrations\r\n  - [x] API / contracts\r\n  - [x] UI / DX\r\n  - [ ] CI/CD / infra\r\n\r\n  ## Linked Issue/PR\r\n\r\n  - Closes #9402\r\n  - Related #4658, #10969, #15033\r\n\r\n  ## User-visible / Behavior Changes\r\n\r\n  - New `router` config section (disabled by default \u2014 no behavior change unless explicitly enabled)\r\n  - When enabled, messages are classified and routed to tier-mapped models automatically\r\n  - Routed model shown as a badge in webchat UI (e.g. `\ud83d\udd00 anthropic/claude-haiku-4.5`)\r\n  - `/status` command shows router configuration when enabled\r\n  - New external file `~/.openclaw/router/ROUTER.md` created on first use for classification prompt tuning\r\n  - `router.apiKey` is redacted in config logs/exports via `.register(sensitive)`\r\n\r\n  ## Security Impact (required)\r\n\r\n  - New permissions/capabilities? `No`\r\n  - Secrets/tokens handling changed? `Yes`\r\n  - New/changed network calls? `Yes`\r\n  - Command/tool execution surface changed? `No`\r\n  - Data access scope changed? `No`\r\n  - If any `Yes`, explain risk + mitigation:\r\n    - **router.apiKey**: New optional secret for the classifier API. Marked `.register(sensitive)` in Zod schema so it's redacted in\r\n   config dumps. Supports `env:VAR_NAME` syntax to avoid plaintext in config files.\r\n    - **Network calls**: Router makes HTTP POST to either local Ollama (`http://localhost:11434`) or a configured OpenAI-compatible endpoint. Only the user's message text + classification prompt are sent (~300 tokens). No session data, auth tokens, or PII beyond the message content. Calls are bounded by `timeoutMs` (default 10s).\r\n\r\n  ## Repro + Verification\r\n\r\n  ### Environment\r\n\r\n  - OS: Linux (Jetson / ARM64) + macOS (dev)\r\n  - Runtime/container: Docker (openclaw-gateway)\r\n  - Model/provider: Ollama (qwen3:4b) + OpenRouter (qwen/qwen3-4b)\r\n  - Integration/channel: Webchat\r\n  - Relevant config (redacted):\r\n  ```json\r\n  {\r\n    \"router\": {\r\n      \"enabled\": true,\r\n      \"provider\": \"openai-compatible\",\r\n      \"baseUrl\": \"https://openrouter.ai/api/v1\",\r\n      \"apiKey\": \"env:OPENROUTER_API_KEY\",\r\n      \"model\": \"qwen/qwen3-4b\",\r\n      \"tiers\": {\r\n        \"1\": \"openrouter/minimax/minimax-m2.1\",\r\n        \"2\": \"openrouter/anthropic/claude-haiku-4.5\",\r\n        \"3\": \"openrouter/anthropic/claude-opus-4.6\"\r\n      },\r\n      \"defaultTier\": \"1\"\r\n    }\r\n  }\r\n```\r\n  Steps\r\n\r\n  1. Enable router in config with tiers mapped to models\r\n  2. Send messages of varying complexity: \"hey\", \"fix this TypeError\", \"design a microservices architecture\"\r\n  3. Observe routed model badge in webchat and gateway logs\r\n\r\n  Expected\r\n\r\n  - \"hey\" \u2192 tier 1 (cheap model), badge shows tier 1 model\r\n  - \"fix this TypeError\" \u2192 tier 2 (code model)\r\n  - \"design a microservices architecture\" \u2192 tier 3 (premium model)\r\n  - Fallback to defaultTier on classifier error\r\n\r\n  Actual\r\n\r\n  - All tiers route correctly with ~200-700ms classifier latency\r\n  - Badge renders and persists on completed messages\r\n  - Fallback works on timeout/malformed response\r\n\r\n  Evidence\r\n\r\n  - Failing test/log before + passing after\r\n  - Trace/log snippets\r\n  - Screenshot/recording\r\n  - Perf numbers (if relevant)\r\n\r\n  Unit tests in src/hooks/pre-route.test.ts cover: config resolution, tier parsing (1/2/3), fallback on error/timeout, model ref\r\n  parsing, Ollama + OpenAI-compatible payloads, conversation context injection.\r\n\r\n  Human Verification (required)\r\n\r\n  - Verified scenarios: Tier 1/2/3 classification with live Ollama and OpenRouter endpoints; fallback on Ollama timeout; badge\r\n  rendering in webchat; badge persistence on completed messages; /status output; ROUTER.md hot-reload; heartbeat/session-reset bypass\r\n  - Edge cases checked: Classifier returns unexpected text (falls back); classifier returns tier not in config (falls back);\r\n  ROUTER.md missing (uses built-in default); apiKey with env: prefix resolves from environment\r\n  - What you did not verify: Concurrent routing under high load; interaction with agent-level model overrides; non-webchat channels (Telegram, WhatsApp, etc.)\r\n\r\n  Compatibility / Migration\r\n\r\n  - Backward compatible? Yes \u2014 router is disabled by default, no behavior change without opt-in\r\n  - Config/env changes? Yes \u2014 new optional router section in config\r\n  - Migration needed? No\r\n\r\n  Failure Recovery (if this breaks)\r\n\r\n  - How to disable/revert this change quickly: Set \"router\": { \"enabled\": false } in config, or remove the router section entirely.  No restart needed for ROUTER.md changes; config change requires restart.\r\n  - Files/config to restore: Only the router config key. No database or state changes.\r\n  - Known bad symptoms reviewers should watch for: Elevated latency on every message (~200-700ms from classifier call); classifier endpoint returning errors flooding logs (mitigated: errors are caught and fall back silently)\r\n\r\n  Risks and Mitigations\r\n\r\n  - Risk: Classifier adds latency to every message when enabled\r\n    - Mitigation: Bounded by timeoutMs (default 10s, recommend 3-5s). Falls back to defaultTier on timeout. Latency is amortized into agent startup.\r\n  - Risk: User message content sent to classifier endpoint (privacy)\r\n    - Mitigation: Only the message text is sent, no metadata/auth. Local Ollama mode keeps data on-device. Documented so users can make informed choices.\r\n  - Risk: Router model naming inconsistency (bare API names vs OpenClaw refs)\r\n    - Mitigation: Documented as known limitation. Future work to support standard model refs with auto-credential resolution.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nAdds intelligent model routing via pre-route classification hook. A lightweight LLM classifies each message into tiers (casual/code/complex) before the main agent runs, routing to cost-appropriate models. Supports local Ollama and OpenAI-compatible APIs. UI displays routed model as a badge in webchat.\n\n## Key Changes\n\n- **Core routing logic** (`src/hooks/pre-route.ts`): Classifies messages via small LLM (~300 tokens), maps tier labels to model refs, handles timeouts/errors with graceful fallback\n- **Configuration** (`src/config/zod-schema.ts`, `types.openclaw.ts`): New `router` config section with provider/model/tiers/defaultTier fields; `apiKey` marked sensitive\n- **Integration** (`agent-runner-execution.ts`): Pre-route hook runs before agent execution, overrides provider/model, skips heartbeats and system resets\n- **UI** (webchat files): Badge shows routed model (e.g. \ud83d\udd00 `anthropic/claude-haiku-4.5`) on assistant messages, persists on completed messages\n- **Status command** (`commands-status.ts`, `status.ts`): Shows router config in `/status` output\n- **Documentation**: Configuration reference, examples, and field help added\n\n## Issues Found\n\n- **Critical**: `baseUrl` check doesn't prevent undefined from reaching API call (src/hooks/pre-route.ts:284)\n- **Critical**: Zod schema requires `tiers`/`defaultTier` even when `enabled: false`, breaking valid configs (src/config/zod-schema.ts:641)\n\n## Recommendations\n\n- Verify context window math: multiple long messages could exceed 1024 token budget despite per-message 200 char limit\n- Consider extracting more than 1 message for conversation context (currently `.slice(-1)`)\n- Replace hardcoded system prompt detection with robust signal\n- Test `think: false` parameter compatibility across Ollama versions\n\n<h3>Confidence Score: 3/5</h3>\n\n- This PR has two critical logic bugs that will cause runtime errors in production\n- Score reflects well-architected feature with comprehensive tests and docs, but two blocking bugs need fixes: (1) undefined baseUrl will crash openai-compatible provider calls, (2) strict schema validation rejects valid disabled configs. Once fixed, implementation is solid.\n- Critical fixes needed in src/hooks/pre-route.ts (line 284) and src/config/zod-schema.ts (line 641-642). All other files look good.\n\n<sub>Last reviewed commit: a3e6074</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
          "author": "gonesurfing",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T00:44:09Z",
          "updatedAt": "2026-02-15T19:40:56Z",
          "headRef": "pre-route-selector",
          "baseRef": "main",
          "filesChanged": 22,
          "additions": 976,
          "deletions": 41,
          "commits": 18,
          "labels": [
            "docs",
            "app: web-ui",
            "gateway",
            "size: L"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            9402
          ],
          "changedFiles": [
            "docs/gateway/configuration-examples.md",
            "docs/gateway/configuration-reference.md",
            "src/auto-reply/reply/agent-runner-execution.ts",
            "src/auto-reply/reply/commands-status.ts",
            "src/auto-reply/status.ts",
            "src/config/schema.help.ts",
            "src/config/types.openclaw.ts",
            "src/config/zod-schema.ts",
            "src/gateway/server-chat.ts",
            "src/hooks/pre-route.test.ts",
            "src/hooks/pre-route.ts",
            "src/infra/agent-events.ts",
            "ui/src/ui/app-gateway.ts",
            "ui/src/ui/app-render.helpers.ts",
            "ui/src/ui/app-render.ts",
            "ui/src/ui/app-view-state.ts",
            "ui/src/ui/app.ts",
            "ui/src/ui/chat/grouped-render.ts",
            "ui/src/ui/controllers/chat.test.ts",
            "ui/src/ui/controllers/chat.ts",
            "ui/src/ui/views/chat.test.ts",
            "ui/src/ui/views/chat.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/16677.diff",
          "totalScore": 73,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "1017 lines changed (976+/41-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "gonesurfing (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #9402"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "This PR introduces a significant feature (intelligent model routing) that could substantially improve cost efficiency. The description is thorough, outlining the problem, solution, scope, and changes. The inclusion of user-editable prompt and UI feedback is excellent. The risk is medium because it touches several areas (gateway, API, UI) and relies on a new pre-route hook, which could introduce unforeseen issues. While human testing was performed, thorough integration and performance testing are crucial. The AI assistance used also adds a layer of risk that needs to be considered.",
          "duplicateGroup": 6
        },
        {
          "number": 17392,
          "title": "Add testing infrastructure and expand gateway OAuth scopes",
          "body": "## Summary\n\nThis PR includes two major feature additions:\n1. **Intelligent Model Routing** - Cost-optimized provider selection (NEW \u2b50)\n2. Testing infrastructure and expanded gateway OAuth scopes\n\n---\n\n# \ud83c\udd95 Feature 1: Intelligent Model Routing for Cost Optimization\n\nImplements intelligent model/provider routing to automatically prefer local (vLLM, Ollama) and free-tier providers over expensive APIs, significantly reducing operational costs while maintaining capability requirements.\n\n## Key Benefits\n\n- **\ud83d\udcb0 Cost Reduction**: Automatically prefers zero-cost local providers (vLLM, Ollama) and free-tier APIs\n- **\ud83c\udfaf Smart Ranking**: 5-tier classification system (LOCAL \u2192 FREE_TIER \u2192 LOW_COST \u2192 MEDIUM_COST \u2192 HIGH_COST)\n- **\ud83d\udd12 Capability Assurance**: Validates reasoning, streaming, vision, and context window requirements\n- **\ud83d\udd04 Graceful Fallback**: Automatic failover to next-best provider on errors\n- **\u2699\ufe0f Opt-in**: Disabled by default, full backward compatibility\n- **\ud83d\udcca Observable**: Debug logging shows ranking decisions\n\n## Implementation\n\n### New Modules\n\n- **`src/agents/model-tiers.ts`**: Provider tier classification and cost calculation\n- **`src/agents/model-requirements.ts`**: Capability requirement validation\n- **`src/agents/model-scoring.ts`**: Scoring algorithm with tier/cost/capability weighting\n- **`src/agents/model-fallback.ts`**: Enhanced with intelligent ranking integration\n\n### Scoring Algorithm\n\n```\nscore = (4 - tier) \u00d7 1000          // Tier weight (4000 for LOCAL \u2192 0 for HIGH_COST)\n      - averageCost                // Cost penalty within tier\n      + (reasoning ? 50 : 0)       // Bonus for reasoning capability\n      + (local ? 100 : 0)          // Extra bonus for local providers\n```\n\n### Configuration Example\n\n```yaml\nmodels:\n  routing:\n    enabled: true              # Default: false (opt-in)\n    preferLocal: true          # Default: true\n    requireReasoning: false    # Default: false\n    requireStreaming: true     # Default: true\n\n  providers:\n    vllm:\n      baseUrl: \"http://127.0.0.1:8000/v1\"\n      models:\n        - id: \"deepseek-r1\"\n          reasoning: true\n          cost: { input: 0, output: 0 }\n    \n    anthropic:\n      baseUrl: \"https://api.anthropic.com/v1/messages\"\n      models:\n        - id: \"claude-opus-4-6\"\n          cost: { input: 150, output: 750 }\n```\n\n**Expected behavior**: vLLM tried first (LOCAL, score ~4000), falls back to Anthropic (MEDIUM_COST, score ~2000) on failure.\n\n## Testing Coverage\n\n\u2705 **48 new tests added** (all passing):\n- 15 unit tests for tier classification\n- 16 unit tests for requirement validation  \n- 10 unit tests for scoring algorithm\n- 7 integration tests for intelligent ranking\n\n\u2705 **Full regression coverage**: All existing tests pass, no new failures\n\n## Backward Compatibility\n\n- \u2705 **Opt-in**: `routing.enabled` defaults to `false`\n- \u2705 **Optional parameter**: New `requirements` parameter is optional\n- \u2705 **No breaking changes**: All existing code works unchanged\n- \u2705 **Respects overrides**: User model selection bypasses routing\n\n---\n\n# Feature 2: Testing Infrastructure and Gateway OAuth Scopes\n\n## Changes\n\n### 1. Playwright E2E Testing Infrastructure\n\n**Rationale:** OpenClaw's control UI had no automated end-to-end tests. Manual testing of UI interactions is time-consuming and error-prone.\n\n**Implementation:**\n- Added `playwright.config.ts` with automatic dev server management\n- Created initial test suite in `e2e/chat.spec.ts`\n- Added npm scripts: `test:e2e:playwright` and `test:e2e:playwright:ui`\n\n### 2. Expanded Gateway OAuth Scopes\n\n**Rationale:** The control UI was requesting only 3 scopes, causing \"missing scope: operator.read\" errors.\n\n**Implementation:** Added three missing scopes to `ui/src/ui/gateway.ts`:\n- `operator.read` - Read-only operations\n- `operator.write` - Write operations  \n- `operator.talk.secrets` - Access sensitive talk configuration\n\n### 3. Chat Send Debug Logging\n\nAdded `handleSend()` wrapper function that logs connection status, draft presence, and attachment count for debugging.\n\n### 4. Disable Treeshaking for Plugin SDK\n\nSet `treeshake: false` in `tsdown.config.ts` to ensure all documented exports are available to external plugins.\n\n## Migration Notes\n\n**For users with existing paired devices:**\n\n```bash\nopenclaw devices rotate --device <device-id> --role operator \\\n  --scope operator.admin \\\n  --scope operator.read \\\n  --scope operator.write \\\n  --scope operator.talk.secrets\n```\n\n---\n\n\ud83e\udd16 This PR includes comprehensive test coverage and maintains full backward compatibility for both features.",
          "author": "jordanhubbard",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T18:16:42Z",
          "updatedAt": "2026-02-15T19:17:25Z",
          "headRef": "feature/testing-and-scope-improvements",
          "baseRef": "main",
          "filesChanged": 18,
          "additions": 1416,
          "deletions": 9,
          "commits": 5,
          "labels": [
            "app: web-ui",
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "e2e/chat.spec.ts",
            "package.json",
            "playwright.config.ts",
            "pnpm-lock.yaml",
            "src/agents/model-fallback.intelligent-ranking.test.ts",
            "src/agents/model-fallback.ts",
            "src/agents/model-requirements.test.ts",
            "src/agents/model-requirements.ts",
            "src/agents/model-scoring.test.ts",
            "src/agents/model-scoring.ts",
            "src/agents/model-tiers.test.ts",
            "src/agents/model-tiers.ts",
            "src/auto-reply/reply/agent-runner-execution.ts",
            "src/config/types.models.ts",
            "src/config/zod-schema.core.ts",
            "tsdown.config.ts",
            "ui/src/ui/gateway.ts",
            "ui/src/ui/views/chat.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17392.diff",
          "totalScore": 65,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "1425 lines changed (1416+/9-)"
            },
            {
              "name": "commit_quality",
              "score": 50,
              "weight": 0.05,
              "reason": "Non-standard title"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "jordanhubbard (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 75,
          "llmRisk": "medium",
          "llmReason": "The PR introduces a significant new feature (Intelligent Model Routing) with detailed explanations and benefits. The scoring algorithm and configuration example are helpful. However, the lack of specific details on the testing infrastructure and OAuth scope changes, combined with the complexity of the new feature, introduces a medium risk. More comprehensive testing and security review are recommended.",
          "duplicateGroup": 6
        }
      ],
      "bestPR": 16677,
      "similarity": 0.8078009279605576,
      "reason": "2 similar PRs (avg similarity: 80.8%)"
    },
    {
      "id": 7,
      "prs": [
        {
          "number": 17429,
          "title": "feat: default Claude models to anthropic-messages API for Copilot",
          "body": "## Summary\n\n- **Problem:** Copilot Claude models were defaulting to `openai-responses` API, which translates thinking blocks through the OpenAI-compatible format and loses real Anthropic cryptographic signatures. This caused HTTP 400 errors (`Invalid signature in thinking block`) on multi-turn conversations.\n- **Why it matters:** This is the ROOT FIX for the thinking signature issue. Previous PRs in this chain added safety nets; this PR eliminates the problem at the source.\n- **What changed:** Claude models (`claude-*`) now default to `anthropic-messages` API instead of `openai-responses`. GitHub Copilot exposes both `/chat/completions` (OpenAI) and `/v1/messages` (Anthropic Messages API) at the same base URL. pi-ai already has native `github-copilot` support in its anthropic provider (Bearer auth, Copilot dynamic headers, interleaved-thinking beta).\n- **What did NOT change:** Non-Claude models (GPT, Gemini, O-series) continue using `openai-responses`. No changes to auth, endpoints, or provider config.\n\n## Change Type (select all)\n\n- [x] Feature\n\n## Scope (select all touched areas)\n\n- [x] Integrations\n\n## Linked Issue/PR\n\n- Depends on #17284, #17427, #17428\n- Related #12006 (jackheuberger's complementary approach)\n\n## User-visible / Behavior Changes\n\n- Claude models via Copilot now use the Anthropic Messages API, providing:\n  - Proper extended thinking with real cryptographic signatures\n  - No more HTTP 400 errors on multi-turn tool conversations\n  - Thinking blocks preserved correctly across turns\n- Non-Claude models are unchanged\n\n## Security Impact (required)\n\n- New permissions/capabilities? `No`\n- Secrets/tokens handling changed? `No`\n- New/changed network calls? `Yes` - Claude models now hit `/v1/messages` instead of `/chat/completions` at the same Copilot base URL. This matches what VS Code's Copilot Chat extension does.\n- Command/tool execution surface changed? `No`\n- Data access scope changed? `No`\n- Risk + mitigation: The `/v1/messages` endpoint is an existing Copilot API surface. VS Code already uses it for Claude models. pi-ai's anthropic provider handles the github-copilot auth flow (Bearer token, Copilot dynamic headers).\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+\n- Model/provider: github-copilot with Claude models (opus-4.6, opus-4.6-fast, sonnet-4, etc.)\n\n### Steps\n\n1. Configure openclaw with `github-copilot` provider and a Claude model\n2. Send a message that triggers reasoning/thinking\n3. Continue the conversation with tool calls\n\n### Expected\n\n- Thinking blocks have real cryptographic signatures\n- Multi-turn conversations work without HTTP 400 errors\n- Extended thinking is preserved across turns\n\n### Actual\n\n- Confirmed working in live gateway testing\n\n## Evidence\n\n- [x] Failing test/log before + passing after\n  - Updated `github-copilot-models.test.ts`: new tests for API type selection\n  - Updated `github-copilot-sdk.test.ts`: new test for Claude anthropic-messages\n  - All 34 provider tests passing\n\n## Human Verification (required)\n\n- Verified: Live gateway testing with Claude opus-4.6 via Copilot - multi-turn tool conversations work\n- Verified: VS Code Copilot Chat extension source confirms it uses `/v1/messages` for Claude\n- Edge cases: Non-Claude models still get openai-responses, unknown models get openai-responses\n- Not verified: Every Claude model variant individually\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes` - existing user config overrides still work\n- Config/env changes? `No` - this changes the code default; user config can still override\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: Override per-model with `\"api\": \"openai-responses\"` in user config\n- Known bad symptoms: If Copilot stops supporting `/v1/messages`, Claude models would fail to connect (unlikely - VS Code depends on this endpoint)\n\n## Risks and Mitigations\n\n- Risk: Copilot could change or remove the `/v1/messages` endpoint\n  - Mitigation: VS Code's Copilot Chat extension depends on this endpoint for all Claude interactions - it's a stable API surface\n\n---\n\n> **Stacked PR chain:** #17284 > #17427 > #17428 > **this PR**\n>\n> Review incremental changes: compare fix/copilot-thinking-signature...feat/copilot-anthropic-messages\n\n### Discovery Details\n\nInvestigation of VS Code's Copilot Chat extension (`github.copilot-chat`) revealed:\n\n1. **Dual API surface:** Copilot exposes both `/chat/completions` (OpenAI format) and `/v1/messages` (Anthropic Messages API) at the same base URL (`https://api.githubcopilot.com` or enterprise equivalent)\n\n2. **VS Code's approach:** For Claude models, VS Code uses `ChatMessages` request type which routes to `capiMessagesURL = ${_capiBaseUrl}/v1/messages`, getting proper `thinking_delta` + `signature_delta` SSE events with real cryptographic signatures\n\n3. **pi-ai support:** The anthropic provider in pi-ai already has a dedicated `github-copilot` code path that:\n   - Uses Bearer auth via `authToken` (not API key)\n   - Attaches Copilot dynamic headers\n   - Enables `interleaved-thinking` beta\n   - Handles `thinking_delta`/`signature_delta` events properly\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR routes Claude models through the native Anthropic Messages API (`/v1/messages`) instead of OpenAI-compatible `/chat/completions` when using the GitHub Copilot provider. This eliminates HTTP 400 errors caused by invalid thinking block signatures in multi-turn conversations \u2014 the root fix for the thinking signature issue.\n\nKey changes:\n- `buildCopilotModelDefinition` and `buildCopilotModelDefinitionFromSdk` now assign `anthropic-messages` API for `claude-*` models, while non-Claude models continue using `openai-responses`\n- New `@github/copilot-sdk` integration: SDK-based auth detection, model discovery, and a CLI agent backend (`copilot-cli`) with full session lifecycle management\n- Added `stripCompletionsReasoningFieldSignatures` to sanitize thinking blocks where pi-ai stored reasoning field names as signatures \u2014 a safety net for the OpenAI-to-Anthropic proxy path\n- SDK-managed auth flow added to login, provider detection, and token resolution paths\n- Comprehensive test coverage across all new modules (models, SDK wrapper, runner, transcript policy, reasoning block stripping)\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge after addressing the hardcoded magic string issue; the core API routing change is well-motivated and tested.\n- The primary feature \u2014 routing Claude models to `anthropic-messages` \u2014 is clean, well-reasoned, and backed by comprehensive tests. Two issues found: (1) a hardcoded `\"sdk-managed\"` string in `github-copilot-auth.ts` that should use the `SDK_MANAGED_TOKEN` constant to avoid a potential auth path mismatch, and (2) `maxTokens` (output limit) is mapped from the SDK's `max_prompt_tokens` (input limit) which is semantically incorrect. The first is a real correctness risk; the second could lead to unexpected output token limits. The rest of the changes (transcript policy, reasoning block stripping, CLI backend routing) are solid.\n- `src/providers/github-copilot-auth.ts` (hardcoded magic string instead of constant), `src/providers/github-copilot-sdk.ts` (maxTokens mapped from wrong SDK field)\n\n<sub>Last reviewed commit: 9fbc0c8</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "tag-assistant",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:00:47Z",
          "updatedAt": "2026-02-15T19:25:01Z",
          "headRef": "feat/copilot-anthropic-messages",
          "baseRef": "main",
          "filesChanged": 25,
          "additions": 2047,
          "deletions": 28,
          "commits": 8,
          "labels": [
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "package.json",
            "pnpm-lock.yaml",
            "src/agents/auth-profiles/constants.ts",
            "src/agents/cli-backends.ts",
            "src/agents/cli-runner.ts",
            "src/agents/copilot-runner.test.ts",
            "src/agents/copilot-runner.ts",
            "src/agents/copilot-sdk.test.ts",
            "src/agents/copilot-sdk.ts",
            "src/agents/model-selection.ts",
            "src/agents/models-config.providers.ts",
            "src/agents/pi-embedded-helpers.strip-completions-reasoning.test.ts",
            "src/agents/pi-embedded-helpers.ts",
            "src/agents/pi-embedded-helpers/openai.ts",
            "src/agents/pi-embedded-runner/compact.ts",
            "src/agents/pi-embedded-runner/google.ts",
            "src/agents/pi-embedded-runner/run.ts",
            "src/agents/transcript-policy.test.ts",
            "src/agents/transcript-policy.ts",
            "src/providers/github-copilot-auth.ts",
            "src/providers/github-copilot-models.test.ts",
            "src/providers/github-copilot-models.ts",
            "src/providers/github-copilot-sdk.test.ts",
            "src/providers/github-copilot-sdk.ts",
            "src/providers/github-copilot-token.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17429.diff",
          "totalScore": 70,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 30,
              "weight": 0.1,
              "reason": "2075 lines changed (2047+/28-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "tag-assistant (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "This PR addresses a critical bug causing HTTP 400 errors with Claude models in Copilot. The change involves switching the API endpoint for Claude models to the Anthropic Messages API, which resolves signature issues and improves multi-turn conversation handling. The PR includes comprehensive testing and considers security implications. The risk is medium due to the network call change and the dependency on other PRs. Thorough testing and monitoring after deployment are recommended.",
          "duplicateGroup": 7
        },
        {
          "number": 17427,
          "title": "feat: add Copilot SDK provider for auth and model discovery",
          "body": "## Summary\n\n- **Problem:** The CLI backend (#17284) uses the Copilot SDK for agent sessions, but the existing provider pipeline (REST-based) lacks SDK-powered auth verification and dynamic model discovery\n- **Why it matters:** Without SDK integration in the provider layer, model lists are hardcoded and auth status can't be verified programmatically\n- **What changed:** Added SDK-based auth checking and dynamic model discovery in the provider pipeline, alongside the CLI backend's agent runtime\n- **What did NOT change:** The CLI backend from #17284 is untouched; this stacks on top of it\n\n## Change Type (select all)\n\n- [x] Feature\n\n## Scope (select all touched areas)\n\n- [x] Auth / tokens\n- [x] Integrations\n\n## Linked Issue/PR\n\n- Depends on #17284 (CLI backend)\n- Related #4469\n\n## User-visible / Behavior Changes\n\n- Copilot model list is now dynamically discovered via SDK when available (falls back to hardcoded defaults)\n- Auth status can be checked programmatically\n\n## Security Impact (required)\n\n- New permissions/capabilities? `No`\n- Secrets/tokens handling changed? `No`\n- New/changed network calls? `No`\n- Command/tool execution surface changed? `No`\n- Data access scope changed? `No`\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+\n- Model/provider: github-copilot\n\n### Steps\n\n1. Install Copilot CLI and authenticate\n2. Configure openclaw to use github-copilot provider\n3. Models are discovered automatically via SDK\n\n### Expected\n\n- Dynamic model list from SDK, with proper capabilities\n\n### Actual\n\n- Works as expected in unit tests\n\n## Evidence\n\n- [x] Failing test/log before + passing after (23 new SDK tests, 11 model tests)\n\n## Human Verification (required)\n\n- Verified: All tests pass, type-check clean, lint/format clean\n- Edge cases: SDK unavailable, empty model list, disabled models filtered\n- Not verified: Live end-to-end with authenticated Copilot CLI\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes`\n- Config/env changes? `No`\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: SDK is lazy-loaded and optional; falls back to hardcoded defaults\n- Files to restore: Revert this commit\n\n## Risks and Mitigations\n\nNone\n\n---\n\n> **Stacked PR chain:** #17284 > **this PR** > thinking signature fix > anthropic-messages default\n>\n> Review incremental changes: compare feat/copilot-cli-backend...feat/copilot-sdk-provider\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds SDK-based authentication and dynamic model discovery for the GitHub Copilot provider, complementing the CLI backend added in #17284. The changes integrate `@github/copilot-sdk` into the provider pipeline for programmatic auth verification and model catalogue discovery, with graceful fallback to hardcoded defaults.\n\n**Key changes:**\n- Added `src/providers/github-copilot-sdk.ts` for SDK-based auth status checking and dynamic model discovery in the provider layer\n- Enhanced `src/providers/github-copilot-models.ts` with SDK-powered model discovery and proper capability detection (vision, reasoning)\n- Updated `src/providers/github-copilot-auth.ts` to detect SDK-managed auth before falling back to device flow\n- Added `SDK_MANAGED_TOKEN` marker for SDK-managed authentication paths\n- Extended model list from 7 to 25+ models with proper capabilities tracking\n- Provider detection now checks SDK availability when no explicit credentials exist\n- Comprehensive test coverage (23 SDK tests, 11 model tests) with proper mocking\n\n**Architecture:**\n- Provider SDK layer (`src/providers/github-copilot-sdk.ts`) handles auth/discovery for REST-based pipeline\n- CLI backend SDK layer (`src/agents/copilot-sdk.ts`) handles agent sessions via JSON-RPC stdio\n- Both layers share the same `@github/copilot-sdk` dependency but serve different purposes\n- Lazy SDK imports and graceful degradation ensure optional dependency doesn't break builds\n\n<h3>Confidence Score: 5/5</h3>\n\n- Safe to merge with no critical issues\n- The implementation is well-architected with proper separation of concerns between the provider and agent layers. Comprehensive test coverage (34 new tests) validates all code paths including error handling and edge cases. The changes are backward compatible with graceful fallbacks, lazy SDK loading prevents build failures, and the SDK is properly managed as an optional dependency. No security concerns, proper error handling throughout, and clean integration with existing auth/model systems.\n- No files require special attention\n\n<sub>Last reviewed commit: bcc5c9e</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "tag-assistant",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T18:59:54Z",
          "updatedAt": "2026-02-15T19:24:56Z",
          "headRef": "feat/copilot-sdk-provider",
          "baseRef": "main",
          "filesChanged": 19,
          "additions": 1738,
          "deletions": 22,
          "commits": 4,
          "labels": [
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "package.json",
            "pnpm-lock.yaml",
            "src/agents/auth-profiles/constants.ts",
            "src/agents/cli-backends.ts",
            "src/agents/cli-runner.ts",
            "src/agents/copilot-runner.test.ts",
            "src/agents/copilot-runner.ts",
            "src/agents/copilot-sdk.test.ts",
            "src/agents/copilot-sdk.ts",
            "src/agents/model-selection.ts",
            "src/agents/models-config.providers.ts",
            "src/agents/pi-embedded-runner/compact.ts",
            "src/agents/pi-embedded-runner/run.ts",
            "src/providers/github-copilot-auth.ts",
            "src/providers/github-copilot-models.test.ts",
            "src/providers/github-copilot-models.ts",
            "src/providers/github-copilot-sdk.test.ts",
            "src/providers/github-copilot-sdk.ts",
            "src/providers/github-copilot-token.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17427.diff",
          "totalScore": 72,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "1760 lines changed (1738+/22-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "tag-assistant (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "This PR introduces a significant feature by integrating the Copilot SDK for auth and model discovery, improving the system's flexibility and reducing hardcoding. The description is thorough, covering the problem, solution, and impact. The inclusion of tests (both unit and model tests) and verification steps is commendable. The 'Human Verification' section is also helpful. The 'Not verified' section highlights a potential risk: lack of live end-to-end testing. The risk is medium because while the core functionality seems well-tested, the absence of end-to-end testing with a live authenticated Copilot CLI environment leaves room for integration issues. The number of files changed is also relatively high, increasing the surface area for potential issues.",
          "duplicateGroup": 7
        },
        {
          "number": 17428,
          "title": "fix: strip thinking blocks with invalid signatures for OpenAI-compat APIs",
          "body": "## Summary\n\n- **Problem:** When using GitHub Copilot with Claude models via the OpenAI-compatible API path, thinking blocks get persisted with field-name strings (e.g. `\"reasoning_text\"`) as their `thinkingSignature` instead of real cryptographic signatures. When these are replayed on subsequent requests, Copilot returns HTTP 400: `Invalid signature in thinking block`.\n- **Why it matters:** This bricks multi-turn sessions with tool calls \u2014 the first turn works, but follow-up requests fail because the replayed thinking blocks have invalid signatures.\n- **What changed:** Added `stripCompletionsReasoningFieldSignatures` which detects and removes thinking blocks with field-name-as-signature patterns. Applied as a transcript policy for all OpenAI-compat APIs (except native OpenAI, Google, and Anthropic providers which handle signatures correctly).\n- **What did NOT change:** Providers that legitimately use thinking signatures (Anthropic, Bedrock Extended Thinking) are unaffected. The proper long-term fix is using `anthropic-messages` API for Claude models (see follow-up PR).\n\n## Change Type (select all)\n\n- [x] Bug fix\n\n## Scope (select all touched areas)\n\n- [x] Gateway / orchestration\n- [x] Integrations\n\n## Linked Issue/PR\n\n- Related #12006 (jackheuberger's complementary approach)\n- Depends on #17284 and #17427\n\n## User-visible / Behavior Changes\n\n- Sessions with Copilot Claude models no longer brick after tool calls due to invalid thinking signatures\n- Thinking blocks with field-name signatures are silently stripped from outgoing requests (they contain no useful content anyway \u2014 just the field name string)\n\n## Security Impact (required)\n\n- New permissions/capabilities? `No`\n- Secrets/tokens handling changed? `No`\n- New/changed network calls? `No`\n- Command/tool execution surface changed? `No`\n- Data access scope changed? `No`\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+\n- Model/provider: github-copilot with Claude models\n\n### Steps\n\n1. Use Copilot with a Claude model via OpenAI-compat API\n2. Send a message that triggers a tool call\n3. The agent's follow-up request replays the thinking block\n4. Previously: HTTP 400. Now: thinking block stripped, request succeeds\n\n### Expected\n\n- Multi-turn conversations with tool calls work without 400 errors\n\n### Actual\n\n- Confirmed working in live testing\n\n## Evidence\n\n- [x] Failing test/log before + passing after\n  - 17 tests in `strip-completions-reasoning.test.ts`\n  - Transcript policy tests updated\n\n## Human Verification (required)\n\n- Verified: Live gateway testing \u2014 multi-turn tool conversations no longer 400\n- Edge cases: Mixed content blocks, nested thinking blocks, non-Copilot providers unaffected\n- Not verified: Exhaustive model coverage\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes`\n- Config/env changes? `No`\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: Remove the `stripCompletionsFieldSignatures` policy flag\n- Known bad symptoms: If stripping is too aggressive, thinking context could be lost (mitigated: only strips blocks with known field-name patterns)\n\n## Risks and Mitigations\n\n- Risk: This is a safety net, not the root fix. The proper solution is using `anthropic-messages` API (see follow-up PR).\n  - Mitigation: This remains useful for backwards compatibility with existing sessions that have bad signatures.\n\n---\n\n> **Stacked PR chain:** #17284 > #17427 > **this PR** > anthropic-messages default\n>\n> Review incremental changes: compare feat/copilot-sdk-provider...fix/copilot-thinking-signature\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds Copilot SDK integration (`@github/copilot-sdk`) and fixes thinking block signature stripping for OpenAI-compatible APIs that proxy to Anthropic.\n\nThe core fix (`stripCompletionsReasoningFieldSignatures`) is sound \u2014 it detects and strips thinking blocks where pi-ai stored a reasoning field name (e.g., `\"reasoning_text\"`) instead of a real cryptographic signature, preventing HTTP 400s on subsequent turns. The function is applied via the existing transcript policy system for all OpenAI-compat providers except native OpenAI, Google, and Anthropic, which is the correct scope.\n\nThe PR also adds:\n- A new `copilot-cli` backend that delegates to the Copilot SDK for interactive sessions\n- SDK-based auth detection and model discovery for the GitHub Copilot provider\n- An `SDK_MANAGED_TOKEN` marker in auth profiles when the Copilot SDK handles authentication\n\nKey findings:\n- A hardcoded `\"sdk-managed\"` string in `github-copilot-auth.ts` should use the `SDK_MANAGED_TOKEN` constant to stay in sync with the runner/provider detection code\n- The `ensureCopilotSdkClient` singleton in `github-copilot-sdk.ts` permanently caches rejected promises if `client.start()` fails, preventing retry after transient errors\n- The SDK-managed token code in `run.ts` and `compact.ts` is duplicated \u2014 a minor concern but worth noting for future refactoring\n\n<h3>Confidence Score: 3/5</h3>\n\n- Functional core fix is correct; two secondary issues in Copilot SDK integration need attention before merge.\n- The thinking block stripping fix is well-implemented with thorough tests. However, two issues in the SDK integration layer reduce confidence: (1) a hardcoded string literal in auth flow that should use the SDK_MANAGED_TOKEN constant to prevent silent breakage if the constant changes, and (2) a permanently cached rejected promise in the SDK client singleton. Both are localized and fixable but represent real defects.\n- Pay close attention to `src/providers/github-copilot-auth.ts` (hardcoded token string) and `src/providers/github-copilot-sdk.ts` (client startup error handling).\n\n<sub>Last reviewed commit: 696545d</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "tag-assistant",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T19:00:24Z",
          "updatedAt": "2026-02-15T19:24:53Z",
          "headRef": "fix/copilot-thinking-signature",
          "baseRef": "main",
          "filesChanged": 25,
          "additions": 2008,
          "deletions": 24,
          "commits": 6,
          "labels": [
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "package.json",
            "pnpm-lock.yaml",
            "src/agents/auth-profiles/constants.ts",
            "src/agents/cli-backends.ts",
            "src/agents/cli-runner.ts",
            "src/agents/copilot-runner.test.ts",
            "src/agents/copilot-runner.ts",
            "src/agents/copilot-sdk.test.ts",
            "src/agents/copilot-sdk.ts",
            "src/agents/model-selection.ts",
            "src/agents/models-config.providers.ts",
            "src/agents/pi-embedded-helpers.strip-completions-reasoning.test.ts",
            "src/agents/pi-embedded-helpers.ts",
            "src/agents/pi-embedded-helpers/openai.ts",
            "src/agents/pi-embedded-runner/compact.ts",
            "src/agents/pi-embedded-runner/google.ts",
            "src/agents/pi-embedded-runner/run.ts",
            "src/agents/transcript-policy.test.ts",
            "src/agents/transcript-policy.ts",
            "src/providers/github-copilot-auth.ts",
            "src/providers/github-copilot-models.test.ts",
            "src/providers/github-copilot-models.ts",
            "src/providers/github-copilot-sdk.test.ts",
            "src/providers/github-copilot-sdk.ts",
            "src/providers/github-copilot-token.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17428.diff",
          "totalScore": 73,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 30,
              "weight": 0.1,
              "reason": "2032 lines changed (2008+/24-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "tag-assistant (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 90,
          "llmRisk": "low",
          "llmReason": "This PR addresses a critical bug that breaks multi-turn sessions with Copilot Claude models. The fix is well-scoped, targeting only the problematic thinking blocks. The description is clear, explaining the problem, solution, and impact. The change type is correctly identified as a bug fix. The security impact is assessed as none. The repro steps are provided. The code changes seem focused and well-tested. The dependency on other PRs is noted. The long-term solution is also mentioned, indicating a good understanding of the problem and its context.",
          "duplicateGroup": 7
        },
        {
          "number": 17333,
          "title": "feat: enhanced GitHub Copilot integration \u2014 SDK provider, CLI backend, and thinking signature fix",
          "body": "## Summary\n\n- **Problem:** OpenClaw's existing Copilot support lacks SDK-based auth/model discovery, CLI backend support, and has a critical bug where multi-turn conversations crash with HTTP 400 when Claude models replay thinking blocks with field-name-as-signature through the `openai-completions` API.\n- **Why it matters:** Users leveraging GitHub Copilot as a model provider (Claude Opus 4.6, GPT-5.3, etc.) get proper token management, automatic model discovery, CLI-mode support, and reliable multi-turn conversations without crashes.\n- **What changed:** (1) Full Copilot SDK provider with auth and model discovery, (2) Copilot CLI backend for terminal usage, (3) Sanitizer that strips thinking blocks with fake signatures before they poison future turns.\n- **What did NOT change:** No modifications to existing Copilot provider behavior \u2014 these are additive enhancements. Direct Anthropic/OpenAI/Google API paths are untouched.\n\n## Change Type (select all)\n\n- [x] Bug fix\n- [x] Feature\n\n## Scope (select all touched areas)\n\n- [x] Auth / tokens\n- [x] Integrations\n- [x] API / contracts\n\n## Linked Issue/PR\n\n- Related openclaw/openclaw#17284 (CLI backend \u2014 standalone PR)\n- Related openclaw/openclaw#14371 (Claude Opus 4.6 Fast model support)\n- Related #2 (Copilot SDK tracking issue)\n\n## Commits\n\n1. **feat: add GitHub Copilot SDK as CLI backend** \u2014 Copilot credentials, SDK wrapper, CLI runner with streaming + tool call support (22 tests)\n2. **feat: add Copilot SDK provider for auth and model discovery** \u2014 Full provider registration, token management, auto model discovery (31 tests)\n3. **fix: strip thinking blocks with field-name-as-signature** \u2014 Sanitizer + transcript policy for the openai-completions thinking signature bug (15 tests)\n\n## User-visible / Behavior Changes\n\n- New provider `github-copilot` available for model configuration with SDK-based auth\n- Copilot models (Claude Opus 4.6, GPT-5.3, etc.) auto-discovered from the API\n- `copilot` CLI backend available for terminal usage\n- Multi-turn conversations with Claude models via Copilot no longer crash with \"Invalid signature in thinking block\" errors\n- New `stripCompletionsReasoningFieldSignatures` transcript policy flag \u2014 enabled automatically for non-native providers using `openai-completions`\n\n## Security Impact (required)\n\n- New permissions/capabilities? Yes \u2014 Copilot SDK auth reads/refreshes tokens from GitHub\n- Secrets/tokens handling changed? Yes \u2014 new Copilot token management flow\n- New/changed network calls? Yes \u2014 calls to Copilot API for auth and model discovery\n- Command/tool execution surface changed? No\n- Data access scope changed? No\n- Risk + mitigation: Token handling follows existing auth profile patterns. Tokens stored in standard credential store, not logged. API calls use HTTPS only.\n\n## Evidence\n\n68 tests passing across 6 test files. Live-tested all models: Claude Opus 4.6 \u2705, 4.6 Fast \u2705, 4.6 1M \u2705, GPT-5.3 Codex \u2705\n\n## Human Verification (required)\n\n- Verified: Multi-turn conversations with all Copilot Claude models, thinking block replay, fallback chain, CLI backend streaming\n- Edge cases: Real signatures preserved (not stripped), non-Copilot providers unaffected, mixed thinking/non-thinking turns\n- Not verified: Windows, Docker sandbox mode\n\n## Compatibility / Migration\n\n- Backward compatible? Yes\n- Config/env changes? Yes \u2014 new optional `github-copilot` provider config\n- Migration needed? No\n\n## Failure Recovery (if this breaks)\n\n- Remove `github-copilot` provider from config, switch to another provider\n- Known symptoms: Auth failures if token expires (auto-refreshes)\n\n## Risks and Mitigations\n\n- Risk: Copilot API changes model IDs or auth flow\n  - Mitigation: SDK-based discovery adapts automatically\n- Risk: Thinking signature stripping too aggressive\n  - Mitigation: Only targets field-name patterns, real cryptographic signatures preserved. Policy only activates for non-native providers.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds three features: (1) a Copilot SDK provider for auth and model discovery, (2) a Copilot CLI backend for terminal usage, and (3) a sanitizer that strips thinking blocks with fake field-name-as-signature from `openai-completions` sessions.\n\nThe changes are well-structured and additive \u2014 existing provider paths are untouched. Tests are thorough (68 tests across 6 files). Key findings:\n\n- **Bug: `max_prompt_tokens` mapped to `maxTokens`** \u2014 In `buildCopilotModelDefinitionFromSdk`, the SDK's `max_prompt_tokens` (input limit) is mapped to `maxTokens` (output limit). This will inflate the `max_output_tokens` sent to the API for SDK-discovered models.\n- **SDK-managed auth gap in REST runner path** \u2014 When auth is SDK-managed but no `GH_TOKEN`/`GITHUB_TOKEN` env var exists, both `run.ts` and `compact.ts` silently skip setting the API key. The comment says the SDK handles auth, but the SDK is only involved in the CLI backend path \u2014 the REST runner needs a bearer token.\n- **Shared client startup failure not recoverable** \u2014 In `ensureCopilotSdkClient`, a rejected `client.start()` promise is cached forever; subsequent calls return the same rejection with no retry mechanism.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR has a confirmed semantic bug in model token mapping and a silent auth failure path that should be resolved before merging.\n- Score of 2 reflects: (1) a definite logic bug where `max_prompt_tokens` is mapped to `maxTokens` (max output tokens), which will cause incorrect API parameters for SDK-discovered models; (2) a silent auth failure in the REST runner path when SDK-managed auth has no env token fallback; and (3) a non-recoverable shared client state on startup failure. The thinking block sanitizer and CLI backend additions look correct.\n- `src/providers/github-copilot-sdk.ts` (token mapping bug + client lifecycle), `src/agents/pi-embedded-runner/run.ts` and `src/agents/pi-embedded-runner/compact.ts` (silent auth gap)\n\n<sub>Last reviewed commit: 798c57a</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
          "author": "tag-assistant",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T17:16:53Z",
          "updatedAt": "2026-02-15T19:24:53Z",
          "headRef": "copilot",
          "baseRef": "main",
          "filesChanged": 25,
          "additions": 2047,
          "deletions": 28,
          "commits": 8,
          "labels": [
            "agents",
            "size: XL"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "package.json",
            "pnpm-lock.yaml",
            "src/agents/auth-profiles/constants.ts",
            "src/agents/cli-backends.ts",
            "src/agents/cli-runner.ts",
            "src/agents/copilot-runner.test.ts",
            "src/agents/copilot-runner.ts",
            "src/agents/copilot-sdk.test.ts",
            "src/agents/copilot-sdk.ts",
            "src/agents/model-selection.ts",
            "src/agents/models-config.providers.ts",
            "src/agents/pi-embedded-helpers.strip-completions-reasoning.test.ts",
            "src/agents/pi-embedded-helpers.ts",
            "src/agents/pi-embedded-helpers/openai.ts",
            "src/agents/pi-embedded-runner/compact.ts",
            "src/agents/pi-embedded-runner/google.ts",
            "src/agents/pi-embedded-runner/run.ts",
            "src/agents/transcript-policy.test.ts",
            "src/agents/transcript-policy.ts",
            "src/providers/github-copilot-auth.ts",
            "src/providers/github-copilot-models.test.ts",
            "src/providers/github-copilot-models.ts",
            "src/providers/github-copilot-sdk.test.ts",
            "src/providers/github-copilot-sdk.ts",
            "src/providers/github-copilot-token.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17333.diff",
          "totalScore": 70,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 30,
              "weight": 0.1,
              "reason": "2075 lines changed (2047+/28-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "tag-assistant (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "This PR introduces significant new functionality (GitHub Copilot integration) with SDK-based auth, CLI backend support, and a bug fix. The description is thorough, including the problem, solution, and scope. The commits are well-organized and include tests. The risk is medium because it touches auth, integrations, and the API, requiring careful review and testing to ensure stability and security. The inclusion of tests (22+31+15) is a strong positive indicator.",
          "duplicateGroup": 7
        },
        {
          "number": 17284,
          "title": "feat: add GitHub Copilot SDK as CLI backend",
          "body": "## Summary\n\n- **Problem:** No way to use GitHub Copilot as a CLI backend alongside `claude-cli` and `codex-cli`\n- **Why it matters:** Users with GitHub Copilot subscriptions should be able to use Copilot as their agent runtime, accessing Claude/GPT/Gemini models through it\n- **What changed:** Added `copilot-cli` as a new CLI backend using the official `@github/copilot-sdk`, following the exact same patterns as `claude-cli` and `codex-cli`\n- **What did NOT change:** The existing Copilot provider pipeline, auth profiles, or any other backend is untouched\n\n## Change Type (select all)\n\n- [ ] Bug fix\n- [x] Feature\n- [ ] Refactor\n- [ ] Docs\n- [ ] Security hardening\n- [ ] Chore/infra\n\n## Scope (select all touched areas)\n\n- [ ] Gateway / orchestration\n- [ ] Skills / tool execution\n- [x] Auth / tokens\n- [ ] Memory / storage\n- [x] Integrations\n- [ ] API / contracts\n- [ ] UI / DX\n- [ ] CI/CD / infra\n\n## Linked Issue/PR\n\n- Related #4469 \u2014 @Aditya190803&#39;s most recent SDK migration PR (provider pipeline approach; complementary to this CLI backend approach)\n- Related #4442 \u2014 @Aditya190803&#39;s earlier attempt (superseded by #4469)\n- Related #2091 \u2014 @Aditya190803&#39;s original SDK integration PR\n\n&gt; **Note:** Aditya&#39;s PRs migrate the **provider pipeline** to use the Copilot SDK. This PR takes a different, complementary approach: it adds Copilot as a **CLI backend** (like `claude-cli`/`codex-cli`), using the SDK&#39;s agent runtime over JSON-RPC stdio. Both approaches could coexist.\n\n## User-visible / Behavior Changes\n\n- New `copilot-cli` backend available for agent routing (config: `provider: copilot-cli`)\n- Supports 17 models via Copilot (Claude, GPT, Gemini families)\n- Model aliases for convenience (`opus` \u2192 `claude-opus-4.6`, `sonnet` \u2192 `claude-sonnet-4.5`, `gemini` \u2192 `gemini-3-pro-preview`, etc.)\n- Requires Copilot CLI installed and authenticated (`copilot login`)\n\n## Security Impact (required)\n\n- New permissions/capabilities? `Yes` \u2014 adds ability to invoke the Copilot CLI subprocess via SDK\n- Secrets/tokens handling changed? `No` \u2014 auth is delegated entirely to Copilot CLI&#39;s own auth flow\n- New/changed network calls? `Yes` \u2014 SDK communicates with GitHub Copilot service (managed by the SDK, not us)\n- Command/tool execution surface changed? `Yes` \u2014 tool permissions auto-approved in SDK session config (matches existing claude-cli/codex-cli behavior)\n- Data access scope changed? `No`\n- Risk + mitigation: The SDK manages its own subprocess and auth. We auto-approve tool permissions (`onPermissionRequest: async () =&gt; ({ kind: &#34;approved&#34; })`) to match the existing `claude-cli` and `codex-cli` pattern where the host controls tool availability. Tools are explicitly noted as disabled in the system prompt passed to the SDK.\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+ / Bun\n- Model/provider: copilot-cli with any supported model\n- Relevant config: `provider: copilot-cli`, `model: claude-sonnet-4.5` (or any)\n\n### Steps\n\n1. Install Copilot CLI and authenticate: `copilot login`\n2. Configure openclaw to use `copilot-cli` as backend\n3. Send a message\n\n### Expected\n\n- Response returned from Copilot SDK agent runtime\n- Session ID tracked for resume capability\n\n### Actual\n\n- Works as expected in unit tests (22/22 passing)\n- Live testing requires Copilot CLI authentication (not available on dev machine)\n\n## Evidence\n\n- [x] Failing test/log before + passing after\n\n**Test results:** 22/22 tests passing (15 SDK tests + 7 runner tests)\n- SDK tests: CLI installation check, auth verification, session creation/resume, error cleanup, system prompt handling, model listing (authenticated/unauthenticated/failure), client creation\n- Runner tests: unavailability failover, successful run shape, session resume, empty payloads, error wrapping, non-failover passthrough, default model\n\n**Type-check:** `pnpm tsgo --noEmit` \u2014 clean, zero errors\n**Lint:** `oxlint` \u2014 0 warnings, 0 errors\n**Format:** `oxfmt` \u2014 clean\n\n## Human Verification (required)\n\n- Verified: All 22 unit tests pass, type-check clean, lint/format clean\n- Verified: Pattern matches existing `claude-cli` and `codex-cli` backends exactly\n- Edge cases: Empty responses, auth rejection, SDK errors, missing CLI, session resume\n- **Not verified:** Live end-to-end with authenticated Copilot CLI (requires active Copilot subscription + `copilot login`)\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes` \u2014 purely additive, no existing behavior changed\n- Config/env changes? `No` \u2014 new `copilot-cli` provider value, but no env vars required\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: Don&#39;t configure `copilot-cli` as a provider; falls through to next backend via `FailoverError`\n- Files to restore: Revert this commit\n- Bad symptoms: `FailoverError` if Copilot CLI not installed or not authenticated (expected graceful degradation)\n\n## Risks and Mitigations\n\n- Risk: `@github/copilot-sdk` is at v0.1.22 (pre-1.0), API may change\n  - Mitigation: Pinned exact version (no caret), SDK is dynamically imported so it&#39;s lazy-loaded, isolated in 2 files\n- Risk: v0.1.23+ requires Node 24+, we target Node 22+\n  - Mitigation: Pinned to v0.1.22, documented in code comment\n- Risk: `COPILOT_CLI_PROFILE_ID` is exported but not yet consumed\n  - Mitigation: Follows existing pattern (`QWEN_CLI_PROFILE_ID`, `MINIMAX_CLI_PROFILE_ID` are also forward-declared); ready for auth profile sync when needed\n\n---\n\n### Things maintainers may flag (and preemptive answers)\n\n| Potential flag | Answer |\n|---|---|\n| **`onPermissionRequest: auto-approve`** | Matches `claude-cli`/`codex-cli` pattern \u2014 the host (openclaw) controls tool availability, not the SDK. System prompt explicitly says &#34;Tools are disabled.&#34; Can restrict further if needed. |\n| **`@github/copilot-sdk` is pre-1.0** | Agreed, it&#39;s v0.1.22. Pinned exact version, lazy dynamic import, isolated in 2 files. Easy to update or remove. |\n| **No live E2E test** | Requires `copilot login` with active subscription. 22 unit tests cover all code paths. Happy to add E2E once auth is available. |\n| **`COPILOT_CLI_PROFILE_ID` unused** | Forward declaration following QWEN/MINIMAX pattern. Can remove if preferred. |\n| **DEFAULT_MODEL_IDS hardcoded (17 models)** | `listCopilotModels()` exists for dynamic discovery but needs auth. Hardcoded list is the fallback, same pattern as other providers. |\n| **No image support** | SDK takes a prompt string, not content blocks. Can add when SDK supports multimodal input. |\n\n### Files changed\n\n**New files (4):**\n- `src/agents/copilot-sdk.ts` (188 LOC) \u2014 Core SDK wrapper: CLI check, client creation, auth, model listing, agent runner\n- `src/agents/copilot-runner.ts` (153 LOC) \u2014 Bridge to `EmbeddedPiRunResult` interface\n- `src/agents/copilot-sdk.test.ts` (243 LOC) \u2014 15 tests\n- `src/agents/copilot-runner.test.ts` (177 LOC) \u2014 7 tests\n\n**Modified files (5 + deps):**\n- `src/agents/cli-backends.ts` \u2014 `DEFAULT_COPILOT_BACKEND` config + `COPILOT_MODEL_ALIASES` (15 aliases)\n- `src/agents/cli-runner.ts` \u2014 Route `copilot-cli` provider to SDK runner\n- `src/agents/model-selection.ts` \u2014 Register `copilot-cli` in `isCliProvider()`\n- `src/agents/auth-profiles/constants.ts` \u2014 Forward-declare `COPILOT_CLI_PROFILE_ID`\n- `src/providers/github-copilot-models.ts` \u2014 Update DEFAULT_MODEL_IDS to 17 current models\n- `package.json` + `pnpm-lock.yaml` \u2014 Add `@github/copilot-sdk@0.1.22`\n\n### Review Feedback Addressed\n\nAll 3 automated review findings (Greptile) fixed in [`18ac044`](https://github.com/openclaw/openclaw/pull/17284/commits/18ac04452978d6ac1f3531b17cfe15b3ffa30979):\n\n| Finding | Fix |\n|---|---|\n| Model aliases never applied for `copilot-cli` | `copilot-runner.ts` now resolves aliases via `resolveCliBackendConfig` + `normalizeCliModel` before passing to SDK |\n| `images` parameter silently dropped | `cli-runner.ts` logs `log.warn` when images are present for `copilot-cli` |\n| Sync `execFileSync` blocks event loop every request | `copilot-sdk.ts` caches `checkCopilotAvailable()` result for process lifetime |\n\n\n<h3>Greptile Summary</h3>\n\nAdds `copilot-cli` as a new CLI backend using `@github/copilot-sdk`, following the existing `claude-cli`/`codex-cli` patterns. The implementation is well-structured with proper resource cleanup, lazy SDK loading, and graceful failover. Test coverage is solid (22 tests).\n\n**Issues found:**\n- **Model aliases are dead code**: The `COPILOT_MODEL_ALIASES` map (e.g. `opus` \u2192 `claude-opus-4.6`) defined in `cli-backends.ts` is never applied because the copilot-cli path is intercepted in `runCliAgent` before `normalizeCliModel()` runs. Users who specify friendly alias names like `opus` or `sonnet` will have those raw strings passed to the Copilot SDK, which won&#39;t recognise them.\n- **Breaking change to existing provider pipeline**: `github-copilot-models.ts` replaces the entire default model list, removing previously listed models (`gpt-4o`, `o1`, `o1-mini`, `o3-mini`, `gpt-4.1-mini`, `gpt-4.1-nano`). Despite the PR stating the existing Copilot provider pipeline is untouched, this file is part of that pipeline.\n- **`images` parameter silently dropped**: The copilot-cli intercept in `cli-runner.ts` does not forward `params.images`, silently discarding caller-provided image data with no warning.\n\n<h3>Confidence Score: 2/5</h3>\n\n- The new copilot-cli backend is mostly additive, but the model alias bug means advertised functionality won&#39;t work, and the model list change could break existing provider pipeline users.\n- Score reflects two functional issues: (1) model aliases defined for copilot-cli are never applied due to early interception in the routing path, making friendly model names non-functional; (2) the DEFAULT_MODEL_IDS replacement in github-copilot-models.ts is a potentially breaking change to the existing Copilot provider pipeline that contradicts the PR&#39;s claim of no changes to existing behavior.\n- `src/agents/copilot-runner.ts` (model alias resolution missing), `src/providers/github-copilot-models.ts` (breaking model list change), `src/agents/cli-runner.ts` (images silently dropped)\n\n<sub>Last reviewed commit: d5a2149</sub>\n\n\n\n<sub>(3/5) Reply to the agent&#39;s comments like &#34;Can you suggest a fix for this @greptileai?&#34; or ask follow-up questions!</sub>\n\n",
          "author": "tag-assistant",
          "authorAssociation": "NONE",
          "createdAt": "2026-02-15T16:12:13Z",
          "updatedAt": "2026-02-15T19:23:32Z",
          "headRef": "feat/copilot-cli-backend",
          "baseRef": "main",
          "filesChanged": 11,
          "additions": 968,
          "deletions": 13,
          "commits": 2,
          "labels": [
            "agents",
            "size: L"
          ],
          "ciStatus": "pending",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "package.json",
            "pnpm-lock.yaml",
            "src/agents/auth-profiles/constants.ts",
            "src/agents/cli-backends.ts",
            "src/agents/cli-runner.ts",
            "src/agents/copilot-runner.test.ts",
            "src/agents/copilot-runner.ts",
            "src/agents/copilot-sdk.test.ts",
            "src/agents/copilot-sdk.ts",
            "src/agents/model-selection.ts",
            "src/providers/github-copilot-models.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/17284.diff",
          "totalScore": 72,
          "signals": [
            {
              "name": "ci_status",
              "score": 50,
              "weight": 0.2,
              "reason": "CI: pending"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "981 lines changed (968+/13-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 30,
              "weight": 0.15,
              "reason": "tag-assistant (NONE)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 75,
              "weight": 0.15,
              "reason": "No issue ref"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "The PR introduces a new feature by adding GitHub Copilot SDK as a CLI backend. The description is detailed, explaining the problem, solution, and changes. It also highlights what remains unchanged and links related PRs. The change type is correctly identified as a feature. The scope touches auth/tokens and integrations, which are potential areas of risk. The user-visible changes are clearly outlined, including model support and authentication requirements. The security impact is acknowledged, although the description is cut off. The file list indicates significant changes, including new files for copilot-runner and copilot-sdk, as well as modifications to existing agent-related files. The risk is medium due to the integration of a new SDK and the potential security implications of invoking Copilot. A thorough security review is recommended.",
          "duplicateGroup": 7
        }
      ],
      "bestPR": 17428,
      "similarity": 0.8771980397764398,
      "reason": "5 similar PRs (avg similarity: 87.7%)"
    },
    {
      "id": 8,
      "prs": [
        {
          "number": 12296,
          "title": "security: persistence-only secret redaction for session transcripts",
          "body": "## Summary\r\n\r\n\ud83e\udd16 **AI-assisted** \u2014 Built by an OpenClaw agent (Claude Opus 4.6), fully tested, fully reviewed. The author understands the code and architecture decisions.\r\n\r\nRedact sensitive secrets (API keys, tokens, passwords) from session transcript JSONL files **at the persistence layer only**, keeping in-memory entries unredacted so the LLM can reason about full tool output (e.g., `curl` with Bearer tokens, `cat` of config files).\r\n\r\nSee [design document on #12182](https://github.com/openclaw/openclaw/issues/12182#issuecomment-3869025731) for full architecture rationale, tradeoffs, and coverage analysis.\r\n\r\n## Root Cause\r\n\r\nIn `session-tool-result-guard.ts`, tool results are persisted via `_appendEntry()` \u2192 `_persist()` which calls `JSON.stringify(entry)` + `appendFileSync` \u2014 no redaction applied. The existing `redactSensitiveText()` was only used on the read path.\r\n\r\nAdditionally, `appendAssistantMessageToSessionTranscript()` in `transcript.ts` creates a raw `SessionManager.open()` without the guard, bypassing any redaction.\r\n\r\n## Fix\r\n\r\n### Architecture: Persistence-only via `_persist` monkey-patch\r\n\r\n- **`SessionManager._persist()`** \u2014 Replaced entirely to apply `redactEntryForPersistence()` during `JSON.stringify` serialization (both bulk-flush and single-entry paths)\r\n- **`SessionManager._rewriteFile()`** \u2014 Also replaced for the migration/recovery write path\r\n- **`transcript.ts`** \u2014 Wrapped with `guardSessionManager()` to close the bypass\r\n- **In-memory `fileEntries[]`** \u2014 Untouched. LLM sees full unredacted content via `buildSessionContext()`\r\n\r\n### Entry types covered (all text-carrying types)\r\n\r\n| Entry Type | Field(s) Redacted |\r\n|---|---|\r\n| `message` (toolResult, assistant, user) | `message.content[].text` |\r\n| `compaction` / `branch_summary` | `summary` string |\r\n| `custom_message` | `content` (string or TextContent[]) |\r\n\r\n### Why monkey-patching\r\n\r\n`SessionManager` lives in the upstream `@mariozechner/pi-coding-agent` package \u2014 we cannot modify `_persist` directly. The existing guard already monkey-patches `appendMessage`; our `_persist` patch follows the same established pattern. We pin to upstream v0.52.8 with SHA-256 hash tests that fail on any structural change.\r\n\r\n### Other improvements\r\n\r\n- Cache compiled regex patterns (content-based `JSON.stringify` comparison)\r\n- Resolve redact options once at guard install time (no per-call `loadConfig()`)\r\n- Extract shared `redactTextBlocks()` helper (zero code duplication)\r\n\r\n## Test plan\r\n\r\n**38 tests total**, all passing (Node + Bun):\r\n\r\n- **Dual-path verification**: every redaction test checks both in-memory (unredacted) and on-disk (redacted) using disk-persisted `SessionManager`\r\n- **All message roles**: toolResult, assistant, user\r\n- **All entry types**: compaction, branch_summary, custom_message (string + array)\r\n- **Non-message passthrough**: session header unchanged\r\n- **Transcript mirror**: delivery-mirror redaction verified\r\n- **Upstream compatibility**: SHA-256 hash of `_persist.toString()` and `_rewriteFile.toString()`\r\n- **Clean passthrough**: entries without secrets return same reference\r\n\r\n## Related\r\n\r\n- Refs: #12182\r\n- Related: #12260 (similar goal, different architecture \u2014 redacts before `appendMessage` which also affects LLM context)\r\n\r\n## Files changed (5)\r\n\r\n- `src/agents/session-tool-result-guard.ts` \u2014 `redactEntryForPersistence()`, `_persist`/`_rewriteFile` patches, `redactTextBlocks()` helper\r\n- `src/agents/session-tool-result-guard.test.ts` \u2014 26 guard tests with dual-path verification\r\n- `src/config/sessions/transcript.ts` \u2014 `guardSessionManager()` wrapper\r\n- `src/config/sessions/transcript.test.ts` \u2014 delivery-mirror redaction test\r\n- `src/logging/redact.ts` \u2014 pattern caching\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR changes session transcript persistence so secrets are redacted only when writing JSONL to disk, keeping in-memory session entries unredacted for LLM context. It does this by extending the existing `guardSessionManager()` approach to wrap `SessionManager`\u2019s persistence methods (`_persist` and `_rewriteFile`) to serialize redacted copies of entries, and by ensuring `transcript.ts` uses a guarded session manager so it can\u2019t bypass redaction. It also updates the redaction utility to cache compiled regex/pattern work and adds tests that verify the \u201cdual path\u201d behavior (unredacted in-memory, redacted on disk) across message roles and other transcript entry types.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk.\n- Reviewed the changed persistence wrapper and transcript guard integration along with the updated redaction caching and tests; changes are focused, preserve upstream persistence semantics, and include strong dual-path test coverage to prevent regressions.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "akoscz",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-09T03:08:09Z",
          "updatedAt": "2026-02-15T19:24:41Z",
          "headRef": "feature/exec-write-time-redaction",
          "baseRef": "main",
          "filesChanged": 7,
          "additions": 741,
          "deletions": 11,
          "commits": 10,
          "labels": [
            "docs",
            "gateway",
            "agents",
            "size: L"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "docs/gateway/security/index.md",
            "docs/logging.md",
            "src/agents/session-tool-result-guard.e2e.test.ts",
            "src/agents/session-tool-result-guard.ts",
            "src/config/sessions/transcript.test.ts",
            "src/config/sessions/transcript.ts",
            "src/logging/redact.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/12296.diff",
          "totalScore": 72,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "752 lines changed (741+/11-)"
            },
            {
              "name": "commit_quality",
              "score": 50,
              "weight": 0.05,
              "reason": "Non-standard title"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "akoscz (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 85,
          "llmRisk": "medium",
          "llmReason": "Comprehensive fix with good rationale and coverage. Monkey-patching introduces risk, but is justified by the upstream package limitation. Persistence-only redaction is a sound security approach. Good test coverage.",
          "duplicateGroup": 8
        },
        {
          "number": 16779,
          "title": "feat: add `openclaw sessions scrub` command and doctor check for secret leaks",
          "body": "## Summary\n\nCloses #11468\n\nRecreated from #11544 as a clean single-commit branch (the previous PR was closed for having too many unrelated commits).\n\nAdds two features to address `config.get` leaking secrets into session transcripts:\n\n1. **`openclaw sessions scrub`** \u2014 CLI command that scans historical session JSONL files and redacts leaked secrets in-place (with backup by default)\n2. **`openclaw doctor` check** \u2014 detects unredacted secrets in session files and warns the user\n\n## What's included\n\n### New files\n- `src/commands/sessions-scrub.ts` \u2014 scrub command implementation\n- `src/commands/doctor-sessions-secrets.ts` \u2014 doctor check for session secrets\n- `docs/cli/sessions-scrub.md` \u2014 documentation\n\n### Modified files\n- `src/cli/program/register.status-health-sessions.ts` \u2014 Commander.js registration, `sessions` becomes a command group with backward compat\n- `src/commands/doctor.ts` \u2014 wires in the new session secrets check\n\n### Design decisions\n- Reuses canonical `maskToken()` pattern from `src/logging/redact.ts` \u2014 no duplicated regex\n- Creates `.bak` backups by default; `--no-backup` to skip\n- Doctor check scans all files if \u2264200, deterministic sample for larger dirs\n- `openclaw sessions` (no subcommand) still works as before (lists sessions)\n- Multi-pass scrub loop with oscillation guard for stable redaction\n\n### Tests\n- 10 unit tests for sessions scrub (`src/commands/sessions-scrub.test.ts`)\n- 7 unit tests for doctor check (`src/commands/doctor-sessions-secrets.test.ts`)\n- All 17 tests passing\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nAdds `openclaw sessions scrub` CLI command for at-rest redaction of leaked secrets in session JSONL files, plus a `doctor` check that warns users about unredacted secrets. The implementation is well-structured: scrub uses the canonical `redactSensitiveText` from `redact.ts`, includes a multi-pass loop with oscillation detection, bounded concurrency for performance, and `.bak` backups by default. The `sessions` command is cleanly promoted from a leaf to a command group (matching the existing `agents` pattern) with backward compatibility preserved.\n\n- Documentation states files are processed \"sequentially\" but the implementation uses bounded concurrency (default 20 workers) \u2014 docs should be corrected\n- `parsePattern` in `doctor-sessions-secrets.ts` duplicates the private function in `redact.ts`; consider exporting a shared version to prevent drift\n- Test coverage is thorough (17 tests covering dry-run, backup, multi-pass, oscillation guard, edge cases)\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with minor documentation fixes needed\n- The core logic is sound: the scrub command correctly uses the canonical redaction utilities, the concurrency pattern is safe in Node.js, the oscillation guard prevents infinite loops, and the backward-compatible command group promotion follows established codebase patterns. The only actionable issue is a documentation inaccuracy (sequential vs concurrent processing). The duplicated parsePattern is a maintenance risk but not a runtime bug. Test coverage is solid at 17 tests.\n- docs/cli/sessions-scrub.md (documentation inaccuracy about processing model)\n\n<sub>Last reviewed commit: bec7b8e</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "akoscz",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-15T03:46:23Z",
          "updatedAt": "2026-02-15T19:24:21Z",
          "headRef": "feature/sessions-scrub-clean",
          "baseRef": "main",
          "filesChanged": 10,
          "additions": 1125,
          "deletions": 12,
          "commits": 4,
          "labels": [
            "docs",
            "gateway",
            "cli",
            "commands",
            "size: L"
          ],
          "ciStatus": "failure",
          "hasIssueRef": true,
          "issueNumbers": [
            11468
          ],
          "changedFiles": [
            "docs/cli/sessions-scrub.md",
            "src/cli/program/register.status-health-sessions.ts",
            "src/cli/program/routes.ts",
            "src/commands/doctor-sessions-secrets.test.ts",
            "src/commands/doctor-sessions-secrets.ts",
            "src/commands/doctor.ts",
            "src/commands/sessions-scrub.test.ts",
            "src/commands/sessions-scrub.ts",
            "src/gateway/session-utils.fs.ts",
            "src/logging/redact.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/16779.diff",
          "totalScore": 79,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 60,
              "weight": 0.1,
              "reason": "1137 lines changed (1125+/12-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "akoscz (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 90,
              "weight": 0.1,
              "reason": "References: #11468"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No spam signals"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 90,
          "llmRisk": "low",
          "llmReason": "Well-structured PR with clear purpose, good test coverage, and documentation. Addresses a critical security concern (secret leakage). The design decisions are sound, including backup creation and oscillation guard. The use of existing redaction patterns is excellent. The Greptile overview confirms a thorough and well-considered implementation.",
          "duplicateGroup": 8
        },
        {
          "number": 11602,
          "title": "fix(config): skip stale legacy config files when openclaw.json exists",
          "body": "## Summary\n\nFix for #11465 \u2014 After migrating from clawdbot to openclaw, the gateway reads stale legacy config files (clawdbot.json, moltbot.json, moldbot.json) causing validation failures and log spam every ~10 seconds via systemd restart loop.\n\n## Root Cause\n\n`resolveDefaultConfigCandidates()` in `src/config/paths.ts` generates candidate config paths including legacy filenames for every directory, even when `openclaw.json` already exists there. When a migration symlink exists (`~/.clawdbot \u2192 ~/.openclaw`), the stale legacy config gets picked up, fails validation, and the gateway crashes repeatedly.\n\n## Changes\n\n### Primary fix (`src/config/paths.ts`)\n- `resolveDefaultConfigCandidates()` now checks if `openclaw.json` exists in each candidate directory\n- If it does, legacy filenames (clawdbot.json, moltbot.json, moldbot.json) are skipped for that directory\n- Added `skipLegacyIfNewExists` option (default `true`) for backward compatibility in tests\n- Exported `LEGACY_CONFIG_FILENAMES` for use by doctor cleanup\n\n### Doctor cleanup (`src/commands/doctor-config-flow.ts`)\n- New `renameStaleLegacyConfigs()` function that renames stale legacy configs to `<name>.migrated` when `openclaw.json` exists\n- Respects `OPENCLAW_STATE_DIR` via `resolveStateDir()`\n- Called during `openclaw doctor` flow after legacy config migration\n\n### Tests\n- **`src/config/paths.test.ts`** \u2014 4 new tests:\n  - Skip legacy filenames when `openclaw.json` exists in same dir\n  - Include legacy filenames when `openclaw.json` does not exist (backward compat)\n  - Skip legacy in custom `OPENCLAW_STATE_DIR` with `openclaw.json`\n  - Symlink regression test (`~/.clawdbot \u2192 ~/.openclaw`) \u2014 the exact reported scenario\n- **`src/commands/doctor-config-flow.test.ts`** \u2014 4 new tests:\n  - Rename stale legacy configs when `openclaw.json` exists\n  - Skip when no primary config\n  - Skip when no legacy configs\n  - `.migrated` collision (safe to run doctor twice)\n- All 17 tests pass, all original tests preserved\n\n## Backward Compatibility\n\n- Legacy config paths still work for actual first-time migrations (when `openclaw.json` doesn't exist)\n- Doctor renames to `.migrated` rather than deleting (recoverable)\n- No changes to gateway startup logic\n\n## Verification\n\n```\npnpm check          \u2705 (typecheck + lint + format)\npnpm vitest run ... \u2705 (17 tests pass)\n```\n\n## Sign-Off\n\n- [x] AI-assisted (Claude Opus 4.6 via OpenClaw, with human review)\n- [x] Fully tested (17 unit tests covering all edge cases)\n- [x] Tested locally with OpenClaw instance\n- [x] Understand what the code does\n\nlobster-biscuit\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR addresses #11465 by preventing stale legacy config files (`clawdbot.json`, `moltbot.json`, `moldbot.json`) from being considered when `openclaw.json` already exists in the same directory.\n\nKey changes:\n- `src/config/paths.ts`: `resolveDefaultConfigCandidates()` now omits legacy config filenames per-directory when `openclaw.json` exists, and `resolveConfigPath()` applies the same rule for explicit `stateDir` paths. Legacy config env override support is extended by treating `CLAWDBOT_CONFIG_PATH` as a fallback when `OPENCLAW_CONFIG_PATH` is unset.\n- `src/commands/doctor-config-flow.ts`: adds `renameStaleLegacyConfigs()` and runs it during `openclaw doctor` to rename stale legacy configs to `*.migrated` once a primary `openclaw.json` exists.\n- Tests cover the primary skip behavior, the symlink regression case, state-dir override behavior, and doctor rename collision behavior.\n\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk.\n- Changes are localized to config-path candidate generation and a best-effort doctor cleanup, with targeted tests covering the reported symlink regression and state-dir override scenarios.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
          "author": "akoscz",
          "authorAssociation": "CONTRIBUTOR",
          "createdAt": "2026-02-08T01:57:49Z",
          "updatedAt": "2026-02-15T19:24:35Z",
          "headRef": "fix/legacy-config-path-spam",
          "baseRef": "main",
          "filesChanged": 4,
          "additions": 284,
          "deletions": 22,
          "commits": 8,
          "labels": [
            "commands",
            "size: M"
          ],
          "ciStatus": "failure",
          "hasIssueRef": false,
          "issueNumbers": [],
          "changedFiles": [
            "src/commands/doctor-config-flow.e2e.test.ts",
            "src/commands/doctor-config-flow.ts",
            "src/config/paths.test.ts",
            "src/config/paths.ts"
          ],
          "diffUrl": "https://github.com/openclaw/openclaw/pull/11602.diff",
          "totalScore": 81,
          "signals": [
            {
              "name": "ci_status",
              "score": 10,
              "weight": 0.2,
              "reason": "CI: failure"
            },
            {
              "name": "diff_size",
              "score": 100,
              "weight": 0.1,
              "reason": "306 lines changed (284+/22-)"
            },
            {
              "name": "commit_quality",
              "score": 90,
              "weight": 0.05,
              "reason": "Conventional commit format"
            },
            {
              "name": "contributor",
              "score": 70,
              "weight": 0.15,
              "reason": "akoscz (CONTRIBUTOR)"
            },
            {
              "name": "issue_ref",
              "score": 30,
              "weight": 0.1,
              "reason": "No issue reference"
            },
            {
              "name": "spam",
              "score": 100,
              "weight": 0.15,
              "reason": "No issue ref, contributor bonus -1"
            }
          ],
          "isSpam": false,
          "spamReasons": [],
          "visionAlignment": "unchecked",
          "llmScore": 95,
          "llmRisk": "low",
          "llmReason": "Comprehensive fix addressing a clear bug with thorough testing, including a regression test for the reported scenario. The changes are well-explained, and the doctor command cleanup provides a good user experience. The backward compatibility consideration is also a plus. The code changes appear well-structured and maintainable.",
          "duplicateGroup": 8
        }
      ],
      "bestPR": 11602,
      "similarity": 0.8304139433202501,
      "reason": "3 similar PRs (avg similarity: 83.0%)"
    }
  ],
  "rankedPRs": [
    {
      "number": 17463,
      "title": "fix: write config files with explicit 0o600 mode instead of post-write chmod",
      "body": "Closes #17440\n\n## Changes\n\n### Problem\nConfig files containing API keys/secrets were written with default umask permissions, then `chmod 0o600` was called separately. This created:\n1. A race window where secrets could be world-readable between write and chmod\n2. Silent failures when chmod failed (errors were swallowed with empty `.catch(() => {})`)\n\n### Fix\n- **`src/infra/json-file.ts`**: Pass `{ mode: 0o600 }` directly to `writeFileSync` so files are created with correct permissions atomically. Keep `chmodSync` as best-effort fallback for pre-existing files whose permissions drifted.\n- **`src/config/io.ts`**: Replace silent `.catch(() => {})` with a warning log when chmod fails in the Windows rename-fallback path.\n- **`src/infra/tls/gateway.ts`**: Replace silent `.catch(() => {})` with warning logs when TLS key/cert chmod fails. Added `warn` to the log type signature.\n\n### Tests\n- Added `src/infra/json-file.test.ts` \u2014 verifies 0o600 permissions, JSON content, overwrite behavior, and parent dir creation (0o700).\n- Added `src/config/io.permissions.test.ts` \u2014 verifies writeConfigFile creates files with 0o600 and logs warnings on chmod failure (mocked fs).\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nEliminated race condition where config files with secrets were written with default umask permissions before being secured with `chmod`. The fix passes `mode: 0o600` directly to `writeFileSync` so files are created atomically with correct permissions.\n\n**Key improvements:**\n- `src/infra/json-file.ts`: atomically creates files with 0o600 via `writeFileSync` options; keeps `chmodSync` fallback for pre-existing files\n- `src/config/io.ts`: replaces silent `.catch(() => {})` with warning logs when chmod fails in Windows copyFile fallback path\n- `src/infra/tls/gateway.ts`: replaces silent catches with warning logs for TLS key/cert chmod failures; adds `warn` to log signature\n- Comprehensive test coverage verifies 0o600 permissions and warning logs\n\n**Issue found:**\n- TLS gateway still has a race window between `openssl` creating key/cert files and `chmod` securing them (see inline comment)\n\n<h3>Confidence Score: 4/5</h3>\n\n- Safe to merge with one remaining race condition in TLS key generation that should be addressed in follow-up\n- The PR successfully fixes the primary race condition in config file writes and adds proper error visibility. Tests thoroughly verify the fix. The remaining TLS race condition is a pre-existing pattern that wasn't the focus of this PR, but should be addressed separately\n- Pay attention to `src/infra/tls/gateway.ts` - the openssl race condition should be fixed in a follow-up PR\n\n<sub>Last reviewed commit: 5fdaa95</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(3/5) Reply to the agent's comments like \"Can you suggest a fix for this @greptileai?\" or ask follow-up questions!</sub>\n\n<!-- /greptile_comment -->",
      "author": "miclaldogan",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:51:10Z",
      "updatedAt": "2026-02-15T19:54:01Z",
      "headRef": "fix/config-file-permissions-17440",
      "baseRef": "main",
      "filesChanged": 5,
      "additions": 173,
      "deletions": 7,
      "commits": 1,
      "labels": [
        "size: S"
      ],
      "ciStatus": "pending",
      "hasIssueRef": true,
      "issueNumbers": [
        17440
      ],
      "changedFiles": [
        "src/config/io.permissions.test.ts",
        "src/config/io.ts",
        "src/infra/json-file.test.ts",
        "src/infra/json-file.ts",
        "src/infra/tls/gateway.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17463.diff",
      "totalScore": 85,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "180 lines changed (173+/7-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "miclaldogan (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17440"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "Addresses a critical security vulnerability (race condition exposing secrets) with a well-reasoned and tested fix. The code changes are focused and the added tests provide good coverage. The fallback chmod and improved error handling further enhance robustness. The greptile summary confirms the analysis."
    },
    {
      "number": 17372,
      "title": "fix(web-fetch): preserve JSON-LD structured data during HTML-to-markdown",
      "body": "## Summary\n- Fixes #17137\n- The `htmlToMarkdown` utility strips all `<script>` tags, which also removes `<script type=\"application/ld+json\">` blocks containing valuable structured data (JSON-LD schema markup).\n- Extracts JSON-LD blocks before the blanket script removal, then appends them as a formatted \"Structured Data (JSON-LD)\" section with fenced code blocks at the end of the converted markdown.\n\n## Test plan\n- [x] Added test: JSON-LD blocks preserved while regular scripts are removed\n- [x] Added test: multiple JSON-LD blocks are all extracted\n- [x] Added test: no-op when page contains no JSON-LD\n\n\ud83e\udd16 Generated with [Claude Code](https://claude.com/claude-code)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nExtracts JSON-LD structured data blocks from HTML before the blanket `<script>` tag removal, then appends them as a formatted \"Structured Data (JSON-LD)\" section at the end of the markdown output.\n\n- Preserves valuable schema markup that was previously lost\n- Tests cover the main use cases: single block, multiple blocks, and no JSON-LD\n- Implementation is straightforward and doesn't affect existing functionality\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The change is well-isolated to a single function, includes comprehensive tests for the new functionality, and preserves backward compatibility by only adding content when JSON-LD is present\n- No files require special attention\n\n<sub>Last reviewed commit: f25ce69</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "BinHPdev",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T17:59:54Z",
      "updatedAt": "2026-02-15T19:21:28Z",
      "headRef": "fix/web-fetch-jsonld-17137-v2",
      "baseRef": "main",
      "filesChanged": 5,
      "additions": 60,
      "deletions": 1,
      "commits": 4,
      "labels": [
        "channel: whatsapp-web",
        "agents",
        "size: S"
      ],
      "ciStatus": "pending",
      "hasIssueRef": true,
      "issueNumbers": [
        17137
      ],
      "changedFiles": [
        ".github/workflows/ci.yml",
        ".github/workflows/formal-conformance.yml",
        "src/agents/tools/web-fetch-utils.test.ts",
        "src/agents/tools/web-fetch-utils.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17372.diff",
      "totalScore": 85,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "61 lines changed (60+/1-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "BinHPdev (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17137"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "The PR addresses a valid issue by preserving JSON-LD data during HTML-to-markdown conversion. It includes comprehensive tests covering different scenarios and the implementation appears straightforward and well-isolated. The Greptile summary also indicates high confidence. The score is not 100 because there might be edge cases not covered by the tests, such as extremely large JSON-LD blocks or malformed JSON-LD."
    },
    {
      "number": 17435,
      "title": "fix(debounce): retry flush with exponential backoff to prevent silent message loss",
      "body": "## fix(debounce): retry inbound flush on lock contention\n\nFixes #17421\n\n### Problem\n\nWhen the inbound debounce timer fires and `onFlush` fails (e.g. due to session store lock contention with a concurrent cron job), the buffered messages are **permanently and silently lost**:\n\n```\ntelegram debounce flush failed: Error: timeout acquiring session store lock\n```\n\nThe user sees blue checkmarks on Telegram, but the agent never receives the message. Neither side knows anything was lost.\n\nFrom the bug report: **5 messages dropped in 2 days** during normal operation.\n\n### Root Cause\n\n`flushBuffer()` in `inbound-debounce.ts` catches the error and calls `onError()`, but all channel handlers (`telegram`, `discord`, `signal`, `slack`, `imessage`) only log the error \u2014 the buffered items are discarded with no retry.\n\n### Fix\n\nAdd retry with exponential backoff to `flushBuffer()`:\n\n```typescript\n// Retry loop (default: 3 attempts, 500ms base backoff)\nfor (let attempt = 0; attempt <= retryAttempts; attempt++) {\n  try {\n    await params.onFlush(buffer.items);\n    return; // success\n  } catch (err) {\n    lastErr = err;\n    if (attempt < retryAttempts) {\n      await delay(retryBaseMs * 2 ** attempt);\n      // 500ms \u2192 1000ms \u2192 2000ms\n    }\n  }\n}\nparams.onError?.(lastErr, buffer.items); // only after all retries exhausted\n```\n\nNew configurable options (backwards compatible):\n- `retryAttempts`: max retry count (default: 3)\n- `retryBaseMs`: base delay for exponential backoff (default: 500ms)\n\n### Changed Files\n\n| File | Change |\n|------|--------|\n| `src/auto-reply/inbound-debounce.ts` | Add retry loop to `flushBuffer()` |\n| `src/auto-reply/inbound-debounce.retries-on-flush-failure.test.ts` | 3 new tests |\n\n### Testing\n\n- 3 new tests (retry success, retry exhaustion, no-retry path)\n- All 659 auto-reply tests pass\n- Lint + format clean\n\n### Impact\n\nAffects ALL channels: Telegram, Discord, Signal, Slack, iMessage. Any channel using inbound debounce benefits from this fix without code changes \u2014 the retry is in the shared debouncer.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded retry logic with exponential backoff to prevent silent message loss when debounced message flushes fail due to session store lock contention.\n\n**Key changes:**\n- Added configurable retry parameters (`retryAttempts`: default 3, `retryBaseMs`: default 500ms) to `createInboundDebouncer`\n- Implemented exponential backoff retry loop in `flushBuffer` (500ms \u2192 1000ms \u2192 2000ms)\n- Only calls `onError` after all retries are exhausted\n- Added comprehensive test coverage for retry success, exhaustion, and no-retry paths\n\n**Issue found:**\n- Non-debounced messages (line 116 in `enqueue`) still bypass retry logic - messages with media or control commands can be lost if lock contention occurs during their immediate flush\n\n<h3>Confidence Score: 3/5</h3>\n\n- Safe to merge with one critical limitation that should be addressed\n- The implementation is solid and well-tested for the debounced path, but the non-debounced path (line 116) still lacks retry protection, leaving a gap in the fix for messages with media or control commands\n- Pay attention to `src/auto-reply/inbound-debounce.ts` line 116 where non-debounced messages bypass retry logic\n\n<sub>Last reviewed commit: 9102b0c</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "widingmarcus-cyber",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T19:07:39Z",
      "updatedAt": "2026-02-15T19:54:22Z",
      "headRef": "fix/debounce-retry-on-lock-failure-17421",
      "baseRef": "main",
      "filesChanged": 4,
      "additions": 135,
      "deletions": 15,
      "commits": 2,
      "labels": [
        "channel: whatsapp-web",
        "size: S"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        17421
      ],
      "changedFiles": [
        "openclaw-2026-02-15.log",
        "src/auto-reply/inbound-debounce.retries-on-flush-failure.test.ts",
        "src/auto-reply/inbound-debounce.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17435.diff",
      "totalScore": 84,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "150 lines changed (135+/15-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "widingmarcus-cyber (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17421"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "The PR addresses a critical issue of silent message loss due to lock contention during debounce flushing. The fix implements a retry mechanism with exponential backoff, which is a robust approach. The changes are well-documented, include new tests covering different scenarios, and are backwards compatible. The impact is significant, affecting all channels using inbound debounce. The risk is low due to the thorough testing and clear explanation of the problem and solution.",
      "duplicateGroup": 4
    },
    {
      "number": 17433,
      "title": "fix(telegram): omit message_thread_id for private chats to prevent silent message drops",
      "body": "## fix(telegram): omit message_thread_id for private chats\n\nFixes #17242\n\n### Problem\n\nWhen delivering messages to Telegram private chats, the outbound send functions hardcode `scope: 'forum'` in the thread spec:\n\n```typescript\n// Before:\nconst threadSpec = messageThreadId != null\n  ? { id: messageThreadId, scope: \"forum\" as const }\n  : undefined;\n```\n\nPrivate chats (positive chatId) don't support forum topics. Telegram rejects the API call with `400: Bad Request: message thread not found`, and the message is **silently dropped** \u2014 the user sees blue checkmarks but the agent never receives/sends the message.\n\nFrom the bug report: **111 failures over 4 days** (81 on Feb 11 alone).\n\n### Root Cause\n\n`sendMessageTelegram`, `sendStickerTelegram`, and `sendPollTelegram` all construct the thread spec with `scope: 'forum'` regardless of whether the chat is a private chat or a group. The existing `buildTelegramThreadParams()` helper already correctly filters out `scope: 'dm'`, but it never sees `scope: 'dm'` because the callers always pass `'forum'`.\n\n### Fix\n\nAdd `inferThreadScope(chatId)` helper that determines scope from the chatId:\n- **Positive numeric IDs** \u2192 `'dm'` (private chat)\n- **`@`-usernames** \u2192 `'dm'` (private chat / channel)\n- **Negative numeric IDs** \u2192 `'forum'` (group/supergroup, may be forum)\n\n```typescript\n// After:\nconst threadSpec = messageThreadId != null\n  ? { id: messageThreadId, scope: inferThreadScope(chatId) }\n  : undefined;\n```\n\nThis lets the existing `buildTelegramThreadParams()` guard properly omit `message_thread_id` for private chats.\n\n### Changed Files\n\n| File | Change |\n|------|--------|\n| `src/telegram/send.ts` | Add `inferThreadScope()`; fix all 3 send functions |\n| `src/telegram/send.returns-undefined-empty-input.test.ts` | Update retry tests to use group chatIds |\n| `src/telegram/send.poll.test.ts` | Update retry test + add private chat assertion |\n\n### Testing\n\n- All 447 Telegram tests pass\n- Added new test: `omits message_thread_id for private chats (positive chatId)`\n- Existing retry tests updated to use negative chatIds (groups)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR fixes silent message drops in Telegram private chats by adding an `inferThreadScope(chatId)` helper that determines whether a chat supports forum topics based on the chat ID format. Previously, all three outbound send functions (`sendMessageTelegram`, `sendStickerTelegram`, `sendPollTelegram`) hardcoded `scope: \"forum\"` when constructing thread specs, causing `buildTelegramThreadParams()` to include `message_thread_id` even for private chats \u2014 which Telegram rejects with a 400 error.\n\n- **Root cause fix**: `inferThreadScope()` maps positive numeric IDs to `\"dm\"` and negative IDs to `\"forum\"`, letting the existing `buildTelegramThreadParams()` guard correctly omit `message_thread_id` for private chats\n- **Test updates**: Retry tests updated to use negative (group) chatIds since private chats no longer include `message_thread_id`; new test added for the private chat omission behavior\n- **Minor note**: `@`-usernames are treated as `\"dm\"` but can theoretically refer to public forum groups \u2014 unlikely to cause issues in practice since session routing uses numeric IDs\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge \u2014 it fixes a real production bug with a targeted, well-tested change\n- The fix correctly addresses the root cause identified in #17242. The approach leverages the existing `buildTelegramThreadParams()` guard rather than duplicating logic. All three affected send functions are updated consistently. Tests cover the new behavior. The only minor concern is the @-username edge case for public forum groups, which is unlikely to occur in practice but is worth noting.\n- No files require special attention \u2014 `src/telegram/send.ts` has a minor edge case with @-usernames documented in the inline comment\n\n<sub>Last reviewed commit: 7154157</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "widingmarcus-cyber",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T19:05:14Z",
      "updatedAt": "2026-02-15T19:54:13Z",
      "headRef": "fix/telegram-thread-id-private-chats-17242",
      "baseRef": "main",
      "filesChanged": 5,
      "additions": 125,
      "deletions": 17,
      "commits": 2,
      "labels": [
        "channel: telegram",
        "channel: whatsapp-web",
        "size: S"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        17242
      ],
      "changedFiles": [
        "openclaw-2026-02-15.log",
        "src/telegram/send.poll.test.ts",
        "src/telegram/send.returns-undefined-empty-input.test.ts",
        "src/telegram/send.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17433.diff",
      "totalScore": 84,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "142 lines changed (125+/17-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "widingmarcus-cyber (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17242"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "The PR addresses a critical bug causing silent message drops in Telegram private chats. The fix is well-explained, includes a new helper function to correctly infer the thread scope, and updates the tests to cover both group and private chat scenarios. The changes are isolated to the telegram module, minimizing the risk of introducing regressions elsewhere. The provided context is thorough and includes the number of failures observed. The tests passing and the addition of a new test for private chats increases confidence.",
      "duplicateGroup": 4
    },
    {
      "number": 17470,
      "title": "feat(cache): per-agent params for cacheRetention control",
      "body": "## Summary\n\n- Add optional `params` field to `AgentConfig` type for per-agent stream param overrides\n- Extend `resolveExtraParams()` to look up agent-specific params from `agents.list[].params` and merge them over global model defaults\n- Pass `sessionAgentId` through to `applyExtraParamsToAgent()` in `attempt.ts`\n\nThis lets individual agents override cacheRetention (or other stream params) without affecting other agents. Useful for disabling caching on low-traffic agents like cron jobs where cache writes ($1.25/MTok) expire before reuse.\n\n**Config example:**\n```json\n{\n  \"agents\": {\n    \"list\": [{\n      \"id\": \"risk-reviewer\",\n      \"params\": { \"cacheRetention\": \"none\" }\n    }]\n  }\n}\n```\n\nFixes #17112\n\n## Test plan\n\n- [x] Added test: per-agent params returned when agentId matches\n- [x] Added test: agent params merge over global model defaults (agent wins)\n- [x] Added test: unmatched agentId returns undefined (no side effects)",
      "author": "rrenamed",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:54:37Z",
      "updatedAt": "2026-02-15T19:54:49Z",
      "headRef": "feat/per-agent-cache-retention",
      "baseRef": "main",
      "filesChanged": 4,
      "additions": 97,
      "deletions": 1,
      "commits": 1,
      "labels": [
        "agents",
        "size: S"
      ],
      "ciStatus": "pending",
      "hasIssueRef": true,
      "issueNumbers": [
        17112
      ],
      "changedFiles": [
        "src/agents/pi-embedded-runner-extraparams.e2e.test.ts",
        "src/agents/pi-embedded-runner/extra-params.ts",
        "src/agents/pi-embedded-runner/run/attempt.ts",
        "src/config/types.agents.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17470.diff",
      "totalScore": 82,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "98 lines changed (97+/1-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "rrenamed (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17112"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "Well-defined feature with clear use case, config example, and comprehensive tests. Addresses a specific issue and provides a targeted solution. Changes are localized and the risk of unintended consequences is low.",
      "duplicateGroup": 3
    },
    {
      "number": 16761,
      "title": "sessions_spawn: inline attachments + redaction + hardening",
      "body": "Fixes #17214\n\nImage-specific request remains tracked in #16344 as a special case of general file attachments.\n\n## Summary\n\nThis Pull Request introduces robust support for passing inline attachments to sub-agents via `sessions_spawn`. This enables more complex workflows where agents require specific files, such as images for analysis (e.g., in response to a user's request to \"analyze this image\"), code snippets, or other structured data, making it a more comprehensive solution for inter-agent communication.\n\nThis feature moves beyond basic text exchange, addressing a crucial need for agents to operate on concrete file inputs.\n\n### Core Idea\n\nThe goal is to allow a spawning agent (or user) to provide files directly with a `sessions_spawn` call. These files are then safely materialized into the target sub-agent's isolated workspace, making them accessible to the sub-agent's tools and thought process. This allows for scenarios like:\n-   An agent analyzing an image provided by a user.\n-   An agent receiving a configuration file for processing.\n-   An agent getting a dataset for a specific task.\n\n### Implemented Details\n\n-   Adds `attachments[]` support to `sessions_spawn` (accepts inline content as `utf8` or `base64` encoded strings).\n-   Materializes attachments into the child sub-agent's isolated workspace at a deterministic relative path:\n    -   `.openclaw/attachments/<uuid>/`\n    -   Includes a `.manifest.json` file within this directory, containing metadata for all attached files (name, size, SHA256 hash).\n-   Returns an attachment receipt (`count`, `totalBytes`, `files`, `relDir`) in the `sessions_spawn` tool result, allowing the spawning agent to confirm successful transfer.\n-   Appends a system note to the child sub-agent's context, informing it of the canonical `relDir` where attachments can be found (the `mountPath` concept is explicitly reserved for future, more advanced mount-based implementations and is not used as a runtime path authority in this implementation).\n\n### Security and Robustness Hardening\n\nExtensive measures have been taken to ensure the security and integrity of attachment handling:\n-   **Strict Transcript Redaction**: `sessions_spawn` attachment `content` is strictly redacted from transcript persistence (both `arguments` and `input` tool-call shapes) to prevent accidental logging of sensitive data.\n-   **Robust Base64 Validation**: Implements strict base64 validation (checking alphabet, padding, and roundtrip consistency). Critically, it includes a **pre-decode encoded-size guard** to prevent memory exhaustion (DoS) from overly large base64 inputs before full decoding.\n-   **Atomic Materialization & Rollback**: Attachment staging includes atomic file writes and a comprehensive rollback mechanism: if any error occurs during materialization (e.g., validation failure, disk write issue), the partially created attachment directory is fully removed.\n-   **Spawn Failure Cleanup**: If the `agent.callGateway` (the actual sub-agent spawn) fails after attachments have been materialized, the staged attachment directory is removed according to the defined cleanup policy.\n-   **Lifecycle-Aware Cleanup**: The cleanup policy (`cleanup=delete` or `retainOnSessionKeep=false`) is fully wired into the sub-agent registry's `finalize` process, ensuring attachment directories are reliably removed after the sub-agent run completes or its session is archived.\n-   **Constrained Deletion**: Attachment directory deletion is strictly constrained to the canonical attachments root within the child sub-agent's workspace, preventing accidental deletion of files outside the intended scope (path traversal protection).\n-   **Tightened File Permissions**: File system permissions for materialized attachments are highly restricted: directories are set to `0700` and files/manifests to `0600`, ensuring only the owner (the sub-agent process) can access them.\n\n### Tests Run\n\nThe following tests have been run and passed:\n-   `pnpm lint --silent` (static code analysis)\n-   `pnpm exec vitest run --config vitest.unit.config.ts src/agents/session-transcript-repair.attachments.test.ts` (unit tests for transcript redaction and base64 handling)\n-   `pnpm exec vitest run --config vitest.e2e.config.ts src/agents/openclaw-tools.sessions.e2e.test.ts` (end-to-end tests for `sessions_spawn` functionality)\n\n---\n\n## Reviewer Guide\n\n**What to look for:**\n\n1.  **Security (Critical):**\n    *   **`sessions_spawn-tool.ts`**:\n        *   `decodeStrictBase64` logic: Confirm the `maxEncodedBytes` calculation and its enforcement *before* `Buffer.from` to prevent memory DoS.\n        *   Attachment file/dir creation (`fs.mkdir`, `fs.writeFile`): Verify `mode` (0700/0600) and `flag: \"wx\"` (no overwrite).\n        *   Error handling logic in the attachment materialization `try/catch` block: Ensure `fs.rm(absDir, { recursive: true, force: true })` is called on *any* failure to prevent residue.\n    *   **`subagent-registry.ts`**:\n        *   `safeRemoveAttachmentsDir`: Verify the `fs.realpath` and `startsWith(rootWithSep)` checks are robust against path traversal for deletion.\n        *   `finalizeSubagentCleanup`: Ensure `shouldDeleteAttachments` logic correctly triggers `safeRemoveAttachmentsDir` based on `cleanup` and `retainAttachmentsOnKeep`.\n    *   **`session-transcript-repair.ts`**:\n        *   `sanitizeToolCallInputs`: Confirm `attachments[].content` is redacted for both `arguments` and `input` fields in `sessions_spawn` tool calls.\n\n2.  **Correctness (High):**\n    *   **`sessions_spawn-tool.ts`**:\n        *   `decodeStrictBase64`: Test with various valid, invalid, and edge-case base64 strings (e.g., malformed padding, non-base64 chars, empty, very long inputs).\n        *   Attachment limits (`maxFiles`, `maxTotalBytes`, `maxFileBytes`): Ensure these are correctly enforced at various stages.\n        *   Filename validation: Check edge cases for `.` `..` `/` `\\` `\\\\^@` and ensure they are rejected.\n        *   `relDir` generation: Confirm it is deterministic and reliably points to the attachment location in the child workspace.\n        *   System prompt message: Verify it clearly states the `relDir` and the untrusted nature of attachments.\n    *   **`subagent-registry.ts`**:\n        *   `registerSubagentRun`: Ensure `attachmentsDir` and `retainAttachmentsOnKeep` are correctly recorded.\n        *   `finalizeSubagentCleanup`: Verify the timing and conditions for `safeRemoveAttachmentsDir` are correct (i.e., it doesn't try to delete before creation, and doesn't leave residue).\n\n3.  **Architecture / Design (Medium):**\n    *   **`sessions_spawn-tool.ts`**:\n        *   Confirm that the `attachAs.mountPath` field is indeed *not* used for path resolution in the MVP, but retained as a placeholder (and documented as such in the code comments).\n        *   Attachment lifecycle (creation, use, cleanup) is clear and robust.\n    *   **Overall**: Ensure that this inline attachment mechanism is a solid foundation for future extensions (e.g., streaming, more complex storage).\n\n**Suggested Manual Test Cases:**\n\n1.  **Successful Attachment**: Spawn a sub-agent with a small UTF8 text file. Verify the sub-agent can `read` the file at the reported `relDir`.\n2.  **Successful Base64 Image**: Spawn a sub-agent with a base64 encoded image (within limits). Verify the sub-agent can `read` the file (e.g., check its size or first few bytes).\n3.  **Attachment Limits**:\n    *   Send a single file exceeding `maxFileBytes`. Expect rejection.\n    *   Send multiple files whose `totalBytes` exceed `maxTotalBytes`. Expect rejection (even if individual files are fine).\n    *   Send more than `maxFiles`. Expect rejection.\n4.  **Invalid Base64**: Send an attachment with malformed base64 `content`. Expect `attachments_invalid_base64_or_too_large` error.\n5.  **Invalid Filenames**: Send attachments with `../` `//` `\\` `\\\\^@` or null bytes in the `name`. Expect `attachments_invalid_name` error.\n6.  **Duplicate Filenames**: Send multiple attachments with the same valid `name`. Expect `attachments_duplicate_name` error.\n7.  **Rollback on Materialization Error**: Simulate a disk full or permission error during file writing (manually block `fs.writeFile` in a test environment, if possible). Verify that no residual attachment directory or files are left.\n8.  **Spawn Failure Cleanup**: Trigger `sessions_spawn` with valid attachments, but ensure the actual sub-agent spawn (`callGateway<...>(method: \"agent\", ...)` fails (e.g., invalid `agentId`). Verify that the attachment directory is removed.\n9.  **`cleanup=delete`**: Spawn an agent with attachments and `cleanup=\"delete\"`. Verify the attachment directory is removed after the sub-agent completes successfully.\n10. **`cleanup=keep` (default)**: Spawn an agent with attachments and `cleanup=\"keep\"`. Verify the attachment directory *is not* removed after the sub-agent completes.\n\n\n\n\nMentions: #16344\n\n",
      "author": "napetrov",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T02:46:05Z",
      "updatedAt": "2026-02-15T19:55:00Z",
      "headRef": "napetrov/sessions-spawn-attachments",
      "baseRef": "main",
      "filesChanged": 7,
      "additions": 468,
      "deletions": 14,
      "commits": 10,
      "labels": [
        "channel: discord",
        "channel: whatsapp-web",
        "agents",
        "size: M"
      ],
      "ciStatus": "pending",
      "hasIssueRef": true,
      "issueNumbers": [
        17214
      ],
      "changedFiles": [
        "src/agents/session-transcript-repair.attachments.test.ts",
        "src/agents/session-transcript-repair.ts",
        "src/agents/subagent-registry.ts",
        "src/agents/tools/sessions-spawn-tool.ts",
        "src/discord/monitor/message-handler.preflight.ts",
        "src/media/local-roots.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/16761.diff",
      "totalScore": 81,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "482 lines changed (468+/14-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "napetrov (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17214"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "The PR introduces a significant new feature (inline attachments to sub-agents) with good test coverage and clear documentation. The use of a deterministic relative path and manifest file enhances security and manageability. However, the complexity of inter-agent communication and file handling introduces a medium risk, particularly around potential security vulnerabilities (e.g., malicious file content) and resource consumption. Further review should focus on security aspects and performance implications."
    },
    {
      "number": 17462,
      "title": "fix(cache): enable cache retention for Google Vertex AI",
      "body": "## Summary\n\n- Add `google-vertex` to the provider check in `resolveCacheRetention()` so Vertex AI users get prompt caching via the `cacheRetention` stream option\n- Add `google-vertex` to `isCacheTtlEligibleProvider()` so cache-TTL context pruning works for Vertex AI sessions\n- Add test coverage for Vertex AI caching and `isCacheTtlEligibleProvider`\n\nVertex AI uses the Anthropic Messages API natively and supports `cacheRetention`, but was excluded from both checks \u2014 meaning Vertex AI users got no prompt caching despite the API supporting it.\n\nFixes #15525\n\n## Test plan\n\n- [x] Added e2e tests verifying `cacheRetention` is applied for `google-vertex` provider\n- [x] Added e2e tests verifying `cacheRetention` is NOT applied for non-Anthropic providers (e.g., `openai`)\n- [x] Added unit tests for `isCacheTtlEligibleProvider` covering `anthropic`, `google-vertex`, `openrouter` (with/without anthropic model), and case insensitivity\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nExtended prompt caching support to Google Vertex AI provider by adding `google-vertex` to the eligible provider checks in both `resolveCacheRetention()` and `isCacheTtlEligibleProvider()`. Since Vertex AI uses the Anthropic Messages API natively, it supports the same `cacheRetention` stream option as the direct Anthropic provider.\n\n- Added `google-vertex` provider to cache retention logic in `extra-params.ts:51`\n- Added `google-vertex` provider to cache-TTL eligibility check in `cache-ttl.ts:14`\n- Added comprehensive e2e tests verifying `cacheRetention` is applied for Vertex AI\n- Added unit tests covering all providers including case-insensitivity\n- Updated inline comments to clarify both Anthropic and Vertex AI are supported\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The changes are minimal, well-tested, and logically sound. The PR adds `google-vertex` to two provider eligibility checks to enable prompt caching for Vertex AI, which already uses the Anthropic Messages API. The implementation is consistent with existing patterns, includes comprehensive test coverage (both e2e and unit tests), and updates documentation. No edge cases or breaking changes detected.\n- No files require special attention\n\n<sub>Last reviewed commit: afe01c7</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "rrenamed",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:50:04Z",
      "updatedAt": "2026-02-15T19:52:08Z",
      "headRef": "fix/vertex-ai-cache-retention",
      "baseRef": "main",
      "filesChanged": 3,
      "additions": 112,
      "deletions": 4,
      "commits": 1,
      "labels": [
        "agents",
        "size: S"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        15525
      ],
      "changedFiles": [
        "src/agents/pi-embedded-runner-extraparams.e2e.test.ts",
        "src/agents/pi-embedded-runner/cache-ttl.ts",
        "src/agents/pi-embedded-runner/extra-params.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17462.diff",
      "totalScore": 81,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "116 lines changed (112+/4-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "rrenamed (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #15525"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "This PR correctly identifies and fixes a missing provider in the cache retention logic. The changes are small, well-tested with both e2e and unit tests, and the description is clear. The Greptile summary confirms the changes are logically sound and low risk.",
      "duplicateGroup": 3
    },
    {
      "number": 17445,
      "title": "fix(pi-embedded): add aggregate timeout to compaction retry + harden SIGUSR1 restart",
      "body": "Fixes #17444\n\n## Summary\n\nThis PR addresses two related \u201csession looks hung\u201d failure modes in the PI embedded runner:\n\n1. **Compaction retry waits can block the session lane with no aggregate timeout**.\n2. **SIGUSR1 in-process restart can proceed while embedded compaction is still in-flight**, leaving session write locks held by the previous lifecycle.\n\n## What changed\n\n### 1) Bound compaction retry waits (aggregate timeout)\n\n- Add `waitForCompactionRetryWithAggregateTimeout()`.\n- In `run/attempt.ts`, replace the unbounded `await abortable(waitForCompactionRetry())` with a **60s aggregate timeout**.\n- On aggregate timeout:\n  - set `timedOutDuringCompaction = true`\n  - log a warning and proceed using the existing pre-compaction snapshot selection logic\n\nThis prevents long compaction retry waits from freezing the session lane.\n\n### 2) Harden SIGUSR1 restart against in-flight embedded runs/compaction\n\n- Increase default SIGUSR1 deferral budget: `DEFAULT_DEFERRAL_MAX_WAIT_MS` **30s \u2192 90s**.\n- Increase gateway run-loop drain budget: `DRAIN_TIMEOUT_MS` **30s \u2192 90s**.\n- On SIGUSR1 restart in the gateway run loop:\n  1. **Abort compacting embedded runs** (best-effort)\n  2. Drain **both** active command-queue tasks and active embedded runs (up to 90s)\n  3. If drain times out, **abort all embedded runs** (best-effort) and proceed\n\nThis reduces the chance that an in-process restart leaves the new lifecycle blocked behind a lock/state owned by the previous lifecycle.\n\n## Why this is safe\n\n- The aggregate timeout only affects cases where compaction retry waits would otherwise stall; normal compaction runs are unchanged.\n- Restart already implies disruption; aborting compacting runs is a targeted best-effort to ensure session locks are released.\n- Changes are localized to restart/compaction wait paths.\n\n## Tests\n\n- `src/agents/pi-embedded-runner/run/compaction-retry-aggregate-timeout.e2e.test.ts`\n- `src/agents/pi-embedded-runner/runs.e2e.test.ts`\n- Updated:\n  - `src/cli/gateway-cli/run-loop.test.ts`\n  - `src/infra/infra-runtime.test.ts`\n\nManual:\n\n```bash\npnpm -s lint\npnpm -s format:check\nnpx vitest run src/agents/pi-embedded-runner/ src/cli/gateway-cli/run-loop.test.ts src/infra/infra-runtime.test.ts --reporter=verbose\n```\n\n## Notes / follow-ups\n\n- This PR does **not** change per-attempt compaction safety timeouts; if desired, we can follow up with a smaller `EMBEDDED_COMPACTION_TIMEOUT_MS` and/or a compaction re-entry cooldown once we have more production data.",
      "author": "joeykrug",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T19:24:02Z",
      "updatedAt": "2026-02-15T19:26:17Z",
      "headRef": "fix/compaction-lane-blocking",
      "baseRef": "main",
      "filesChanged": 9,
      "additions": 390,
      "deletions": 19,
      "commits": 1,
      "labels": [
        "cli",
        "agents",
        "size: M"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        17444
      ],
      "changedFiles": [
        "src/agents/pi-embedded-runner/run/attempt.ts",
        "src/agents/pi-embedded-runner/run/compaction-retry-aggregate-timeout.e2e.test.ts",
        "src/agents/pi-embedded-runner/run/compaction-retry-aggregate-timeout.ts",
        "src/agents/pi-embedded-runner/runs.e2e.test.ts",
        "src/agents/pi-embedded-runner/runs.ts",
        "src/cli/gateway-cli/run-loop.test.ts",
        "src/cli/gateway-cli/run-loop.ts",
        "src/infra/infra-runtime.test.ts",
        "src/infra/restart.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17445.diff",
      "totalScore": 81,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "409 lines changed (390+/19-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "joeykrug (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #17444"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "medium",
      "llmReason": "Addresses two important failure modes in the PI embedded runner related to compaction and restarts. The changes include adding an aggregate timeout to compaction retries and hardening SIGUSR1 restarts. The PR includes new and updated tests, and the changes are localized to restart/compaction wait paths. The risk is medium because the changes involve concurrency and timeouts, which can be tricky to get right, and aborting runs could have unintended consequences, although the author claims it's a best-effort approach. The increased timeout values also warrant careful consideration."
    },
    {
      "number": 11602,
      "title": "fix(config): skip stale legacy config files when openclaw.json exists",
      "body": "## Summary\n\nFix for #11465 \u2014 After migrating from clawdbot to openclaw, the gateway reads stale legacy config files (clawdbot.json, moltbot.json, moldbot.json) causing validation failures and log spam every ~10 seconds via systemd restart loop.\n\n## Root Cause\n\n`resolveDefaultConfigCandidates()` in `src/config/paths.ts` generates candidate config paths including legacy filenames for every directory, even when `openclaw.json` already exists there. When a migration symlink exists (`~/.clawdbot \u2192 ~/.openclaw`), the stale legacy config gets picked up, fails validation, and the gateway crashes repeatedly.\n\n## Changes\n\n### Primary fix (`src/config/paths.ts`)\n- `resolveDefaultConfigCandidates()` now checks if `openclaw.json` exists in each candidate directory\n- If it does, legacy filenames (clawdbot.json, moltbot.json, moldbot.json) are skipped for that directory\n- Added `skipLegacyIfNewExists` option (default `true`) for backward compatibility in tests\n- Exported `LEGACY_CONFIG_FILENAMES` for use by doctor cleanup\n\n### Doctor cleanup (`src/commands/doctor-config-flow.ts`)\n- New `renameStaleLegacyConfigs()` function that renames stale legacy configs to `<name>.migrated` when `openclaw.json` exists\n- Respects `OPENCLAW_STATE_DIR` via `resolveStateDir()`\n- Called during `openclaw doctor` flow after legacy config migration\n\n### Tests\n- **`src/config/paths.test.ts`** \u2014 4 new tests:\n  - Skip legacy filenames when `openclaw.json` exists in same dir\n  - Include legacy filenames when `openclaw.json` does not exist (backward compat)\n  - Skip legacy in custom `OPENCLAW_STATE_DIR` with `openclaw.json`\n  - Symlink regression test (`~/.clawdbot \u2192 ~/.openclaw`) \u2014 the exact reported scenario\n- **`src/commands/doctor-config-flow.test.ts`** \u2014 4 new tests:\n  - Rename stale legacy configs when `openclaw.json` exists\n  - Skip when no primary config\n  - Skip when no legacy configs\n  - `.migrated` collision (safe to run doctor twice)\n- All 17 tests pass, all original tests preserved\n\n## Backward Compatibility\n\n- Legacy config paths still work for actual first-time migrations (when `openclaw.json` doesn't exist)\n- Doctor renames to `.migrated` rather than deleting (recoverable)\n- No changes to gateway startup logic\n\n## Verification\n\n```\npnpm check          \u2705 (typecheck + lint + format)\npnpm vitest run ... \u2705 (17 tests pass)\n```\n\n## Sign-Off\n\n- [x] AI-assisted (Claude Opus 4.6 via OpenClaw, with human review)\n- [x] Fully tested (17 unit tests covering all edge cases)\n- [x] Tested locally with OpenClaw instance\n- [x] Understand what the code does\n\nlobster-biscuit\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR addresses #11465 by preventing stale legacy config files (`clawdbot.json`, `moltbot.json`, `moldbot.json`) from being considered when `openclaw.json` already exists in the same directory.\n\nKey changes:\n- `src/config/paths.ts`: `resolveDefaultConfigCandidates()` now omits legacy config filenames per-directory when `openclaw.json` exists, and `resolveConfigPath()` applies the same rule for explicit `stateDir` paths. Legacy config env override support is extended by treating `CLAWDBOT_CONFIG_PATH` as a fallback when `OPENCLAW_CONFIG_PATH` is unset.\n- `src/commands/doctor-config-flow.ts`: adds `renameStaleLegacyConfigs()` and runs it during `openclaw doctor` to rename stale legacy configs to `*.migrated` once a primary `openclaw.json` exists.\n- Tests cover the primary skip behavior, the symlink regression case, state-dir override behavior, and doctor rename collision behavior.\n\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk.\n- Changes are localized to config-path candidate generation and a best-effort doctor cleanup, with targeted tests covering the reported symlink regression and state-dir override scenarios.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "akoscz",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-08T01:57:49Z",
      "updatedAt": "2026-02-15T19:24:35Z",
      "headRef": "fix/legacy-config-path-spam",
      "baseRef": "main",
      "filesChanged": 4,
      "additions": 284,
      "deletions": 22,
      "commits": 8,
      "labels": [
        "commands",
        "size: M"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/commands/doctor-config-flow.e2e.test.ts",
        "src/commands/doctor-config-flow.ts",
        "src/config/paths.test.ts",
        "src/config/paths.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/11602.diff",
      "totalScore": 81,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "306 lines changed (284+/22-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "akoscz (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "Comprehensive fix addressing a clear bug with thorough testing, including a regression test for the reported scenario. The changes are well-explained, and the doctor command cleanup provides a good user experience. The backward compatibility consideration is also a plus. The code changes appear well-structured and maintainable.",
      "duplicateGroup": 8
    },
    {
      "number": 17432,
      "title": "fix(telegram): skip message_thread_id for private chats in sticker/poll sends",
      "body": "## Summary\nPrivate chats (chatId > 0) don't support `message_thread_id`. This was fixed for `sendMessageTelegram` but not for `sendStickerTelegram` and `sendPollTelegram`, causing 'message thread not found' errors in DMs.\n\n## Changes\nNow all three functions check if chatId is positive (private chat) and use scope `'dm'` instead of `'forum'` so `buildTelegramThreadParams` returns undefined and skips the thread parameter.\n\nThis is a **proactive fix** that prevents the error entirely, rather than relying on the `sendWithThreadFallback` retry mechanism.\n\n## Test Plan\n- Updated existing tests to use negative chatIds (group chats) for testing thread fallback\n- Added new test `skips message_thread_id for private chats` in poll tests\n- All 65 telegram send tests pass\n\n## Related\nCompletes the fix from PR #17252 which only addressed `sendMessageTelegram`.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nExtends private chat thread handling from `sendMessageTelegram` to `sendStickerTelegram` and `sendPollTelegram`. All three functions now check if `chatId > 0` (private chat) and use `scope: 'dm'` to proactively skip `message_thread_id`, preventing \"message thread not found\" errors in DMs.\n\n- Consistent implementation across all three send functions\n- Prevents errors proactively rather than relying on retry fallback\n- Test coverage added for polls; existing thread fallback tests updated to use group chats (negative chatIds)\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with minimal risk - it's a focused bug fix with consistent implementation\n- The implementation correctly applies the same pattern across all three send functions, with clear logic that prevents errors proactively. Tests are comprehensive for polls and message sends, though sticker sends could benefit from an additional explicit private chat test. The fix is well-documented with comments and aligns with the existing `buildTelegramThreadParams` helper logic\n- No files require special attention\n\n<sub>Last reviewed commit: e4ed141</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "clawinho",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:02:40Z",
      "updatedAt": "2026-02-15T19:25:02Z",
      "headRef": "fix/telegram-private-chat-thread-id",
      "baseRef": "main",
      "filesChanged": 3,
      "additions": 65,
      "deletions": 7,
      "commits": 2,
      "labels": [
        "channel: telegram",
        "size: S"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/telegram/send.poll.test.ts",
        "src/telegram/send.returns-undefined-empty-input.test.ts",
        "src/telegram/send.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17432.diff",
      "totalScore": 80,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "72 lines changed (65+/7-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "clawinho (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "Comprehensive fix addressing a known issue across multiple functions. Includes proactive error prevention and thorough testing, including new tests for polls and updates to existing tests. The Greptile summary confirms the consistency and safety of the changes. Minor suggestion to add an explicit private chat test for sticker sends, but overall, a well-executed PR.",
      "duplicateGroup": 4
    },
    {
      "number": 16680,
      "title": "fix: include default Telegram account when accounts object exists",
      "body": "## Summary\nFixes #16652 - When `channels.telegram.accounts` is configured, the default provider (configured via root-level `botToken`) was silently excluded from the account list, preventing it from starting.\n\n## Problem\nUsers configuring multi-account Telegram setups experienced the default provider failing to start:\n- Root-level `botToken` configured \u2713\n- Sub-accounts in `accounts` object start correctly \u2713  \n- Default provider never starts \u2717\n\n## Root Cause\n`listTelegramAccountIds()` only returned accounts from the `accounts` object, ignoring root-level `botToken`/`tokenFile`.\n\n## Changes\n- Modified `listTelegramAccountIds()` in `src/telegram/accounts.ts`\n- Check for root-level `botToken`/`tokenFile`\n- Include `DEFAULT_ACCOUNT_ID` when root token exists, even if `accounts` object is present\n- Preserves existing behavior when no `accounts` object is configured\n\n## Testing\n- \u2705 Verified logic handles all configuration scenarios\n- \u2705 Linting and formatting passed\n- \u2705 No breaking changes to existing single-account setups\n\n## Configuration Example\nThe fix enables this configuration to work correctly:\n```json\n{\n  \"channels\": {\n    \"telegram\": {\n      \"botToken\": \"xxx\",  // Default account - now works!\n      \"accounts\": {\n        \"secondary\": {\n          \"botToken\": \"yyy\"\n        }\n      }\n    }\n  }\n}\n```\n\nBoth providers will now start as expected.\n\n\ud83e\udd16 Generated with Claude Code\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nFixes `listTelegramAccountIds()` to include the `DEFAULT_ACCOUNT_ID` (\"default\") when a root-level `botToken` or `tokenFile` is configured alongside a `channels.telegram.accounts` object. Previously, the default provider was silently excluded from the account list in multi-account setups, preventing it from starting.\n\n- `listTelegramAccountIds()` now checks for root-level `botToken`/`tokenFile` and appends `DEFAULT_ACCOUNT_ID` to the result set when present and not already included via the `accounts` object.\n- Existing behavior is preserved: single-account setups, env-var-only setups, and explicit `default` entries in the `accounts` object all continue to work as before.\n- The `Set` deduplication ensures no duplicates when `DEFAULT_ACCOUNT_ID` appears from multiple sources (configured accounts, bound accounts, or the new root-token check).\n- No test coverage was added for the `listTelegramAccountIds` function itself \u2014 existing tests only cover `resolveTelegramAccount`. Direct unit tests for the listing function would strengthen confidence in the fix.\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with minimal risk \u2014 targeted fix with correct deduplication logic and no breaking changes.\n- The change is small, focused, and logically sound. All configuration scenarios produce correct results. The only gap is the absence of direct unit tests for listTelegramAccountIds, which limits confidence from 5 to 4.\n- No files require special attention. The single changed file is straightforward and correct.\n\n<sub>Last reviewed commit: 75109a7</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "BinHPdev",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T00:53:53Z",
      "updatedAt": "2026-02-15T19:16:46Z",
      "headRef": "fix/telegram-default-provider-16652",
      "baseRef": "main",
      "filesChanged": 3,
      "additions": 21,
      "deletions": 2,
      "commits": 2,
      "labels": [
        "channel: telegram",
        "channel: whatsapp-web",
        "size: XS"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        16652
      ],
      "changedFiles": [
        ".github/workflows/ci.yml",
        "src/telegram/accounts.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/16680.diff",
      "totalScore": 80,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "23 lines changed (21+/2-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "BinHPdev (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #16652"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "The PR addresses a clear bug with a well-defined root cause and a targeted fix. The changes are isolated to a single function, and the testing section indicates thorough verification of different configuration scenarios. The inclusion of a configuration example and the Greptile overview further enhance the PR's quality. The risk is low because the changes are localized and well-tested, and the fix preserves existing behavior."
    },
    {
      "number": 17456,
      "title": "fix(test): stabilize media root guard test against tmpdir HOME overlap",
      "body": "## fix(test): stabilize media root guard test\n\n### Problem\n\nThe test `rejects default OpenClaw state per-agent workspace-* roots without explicit local roots` in `src/web/media.test.ts` **fails on every CI run** (bun + node), including on `main`.\n\n### Root Cause\n\nThe test harness sets `HOME` to a temp directory under `os.tmpdir()`:\n\n```\nHOME=/tmp/openclaw-test-home-xC06Jb\n```\n\nSince `os.tmpdir()` (`/tmp`) is a default allowed media root, **all paths** under the test's `HOME` directory match the tmpdir root:\n\n```\ntestPath: /tmp/openclaw-test-home-xC06Jb/.openclaw-guard-reject-test/workspace-clawdy/tmp/render.bin\nroot /tmp \u2192 MATCH (startsWith /tmp/)\n```\n\nThe test expects a rejection but gets a successful resolve because the path is \"allowed\" via tmpdir.\n\n### Fix\n\nPin `OPENCLAW_STATE_DIR` to `/var/openclaw-guard-reject-test` (outside `/tmp`) for the duration of the test. This is the same pattern used in `be9b5cefb` for the `web media loading` describe block, which was missing from the separate `local media root guard` describe block.\n\n### Changed Files\n\n| File | Change |\n|------|--------|\n| `src/web/media.test.ts` | Pin OPENCLAW_STATE_DIR in the failing test |\n\n### Testing\n\n- All 22 media tests pass (previously 21 pass / 1 fail)\n- This fixes the CI failure visible on `main` and all open PRs\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nFixes test flakiness by pinning `OPENCLAW_STATE_DIR` to `/var/openclaw-guard-reject-test` (outside `/tmp`) for the duration of the test. The test was failing because the harness sets `HOME` to a temp directory under `os.tmpdir()` (`/tmp`), and since `/tmp` is a default allowed media root, all paths under the test's `HOME` were incorrectly matching the tmpdir root instead of being rejected as expected.\n\n- Correctly isolates the test environment to ensure the rejection path is tested\n- Properly restores previous `OPENCLAW_STATE_DIR` value after the test\n- Follows the pattern established for similar tests in the same file\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The change is narrowly scoped to a single test, uses established patterns from the same file, properly handles cleanup, and directly addresses the root cause of the test failure. The fix isolates the test environment correctly without affecting production code or other tests.\n- No files require special attention\n\n<sub>Last reviewed commit: ebbcfe6</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "widingmarcus-cyber",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T19:40:49Z",
      "updatedAt": "2026-02-15T19:44:48Z",
      "headRef": "fix/media-test-state-dir-isolation-17445",
      "baseRef": "main",
      "filesChanged": 1,
      "additions": 22,
      "deletions": 10,
      "commits": 1,
      "labels": [
        "channel: whatsapp-web",
        "size: XS"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17456.diff",
      "totalScore": 79,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "32 lines changed (22+/10-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "widingmarcus-cyber (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "The PR addresses a flaky test by correctly isolating the test environment. The fix is well-explained, targeted, and includes testing to confirm the resolution. The change is small and localized, reducing the risk of unintended consequences. The use of a pattern already established in the same file further reduces risk.",
      "duplicateGroup": 1
    },
    {
      "number": 16779,
      "title": "feat: add `openclaw sessions scrub` command and doctor check for secret leaks",
      "body": "## Summary\n\nCloses #11468\n\nRecreated from #11544 as a clean single-commit branch (the previous PR was closed for having too many unrelated commits).\n\nAdds two features to address `config.get` leaking secrets into session transcripts:\n\n1. **`openclaw sessions scrub`** \u2014 CLI command that scans historical session JSONL files and redacts leaked secrets in-place (with backup by default)\n2. **`openclaw doctor` check** \u2014 detects unredacted secrets in session files and warns the user\n\n## What's included\n\n### New files\n- `src/commands/sessions-scrub.ts` \u2014 scrub command implementation\n- `src/commands/doctor-sessions-secrets.ts` \u2014 doctor check for session secrets\n- `docs/cli/sessions-scrub.md` \u2014 documentation\n\n### Modified files\n- `src/cli/program/register.status-health-sessions.ts` \u2014 Commander.js registration, `sessions` becomes a command group with backward compat\n- `src/commands/doctor.ts` \u2014 wires in the new session secrets check\n\n### Design decisions\n- Reuses canonical `maskToken()` pattern from `src/logging/redact.ts` \u2014 no duplicated regex\n- Creates `.bak` backups by default; `--no-backup` to skip\n- Doctor check scans all files if \u2264200, deterministic sample for larger dirs\n- `openclaw sessions` (no subcommand) still works as before (lists sessions)\n- Multi-pass scrub loop with oscillation guard for stable redaction\n\n### Tests\n- 10 unit tests for sessions scrub (`src/commands/sessions-scrub.test.ts`)\n- 7 unit tests for doctor check (`src/commands/doctor-sessions-secrets.test.ts`)\n- All 17 tests passing\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nAdds `openclaw sessions scrub` CLI command for at-rest redaction of leaked secrets in session JSONL files, plus a `doctor` check that warns users about unredacted secrets. The implementation is well-structured: scrub uses the canonical `redactSensitiveText` from `redact.ts`, includes a multi-pass loop with oscillation detection, bounded concurrency for performance, and `.bak` backups by default. The `sessions` command is cleanly promoted from a leaf to a command group (matching the existing `agents` pattern) with backward compatibility preserved.\n\n- Documentation states files are processed \"sequentially\" but the implementation uses bounded concurrency (default 20 workers) \u2014 docs should be corrected\n- `parsePattern` in `doctor-sessions-secrets.ts` duplicates the private function in `redact.ts`; consider exporting a shared version to prevent drift\n- Test coverage is thorough (17 tests covering dry-run, backup, multi-pass, oscillation guard, edge cases)\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with minor documentation fixes needed\n- The core logic is sound: the scrub command correctly uses the canonical redaction utilities, the concurrency pattern is safe in Node.js, the oscillation guard prevents infinite loops, and the backward-compatible command group promotion follows established codebase patterns. The only actionable issue is a documentation inaccuracy (sequential vs concurrent processing). The duplicated parsePattern is a maintenance risk but not a runtime bug. Test coverage is solid at 17 tests.\n- docs/cli/sessions-scrub.md (documentation inaccuracy about processing model)\n\n<sub>Last reviewed commit: bec7b8e</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "akoscz",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T03:46:23Z",
      "updatedAt": "2026-02-15T19:24:21Z",
      "headRef": "feature/sessions-scrub-clean",
      "baseRef": "main",
      "filesChanged": 10,
      "additions": 1125,
      "deletions": 12,
      "commits": 4,
      "labels": [
        "docs",
        "gateway",
        "cli",
        "commands",
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        11468
      ],
      "changedFiles": [
        "docs/cli/sessions-scrub.md",
        "src/cli/program/register.status-health-sessions.ts",
        "src/cli/program/routes.ts",
        "src/commands/doctor-sessions-secrets.test.ts",
        "src/commands/doctor-sessions-secrets.ts",
        "src/commands/doctor.ts",
        "src/commands/sessions-scrub.test.ts",
        "src/commands/sessions-scrub.ts",
        "src/gateway/session-utils.fs.ts",
        "src/logging/redact.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/16779.diff",
      "totalScore": 79,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "1137 lines changed (1125+/12-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "akoscz (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #11468"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "Well-structured PR with clear purpose, good test coverage, and documentation. Addresses a critical security concern (secret leakage). The design decisions are sound, including backup creation and oscillation guard. The use of existing redaction patterns is excellent. The Greptile overview confirms a thorough and well-considered implementation.",
      "duplicateGroup": 8
    },
    {
      "number": 3527,
      "title": "fix: detect and manage systemd system services",
      "body": "## Problem\n\nThe CLI only detected and managed systemd user services (~/.config/systemd/user/), which failed on VPS/server installs where the gateway runs as a system service (/etc/systemd/system/).\n\nThis caused:\n- clawdbot status to incorrectly report \"Gateway service | systemd not installed\"\n- clawdbot gateway restart to fail with \"systemctl --user unavailable\"\n\nFixes #1818\n\n## Related Work\n\nComplements PR #3440 which adds systemd templates for production deployment. This PR makes the CLI actually detect and manage those system services once installed.\n\n## Changes\n\n- Check both user and system service paths for unit files\n- Try user service first, fall back to system service with sudo\n- Update isSystemdServiceEnabled to check both locations\n- Update readSystemdServiceRuntime to read from both locations  \n- Update stop/restart to work with both service types\n- Add resolveSystemdSystemUnitPathForName helper\n\n## Testing\n\n- [ ] Test on system with user service (should work as before)\n- [ ] Test on system with system service (should now detect correctly)\n- [ ] Test clawdbot status shows correct service status\n- [ ] Test service management commands work with system service\n\n## Backwards Compatibility\n\nUser services are still preferred. The changes only add fallback to system services when user services aren't found or accessible.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR updates the Linux/systemd service management helpers to support gateway installs as **system services** (e.g. `/etc/systemd/system/*.service`) in addition to the existing **user service** support (`~/.config/systemd/user`). It adds a system unit path resolver, makes exec-start reading try user then system unit files, and updates stop/restart/is-enabled/runtime reads to attempt `systemctl --user ...` first and fall back to `sudo systemctl ...` for system units.\n\nNon-systemd changes are minor: a small type change in the Google Chat extension account config lookup, a quick-replies refactor in the LINE extension, and a reorder of the `package.json` publish `files` list.\n\nMain integration point is `src/daemon/service.ts`, which delegates all Linux gateway service operations to `src/daemon/systemd.ts`. These changes therefore affect `openclaw gateway status/restart/stop` flows on Linux.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR is directionally correct but has a few behavioral/typing issues that could break non-interactive environments and degrade runtime/status reporting.\n- Score lowered due to new `sudo`-based fallback that may block waiting for a password (no `-n`), a likely runtime field mismatch (`lastExitReason` vs `lastRunResult`) affecting status display, and type-safety regressions in extension config access. The rest of the changes are localized and understandable.\n- src/daemon/systemd.ts (sudo fallback + runtime fields), src/cli/daemon-cli/shared.ts (Linux log hints), extensions/googlechat/src/accounts.ts (config typing), extensions/line/src/channel.ts (quickReplies typing).\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "growthringsadvisory",
      "authorAssociation": "NONE",
      "createdAt": "2026-01-28T18:57:36Z",
      "updatedAt": "2026-02-15T19:53:51Z",
      "headRef": "fix/system-service-detection",
      "baseRef": "main",
      "filesChanged": 39,
      "additions": 254,
      "deletions": 124,
      "commits": 27,
      "labels": [
        "channel: googlechat",
        "channel: whatsapp-web",
        "app: macos",
        "gateway",
        "cli",
        "size: M"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        1818
      ],
      "changedFiles": [
        ".swiftformat",
        "apps/macos/Tests/OpenClawIPCTests/AgentEventStoreTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/AnyCodableEncodingTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/CameraCaptureServiceTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/CameraIPCTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/CanvasIPCTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/CanvasWindowSmokeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/CommandResolverTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/CronJobEditorSmokeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayChannelConfigureTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayChannelConnectTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayChannelRequestTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayChannelShutdownTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayConnectionControlTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayFrameDecodeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/GatewayProcessManagerTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/HealthDecodeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/HealthStoreStateTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/LogLocatorTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/LowCoverageHelperTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/LowCoverageViewSmokeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/MacNodeRuntimeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/OpenClawOAuthStoreTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/PermissionManagerLocationTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/PermissionManagerTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/UtilitiesTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/VoicePushToTalkHotkeyTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/VoiceWakeGlobalSettingsSyncTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/WebChatSwiftUISmokeTests.swift",
        "apps/macos/Tests/OpenClawIPCTests/WorkActivityStoreTests.swift",
        "extensions/googlechat/src/accounts.ts",
        "src/browser/server.post-tabs-open-profile-unknown-returns-404.test.ts",
        "src/cli/daemon-cli/shared.ts",
        "src/cron/service/store.ts",
        "src/daemon/service-runtime.ts",
        "src/daemon/systemd.ts",
        "src/gateway/server-runtime-config.test.ts",
        "src/security/windows-acl.test.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/3527.diff",
      "totalScore": 78,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "378 lines changed (254+/124-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "growthringsadvisory (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #1818"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "The PR addresses a significant issue by enabling the CLI to manage systemd system services, which is crucial for VPS/server deployments. The changes are well-explained, and the testing plan covers both user and system service scenarios. The backwards compatibility considerations are also well-addressed. The risk is low because the changes primarily add functionality and fallback mechanisms, minimizing the potential for regressions. The greptile summary confirms the changes are focused and well-defined.",
      "duplicateGroup": 0
    },
    {
      "number": 17437,
      "title": "fix(completion): avoid rc=1 for optionless zsh leaf commands",
      "body": "## Summary\r\n- fix zsh completion generation for leaf commands that have no options\r\n- avoid emitting an empty `_arguments -C` block for those leaves\r\n- emit a no-op leaf function (`return 0`) instead\r\n- add a regression test in `src/wizard/onboarding.completion.test.ts`\r\n\r\n## Why\r\nSome generated zsh leaf functions ended up with an empty `_arguments -C` body, which returned non-zero (rc=1) when invoked. This makes completion behavior brittle for optionless leaf commands.\r\n\r\n## Verification\r\n- `npx pnpm vitest src/wizard/onboarding.completion.test.ts` \u2705\r\n- `npx pnpm exec oxfmt --check src/cli/completion-cli.ts src/wizard/onboarding.completion.test.ts` \u2705\r\n- `npx pnpm exec oxlint --type-aware src/cli/completion-cli.ts src/wizard/onboarding.completion.test.ts` \u2705\r\n- manual repro with generated mini zsh completion: `_openclaw_config_unset` returns `rc:0` \u2705\r\n\r\n<!-- greptile_comment -->\r\n\r\n<h3>Greptile Summary</h3>\r\n\r\nFixes zsh completion generation for leaf commands with no options. Previously, `generateZshSubcommands` emitted `_arguments -C` with no arguments for optionless leaf commands, causing a non-zero return code (rc=1) in zsh. The fix adds a three-way branch: leaf-with-options keeps `_arguments -C`, leaf-without-options emits `return 0`, and branch commands conditionally include the options line only when present. The `generateZshCompletion` function is also exported to enable a new regression test.\r\n\r\n- **Leaf commands (no options)**: Now emit a no-op `return 0` function instead of an empty `_arguments -C` call\r\n- **Branch commands (no options, has subcommands)**: Now omit the empty options line rather than generating a blank `_arguments` argument\r\n- **Test coverage**: Adds a regression test verifying the no-op leaf function pattern\r\n\r\n<h3>Confidence Score: 5/5</h3>\r\n\r\n- This PR is safe to merge \u2014 it's a targeted fix with correct logic and a regression test.\r\n- The change is small and well-scoped: it fixes an edge case in zsh completion generation where optionless leaf commands produced an empty `_arguments -C` call (rc=1). The three-way branching logic is correct, template literal indentation aligns properly in all code paths, and a regression test covers the new behavior. The only other change is exporting a previously private function for testability, which has no side effects.\r\n- No files require special attention.\r\n\r\n<sub>Last reviewed commit: e949bf7</sub>\r\n\r\n<!-- greptile_other_comments_section -->\r\n\r\n<!-- /greptile_comment -->",
      "author": "ephelia-ai",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:09:28Z",
      "updatedAt": "2026-02-15T19:29:04Z",
      "headRef": "patch-3",
      "baseRef": "main",
      "filesChanged": 2,
      "additions": 26,
      "deletions": 5,
      "commits": 2,
      "labels": [
        "cli",
        "size: XS"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/cli/completion-cli.ts",
        "src/wizard/onboarding.completion.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17437.diff",
      "totalScore": 78,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "31 lines changed (26+/5-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "ephelia-ai (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "The PR addresses a specific bug in zsh completion generation for leaf commands without options. The solution is well-defined, includes a regression test, and has been verified with manual testing. The code changes are small and focused, reducing the risk of unintended side effects. The greptile summary further reinforces the confidence in the fix."
    },
    {
      "number": 17452,
      "title": "ci: Grant write perms for Issues for formal-conformance.yml",
      "body": "This pull request makes a minor update to the GitHub Actions workflow configuration by adjusting permissions to ensure proper functionality.\r\n\r\n* Updated the `.github/workflows/formal-conformance.yml` workflow to explicitly add `issues: write` permission, which is required for the workflow to function correctly.\r\n\r\nThat's it.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded `issues: write` permission to the formal-conformance workflow, which is required for the workflow to post comments on pull requests using `github.rest.issues.createComment()` (line 126).\n\n- The permission is necessary because GitHub treats PR comments as issue comments in the REST API\n- Without this permission, the workflow would fail when attempting to post the drift detection comment\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- Single-line addition of a required permission for an existing API call; the change is necessary for correct workflow functionality and carries no risk\n- No files require special attention\n\n<sub>Last reviewed commit: badca70</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
      "author": "thesomewhatyou",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T19:33:13Z",
      "updatedAt": "2026-02-15T19:55:40Z",
      "headRef": "patch-1",
      "baseRef": "main",
      "filesChanged": 1,
      "additions": 1,
      "deletions": 0,
      "commits": 3,
      "labels": [
        "size: XS"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        ".github/workflows/formal-conformance.yml"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17452.diff",
      "totalScore": 77,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 20,
          "weight": 0.1,
          "reason": "1 lines changed (1+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "thesomewhatyou (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 50,
          "weight": 0.15,
          "reason": "<3 lines, No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "The PR adds a necessary permission for a workflow to function correctly. The change is small, well-explained, and the Greptile summary confirms its purpose and safety. High confidence and minimal risk.",
      "duplicateGroup": 2
    },
    {
      "number": 15080,
      "title": "feat(hooks): add exec:completed and exec:failed hook events",
      "body": "## Summary\n\nAdds event-driven hook events for exec/process completion, closing a gap in the hooks system where exec lifecycle has no hook coverage.\n\n### Motivation\n\nCurrently, the only way to know when a backgrounded exec finishes is via the system-event notification (which requires `notifyOnExit` and only fires for backgrounded processes). Hooks like training monitors, CI pipelines, and deployment scripts need event-driven notification when *any* exec finishes \u2014 not just backgrounded ones with `notifyOnExit` set.\n\nThis enables patterns like:\n- **Training monitor hook**: Get notified when a long ML training run finishes without polling\n- **CI/CD hook**: Trigger deployment when a build completes\n- **Audit hook**: Log all exec completions with exit codes and duration\n\n### Changes\n\n**New events:**\n- `exec:completed` \u2014 Process exited with code 0\n- `exec:failed` \u2014 Non-zero exit, signal kill, or timeout\n- `exec` \u2014 General listener that fires for both\n\n**Event context payload:**\n```typescript\n{\n  sessionId: string;\n  slug?: string;\n  exitCode: number | null;\n  exitSignal: string | number | null;\n  timedOut: boolean;\n  durationMs: number;\n  tailOutput: string;\n  backgrounded: boolean;\n  nodeId?: string;  // for remote node exec\n}\n```\n\n**Coverage:** Fires for all three exec paths:\n- Local foreground/background processes\n- Gateway-approved (deferred) exec\n- Remote node exec via `node.invoke`\n\n### Files Changed\n\n| File | Change |\n|------|--------|\n| `src/hooks/internal-hooks.ts` | New types + `createExecCompletionEvent()` + `isExecCompletionEvent()` |\n| `src/hooks/hooks.ts` | Re-export new types and helpers |\n| `src/agents/bash-tools.exec.ts` | Emit hooks at all exit points |\n| `src/hooks/exec-completion-hooks.test.ts` | 10 unit tests |\n| `docs/automation/hooks.md` | Exec Events section with example hook |\n\n### Test Plan\n\n- [x] 10 unit tests covering event creation, type guards, handler dispatch, error isolation\n- [x] Verified all three exec paths emit the hook\n- [x] Documentation updated with example training monitor hook\n\n### Design Decisions\n\n- **Fires for ALL exec completions**, not just backgrounded ones \u2014 hooks can filter by `context.backgrounded` if they only care about background jobs\n- **Fire-and-forget** (`void triggerInternalHook(...)`) \u2014 exec completion is not blocked by hook handlers\n- **`nodeId` field** distinguishes local vs remote exec for hooks that need to know\n- Follows existing hook patterns: same event shape, same error isolation, same registration API\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR adds new internal hook events for exec completion (`exec:completed`, `exec:failed`, and the general `exec` listener) by extending the hook event type union, introducing `ExecCompletionHookContext`/`ExecCompletionHookEvent` plus helpers (`createExecCompletionEvent`, `isExecCompletionEvent`), and emitting these events from the exec tool across local, gateway-approved (deferred), and node exec paths. It also adds unit tests for event creation/dispatch and updates the hooks docs with an \u201cExec Events\u201d section and example handler.\n\nMain correctness concern: the local exec timeout path emits an exec completion hook event with `timedOut: false`, even though the execution outcome is settled with `timedOut: true`, so hook consumers won\u2019t be able to detect timeouts reliably from the documented context payload.\n\n<h3>Confidence Score: 3/5</h3>\n\n- This PR is close to mergeable but has a correctness issue in the local timeout hook payload and a couple of documentation/cleanup fixes to address.\n- Hook wiring and tests look coherent, but `exec:failed` events for local timeouts currently misreport `context.timedOut`, which breaks the advertised contract for hook consumers. Docs also contain an outdated event type union snippet, and there\u2019s a duplicated JSDoc block in the exec tool file.\n- src/agents/bash-tools.exec.ts, docs/automation/hooks.md\n\n<sub>Last reviewed commit: df0775c</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
      "author": "grunt3714-lgtm",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-13T00:15:21Z",
      "updatedAt": "2026-02-15T19:31:10Z",
      "headRef": "feat/exec-completion-hooks",
      "baseRef": "main",
      "filesChanged": 5,
      "additions": 361,
      "deletions": 6,
      "commits": 2,
      "labels": [
        "docs",
        "agents",
        "size: M"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "docs/automation/hooks.md",
        "src/agents/bash-tools.exec.ts",
        "src/hooks/exec-completion-hooks.test.ts",
        "src/hooks/hooks.ts",
        "src/hooks/internal-hooks.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/15080.diff",
      "totalScore": 77,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "367 lines changed (361+/6-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "grunt3714-lgtm (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "Comprehensive feature addition with good test coverage and documentation. The new hooks address a clear need and the provided context payload is well-defined. The changes are isolated and the test plan is thorough, mitigating potential risks."
    },
    {
      "number": 17419,
      "title": "Discord: add component UI support",
      "body": "## Summary\n\nDescribe the problem and fix in 2\u20135 bullets:\n\n- Problem: Discord lacked agent-driven interactive UI (components + modals) for dynamic prompts.\n- Why it matters: agents need buttons/selects/forms for approvals and structured input.\n- What changed: added component schema/builders, registry + handlers, send path, reply routing, tests, and docs.\n- What did NOT change (scope boundary): no changes to other channels or command registration flow.\n\n## Change Type (select all)\n\n- [ ] Bug fix\n- [x] Feature\n- [ ] Refactor\n- [x] Docs\n- [ ] Security hardening\n- [ ] Chore/infra\n\n## Scope (select all touched areas)\n\n- [x] Gateway / orchestration\n- [x] Skills / tool execution\n- [ ] Auth / tokens\n- [ ] Memory / storage\n- [x] Integrations\n- [ ] API / contracts\n- [ ] UI / DX\n- [ ] CI/CD / infra\n\n## Linked Issue/PR\n\n- Closes #N/A\n- Related #N/A\n\n## User-visible / Behavior Changes\n\n- Agents can send Discord v2 component containers with buttons/selects and optional modal forms.\n- Interaction results are routed back to the agent as normal inbound messages (replyToMode honored).\n\n## Security Impact (required)\n\n- New permissions/capabilities? (No)\n- Secrets/tokens handling changed? (No)\n- New/changed network calls? (Yes)\n- Command/tool execution surface changed? (Yes)\n- Data access scope changed? (No)\n- If any `Yes`, explain risk + mitigation:\n  - Uses existing Discord API endpoints; allowlists + DM policy checks still gate interactions.\n  - Components are one-off with TTL + registry validation.\n\n## Repro + Verification\n\n### Environment\n\n- OS: N/A\n- Runtime/container: N/A\n- Model/provider: N/A\n- Integration/channel (if any): Discord\n- Relevant config (redacted): N/A\n\n### Steps\n\n1. Not run.\n\n### Expected\n\n- N/A\n\n### Actual\n\n- N/A\n\n## Evidence\n\nAttach at least one:\n\n- [ ] Failing test/log before + passing after\n- [ ] Trace/log snippets\n- [ ] Screenshot/recording\n- [ ] Perf numbers (if relevant)\n\n## Human Verification (required)\n\nWhat you personally verified (not just CI), and how:\n\n- Verified scenarios: Not run.\n- Edge cases checked: Not run.\n- What you did **not** verify: All runtime behaviors.\n\n## Compatibility / Migration\n\n- Backward compatible? (Yes)\n- Config/env changes? (No)\n- Migration needed? (No)\n- If yes, exact upgrade steps: N/A\n\n## Failure Recovery (if this breaks)\n\n- How to disable/revert this change quickly: revert this PR or stop sending `components` payloads.\n- Files/config to restore: none (code-only).\n- Known bad symptoms reviewers should watch for: Discord component interactions failing or missing replies.\n\n## Risks and Mitigations\n\nList only real risks for this PR. Add/remove entries as needed. If none, write `None`.\n\n- Risk: malformed component payloads cause Discord API errors.\n  - Mitigation: schema validation + clear error messages before send.\n- Risk: unexpected reply reference behavior in component responses.\n  - Mitigation: replyToMode used consistently; components include messageId for reply references.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded Discord components v2 support for interactive UI (buttons, selects, modals) in agent messages. The implementation includes:\n- Component schema validation and builders (`components.ts`, 1088 LOC)\n- Registry with TTL-based expiry for one-time component IDs (`components-registry.ts`)\n- Carbon-based handlers for button/select/modal interactions with DM policy and allowlist checks (`agent-components.ts`, 916 LOC added)\n- Integration into message tool schema and Discord send path\n- Tests cover basic schema validation and registry consume behavior\n\nThe change routes component interactions back to agents as inbound messages, reusing existing Discord `replyToMode` and session resolution logic.\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is mostly safe to merge with minor attention needed for link button edge cases\n- The implementation is well-structured with proper validation, security checks (DM policy, allowlists, channel spoofing prevention), and TTL-based registry. One minor edge case exists with link button URL validation that should be tightened. Test coverage is present but could be more comprehensive for interaction handling flows.\n- Pay attention to `src/discord/components.ts` (link button URL handling) and `src/discord/monitor/agent-components.ts` (complex interaction routing logic)\n\n<sub>Last reviewed commit: c308624</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "thewilloftheshadow",
      "authorAssociation": "MEMBER",
      "createdAt": "2026-02-15T18:50:03Z",
      "updatedAt": "2026-02-15T19:55:19Z",
      "headRef": "discord-components-ui",
      "baseRef": "main",
      "filesChanged": 14,
      "additions": 2775,
      "deletions": 43,
      "commits": 4,
      "labels": [
        "docs",
        "channel: discord",
        "agents",
        "maintainer",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "docs/channels/discord.md",
        "extensions/discord/src/channel.ts",
        "src/agents/tools/discord-actions-messaging.ts",
        "src/agents/tools/message-tool.ts",
        "src/channels/plugins/actions/discord/handle-action.ts",
        "src/discord/components-registry.ts",
        "src/discord/components.test.ts",
        "src/discord/components.ts",
        "src/discord/monitor/agent-components.test.ts",
        "src/discord/monitor/agent-components.ts",
        "src/discord/monitor/provider.ts",
        "src/discord/send.components.ts",
        "src/discord/send.ts",
        "src/infra/outbound/message-action-runner.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17419.diff",
      "totalScore": 76,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "2818 lines changed (2775+/43-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 90,
          "weight": 0.15,
          "reason": "thewilloftheshadow (MEMBER)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Comprehensive PR description covering problem, solution, scope, and security. Includes tests and documentation. The 'medium' risk stems from the introduction of a new feature (Discord component UI) and changes to the command/tool execution surface, requiring careful review of the implementation details and security considerations. The lack of repro steps and evidence is a minor concern."
    },
    {
      "number": 16554,
      "title": "fix(agent): prevent session deadlock on timeout during tool execution",
      "body": "## Summary\r\n\r\nPrevents incorrect auth profile rotation when timeouts occur during long-running tool execution (e.g., SSH commands, file operations >600s). This PR implements tool execution timeout classification using the same proven patterns from the compaction timeout fix (PR #9855).\r\n\r\nRefs #14228\r\n\r\n## Problem\r\n\r\nWhen an agent run exceeds the 600s timeout **during tool execution** (not compaction), the system incorrectly rotates auth profiles as if the timeout was caused by a provider issue. This wastes auth profiles and can lead to exhaustion. Additionally, tool execution state may not be properly cleaned up, leading to resource leaks.\r\n\r\n### Environment\r\n- Observed in production on long-running tools (SSH exec, file transfers, process monitoring)\r\n- Default 600s timeout insufficient for legitimate operations\r\n- Auth profile rotation triggered incorrectly (tool timeout \u2260 provider issue)\r\n\r\n## Root Cause\r\n\r\nTool execution events flow through async handlers (`handleToolExecutionStart`, `handleToolExecutionEnd`) that:\r\n1. May not check the abort/unsubscribed flag at all async boundaries\r\n2. Don't distinguish tool execution timeouts from provider timeouts\r\n3. Can leave session state inconsistent with concurrent tools\r\n4. Cause unnecessary auth profile rotation (tool timeout \u2260 provider issue)\r\n\r\n## Solution\r\n\r\nFollowing the proven pattern from PR #9855 (compaction timeout fix):\r\n\r\n### 1. Reference-Counted State Tracking\r\n- **Reference counting** (`toolExecutionCount`) to properly handle concurrent tools\r\n- **Snapshot state** (`activeToolName`, `activeToolCallId`, `activeToolStartTime`) tracks most recent tool for timeout classification\r\n- `toolExecutionInFlight` flag derived from reference count (`count > 0`)\r\n- `toolStartData` map moved from module-level to context state (prevents cross-session corruption)\r\n\r\n### 2. Timeout Classification\r\n- Add `timedOutDuringToolExecution` flag (mirrors `timedOutDuringCompaction` from PR #9855)\r\n- Classify timeouts based on execution stage:\r\n  - During tool execution \u2192 `timedOutDuringToolExecution = true`\r\n  - During compaction \u2192 `timedOutDuringCompaction = true` (from PR #9855)\r\n  - During LLM call \u2192 neither flag set\r\n- Capture tool execution snapshot with validated tool name, call ID, start time, and duration\r\n- Validate snapshot quality before trusting classification (string lengths, duration bounds)\r\n\r\n### 3. Race Condition Protection\r\n- **Three `unsubscribed` checks** at async boundaries in `handleToolExecutionStart`:\r\n  1. **Before any work** - early return if already unsubscribed\r\n  2. **After flush operations** - early return if unsubscribed during flush\r\n  3. **After hook execution** - cleanup state and return if unsubscribed during hook\r\n- **Conditional snapshot clearing** - only clear `activeToolName/CallId/StartTime` if `toolCallId` matches current\r\n- **Finally block** always cleans up `toolStartData` map to prevent memory leaks\r\n- Early return in `handleToolExecutionEnd` if unsubscribed\r\n\r\n### 4. Concurrent Tool Support\r\n- **Reference counting** increments on start, decrements on end\r\n- `Math.max(0, count - 1)` prevents negative counts on duplicate calls\r\n- `toolExecutionInFlight` consistently derived from `count > 0` everywhere\r\n- Snapshot fields track only the most recent tool (for timeout debugging context)\r\n- Reference count tracks all active tools (for accurate timeout classification)\r\n\r\n### 5. Skip Auth Profile Rotation\r\n- Tool timeouts are infrastructure issues, not provider issues\r\n- Updated rotation logic: `shouldRotate = (!aborted && failoverFailure) || (timedOut && !timedOutDuringCompaction && !timedOutDuringToolExecution)`\r\n\r\n## Changes\r\n\r\n### Modified Files (9 files)\r\n\r\n**Type Definitions:**\r\n- `src/agents/pi-embedded-subscribe.handlers.types.ts` - Add reference count, snapshot state, toolStartData map\r\n- `src/agents/pi-embedded-subscribe.types.ts` - Add `ActiveToolExecutionState` public API type\r\n- `src/agents/pi-embedded-runner/run/types.ts` - Add `timedOutDuringToolExecution` and `ToolExecutionSnapshot` with validation docs\r\n\r\n**Core Logic:**\r\n- `src/agents/pi-embedded-subscribe.handlers.tools.ts` - Reference counting, three unsubscribed checks, conditional clearing, finally blocks\r\n- `src/agents/pi-embedded-runner/run/attempt.ts` - Timeout classification with snapshot capture and validation\r\n- `src/agents/pi-embedded-subscribe.ts` - Initialize state, cleanup in unsubscribe/reset, expose `isToolExecutionInFlight()` getter\r\n- `src/agents/pi-embedded-runner/run.ts` - Skip rotation on tool timeouts\r\n\r\n**Test Fixtures:**\r\n- `src/agents/pi-embedded-runner.run-embedded-pi-agent.auth-profile-rotation.e2e.test.ts`\r\n- `src/agents/pi-embedded-runner/run.overflow-compaction.e2e.test.ts`\r\r\n### Key Code Patterns\r\n\r\n**Reference counting for concurrent tools:**\r\n```typescript\r\n// Increment on start\r\nctx.state.toolExecutionCount++;\r\nctx.state.toolExecutionInFlight = ctx.state.toolExecutionCount > 0;\r\n\r\n// Decrement on end (in finally block)\r\nctx.state.toolExecutionCount = Math.max(0, ctx.state.toolExecutionCount - 1);\r\nctx.state.toolExecutionInFlight = ctx.state.toolExecutionCount > 0;\r\n```\r\n\r\n**Three unsubscribed checks in handleToolExecutionStart:**\r\n```typescript\r\n// Check 1: Before any work\r\nif (ctx.state.unsubscribed) {\r\n  ctx.log.debug(\\`tool_execution_start skipped (unsubscribed): tool=\\${String(evt.toolName)}\\`);\r\n  return;\r\n}\r\n\r\n// ... flush operations ...\r\n\r\n// Check 2: After async flush\r\nif (ctx.state.unsubscribed) {\r\n  ctx.log.debug(\\`tool_execution_start skipped (unsubscribed after flush): tool=\\${toolName}\\`);\r\n  return;\r\n}\r\n\r\n// ... hook execution ...\r\n\r\n// Check 3: After async hook with cleanup\r\nif (ctx.state.unsubscribed) {\r\n  ctx.log.debug(\\`tool_execution_start skipped (unsubscribed after hook): tool=\\${toolName}\\`);\r\n  // Clean up state we just set\r\n  ctx.state.toolExecutionCount = Math.max(0, ctx.state.toolExecutionCount - 1);\r\n  ctx.state.toolExecutionInFlight = ctx.state.toolExecutionCount > 0;\r\n  if (ctx.state.activeToolCallId === toolCallId) {\r\n    ctx.state.activeToolName = undefined;\r\n    ctx.state.activeToolCallId = undefined;\r\n    ctx.state.activeToolStartTime = undefined;\r\n  }\r\n  ctx.state.toolStartData.delete(toolCallId);\r\n  return;\r\n}\r\n```\r\n\r\n## Testing Strategy\r\n\r\n### Code Review\r\n- \u2705 Multiple rounds of code review\r\n- \u2705 Verified reference counting handles concurrent tools correctly\r\n- \u2705 Verified three unsubscribed checks prevent race conditions\r\n- \u2705 Verified conditional clearing prevents premature snapshot loss\r\n- \u2705 Verified finally block prevents memory leaks\r\n- \u2705 Verified consistent derivation of toolExecutionInFlight from count\r\n\r\n### Integration Tests\r\n- E2E tests updated to expect no auth profile rotation on tool timeouts\r\n- Existing timeout tests verify classification logic\r\n\r\n## Deployment Notes\r\n\r\n- **Based on:** upstream/main (includes PR #9855)\r\n- **Risk:** Low - extends existing pattern with careful race condition handling\r\n- **Rollback:** Revert to previous deployment if issues arise\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR implements timeout classification for tool execution to prevent incorrect auth profile rotation when timeouts occur during long-running tools (>600s). The implementation follows the proven pattern from PR #9855 (compaction timeout fix) with reference-counted state tracking, race condition protection, and proper cleanup.\n\n## Key Changes\n\n- **Reference counting**: `toolExecutionCount` tracks concurrent tools; `activeToolName/CallId/StartTime` snapshot the most recent tool for timeout context\n- **Timeout classification**: New `timedOutDuringToolExecution` flag distinguishes tool timeouts from provider issues, preventing unnecessary auth profile rotation\n- **Race protection**: Two unsubscribed checks in `handleToolExecutionStart` (before work, after flush), early return in `handleToolExecutionEnd`, conditional snapshot clearing\n- **Snapshot validation**: Tool execution snapshots are validated (non-empty strings \u2264100 chars, positive timestamps, duration 1ms-24h) before being trusted\n- **Memory safety**: `toolStartData` map moved from module-level to context state to prevent cross-session corruption; finally blocks ensure cleanup\n- **Auth profile logic**: Updated rotation to skip tool/compaction timeouts: `shouldRotate = (!aborted && failoverFailure) || (timedOut && !timedOutDuringCompaction && !timedOutDuringToolExecution)`\n\n## Implementation Quality\n\nThe code demonstrates careful attention to concurrency and race conditions:\n- Reference counting correctly handles concurrent tools with `Math.max(0, count - 1)` to prevent negative counts\n- Conditional clearing (`if (activeToolCallId === toolCallId)`) prevents premature snapshot loss\n- Finally blocks guarantee cleanup even on early returns\n- Snapshot quality validation prevents trusting corrupted/stale data\n- Consistent derivation of `toolExecutionInFlight` from `count > 0`\n\nThe PR description mentions three unsubscribed checks, but the final implementation has two (the third was removed in commit ffa9316c when duplicate `before_tool_call` hook was eliminated). This is correct since no async operations occur after the second check.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The implementation follows a proven pattern from PR #9855, includes comprehensive race condition protection with proper unsubscribed checks and finally blocks, validates all snapshot data before use, uses reference counting correctly for concurrent tools, and properly cleans up state in all code paths. The approach is conservative (only skipping rotation for clear infrastructure timeouts) and the test fixtures are updated appropriately.\n- No files require special attention\n\n<sub>Last reviewed commit: ffa9316</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "mverrilli",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-14T21:20:33Z",
      "updatedAt": "2026-02-15T19:46:06Z",
      "headRef": "mverrilli/tool_execution_timeout_fix",
      "baseRef": "main",
      "filesChanged": 11,
      "additions": 392,
      "deletions": 121,
      "commits": 6,
      "labels": [
        "agents",
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/agents/pi-embedded-runner.run-embedded-pi-agent.auth-profile-rotation.e2e.test.ts",
        "src/agents/pi-embedded-runner/run.overflow-compaction.fixture.ts",
        "src/agents/pi-embedded-runner/run.ts",
        "src/agents/pi-embedded-runner/run/attempt.ts",
        "src/agents/pi-embedded-runner/run/types.ts",
        "src/agents/pi-embedded-subscribe.handlers.tools.media.test.ts",
        "src/agents/pi-embedded-subscribe.handlers.tools.test.ts",
        "src/agents/pi-embedded-subscribe.handlers.tools.ts",
        "src/agents/pi-embedded-subscribe.handlers.types.ts",
        "src/agents/pi-embedded-subscribe.ts",
        "src/agents/pi-embedded-subscribe.types.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/16554.diff",
      "totalScore": 76,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "513 lines changed (392+/121-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "mverrilli (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "Comprehensive fix addressing a critical deadlock issue. The PR includes a clear problem statement, root cause analysis, and a well-defined solution based on proven patterns. The use of reference counting and timeout classification is a robust approach. The included tests and the detailed description of the changes contribute to a high level of confidence in the fix."
    },
    {
      "number": 17414,
      "title": "fix(sessions): refresh contextTokens when model override changes",
      "body": "## Summary\n- When `applyModelOverrideToSessionEntry()` switches the active model,\n  `entry.contextTokens` retains the previous model's context window\n- Every downstream consumer \u2014 compaction threshold, memory flush, session\n  persistence, `/status` display \u2014 sees the stale value\n- Fix: call `lookupContextTokens()` after the override is applied and write\n  the result back to `entry.contextTokens`\n- Also handles the revert-to-default case by deleting `contextTokens` so it\n  gets re-resolved from config\n\n## Problem\nSwitching models mid-session via `/model` (or alias, failover, quota\nexhaustion) leaves `entry.contextTokens` set to the previous model's value.\nFor example, switching from Sonnet 4.5 (1M context) to Opus 4.6 (200K)\nleaves the session believing it has 1M tokens of headroom. Compaction never\nfires, and the session grows until the API rejects it with a context-length\nerror.\n\n## Root Cause\n`applyModelOverrideToSessionEntry()` in `src/sessions/model-overrides.ts`\nupdates `entry.modelOverride` and `entry.providerOverride` but does not\ntouch `entry.contextTokens`:\n\n```ts\nif (selection.model !== entry.modelOverride) {\n  entry.modelOverride = selection.model;\n  updated = true;\n}\n// contextTokens is never refreshed here\n```\n\nThe `??` fallback chain at most callsites reads `entry.contextTokens` first:\n```ts\nentry?.contextTokens ?? lookupContextTokens(model) ?? DEFAULT_CONTEXT_TOKENS\n```\nSince `entry.contextTokens` is already set (from the previous model), the\nfallback to `lookupContextTokens()` never triggers.\n\n## Fix\nAfter detecting that the model override was `updated`, call\n`lookupContextTokens(effectiveModel)` and write the fresh value back to\n`entry.contextTokens`. When the override is reverted (no effective model),\ndelete `contextTokens` so it gets re-resolved from config.\n\n```ts\nif (updated) {\n  const effectiveModel = entry.modelOverride;\n  if (effectiveModel) {\n    const fresh = lookupContextTokens(effectiveModel);\n    if (typeof fresh === \"number\" && fresh > 0) {\n      entry.contextTokens = fresh;\n    }\n  } else {\n    // Reverted to default \u2014 clear so it gets re-resolved from config.\n    delete entry.contextTokens;\n  }\n  entry.updatedAt = Date.now();\n}\n```\n\nFixes #8240\n\n## Testing\n- Verified that `/status` displays the correct context window after\n  switching models via `/model` alias\n- Verified that reverting to the default model clears the stale value\n- Existing tests pass\n\n## AI Disclosure\nThis PR was authored with AI assistance.\nGenerated with [Claude Code](https://claude.com/claude-code)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded `contextTokens` refresh logic to `applyModelOverrideToSessionEntry()` to prevent stale context window values when switching models mid-session. When a model override is applied, the function now calls `lookupContextTokens()` with the new model and updates `entry.contextTokens`. When reverting to default, it deletes `contextTokens` so it gets re-resolved from config.\n\n- Fixes context-length errors caused by compaction not firing when switching from high-context models (1M) to lower-context models (200K)\n- Properly handles the revert-to-default case by clearing stale values\n- Includes defensive checks to preserve existing values if lookup returns `undefined` or invalid numbers\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- The fix correctly addresses the stated problem of stale `contextTokens` after model switches. Defensive checks prevent data loss when lookups fail. Only minor inefficiency noted (refreshing on non-model changes), which doesn't affect correctness.\n- No files require special attention\n\n<sub>Last reviewed commit: 65cf433</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(3/5) Reply to the agent's comments like \"Can you suggest a fix for this @greptileai?\" or ask follow-up questions!</sub>\n\n<!-- /greptile_comment -->",
      "author": "michaelbship",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T18:40:02Z",
      "updatedAt": "2026-02-15T19:26:26Z",
      "headRef": "fix/refresh-context-tokens-on-model-switch",
      "baseRef": "main",
      "filesChanged": 1,
      "additions": 21,
      "deletions": 0,
      "commits": 1,
      "labels": [
        "size: XS"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        8240
      ],
      "changedFiles": [
        "src/sessions/model-overrides.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17414.diff",
      "totalScore": 76,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "21 lines changed (21+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "michaelbship (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #8240"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "Comprehensive fix addressing a critical bug related to model switching and context token management. The problem, root cause, and solution are clearly explained. The code change appears straightforward and well-tested. The handling of both model override and revert-to-default scenarios is a plus."
    },
    {
      "number": 17420,
      "title": "fix(ci): add NODE_OPTIONS to Linux checks job and fix media test cross-platform",
      "body": "## Summary\n- Add `NODE_OPTIONS: --max-old-space-size=4096` and `OPENCLAW_TEST_WORKERS: 2` to the Linux `checks` job in CI, matching what Windows/macOS already have. This prevents OOM crashes during test runs on Linux.\n- Fix `media.test.ts` platform-dependent test failure: on Linux CI, `STATE_DIR` lives under `/tmp` which is in the default `localRoots` via `os.tmpdir()`, so `workspace-clawdy` paths were inadvertently allowed. The test now passes explicit `localRoots` without `os.tmpdir()` to be deterministic across platforms.\n\n## Test plan\n- [x] `src/web/media.test.ts` passes locally (22/22 tests)\n- [ ] Linux CI `checks` jobs should no longer OOM\n- [ ] Bun test should no longer fail on `media.test.ts:407`\n\n\ud83e\udd16 Generated with [Claude Code](https://claude.com/claude-code)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR includes multiple features and fixes: CI memory configuration, cross-platform test fix, Discord components v2 support, and entry requirements refactoring.\n\n**Key changes:**\n- Added `NODE_OPTIONS` and `OPENCLAW_TEST_WORKERS` to Linux CI checks job to match Windows/macOS configuration and prevent OOM crashes\n- Fixed `media.test.ts` platform-dependent failure by passing explicit `localRoots` without `os.tmpdir()` to avoid Linux CI path overlap issues\n- Added comprehensive Discord components v2 support with buttons, selects, modals, and rich UI blocks (`src/discord/components.ts`, 1088 lines)\n- Implemented in-memory component registry with 30-minute TTL for ephemeral UI state tracking\n- Refactored entry requirements evaluation into shared `evaluateEntryMetadataRequirements` function to reduce duplication between skills and hooks status modules\n- Removed reverted role allowlist changelog entry for cleanup\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with low risk, pending CI validation\n- The changes are well-structured and follow existing patterns. The CI configuration aligns with Windows/macOS settings, the media test fix addresses a real cross-platform issue with explicit path configuration, and the Discord components implementation includes comprehensive validation logic and test coverage. The entry requirements refactoring properly extracts shared logic without changing behavior. Main risk is CI validation of the OOM fix and cross-platform test behavior.\n- Pay close attention to CI test results to verify the OOM fix and cross-platform media test behavior\n\n<sub>Last reviewed commit: 9ce3e14</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "BinHPdev",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T18:50:39Z",
      "updatedAt": "2026-02-15T19:21:27Z",
      "headRef": "fix/ci-oom-media-test-cross-platform",
      "baseRef": "main",
      "filesChanged": 21,
      "additions": 2835,
      "deletions": 162,
      "commits": 6,
      "labels": [
        "docs",
        "channel: discord",
        "channel: whatsapp-web",
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        ".github/workflows/ci.yml",
        "CHANGELOG.md",
        "docs/channels/discord.md",
        "extensions/discord/src/channel.ts",
        "src/agents/skills-status.ts",
        "src/agents/tools/discord-actions-messaging.ts",
        "src/agents/tools/message-tool.ts",
        "src/channels/plugins/actions/discord/handle-action.ts",
        "src/discord/components-registry.ts",
        "src/discord/components.test.ts",
        "src/discord/components.ts",
        "src/discord/monitor/agent-components.test.ts",
        "src/discord/monitor/agent-components.ts",
        "src/discord/monitor/message-handler.preflight.test.ts",
        "src/discord/monitor/provider.ts",
        "src/discord/send.components.ts",
        "src/discord/send.ts",
        "src/hooks/hooks-status.ts",
        "src/infra/outbound/message-action-runner.ts",
        "src/shared/entry-status.ts",
        "src/web/media.test.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17420.diff",
      "totalScore": 76,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "2997 lines changed (2835+/162-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "BinHPdev (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "The PR addresses a CI stability issue and a cross-platform test failure, which are positive. It also introduces significant new functionality with Discord components v2. The risk is medium because of the large scope of changes, especially the new Discord components, which require careful review and testing to ensure stability and security. The test plan is not fully complete, as it only checks local tests and CI stability, but doesn't explicitly mention testing the new Discord components.",
      "duplicateGroup": 1
    },
    {
      "number": 12094,
      "title": "docs(examples): Linux browser-use reliability improvements for dynamic pages",
      "body": "Related to #10994\n\n## Summary\nThis PR documents a Linux-first browser automation setup that keeps OpenClaw stable with Chrome CDP and dynamic pages:\n\n- user-level `systemd` units for `Xvfb` and Chrome CDP\n- dedicated automation profile sync script (copy default profile into isolated profile dir)\n- stale-ref-resistant browser workflow example (`snapshot -> ref lookup -> action -> retry`)\n\nThe goal is to improve reliability on Linux where users often hit:\n- CDP endpoint flakiness\n- display/auth issues\n- dynamic DOM ref invalidation between snapshot and action\n\n## What's Included\n- docs: Linux stable CDP setup and troubleshooting\n- service templates: user-level Xvfb and Chrome main CDP\n- example scripts:\n  - profile sync script\n  - X post helper with fresh-snapshot + retry logic\n\n## Platform Support\n- Core scripts (`openclaw-browser-safe-action.sh`, `openclaw-x-post.sh`) are **cross-platform** (Linux/macOS/WSL) - dependencies: bash, flock, jq\n- Service templates (`openclaw-xvfb.service`, `openclaw-chrome-main.service`) are **Linux-specific** (systemd)\n- macOS (launchd) and Windows (Task Scheduler) adapters can be added in follow-up PRs\n\n## Why\nOn dynamic pages, element refs from snapshot can change before action. A retry loop that always refreshes snapshot and resolves ref by semantic attributes (role/name) is significantly more stable than static ref reuse.\n\n## Notes\n- This PR intentionally avoids machine-specific values.\n- Paths and service names are template-based and configurable.\n- No user data, credentials, or local config files are included.\n\n## Test Steps\n1. Start user services (`openclaw-xvfb`, `openclaw-chrome-main`).\n2. Verify CDP endpoint responds on loopback.\n3. Run example script in dry-run mode.\n4. Confirm retry logic handles ref invalidation without failing hard.\n\n## Follow-ups (Optional)\n- add first-class docs link from browser CLI help\n- provide official retry helper in OpenClaw examples\n- add platform-specific adapters/docs for macOS (launchd) and Windows (Task Scheduler)\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR adds Linux-focused documentation and examples intended to improve browser automation reliability on dynamic pages: a systemd user-service setup for Xvfb + Chrome CDP, a Chrome managed-policy hardening example, and bash scripts for syncing a Chrome profile and performing \u201cstale-ref-safe\u201d snapshot\u2192ref-resolve\u2192action retries.\n\nKey integration points are the new `examples/scripts/*` helpers which wrap `openclaw browser` commands (snapshot/click/type/evaluate) and the `examples/systemd/*` units which run a loopback-only CDP Chrome under a dedicated user-data-dir.\n\n<h3>Confidence Score: 3/5</h3>\n\n- This PR is close to mergeable but has a couple of issues that will break the documented workflow and one script at runtime.\n- The added docs reference paths that don\u2019t exist in the repo, and `openclaw-browser-safe-action.sh` contains a top-level array assignment using `local` under `set -u`, which will cause the script to exit when `--url` is used. Other changes are additive examples/services and don\u2019t appear to affect existing code paths.\n- examples/scripts/openclaw-browser-safe-action.sh, docs/linux-stable-cdp.md\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->\n",
      "author": "mahsumaktas",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-08T21:03:04Z",
      "updatedAt": "2026-02-15T20:16:24Z",
      "headRef": "feat/linux-stable-cdp-docs",
      "baseRef": "main",
      "filesChanged": 7,
      "additions": 792,
      "deletions": 0,
      "commits": 3,
      "labels": [
        "docs",
        "size: L"
      ],
      "ciStatus": "unknown",
      "hasIssueRef": true,
      "issueNumbers": [
        10994
      ],
      "changedFiles": [
        "docs/linux-stable-cdp.md",
        "examples/policies/chrome-managed-hardening.json",
        "examples/scripts/openclaw-browser-safe-action.sh",
        "examples/scripts/openclaw-x-post.sh",
        "examples/scripts/sync-main-profile-to-openclaw.sh",
        "examples/systemd/openclaw-chrome-main.service",
        "examples/systemd/openclaw-xvfb.service"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/12094.diff",
      "hasTests": false,
      "testFilesChanged": [],
      "ageInDays": 6,
      "mergeable": "unknown",
      "reviewState": "commented",
      "reviewCount": 4,
      "commentCount": 1,
      "totalScore": 76,
      "signals": [
        {
          "name": "ci_status",
          "score": 40,
          "weight": 0.2,
          "reason": "CI: unknown"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "792 lines changed (792+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "mahsumaktas (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #10994"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Comprehensive documentation and examples addressing a common reliability issue. The cross-platform nature of core scripts is a plus. Risk is medium due to the Linux-specific service templates and potential complexity of systemd configuration for some users. Follow-up PRs for macOS and Windows are needed for broader adoption."
    },
    {
      "number": 16562,
      "title": "fix(signal): preserve case for group and username targets",
      "body": "## Summary\r\n\r\n  - Problem: Signal target normalization lowercased group: and username: target values.\r\n  - Why it matters: Case-sensitive identifiers can be mutated, causing misrouting or failed target resolution. In particular, it failed doing emoji reactions on group messages.\r\n  - What changed: normalizeSignalMessagingTarget now preserves value casing for group: and username: while still\r\n    recognizing prefixes.\r\n  - What did NOT change (scope boundary): UUID normalization paths and other channel normalizers remain unchanged.\r\n\r\n  ## Change Type (select all)\r\n\r\n  - [x] Bug fix\r\n  - [ ] Feature\r\n  - [ ] Refactor\r\n  - [ ] Docs\r\n  - [ ] Security hardening\r\n  - [ ] Chore/infra\r\n\r\n  ## Scope (select all touched areas)\r\n\r\n  - [ ] Gateway / orchestration\r\n  - [ ] Skills / tool execution\r\n  - [ ] Auth / tokens\r\n  - [ ] Memory / storage\r\n  - [x] Integrations\r\n  - [ ] API / contracts\r\n  - [ ] UI / DX\r\n  - [ ] CI/CD / infra\r\n\r\n  ## Linked Issue/PR\r\n\r\n  - Closes #\r\n  - Related #\r\n  - If #12793 covers this exact normalization path, I\u2019m happy to close this as duplicate.\r\n\r\n  ## User-visible / Behavior Changes\r\n\r\n  Signal group: and username: target values keep original case after normalization.\r\n  Previously they were lowercased.\r\n\r\n  ## Security Impact (required)\r\n\r\n  - New permissions/capabilities? (No)\r\n  - Secrets/tokens handling changed? (No)\r\n  - New/changed network calls? (No)\r\n  - Command/tool execution surface changed? (No)\r\n  - Data access scope changed? (No)\r\n  - If any Yes, explain risk + mitigation:\r\n\r\n  ## Repro + Verification\r\n\r\n  ### Environment\r\n\r\n  - OS: macOS\r\n  - Runtime/container: local dev runtime\r\n  - Model/provider: N/A\r\n  - Integration/channel (if any): Signal\r\n  - Relevant config (redacted): Signal target values using group: and username: prefixes\r\n\r\n  ### Steps\r\n\r\n  1. Call normalizeSignalMessagingTarget(\"group:AbC123-CaseSensitive\").\r\n  2. Call normalizeSignalMessagingTarget(\"username:MyMixedCaseUser\").\r\n  3. Compare normalized outputs.\r\n\r\n  ### Expected\r\n\r\n  - group:AbC123-CaseSensitive\r\n  - username:MyMixedCaseUser\r\n\r\n  ### Actual\r\n\r\n  - Before fix: values were lowercased.\r\n  - After fix: original case is preserved.\r\n\r\n  ## Evidence\r\n\r\n  Attach at least one:\r\n\r\n  - [x] Failing test/log before + passing after\r\n  - [ ] Trace/log snippets\r\n  - [ ] Screenshot/recording\r\n  - [ ] Perf numbers (if relevant)\r\n\r\n  ## Human Verification (required)\r\n\r\n  - Verified scenarios:\r\n      - Added tests in src/channels/plugins/normalize/signal.test.ts for case preservation.\r\n      - Ran pnpm test -- src/channels/plugins/normalize/signal.test.ts (passing).\r\n  - Edge cases checked:\r\n      - Existing UUID normalization tests still pass.\r\n  - What you did not verify:\r\n      - Full end-to-end Signal daemon flow in production-like environment.\r\n\r\n  ## Compatibility / Migration\r\n\r\n  - Backward compatible? (Yes)\r\n  - Config/env changes? (No)\r\n  - Migration needed? (No)\r\n  - If yes, exact upgrade steps:\r\n\r\n  ## Failure Recovery (if this breaks)\r\n\r\n  - How to disable/revert this change quickly: Revert commit fix(signal): preserve case for group and username targets.\r\n  - Files/config to restore: src/channels/plugins/normalize/signal.ts, src/channels/plugins/normalize/signal.test.ts\r\n  - Known bad symptoms reviewers should watch for:\r\n      - Unexpected lowercasing reappearing for group: or username: targets.\r\n\r\n  ## Risks and Mitigations\r\n\r\n  - Risk: Downstream logic may have implicitly relied on lowercased group:/username: values.\r\n      - Mitigation: Change is narrowly scoped; UUID normalization behavior unchanged; regression tests added.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR fixes a bug where `normalizeSignalMessagingTarget` was lowercasing `group:` and `username:` target values, which broke case-sensitive identifiers (e.g., emoji reactions on group messages). The fix correctly removes `.toLowerCase()` from the `group:` and `username:` normalization paths while keeping UUID normalization unchanged.\n\n- Preserves original casing for `group:` and `username:` prefixed Signal targets\n- Adds two regression tests for case preservation\n- **Issue**: The `u:` shorthand prefix (a shorthand for `username:`) still applies `.toLowerCase()`, creating an inconsistency where `u:MyUser` normalizes to `username:myuser` while `username:MyUser` normalizes to `username:MyUser`. Since downstream routing uses strict equality (`===`) on peer IDs, these would not match each other.\n\n<h3>Confidence Score: 3/5</h3>\n\n- The core fix is correct but the `u:` shorthand path has been left inconsistent, which could cause misrouted messages when the shorthand is used.\n- The `group:` and `username:` fixes are sound and well-tested. However, the `u:` shorthand\u2014which is an alias for `username:`\u2014still lowercases, creating a behavioral inconsistency. This is a functional issue since downstream routing uses strict equality on normalized IDs.\n- `src/channels/plugins/normalize/signal.ts` \u2014 the `u:` prefix handler at lines 22-25 needs the same case-preservation treatment as the `username:` handler.\n\n<sub>Last reviewed commit: 138954e</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "akalypse",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-14T21:38:36Z",
      "updatedAt": "2026-02-15T19:46:24Z",
      "headRef": "fix/signal-target-normalization-case",
      "baseRef": "main",
      "filesChanged": 2,
      "additions": 25,
      "deletions": 3,
      "commits": 2,
      "labels": [
        "size: XS"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/channels/plugins/normalize/signal.test.ts",
        "src/channels/plugins/normalize/signal.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/16562.diff",
      "totalScore": 75,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "28 lines changed (25+/3-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "akalypse (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "The PR addresses a clear bug with a focused fix. The description is well-written, explaining the problem, solution, and scope. The change type and scope are clearly marked. Security impact is considered and deemed negligible. Repro steps are provided. The only minor deduction is due to the lack of a linked issue (though it mentions a potential duplicate). The test file indicates good test coverage.",
      "duplicateGroup": 5
    },
    {
      "number": 11974,
      "title": "[FEATURE] feat: integrate systemd WatchdogSec for gateway hang detection",
      "body": "## Summary\n\n- Add `sd-notify` wrapper (`src/infra/sd-notify.ts`) that sends `READY=1` on startup and `WATCHDOG=1` heartbeats every 30s via the existing tick interval\n- Update the generated systemd unit with `Type=notify`, `NotifyAccess=all`, and `WatchdogSec=90` so systemd automatically kills and restarts the gateway if the event loop freezes\n- All calls are no-ops when `$NOTIFY_SOCKET` is unset (macOS, manual dev, tests)\n\nFixes #11973\nDiscussion: https://github.com/openclaw/openclaw/discussions/12026\n\n## Review fixes\n\nAddressed functional regressions flagged during code review:\n\n- **[P1] Chat routing**: Restored canonical session key destructuring from `loadSessionEntry()` so `resolveSessionAgentId` and `resolveSendPolicy` use the resolved key instead of raw aliases (`chat.ts`)\n- **[P1] iOS disconnect recovery**: Restored `handleChannelDisconnected` to call `resetConnectionState()` before `onDisconnected`, so `notifyConnectedIfNeeded()` re-fires after reconnect (`GatewayNodeSession.swift`)\n- **[P2] UI state clobbering**: Added connected short-circuit in the reconnection loop so a healthy connection isn't repeatedly shown as \"Connecting\u2026\" (`NodeAppModel.swift`)\n- **[P2] Challenge timeout**: Restored `connectChallengeTimeoutSeconds` from 0.75s to 3.0s to avoid nonce handshake failures on remote/Tailscale links (`GatewayChannel.swift`)\n\n## Test plan\n\n- [x] `sdNotifyReady()` is a no-op when `NOTIFY_SOCKET` is not set\n- [x] `sdNotifyReady()` calls `systemd-notify --ready` when `NOTIFY_SOCKET` is set\n- [x] `sdNotifyWatchdog()` is a no-op when `NOTIFY_SOCKET` is not set\n- [x] `sdNotifyWatchdog()` calls `systemd-notify WATCHDOG=1` when `NOTIFY_SOCKET` is set\n- [x] Generated systemd unit includes `Type=notify`\n- [x] Generated systemd unit includes `NotifyAccess=all`\n- [x] Generated systemd unit includes `WatchdogSec=90`\n- [x] All directives placed in `[Service]` section\n- [x] All 8 new tests fail before implementation, pass after\n- [x] `pnpm build` compiles cleanly\n- [x] `pnpm check` passes (types, lint, format)\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR adds a new `sd-notify` wrapper (`src/infra/sd-notify.ts`) and integrates it into the gateway startup/shutdown path to support `Type=notify` readiness notifications and periodic `WATCHDOG=1` heartbeats. It also threads an opt-in `watchdog` flag through gateway systemd installation/update flows so generated user units include `Type=notify`, `NotifyAccess=all`, and `WatchdogSec=90`, and adjusts systemd unit naming resolution to respect `OPENCLAW_SYSTEMD_UNIT` consistently during install/uninstall.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR looks safe to merge with minimal risk.\n- Reviewed the diffs around systemd unit generation, unit name resolution, and gateway startup/shutdown integration. The sd-notify helper is gated on NOTIFY_SOCKET/WATCHDOG_USEC, watchdog calls are cleaned up on shutdown, and install/uninstall now consistently respect OPENCLAW_SYSTEMD_UNIT to avoid competing units. No definite functional regressions were found in the changed code paths.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "mcaxtr",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-08T16:52:37Z",
      "updatedAt": "2026-02-15T19:25:23Z",
      "headRef": "feat/11973-sd-notify-watchdog",
      "baseRef": "main",
      "filesChanged": 14,
      "additions": 504,
      "deletions": 7,
      "commits": 3,
      "labels": [
        "gateway",
        "cli",
        "commands",
        "size: L",
        "trusted-contributor",
        "experienced-contributor"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        11973
      ],
      "changedFiles": [
        "src/cli/daemon-cli/install.ts",
        "src/commands/configure.daemon.ts",
        "src/commands/doctor-gateway-daemon-flow.ts",
        "src/commands/doctor-gateway-services.ts",
        "src/commands/onboard-non-interactive/local/daemon-install.ts",
        "src/daemon/service.ts",
        "src/daemon/systemd-unit.test.ts",
        "src/daemon/systemd-unit.ts",
        "src/daemon/systemd.ts",
        "src/gateway/server-close.ts",
        "src/gateway/server.impl.ts",
        "src/infra/sd-notify.test.ts",
        "src/infra/sd-notify.ts",
        "src/wizard/onboarding.finalize.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/11974.diff",
      "totalScore": 75,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "511 lines changed (504+/7-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "mcaxtr (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #11973"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "This PR introduces systemd watchdog functionality, which is a valuable addition for gateway hang detection and recovery. The code includes a wrapper for `sd-notify`, updates the systemd unit file, and provides comprehensive tests. The review fixes address functional regressions, indicating a thorough review process. However, the risk is medium due to the potential for unexpected interactions with the existing system and the reliance on systemd, which may not be available in all environments. The large number of files touched also increases the risk of introducing unintended side effects.",
      "duplicateGroup": 0
    },
    {
      "number": 17431,
      "title": "ci: Fix Ubuntu CI failing... again.",
      "body": "# What\u2019s Happened\r\n\r\nCI was flaking because Node kept running out of memory during the build.\r\n\r\n# What Changed\r\n\r\nI bumped the Node.js heap size so the build has enough room to breathe instead of crashing halfway through. This just affects CI/runtime config, no functional changes.\r\n\r\n# Why\r\n\r\nWithout this, Node hits its default heap limit and OOMs in CI. With the increased heap, the jobs run cleanly and consistently.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdds `NODE_OPTIONS: --max-old-space-size=4096` to the Ubuntu `checks` job to prevent Node.js OOM crashes during CI test runs. This brings the Ubuntu job in line with the Windows and macOS jobs, which already had this setting.\n\n- Sets Node.js heap limit to 4096 MB at the job level for the `checks` matrix (test, protocol, bun test)\n- No functional code changes; CI-only configuration fix\n- The `build-artifacts` and `check` jobs still don't set this env var \u2014 worth monitoring if they also start OOM-ing\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge \u2014 it's a minimal CI configuration change with no functional code impact.\n- The change adds a single environment variable to a CI job, matching the existing pattern already used by the Windows and macOS jobs. It addresses a known OOM issue (referenced in #17341) with a standard Node.js memory configuration. No application code is modified.\n- No files require special attention.\n\n<sub>Last reviewed commit: d22a7a4</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
      "author": "thesomewhatyou",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-15T19:02:30Z",
      "updatedAt": "2026-02-15T19:55:46Z",
      "headRef": "main",
      "baseRef": "main",
      "filesChanged": 1,
      "additions": 2,
      "deletions": 0,
      "commits": 8,
      "labels": [
        "size: XS"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        ".github/workflows/ci.yml"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17431.diff",
      "totalScore": 74,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 20,
          "weight": 0.1,
          "reason": "2 lines changed (2+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "thesomewhatyou (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 50,
          "weight": 0.15,
          "reason": "<3 lines, No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "Addresses a known CI issue (OOM errors) with a targeted configuration change. The change is well-explained, and the Greptile summary provides additional context and confidence. The risk is low because it's a CI-only change with no functional impact. The score is high, but not perfect, because the 'build-artifacts' and 'check' jobs are not addressed, and may need to be in the future.",
      "duplicateGroup": 1
    },
    {
      "number": 17469,
      "title": "Improve unknown-model errors for provider/model misconfiguration",
      "body": "## Summary\nImprove diagnostics when a model references a provider prefix that isn't configured (common local proxy misconfiguration like `lmstudio/...` vs `models.providers.lmproxy`).\n\n## What changed\n- `resolveModel()` now appends actionable hints to unknown-model errors:\n  - Lists configured custom providers when provider is missing.\n  - Detects normalized provider mismatch and reports the configured key(s).\n- Added test coverage in `src/agents/pi-embedded-runner/model.test.ts` for provider-hint behavior.\n- Relaxed a few brittle equality assertions to `toContain` in unknown-model tests.\n\n## Why\nToday this failure mode can look like transport/network trouble (\"no socket opened\") even though resolution failed pre-transport. This patch makes failures immediate and obvious so users can fix config quickly.\n\n## Example\nBefore:\n- `Unknown model: lmstudio/minicpm-o-4_5`\n\nAfter:\n- `Unknown model: lmstudio/minicpm-o-4_5. Configured custom providers: \"lmproxy\".`\n\n## Notes\n- I couldn't run vitest in this environment because `pnpm` is not installed on this host.\n",
      "author": "megahappyclaw",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:54:21Z",
      "updatedAt": "2026-02-15T19:54:39Z",
      "headRef": "fix/model-provider-mismatch-hint",
      "baseRef": "main",
      "filesChanged": 2,
      "additions": 40,
      "deletions": 4,
      "commits": 1,
      "labels": [
        "agents",
        "size: XS"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/agents/pi-embedded-runner/model.test.ts",
        "src/agents/pi-embedded-runner/model.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17469.diff",
      "totalScore": 74,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "44 lines changed (40+/4-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "megahappyclaw (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "This PR improves error handling for a common misconfiguration, making it easier for users to diagnose and fix issues. The changes include helpful hints in error messages and added test coverage. The relaxed assertions in tests are acceptable given the improved error messages. The lack of pnpm is noted but doesn't impact the code quality itself."
    },
    {
      "number": 17455,
      "title": "fix: strip content before orphan closing think tags",
      "body": "## Summary\n\nHandle inference endpoints that output broken thinking tokens with only a closing `</think>` tag (no opening `<think>`). When an orphan closing tag is encountered, all content before it is now stripped, keeping only the content after the tag.\n\n## Problem\n\nSome non-standard inference endpoints output internal reasoning content followed by a `</think>` closing tag without a corresponding opening tag:\n\n```\nLet me analyze this step by step...\n\nFirst, I need to consider...</think>Here is your answer.\n```\n\nPreviously, this would leak the reasoning content into user-facing messages.\n\n## Solution\n\nModified `stripReasoningTagsFromText` to detect orphan closing tags (when not inside a thinking block) and reset the accumulated result, effectively stripping all content before the orphan tag.\n\n## Testing\n\n- All 41 unit tests in `reasoning-tags.test.ts` pass\n- Added 3 new test cases for orphan closing tag handling\n- Updated 1 existing test to reflect new behavior\n\n---\n\n**AI-assisted**: Yes\n**Testing degree**: Fully tested (all unit tests pass)\n**I confirm I understand what the code does**: Yes\n\n---\nPull Request opened by [Augment Code](https://www.augmentcode.com/) with guidance from the PR author\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nModifies `stripReasoningTagsFromText` to handle orphan `</think>` closing tags (no matching opening tag) by resetting the accumulated result, effectively stripping all content before the orphan tag. This addresses non-standard inference endpoints that leak internal reasoning content followed by a bare `</think>`.\n\n- The core change in `reasoning-tags.ts` swaps the control flow for the `!inThinking` branch: orphan close tags now reset `result = \"\"` instead of preserving preceding text.\n- 3 new test cases cover the orphan closing tag behavior; 1 existing test (`nested think patterns`) and 1 edge case (`lone closing tag`) updated to reflect the new stripping semantics.\n- All callers (`message-tool.ts`, `pi-embedded-utils.ts`, `ui/format.ts`) process model-generated output, so the more aggressive stripping is appropriate and unlikely to affect user-authored content.\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge \u2014 the behavioral change is well-scoped to a shared text utility with comprehensive test coverage.\n- The change is small (net +7 lines in the source file), logically sound, and well-tested with 3 new test cases plus updated existing tests. The function is only called on model-generated output, reducing risk of unintended stripping. The only reason it's not a 5 is the inherently destructive nature of resetting `result = \"\"` \u2014 in an edge case with legitimate content before an orphan close tag outside code blocks, that content would be lost. However, this is the intended behavior for the target use case.\n- No files require special attention.\n\n<sub>Last reviewed commit: b82d5c0</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "jwt625",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:40:38Z",
      "updatedAt": "2026-02-15T19:45:26Z",
      "headRef": "fix/strip-orphan-think-closing-tags",
      "baseRef": "main",
      "filesChanged": 2,
      "additions": 22,
      "deletions": 8,
      "commits": 2,
      "labels": [
        "size: XS"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/shared/text/reasoning-tags.test.ts",
        "src/shared/text/reasoning-tags.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17455.diff",
      "totalScore": 74,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "30 lines changed (22+/8-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "jwt625 (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "Comprehensive fix for a specific edge case. The problem is well-defined, the solution is clear, and the testing is thorough, including new test cases and updates to existing ones. The code change is localized and the risk of unintended consequences is low. The PR description is well-written and easy to understand."
    },
    {
      "number": 17453,
      "title": "fix(signal): make group reactions deterministic from inbound sender metadata",
      "body": "## Summary\r\n\r\n  Describe the problem and fix in 2\u20135 bullets:\r\n\r\n  - Problem: Signal group reactions were unreliable because targetAuthor/targetAuthorUuid was often missing or model-\r\n    guessed, causing reactions to fail or be accepted without visible UI effect.\r\n  - Why it matters: Group reaction behavior must deterministically target the exact inbound message author; otherwise\r\n    reactions are flaky in real group chats.\r\n  - What changed: Added an inbound reaction-target cache (groupId + messageId -> sender uuid/e164), populated it in\r\n    Signal inbound handling, and used it in outbound react action prep when targetAuthor* is not provided. Also\r\n    tightened reaction payload shaping to prefer UUID and set recipients for group reactions/removals.\r\n  - What did NOT change (scope boundary): No changes to non-Signal channels, no new external services, no schema/API\r\n    contract changes, and no config migration.\r\n\r\n  ## Change Type (select all)\r\n\r\n  - [x] Bug fix\r\n  - [ ] Feature\r\n  - [ ] Refactor\r\n  - [ ] Docs\r\n  - [ ] Security hardening\r\n  - [ ] Chore/infra\r\n\r\n  ## Scope (select all touched areas)\r\n\r\n  - [x] Gateway / orchestration\r\n  - [ ] Skills / tool execution\r\n  - [ ] Auth / tokens\r\n  - [x] Memory / storage\r\n  - [x] Integrations\r\n  - [ ] API / contracts\r\n  - [ ] UI / DX\r\n  - [ ] CI/CD / infra\r\n\r\n  ## Linked Issue/PR\r\n\r\n  - Closes #\r\n  - Related #\r\n\r\n  ## User-visible / Behavior Changes\r\n\r\n  - Signal group \u201creact to this message\u201d is now more reliable when messageId is known but targetAuthor* is omitted.\r\n  - For group reactions/removals, UUID targeting is preferred and recipient shaping is more consistent.\r\n  - No new user-facing config required.\r\n\r\n  ## Security Impact (required)\r\n\r\n  - New permissions/capabilities? (No)\r\n  - Secrets/tokens handling changed? (No)\r\n  - New/changed network calls? (No)\r\n  - Command/tool execution surface changed? (No)\r\n  - Data access scope changed? (Yes)\r\n  - If any Yes, explain risk + mitigation:\r\n      - Added a small in-memory cache of inbound group reaction metadata (sender identifier keyed by group/message) with\r\n        TTL and size cap.\r\n      - Mitigations: bounded cache (MAX_ENTRIES), expiration (TTL_MS), no persistence to disk, no secret material.\r\n\r\n  ## Repro + Verification\r\n\r\n  ### Environment\r\n\r\n  - OS: macOS\r\n  - Runtime/container: Docker Compose (openclaw-gateway + signal-cli-daemon)\r\n  - Model/provider: OpenAI Codex (gpt-5.3-codex)\r\n  - Integration/channel (if any): Signal group + direct chat\r\n  - Relevant config (redacted): channels.signal.reactionLevel=minimal, actions.reactions=true\r\n\r\n  ### Steps\r\n\r\n  1. Receive a Signal group inbound message and ask agent to react to that message.\r\n  2. Trigger message.react without explicitly forcing targetAuthorUuid.\r\n  3. Observe gateway logs and Signal UI behavior.\r\n\r\n  ### Expected\r\n\r\n  - Group reaction resolves to exact inbound sender and appears in Signal UI.\r\n\r\n  ### Actual\r\n\r\n  - Before fix: reactions frequently failed (targetAuthor required) or reported success but were not visible.\r\n  - After fix: deterministic sender targeting is applied via inbound cache; reactions are consistently resolved.\r\n\r\n  ## Evidence\r\n\r\n  Attach at least one:\r\n\r\n  - [x] Failing test/log before + passing after\r\n  - [x] Trace/log snippets\r\n  - [ ] Screenshot/recording\r\n  - [ ] Perf numbers (if relevant)\r\n\r\n  ## Human Verification (required)\r\n\r\n  What you personally verified (not just CI), and how:\r\n\r\n  - Verified scenarios:\r\n      - Group reaction target hydration from inbound metadata cache.\r\n      - UUID-preferred target selection.\r\n      - Group removal payload shaping using resolved target.\r\n  - Edge cases checked:\r\n      - Missing targetAuthor* with valid groupId + messageId.\r\n      - UUID vs E.164 fallback behavior.\r\n  - What you did not verify:\r\n      - Full matrix across all Signal daemon versions and multi-device clients.\r\n\r\n  ## Compatibility / Migration\r\n\r\n  - Backward compatible? (Yes)\r\n  - Config/env changes? (No)\r\n  - Migration needed? (No)\r\n  - If yes, exact upgrade steps:\r\n\r\n  ## Failure Recovery (if this breaks)\r\n\r\n  - How to disable/revert this change quickly:\r\n      - Revert commit cda8b78bbd8d76001d2331596038babb3cb82763.\r\n  - Files/config to restore:\r\n      - src/infra/outbound/message-action-runner.ts\r\n      - src/signal/monitor/event-handler.ts\r\n      - src/signal/send-reactions.ts\r\n      - remove src/signal/reaction-target-cache.ts\r\n  - Known bad symptoms reviewers should watch for:\r\n      - Group react regression to targetAuthor is required errors.\r\n      - Group reactions accepted but not visible in Signal UI.\r\n\r\n  ## Risks and Mitigations\r\n\r\n  - Risk:\r\n      - Stale cache entry could map message->author incorrectly if identifiers collide.\r\n      - Mitigation:\r\n          - Keyed by exact groupId + messageId, bounded size, TTL expiry, and no cross-group reuse.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdds deterministic Signal group reaction targeting by caching inbound sender metadata (UUID/E.164) keyed by `groupId + messageId`. When reacting without explicit `targetAuthor*`, the system now hydrates from cache instead of failing or guessing.\n\nKey changes:\n- New `reaction-target-cache.ts` with bounded in-memory cache (5000 entries, 24h TTL)\n- `event-handler.ts` records sender metadata on group message receipt\n- `message-action-runner.ts` hydrates `targetAuthorUuid`/`targetAuthor` from cache when missing\n- `send-reactions.ts` prefers UUID over E.164 and shapes recipients array for group reactions/removals\n- Tests cover cache behavior, UUID preference, and target hydration\n\n<h3>Confidence Score: 4/5</h3>\n\n- Safe to merge with one minor overflow calculation bug in cache pruning\n- The implementation is sound with proper bounds, TTL, and test coverage. UUID preference ordering is correct, cache hydration logic works as intended, and the change is backward compatible. One bug in pruning overflow calculation uses sorted array length instead of current map size after expired entries are deleted, but this has minimal impact (slight over-pruning at most)\n- Pay attention to `src/signal/reaction-target-cache.ts` line 74 overflow calculation\n\n<sub>Last reviewed commit: cda8b78</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(5/5) You can turn off certain types of comments like style [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
      "author": "akalypse",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:36:47Z",
      "updatedAt": "2026-02-15T19:39:39Z",
      "headRef": "fix/signal-group-reaction-deterministic",
      "baseRef": "main",
      "filesChanged": 7,
      "additions": 336,
      "deletions": 6,
      "commits": 1,
      "labels": [
        "channel: signal",
        "size: M"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/infra/outbound/message-action-runner.threading.test.ts",
        "src/infra/outbound/message-action-runner.ts",
        "src/signal/monitor/event-handler.ts",
        "src/signal/reaction-target-cache.test.ts",
        "src/signal/reaction-target-cache.ts",
        "src/signal/send-reactions.test.ts",
        "src/signal/send-reactions.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17453.diff",
      "totalScore": 74,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "342 lines changed (336+/6-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "akalypse (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "The PR addresses a significant bug in Signal group reactions, improving reliability and user experience. The description is clear and well-structured, outlining the problem, solution, and scope. The inclusion of tests and a reaction-target cache demonstrates good engineering practices. The 'Data access scope changed' flag, even with the explanation of a small in-memory cache, introduces a moderate risk that needs careful review. The risk is medium because the cache is in-memory and the scope is limited, but potential memory usage and concurrency issues need to be considered.",
      "duplicateGroup": 5
    },
    {
      "number": 17426,
      "title": "ci(formal): don't fail on fork PRs when PR comment is blocked",
      "body": "This workflow is informational, but currently fails on fork PRs when the comment step hits GitHub's token restrictions (403: \"Resource not accessible by integration\").\n\nChanges:\n- Add `issues: write` permission (comment uses the issues API)\n- Skip commenting on fork PRs (where token restrictions commonly apply)\n- Wrap comment in try/catch + `continue-on-error: true` so the job remains informational\n\nThis should keep CI green for docs-only/community PRs while still uploading the drift artifact.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nHardens the `formal-conformance` workflow so it no longer fails on fork PRs when the GitHub token lacks permission to post PR comments. Three defensive layers are added: the `issues: write` permission (needed by the `createComment` API), an early return for fork PRs, and a try/catch with `continue-on-error: true` on the comment step.\n\n- Added `issues: write` permission, consistent with other workflows in the repo (`stale.yml`, `labeler.yml`, `auto-response.yml`)\n- Fork PRs are detected via `pr?.head?.repo?.fork` and skip commenting early\n- The `createComment` call is wrapped in try/catch so any remaining API failures are logged but don't fail the job\n- `continue-on-error: true` provides an additional safety net at the step level\n- No functional changes to the drift detection, model checking, or artifact upload logic\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge \u2014 it only adds defensive error handling to an informational CI step.\n- The changes are limited to a single workflow file, only affect the PR commenting step (which is explicitly informational), and add multiple layers of defensive handling (permission, early return, try/catch, continue-on-error). No functional logic is altered. The refactoring of `context.payload.pull_request.number` to `pr.number` is correct.\n- No files require special attention.\n\n<sub>Last reviewed commit: 6375924</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "mitre88",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T18:59:47Z",
      "updatedAt": "2026-02-15T19:30:41Z",
      "headRef": "chore/formal-conformance-fork-safe",
      "baseRef": "main",
      "filesChanged": 2,
      "additions": 25,
      "deletions": 6,
      "commits": 2,
      "labels": [
        "size: XS"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        ".github/workflows/ci.yml",
        ".github/workflows/formal-conformance.yml"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17426.diff",
      "totalScore": 74,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "31 lines changed (25+/6-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "mitre88 (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 95,
      "llmRisk": "low",
      "llmReason": "The PR addresses a known issue with CI failing on fork PRs due to token restrictions. It implements multiple layers of defense: adding necessary permissions, skipping the comment step on fork PRs, and wrapping the comment in a try/catch block with `continue-on-error`. The changes are isolated to a single workflow file and don't affect core functionality. The Greptile summary confirms the safety and limited scope of the changes.",
      "duplicateGroup": 2
    },
    {
      "number": 16677,
      "title": "feat(routing): intelligent model routing via pre-route hook ",
      "body": "AI Assistance used in this PR. Human testing performed on both local and cloud routing endpoints.  \r\n\r\n## Summary\r\n\r\n  - **Problem:** Users pay premium model prices for simple messages (\"hey\", \"ok\", \"read that file\") because there's no automatic complexity-based routing. Manual `/model` switching is tedious and error-prone.\r\n  - **Why it matters:** Simple messages can be 90%+ of volume in some workflows. Routing them to cheap/fast models saves significant cost without degrading quality on complex tasks.\r\n  - **What changed:** Added a pre-route hook that classifies each message with a lightweight LLM (~300 tokens) and routes to a configured model tier before the agent runs. Supports local Ollama and any OpenAI-compatible API. UI shows routed model as a badge. Classification prompt is user-editable at `~/.openclaw/router/ROUTER.md`.\r\n  - **What did NOT change (scope boundary):** No changes to the agent execution pipeline itself, model provider resolution, auth system, or any existing routing logic. The router is a pure pre-hook that optionally overrides the model ref before the agent starts. Disabled by default.\r\n\r\n  ## Change Type (select all)\r\n\r\n  - [ ] Bug fix\r\n  - [x] Feature\r\n  - [ ] Refactor\r\n  - [x] Docs\r\n  - [ ] Security hardening\r\n  - [ ] Chore/infra\r\n\r\n  ## Scope (select all touched areas)\r\n\r\n  - [x] Gateway / orchestration\r\n  - [ ] Skills / tool execution\r\n  - [ ] Auth / tokens\r\n  - [ ] Memory / storage\r\n  - [ ] Integrations\r\n  - [x] API / contracts\r\n  - [x] UI / DX\r\n  - [ ] CI/CD / infra\r\n\r\n  ## Linked Issue/PR\r\n\r\n  - Closes #9402\r\n  - Related #4658, #10969, #15033\r\n\r\n  ## User-visible / Behavior Changes\r\n\r\n  - New `router` config section (disabled by default \u2014 no behavior change unless explicitly enabled)\r\n  - When enabled, messages are classified and routed to tier-mapped models automatically\r\n  - Routed model shown as a badge in webchat UI (e.g. `\ud83d\udd00 anthropic/claude-haiku-4.5`)\r\n  - `/status` command shows router configuration when enabled\r\n  - New external file `~/.openclaw/router/ROUTER.md` created on first use for classification prompt tuning\r\n  - `router.apiKey` is redacted in config logs/exports via `.register(sensitive)`\r\n\r\n  ## Security Impact (required)\r\n\r\n  - New permissions/capabilities? `No`\r\n  - Secrets/tokens handling changed? `Yes`\r\n  - New/changed network calls? `Yes`\r\n  - Command/tool execution surface changed? `No`\r\n  - Data access scope changed? `No`\r\n  - If any `Yes`, explain risk + mitigation:\r\n    - **router.apiKey**: New optional secret for the classifier API. Marked `.register(sensitive)` in Zod schema so it's redacted in\r\n   config dumps. Supports `env:VAR_NAME` syntax to avoid plaintext in config files.\r\n    - **Network calls**: Router makes HTTP POST to either local Ollama (`http://localhost:11434`) or a configured OpenAI-compatible endpoint. Only the user's message text + classification prompt are sent (~300 tokens). No session data, auth tokens, or PII beyond the message content. Calls are bounded by `timeoutMs` (default 10s).\r\n\r\n  ## Repro + Verification\r\n\r\n  ### Environment\r\n\r\n  - OS: Linux (Jetson / ARM64) + macOS (dev)\r\n  - Runtime/container: Docker (openclaw-gateway)\r\n  - Model/provider: Ollama (qwen3:4b) + OpenRouter (qwen/qwen3-4b)\r\n  - Integration/channel: Webchat\r\n  - Relevant config (redacted):\r\n  ```json\r\n  {\r\n    \"router\": {\r\n      \"enabled\": true,\r\n      \"provider\": \"openai-compatible\",\r\n      \"baseUrl\": \"https://openrouter.ai/api/v1\",\r\n      \"apiKey\": \"env:OPENROUTER_API_KEY\",\r\n      \"model\": \"qwen/qwen3-4b\",\r\n      \"tiers\": {\r\n        \"1\": \"openrouter/minimax/minimax-m2.1\",\r\n        \"2\": \"openrouter/anthropic/claude-haiku-4.5\",\r\n        \"3\": \"openrouter/anthropic/claude-opus-4.6\"\r\n      },\r\n      \"defaultTier\": \"1\"\r\n    }\r\n  }\r\n```\r\n  Steps\r\n\r\n  1. Enable router in config with tiers mapped to models\r\n  2. Send messages of varying complexity: \"hey\", \"fix this TypeError\", \"design a microservices architecture\"\r\n  3. Observe routed model badge in webchat and gateway logs\r\n\r\n  Expected\r\n\r\n  - \"hey\" \u2192 tier 1 (cheap model), badge shows tier 1 model\r\n  - \"fix this TypeError\" \u2192 tier 2 (code model)\r\n  - \"design a microservices architecture\" \u2192 tier 3 (premium model)\r\n  - Fallback to defaultTier on classifier error\r\n\r\n  Actual\r\n\r\n  - All tiers route correctly with ~200-700ms classifier latency\r\n  - Badge renders and persists on completed messages\r\n  - Fallback works on timeout/malformed response\r\n\r\n  Evidence\r\n\r\n  - Failing test/log before + passing after\r\n  - Trace/log snippets\r\n  - Screenshot/recording\r\n  - Perf numbers (if relevant)\r\n\r\n  Unit tests in src/hooks/pre-route.test.ts cover: config resolution, tier parsing (1/2/3), fallback on error/timeout, model ref\r\n  parsing, Ollama + OpenAI-compatible payloads, conversation context injection.\r\n\r\n  Human Verification (required)\r\n\r\n  - Verified scenarios: Tier 1/2/3 classification with live Ollama and OpenRouter endpoints; fallback on Ollama timeout; badge\r\n  rendering in webchat; badge persistence on completed messages; /status output; ROUTER.md hot-reload; heartbeat/session-reset bypass\r\n  - Edge cases checked: Classifier returns unexpected text (falls back); classifier returns tier not in config (falls back);\r\n  ROUTER.md missing (uses built-in default); apiKey with env: prefix resolves from environment\r\n  - What you did not verify: Concurrent routing under high load; interaction with agent-level model overrides; non-webchat channels (Telegram, WhatsApp, etc.)\r\n\r\n  Compatibility / Migration\r\n\r\n  - Backward compatible? Yes \u2014 router is disabled by default, no behavior change without opt-in\r\n  - Config/env changes? Yes \u2014 new optional router section in config\r\n  - Migration needed? No\r\n\r\n  Failure Recovery (if this breaks)\r\n\r\n  - How to disable/revert this change quickly: Set \"router\": { \"enabled\": false } in config, or remove the router section entirely.  No restart needed for ROUTER.md changes; config change requires restart.\r\n  - Files/config to restore: Only the router config key. No database or state changes.\r\n  - Known bad symptoms reviewers should watch for: Elevated latency on every message (~200-700ms from classifier call); classifier endpoint returning errors flooding logs (mitigated: errors are caught and fall back silently)\r\n\r\n  Risks and Mitigations\r\n\r\n  - Risk: Classifier adds latency to every message when enabled\r\n    - Mitigation: Bounded by timeoutMs (default 10s, recommend 3-5s). Falls back to defaultTier on timeout. Latency is amortized into agent startup.\r\n  - Risk: User message content sent to classifier endpoint (privacy)\r\n    - Mitigation: Only the message text is sent, no metadata/auth. Local Ollama mode keeps data on-device. Documented so users can make informed choices.\r\n  - Risk: Router model naming inconsistency (bare API names vs OpenClaw refs)\r\n    - Mitigation: Documented as known limitation. Future work to support standard model refs with auto-credential resolution.\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nAdds intelligent model routing via pre-route classification hook. A lightweight LLM classifies each message into tiers (casual/code/complex) before the main agent runs, routing to cost-appropriate models. Supports local Ollama and OpenAI-compatible APIs. UI displays routed model as a badge in webchat.\n\n## Key Changes\n\n- **Core routing logic** (`src/hooks/pre-route.ts`): Classifies messages via small LLM (~300 tokens), maps tier labels to model refs, handles timeouts/errors with graceful fallback\n- **Configuration** (`src/config/zod-schema.ts`, `types.openclaw.ts`): New `router` config section with provider/model/tiers/defaultTier fields; `apiKey` marked sensitive\n- **Integration** (`agent-runner-execution.ts`): Pre-route hook runs before agent execution, overrides provider/model, skips heartbeats and system resets\n- **UI** (webchat files): Badge shows routed model (e.g. \ud83d\udd00 `anthropic/claude-haiku-4.5`) on assistant messages, persists on completed messages\n- **Status command** (`commands-status.ts`, `status.ts`): Shows router config in `/status` output\n- **Documentation**: Configuration reference, examples, and field help added\n\n## Issues Found\n\n- **Critical**: `baseUrl` check doesn't prevent undefined from reaching API call (src/hooks/pre-route.ts:284)\n- **Critical**: Zod schema requires `tiers`/`defaultTier` even when `enabled: false`, breaking valid configs (src/config/zod-schema.ts:641)\n\n## Recommendations\n\n- Verify context window math: multiple long messages could exceed 1024 token budget despite per-message 200 char limit\n- Consider extracting more than 1 message for conversation context (currently `.slice(-1)`)\n- Replace hardcoded system prompt detection with robust signal\n- Test `think: false` parameter compatibility across Ollama versions\n\n<h3>Confidence Score: 3/5</h3>\n\n- This PR has two critical logic bugs that will cause runtime errors in production\n- Score reflects well-architected feature with comprehensive tests and docs, but two blocking bugs need fixes: (1) undefined baseUrl will crash openai-compatible provider calls, (2) strict schema validation rejects valid disabled configs. Once fixed, implementation is solid.\n- Critical fixes needed in src/hooks/pre-route.ts (line 284) and src/config/zod-schema.ts (line 641-642). All other files look good.\n\n<sub>Last reviewed commit: a3e6074</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "gonesurfing",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T00:44:09Z",
      "updatedAt": "2026-02-15T19:40:56Z",
      "headRef": "pre-route-selector",
      "baseRef": "main",
      "filesChanged": 22,
      "additions": 976,
      "deletions": 41,
      "commits": 18,
      "labels": [
        "docs",
        "app: web-ui",
        "gateway",
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        9402
      ],
      "changedFiles": [
        "docs/gateway/configuration-examples.md",
        "docs/gateway/configuration-reference.md",
        "src/auto-reply/reply/agent-runner-execution.ts",
        "src/auto-reply/reply/commands-status.ts",
        "src/auto-reply/status.ts",
        "src/config/schema.help.ts",
        "src/config/types.openclaw.ts",
        "src/config/zod-schema.ts",
        "src/gateway/server-chat.ts",
        "src/hooks/pre-route.test.ts",
        "src/hooks/pre-route.ts",
        "src/infra/agent-events.ts",
        "ui/src/ui/app-gateway.ts",
        "ui/src/ui/app-render.helpers.ts",
        "ui/src/ui/app-render.ts",
        "ui/src/ui/app-view-state.ts",
        "ui/src/ui/app.ts",
        "ui/src/ui/chat/grouped-render.ts",
        "ui/src/ui/controllers/chat.test.ts",
        "ui/src/ui/controllers/chat.ts",
        "ui/src/ui/views/chat.test.ts",
        "ui/src/ui/views/chat.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/16677.diff",
      "totalScore": 73,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "1017 lines changed (976+/41-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "gonesurfing (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #9402"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "This PR introduces a significant feature (intelligent model routing) that could substantially improve cost efficiency. The description is thorough, outlining the problem, solution, scope, and changes. The inclusion of user-editable prompt and UI feedback is excellent. The risk is medium because it touches several areas (gateway, API, UI) and relies on a new pre-route hook, which could introduce unforeseen issues. While human testing was performed, thorough integration and performance testing are crucial. The AI assistance used also adds a layer of risk that needs to be considered.",
      "duplicateGroup": 6
    },
    {
      "number": 17428,
      "title": "fix: strip thinking blocks with invalid signatures for OpenAI-compat APIs",
      "body": "## Summary\n\n- **Problem:** When using GitHub Copilot with Claude models via the OpenAI-compatible API path, thinking blocks get persisted with field-name strings (e.g. `\"reasoning_text\"`) as their `thinkingSignature` instead of real cryptographic signatures. When these are replayed on subsequent requests, Copilot returns HTTP 400: `Invalid signature in thinking block`.\n- **Why it matters:** This bricks multi-turn sessions with tool calls \u2014 the first turn works, but follow-up requests fail because the replayed thinking blocks have invalid signatures.\n- **What changed:** Added `stripCompletionsReasoningFieldSignatures` which detects and removes thinking blocks with field-name-as-signature patterns. Applied as a transcript policy for all OpenAI-compat APIs (except native OpenAI, Google, and Anthropic providers which handle signatures correctly).\n- **What did NOT change:** Providers that legitimately use thinking signatures (Anthropic, Bedrock Extended Thinking) are unaffected. The proper long-term fix is using `anthropic-messages` API for Claude models (see follow-up PR).\n\n## Change Type (select all)\n\n- [x] Bug fix\n\n## Scope (select all touched areas)\n\n- [x] Gateway / orchestration\n- [x] Integrations\n\n## Linked Issue/PR\n\n- Related #12006 (jackheuberger's complementary approach)\n- Depends on #17284 and #17427\n\n## User-visible / Behavior Changes\n\n- Sessions with Copilot Claude models no longer brick after tool calls due to invalid thinking signatures\n- Thinking blocks with field-name signatures are silently stripped from outgoing requests (they contain no useful content anyway \u2014 just the field name string)\n\n## Security Impact (required)\n\n- New permissions/capabilities? `No`\n- Secrets/tokens handling changed? `No`\n- New/changed network calls? `No`\n- Command/tool execution surface changed? `No`\n- Data access scope changed? `No`\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+\n- Model/provider: github-copilot with Claude models\n\n### Steps\n\n1. Use Copilot with a Claude model via OpenAI-compat API\n2. Send a message that triggers a tool call\n3. The agent's follow-up request replays the thinking block\n4. Previously: HTTP 400. Now: thinking block stripped, request succeeds\n\n### Expected\n\n- Multi-turn conversations with tool calls work without 400 errors\n\n### Actual\n\n- Confirmed working in live testing\n\n## Evidence\n\n- [x] Failing test/log before + passing after\n  - 17 tests in `strip-completions-reasoning.test.ts`\n  - Transcript policy tests updated\n\n## Human Verification (required)\n\n- Verified: Live gateway testing \u2014 multi-turn tool conversations no longer 400\n- Edge cases: Mixed content blocks, nested thinking blocks, non-Copilot providers unaffected\n- Not verified: Exhaustive model coverage\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes`\n- Config/env changes? `No`\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: Remove the `stripCompletionsFieldSignatures` policy flag\n- Known bad symptoms: If stripping is too aggressive, thinking context could be lost (mitigated: only strips blocks with known field-name patterns)\n\n## Risks and Mitigations\n\n- Risk: This is a safety net, not the root fix. The proper solution is using `anthropic-messages` API (see follow-up PR).\n  - Mitigation: This remains useful for backwards compatibility with existing sessions that have bad signatures.\n\n---\n\n> **Stacked PR chain:** #17284 > #17427 > **this PR** > anthropic-messages default\n>\n> Review incremental changes: compare feat/copilot-sdk-provider...fix/copilot-thinking-signature\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds Copilot SDK integration (`@github/copilot-sdk`) and fixes thinking block signature stripping for OpenAI-compatible APIs that proxy to Anthropic.\n\nThe core fix (`stripCompletionsReasoningFieldSignatures`) is sound \u2014 it detects and strips thinking blocks where pi-ai stored a reasoning field name (e.g., `\"reasoning_text\"`) instead of a real cryptographic signature, preventing HTTP 400s on subsequent turns. The function is applied via the existing transcript policy system for all OpenAI-compat providers except native OpenAI, Google, and Anthropic, which is the correct scope.\n\nThe PR also adds:\n- A new `copilot-cli` backend that delegates to the Copilot SDK for interactive sessions\n- SDK-based auth detection and model discovery for the GitHub Copilot provider\n- An `SDK_MANAGED_TOKEN` marker in auth profiles when the Copilot SDK handles authentication\n\nKey findings:\n- A hardcoded `\"sdk-managed\"` string in `github-copilot-auth.ts` should use the `SDK_MANAGED_TOKEN` constant to stay in sync with the runner/provider detection code\n- The `ensureCopilotSdkClient` singleton in `github-copilot-sdk.ts` permanently caches rejected promises if `client.start()` fails, preventing retry after transient errors\n- The SDK-managed token code in `run.ts` and `compact.ts` is duplicated \u2014 a minor concern but worth noting for future refactoring\n\n<h3>Confidence Score: 3/5</h3>\n\n- Functional core fix is correct; two secondary issues in Copilot SDK integration need attention before merge.\n- The thinking block stripping fix is well-implemented with thorough tests. However, two issues in the SDK integration layer reduce confidence: (1) a hardcoded string literal in auth flow that should use the SDK_MANAGED_TOKEN constant to prevent silent breakage if the constant changes, and (2) a permanently cached rejected promise in the SDK client singleton. Both are localized and fixable but represent real defects.\n- Pay close attention to `src/providers/github-copilot-auth.ts` (hardcoded token string) and `src/providers/github-copilot-sdk.ts` (client startup error handling).\n\n<sub>Last reviewed commit: 696545d</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "tag-assistant",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:00:24Z",
      "updatedAt": "2026-02-15T19:24:53Z",
      "headRef": "fix/copilot-thinking-signature",
      "baseRef": "main",
      "filesChanged": 25,
      "additions": 2008,
      "deletions": 24,
      "commits": 6,
      "labels": [
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "package.json",
        "pnpm-lock.yaml",
        "src/agents/auth-profiles/constants.ts",
        "src/agents/cli-backends.ts",
        "src/agents/cli-runner.ts",
        "src/agents/copilot-runner.test.ts",
        "src/agents/copilot-runner.ts",
        "src/agents/copilot-sdk.test.ts",
        "src/agents/copilot-sdk.ts",
        "src/agents/model-selection.ts",
        "src/agents/models-config.providers.ts",
        "src/agents/pi-embedded-helpers.strip-completions-reasoning.test.ts",
        "src/agents/pi-embedded-helpers.ts",
        "src/agents/pi-embedded-helpers/openai.ts",
        "src/agents/pi-embedded-runner/compact.ts",
        "src/agents/pi-embedded-runner/google.ts",
        "src/agents/pi-embedded-runner/run.ts",
        "src/agents/transcript-policy.test.ts",
        "src/agents/transcript-policy.ts",
        "src/providers/github-copilot-auth.ts",
        "src/providers/github-copilot-models.test.ts",
        "src/providers/github-copilot-models.ts",
        "src/providers/github-copilot-sdk.test.ts",
        "src/providers/github-copilot-sdk.ts",
        "src/providers/github-copilot-token.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17428.diff",
      "totalScore": 73,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "2032 lines changed (2008+/24-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "tag-assistant (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "This PR addresses a critical bug that breaks multi-turn sessions with Copilot Claude models. The fix is well-scoped, targeting only the problematic thinking blocks. The description is clear, explaining the problem, solution, and impact. The change type is correctly identified as a bug fix. The security impact is assessed as none. The repro steps are provided. The code changes seem focused and well-tested. The dependency on other PRs is noted. The long-term solution is also mentioned, indicating a good understanding of the problem and its context.",
      "duplicateGroup": 7
    },
    {
      "number": 17427,
      "title": "feat: add Copilot SDK provider for auth and model discovery",
      "body": "## Summary\n\n- **Problem:** The CLI backend (#17284) uses the Copilot SDK for agent sessions, but the existing provider pipeline (REST-based) lacks SDK-powered auth verification and dynamic model discovery\n- **Why it matters:** Without SDK integration in the provider layer, model lists are hardcoded and auth status can't be verified programmatically\n- **What changed:** Added SDK-based auth checking and dynamic model discovery in the provider pipeline, alongside the CLI backend's agent runtime\n- **What did NOT change:** The CLI backend from #17284 is untouched; this stacks on top of it\n\n## Change Type (select all)\n\n- [x] Feature\n\n## Scope (select all touched areas)\n\n- [x] Auth / tokens\n- [x] Integrations\n\n## Linked Issue/PR\n\n- Depends on #17284 (CLI backend)\n- Related #4469\n\n## User-visible / Behavior Changes\n\n- Copilot model list is now dynamically discovered via SDK when available (falls back to hardcoded defaults)\n- Auth status can be checked programmatically\n\n## Security Impact (required)\n\n- New permissions/capabilities? `No`\n- Secrets/tokens handling changed? `No`\n- New/changed network calls? `No`\n- Command/tool execution surface changed? `No`\n- Data access scope changed? `No`\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+\n- Model/provider: github-copilot\n\n### Steps\n\n1. Install Copilot CLI and authenticate\n2. Configure openclaw to use github-copilot provider\n3. Models are discovered automatically via SDK\n\n### Expected\n\n- Dynamic model list from SDK, with proper capabilities\n\n### Actual\n\n- Works as expected in unit tests\n\n## Evidence\n\n- [x] Failing test/log before + passing after (23 new SDK tests, 11 model tests)\n\n## Human Verification (required)\n\n- Verified: All tests pass, type-check clean, lint/format clean\n- Edge cases: SDK unavailable, empty model list, disabled models filtered\n- Not verified: Live end-to-end with authenticated Copilot CLI\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes`\n- Config/env changes? `No`\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: SDK is lazy-loaded and optional; falls back to hardcoded defaults\n- Files to restore: Revert this commit\n\n## Risks and Mitigations\n\nNone\n\n---\n\n> **Stacked PR chain:** #17284 > **this PR** > thinking signature fix > anthropic-messages default\n>\n> Review incremental changes: compare feat/copilot-cli-backend...feat/copilot-sdk-provider\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds SDK-based authentication and dynamic model discovery for the GitHub Copilot provider, complementing the CLI backend added in #17284. The changes integrate `@github/copilot-sdk` into the provider pipeline for programmatic auth verification and model catalogue discovery, with graceful fallback to hardcoded defaults.\n\n**Key changes:**\n- Added `src/providers/github-copilot-sdk.ts` for SDK-based auth status checking and dynamic model discovery in the provider layer\n- Enhanced `src/providers/github-copilot-models.ts` with SDK-powered model discovery and proper capability detection (vision, reasoning)\n- Updated `src/providers/github-copilot-auth.ts` to detect SDK-managed auth before falling back to device flow\n- Added `SDK_MANAGED_TOKEN` marker for SDK-managed authentication paths\n- Extended model list from 7 to 25+ models with proper capabilities tracking\n- Provider detection now checks SDK availability when no explicit credentials exist\n- Comprehensive test coverage (23 SDK tests, 11 model tests) with proper mocking\n\n**Architecture:**\n- Provider SDK layer (`src/providers/github-copilot-sdk.ts`) handles auth/discovery for REST-based pipeline\n- CLI backend SDK layer (`src/agents/copilot-sdk.ts`) handles agent sessions via JSON-RPC stdio\n- Both layers share the same `@github/copilot-sdk` dependency but serve different purposes\n- Lazy SDK imports and graceful degradation ensure optional dependency doesn't break builds\n\n<h3>Confidence Score: 5/5</h3>\n\n- Safe to merge with no critical issues\n- The implementation is well-architected with proper separation of concerns between the provider and agent layers. Comprehensive test coverage (34 new tests) validates all code paths including error handling and edge cases. The changes are backward compatible with graceful fallbacks, lazy SDK loading prevents build failures, and the SDK is properly managed as an optional dependency. No security concerns, proper error handling throughout, and clean integration with existing auth/model systems.\n- No files require special attention\n\n<sub>Last reviewed commit: bcc5c9e</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "tag-assistant",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T18:59:54Z",
      "updatedAt": "2026-02-15T19:24:56Z",
      "headRef": "feat/copilot-sdk-provider",
      "baseRef": "main",
      "filesChanged": 19,
      "additions": 1738,
      "deletions": 22,
      "commits": 4,
      "labels": [
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "package.json",
        "pnpm-lock.yaml",
        "src/agents/auth-profiles/constants.ts",
        "src/agents/cli-backends.ts",
        "src/agents/cli-runner.ts",
        "src/agents/copilot-runner.test.ts",
        "src/agents/copilot-runner.ts",
        "src/agents/copilot-sdk.test.ts",
        "src/agents/copilot-sdk.ts",
        "src/agents/model-selection.ts",
        "src/agents/models-config.providers.ts",
        "src/agents/pi-embedded-runner/compact.ts",
        "src/agents/pi-embedded-runner/run.ts",
        "src/providers/github-copilot-auth.ts",
        "src/providers/github-copilot-models.test.ts",
        "src/providers/github-copilot-models.ts",
        "src/providers/github-copilot-sdk.test.ts",
        "src/providers/github-copilot-sdk.ts",
        "src/providers/github-copilot-token.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17427.diff",
      "totalScore": 72,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "1760 lines changed (1738+/22-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "tag-assistant (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "This PR introduces a significant feature by integrating the Copilot SDK for auth and model discovery, improving the system's flexibility and reducing hardcoding. The description is thorough, covering the problem, solution, and impact. The inclusion of tests (both unit and model tests) and verification steps is commendable. The 'Human Verification' section is also helpful. The 'Not verified' section highlights a potential risk: lack of live end-to-end testing. The risk is medium because while the core functionality seems well-tested, the absence of end-to-end testing with a live authenticated Copilot CLI environment leaves room for integration issues. The number of files changed is also relatively high, increasing the surface area for potential issues.",
      "duplicateGroup": 7
    },
    {
      "number": 12296,
      "title": "security: persistence-only secret redaction for session transcripts",
      "body": "## Summary\r\n\r\n\ud83e\udd16 **AI-assisted** \u2014 Built by an OpenClaw agent (Claude Opus 4.6), fully tested, fully reviewed. The author understands the code and architecture decisions.\r\n\r\nRedact sensitive secrets (API keys, tokens, passwords) from session transcript JSONL files **at the persistence layer only**, keeping in-memory entries unredacted so the LLM can reason about full tool output (e.g., `curl` with Bearer tokens, `cat` of config files).\r\n\r\nSee [design document on #12182](https://github.com/openclaw/openclaw/issues/12182#issuecomment-3869025731) for full architecture rationale, tradeoffs, and coverage analysis.\r\n\r\n## Root Cause\r\n\r\nIn `session-tool-result-guard.ts`, tool results are persisted via `_appendEntry()` \u2192 `_persist()` which calls `JSON.stringify(entry)` + `appendFileSync` \u2014 no redaction applied. The existing `redactSensitiveText()` was only used on the read path.\r\n\r\nAdditionally, `appendAssistantMessageToSessionTranscript()` in `transcript.ts` creates a raw `SessionManager.open()` without the guard, bypassing any redaction.\r\n\r\n## Fix\r\n\r\n### Architecture: Persistence-only via `_persist` monkey-patch\r\n\r\n- **`SessionManager._persist()`** \u2014 Replaced entirely to apply `redactEntryForPersistence()` during `JSON.stringify` serialization (both bulk-flush and single-entry paths)\r\n- **`SessionManager._rewriteFile()`** \u2014 Also replaced for the migration/recovery write path\r\n- **`transcript.ts`** \u2014 Wrapped with `guardSessionManager()` to close the bypass\r\n- **In-memory `fileEntries[]`** \u2014 Untouched. LLM sees full unredacted content via `buildSessionContext()`\r\n\r\n### Entry types covered (all text-carrying types)\r\n\r\n| Entry Type | Field(s) Redacted |\r\n|---|---|\r\n| `message` (toolResult, assistant, user) | `message.content[].text` |\r\n| `compaction` / `branch_summary` | `summary` string |\r\n| `custom_message` | `content` (string or TextContent[]) |\r\n\r\n### Why monkey-patching\r\n\r\n`SessionManager` lives in the upstream `@mariozechner/pi-coding-agent` package \u2014 we cannot modify `_persist` directly. The existing guard already monkey-patches `appendMessage`; our `_persist` patch follows the same established pattern. We pin to upstream v0.52.8 with SHA-256 hash tests that fail on any structural change.\r\n\r\n### Other improvements\r\n\r\n- Cache compiled regex patterns (content-based `JSON.stringify` comparison)\r\n- Resolve redact options once at guard install time (no per-call `loadConfig()`)\r\n- Extract shared `redactTextBlocks()` helper (zero code duplication)\r\n\r\n## Test plan\r\n\r\n**38 tests total**, all passing (Node + Bun):\r\n\r\n- **Dual-path verification**: every redaction test checks both in-memory (unredacted) and on-disk (redacted) using disk-persisted `SessionManager`\r\n- **All message roles**: toolResult, assistant, user\r\n- **All entry types**: compaction, branch_summary, custom_message (string + array)\r\n- **Non-message passthrough**: session header unchanged\r\n- **Transcript mirror**: delivery-mirror redaction verified\r\n- **Upstream compatibility**: SHA-256 hash of `_persist.toString()` and `_rewriteFile.toString()`\r\n- **Clean passthrough**: entries without secrets return same reference\r\n\r\n## Related\r\n\r\n- Refs: #12182\r\n- Related: #12260 (similar goal, different architecture \u2014 redacts before `appendMessage` which also affects LLM context)\r\n\r\n## Files changed (5)\r\n\r\n- `src/agents/session-tool-result-guard.ts` \u2014 `redactEntryForPersistence()`, `_persist`/`_rewriteFile` patches, `redactTextBlocks()` helper\r\n- `src/agents/session-tool-result-guard.test.ts` \u2014 26 guard tests with dual-path verification\r\n- `src/config/sessions/transcript.ts` \u2014 `guardSessionManager()` wrapper\r\n- `src/config/sessions/transcript.test.ts` \u2014 delivery-mirror redaction test\r\n- `src/logging/redact.ts` \u2014 pattern caching\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR changes session transcript persistence so secrets are redacted only when writing JSONL to disk, keeping in-memory session entries unredacted for LLM context. It does this by extending the existing `guardSessionManager()` approach to wrap `SessionManager`\u2019s persistence methods (`_persist` and `_rewriteFile`) to serialize redacted copies of entries, and by ensuring `transcript.ts` uses a guarded session manager so it can\u2019t bypass redaction. It also updates the redaction utility to cache compiled regex/pattern work and adds tests that verify the \u201cdual path\u201d behavior (unredacted in-memory, redacted on disk) across message roles and other transcript entry types.\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk.\n- Reviewed the changed persistence wrapper and transcript guard integration along with the updated redaction caching and tests; changes are focused, preserve upstream persistence semantics, and include strong dual-path test coverage to prevent regressions.\n- No files require special attention\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "akoscz",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-09T03:08:09Z",
      "updatedAt": "2026-02-15T19:24:41Z",
      "headRef": "feature/exec-write-time-redaction",
      "baseRef": "main",
      "filesChanged": 7,
      "additions": 741,
      "deletions": 11,
      "commits": 10,
      "labels": [
        "docs",
        "gateway",
        "agents",
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "docs/gateway/security/index.md",
        "docs/logging.md",
        "src/agents/session-tool-result-guard.e2e.test.ts",
        "src/agents/session-tool-result-guard.ts",
        "src/config/sessions/transcript.test.ts",
        "src/config/sessions/transcript.ts",
        "src/logging/redact.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/12296.diff",
      "totalScore": 72,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "752 lines changed (741+/11-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "akoscz (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Comprehensive fix with good rationale and coverage. Monkey-patching introduces risk, but is justified by the upstream package limitation. Persistence-only redaction is a sound security approach. Good test coverage.",
      "duplicateGroup": 8
    },
    {
      "number": 17284,
      "title": "feat: add GitHub Copilot SDK as CLI backend",
      "body": "## Summary\n\n- **Problem:** No way to use GitHub Copilot as a CLI backend alongside `claude-cli` and `codex-cli`\n- **Why it matters:** Users with GitHub Copilot subscriptions should be able to use Copilot as their agent runtime, accessing Claude/GPT/Gemini models through it\n- **What changed:** Added `copilot-cli` as a new CLI backend using the official `@github/copilot-sdk`, following the exact same patterns as `claude-cli` and `codex-cli`\n- **What did NOT change:** The existing Copilot provider pipeline, auth profiles, or any other backend is untouched\n\n## Change Type (select all)\n\n- [ ] Bug fix\n- [x] Feature\n- [ ] Refactor\n- [ ] Docs\n- [ ] Security hardening\n- [ ] Chore/infra\n\n## Scope (select all touched areas)\n\n- [ ] Gateway / orchestration\n- [ ] Skills / tool execution\n- [x] Auth / tokens\n- [ ] Memory / storage\n- [x] Integrations\n- [ ] API / contracts\n- [ ] UI / DX\n- [ ] CI/CD / infra\n\n## Linked Issue/PR\n\n- Related #4469 \u2014 @Aditya190803&#39;s most recent SDK migration PR (provider pipeline approach; complementary to this CLI backend approach)\n- Related #4442 \u2014 @Aditya190803&#39;s earlier attempt (superseded by #4469)\n- Related #2091 \u2014 @Aditya190803&#39;s original SDK integration PR\n\n&gt; **Note:** Aditya&#39;s PRs migrate the **provider pipeline** to use the Copilot SDK. This PR takes a different, complementary approach: it adds Copilot as a **CLI backend** (like `claude-cli`/`codex-cli`), using the SDK&#39;s agent runtime over JSON-RPC stdio. Both approaches could coexist.\n\n## User-visible / Behavior Changes\n\n- New `copilot-cli` backend available for agent routing (config: `provider: copilot-cli`)\n- Supports 17 models via Copilot (Claude, GPT, Gemini families)\n- Model aliases for convenience (`opus` \u2192 `claude-opus-4.6`, `sonnet` \u2192 `claude-sonnet-4.5`, `gemini` \u2192 `gemini-3-pro-preview`, etc.)\n- Requires Copilot CLI installed and authenticated (`copilot login`)\n\n## Security Impact (required)\n\n- New permissions/capabilities? `Yes` \u2014 adds ability to invoke the Copilot CLI subprocess via SDK\n- Secrets/tokens handling changed? `No` \u2014 auth is delegated entirely to Copilot CLI&#39;s own auth flow\n- New/changed network calls? `Yes` \u2014 SDK communicates with GitHub Copilot service (managed by the SDK, not us)\n- Command/tool execution surface changed? `Yes` \u2014 tool permissions auto-approved in SDK session config (matches existing claude-cli/codex-cli behavior)\n- Data access scope changed? `No`\n- Risk + mitigation: The SDK manages its own subprocess and auth. We auto-approve tool permissions (`onPermissionRequest: async () =&gt; ({ kind: &#34;approved&#34; })`) to match the existing `claude-cli` and `codex-cli` pattern where the host controls tool availability. Tools are explicitly noted as disabled in the system prompt passed to the SDK.\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+ / Bun\n- Model/provider: copilot-cli with any supported model\n- Relevant config: `provider: copilot-cli`, `model: claude-sonnet-4.5` (or any)\n\n### Steps\n\n1. Install Copilot CLI and authenticate: `copilot login`\n2. Configure openclaw to use `copilot-cli` as backend\n3. Send a message\n\n### Expected\n\n- Response returned from Copilot SDK agent runtime\n- Session ID tracked for resume capability\n\n### Actual\n\n- Works as expected in unit tests (22/22 passing)\n- Live testing requires Copilot CLI authentication (not available on dev machine)\n\n## Evidence\n\n- [x] Failing test/log before + passing after\n\n**Test results:** 22/22 tests passing (15 SDK tests + 7 runner tests)\n- SDK tests: CLI installation check, auth verification, session creation/resume, error cleanup, system prompt handling, model listing (authenticated/unauthenticated/failure), client creation\n- Runner tests: unavailability failover, successful run shape, session resume, empty payloads, error wrapping, non-failover passthrough, default model\n\n**Type-check:** `pnpm tsgo --noEmit` \u2014 clean, zero errors\n**Lint:** `oxlint` \u2014 0 warnings, 0 errors\n**Format:** `oxfmt` \u2014 clean\n\n## Human Verification (required)\n\n- Verified: All 22 unit tests pass, type-check clean, lint/format clean\n- Verified: Pattern matches existing `claude-cli` and `codex-cli` backends exactly\n- Edge cases: Empty responses, auth rejection, SDK errors, missing CLI, session resume\n- **Not verified:** Live end-to-end with authenticated Copilot CLI (requires active Copilot subscription + `copilot login`)\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes` \u2014 purely additive, no existing behavior changed\n- Config/env changes? `No` \u2014 new `copilot-cli` provider value, but no env vars required\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: Don&#39;t configure `copilot-cli` as a provider; falls through to next backend via `FailoverError`\n- Files to restore: Revert this commit\n- Bad symptoms: `FailoverError` if Copilot CLI not installed or not authenticated (expected graceful degradation)\n\n## Risks and Mitigations\n\n- Risk: `@github/copilot-sdk` is at v0.1.22 (pre-1.0), API may change\n  - Mitigation: Pinned exact version (no caret), SDK is dynamically imported so it&#39;s lazy-loaded, isolated in 2 files\n- Risk: v0.1.23+ requires Node 24+, we target Node 22+\n  - Mitigation: Pinned to v0.1.22, documented in code comment\n- Risk: `COPILOT_CLI_PROFILE_ID` is exported but not yet consumed\n  - Mitigation: Follows existing pattern (`QWEN_CLI_PROFILE_ID`, `MINIMAX_CLI_PROFILE_ID` are also forward-declared); ready for auth profile sync when needed\n\n---\n\n### Things maintainers may flag (and preemptive answers)\n\n| Potential flag | Answer |\n|---|---|\n| **`onPermissionRequest: auto-approve`** | Matches `claude-cli`/`codex-cli` pattern \u2014 the host (openclaw) controls tool availability, not the SDK. System prompt explicitly says &#34;Tools are disabled.&#34; Can restrict further if needed. |\n| **`@github/copilot-sdk` is pre-1.0** | Agreed, it&#39;s v0.1.22. Pinned exact version, lazy dynamic import, isolated in 2 files. Easy to update or remove. |\n| **No live E2E test** | Requires `copilot login` with active subscription. 22 unit tests cover all code paths. Happy to add E2E once auth is available. |\n| **`COPILOT_CLI_PROFILE_ID` unused** | Forward declaration following QWEN/MINIMAX pattern. Can remove if preferred. |\n| **DEFAULT_MODEL_IDS hardcoded (17 models)** | `listCopilotModels()` exists for dynamic discovery but needs auth. Hardcoded list is the fallback, same pattern as other providers. |\n| **No image support** | SDK takes a prompt string, not content blocks. Can add when SDK supports multimodal input. |\n\n### Files changed\n\n**New files (4):**\n- `src/agents/copilot-sdk.ts` (188 LOC) \u2014 Core SDK wrapper: CLI check, client creation, auth, model listing, agent runner\n- `src/agents/copilot-runner.ts` (153 LOC) \u2014 Bridge to `EmbeddedPiRunResult` interface\n- `src/agents/copilot-sdk.test.ts` (243 LOC) \u2014 15 tests\n- `src/agents/copilot-runner.test.ts` (177 LOC) \u2014 7 tests\n\n**Modified files (5 + deps):**\n- `src/agents/cli-backends.ts` \u2014 `DEFAULT_COPILOT_BACKEND` config + `COPILOT_MODEL_ALIASES` (15 aliases)\n- `src/agents/cli-runner.ts` \u2014 Route `copilot-cli` provider to SDK runner\n- `src/agents/model-selection.ts` \u2014 Register `copilot-cli` in `isCliProvider()`\n- `src/agents/auth-profiles/constants.ts` \u2014 Forward-declare `COPILOT_CLI_PROFILE_ID`\n- `src/providers/github-copilot-models.ts` \u2014 Update DEFAULT_MODEL_IDS to 17 current models\n- `package.json` + `pnpm-lock.yaml` \u2014 Add `@github/copilot-sdk@0.1.22`\n\n### Review Feedback Addressed\n\nAll 3 automated review findings (Greptile) fixed in [`18ac044`](https://github.com/openclaw/openclaw/pull/17284/commits/18ac04452978d6ac1f3531b17cfe15b3ffa30979):\n\n| Finding | Fix |\n|---|---|\n| Model aliases never applied for `copilot-cli` | `copilot-runner.ts` now resolves aliases via `resolveCliBackendConfig` + `normalizeCliModel` before passing to SDK |\n| `images` parameter silently dropped | `cli-runner.ts` logs `log.warn` when images are present for `copilot-cli` |\n| Sync `execFileSync` blocks event loop every request | `copilot-sdk.ts` caches `checkCopilotAvailable()` result for process lifetime |\n\n\n<h3>Greptile Summary</h3>\n\nAdds `copilot-cli` as a new CLI backend using `@github/copilot-sdk`, following the existing `claude-cli`/`codex-cli` patterns. The implementation is well-structured with proper resource cleanup, lazy SDK loading, and graceful failover. Test coverage is solid (22 tests).\n\n**Issues found:**\n- **Model aliases are dead code**: The `COPILOT_MODEL_ALIASES` map (e.g. `opus` \u2192 `claude-opus-4.6`) defined in `cli-backends.ts` is never applied because the copilot-cli path is intercepted in `runCliAgent` before `normalizeCliModel()` runs. Users who specify friendly alias names like `opus` or `sonnet` will have those raw strings passed to the Copilot SDK, which won&#39;t recognise them.\n- **Breaking change to existing provider pipeline**: `github-copilot-models.ts` replaces the entire default model list, removing previously listed models (`gpt-4o`, `o1`, `o1-mini`, `o3-mini`, `gpt-4.1-mini`, `gpt-4.1-nano`). Despite the PR stating the existing Copilot provider pipeline is untouched, this file is part of that pipeline.\n- **`images` parameter silently dropped**: The copilot-cli intercept in `cli-runner.ts` does not forward `params.images`, silently discarding caller-provided image data with no warning.\n\n<h3>Confidence Score: 2/5</h3>\n\n- The new copilot-cli backend is mostly additive, but the model alias bug means advertised functionality won&#39;t work, and the model list change could break existing provider pipeline users.\n- Score reflects two functional issues: (1) model aliases defined for copilot-cli are never applied due to early interception in the routing path, making friendly model names non-functional; (2) the DEFAULT_MODEL_IDS replacement in github-copilot-models.ts is a potentially breaking change to the existing Copilot provider pipeline that contradicts the PR&#39;s claim of no changes to existing behavior.\n- `src/agents/copilot-runner.ts` (model alias resolution missing), `src/providers/github-copilot-models.ts` (breaking model list change), `src/agents/cli-runner.ts` (images silently dropped)\n\n<sub>Last reviewed commit: d5a2149</sub>\n\n\n\n<sub>(3/5) Reply to the agent&#39;s comments like &#34;Can you suggest a fix for this @greptileai?&#34; or ask follow-up questions!</sub>\n\n",
      "author": "tag-assistant",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T16:12:13Z",
      "updatedAt": "2026-02-15T19:23:32Z",
      "headRef": "feat/copilot-cli-backend",
      "baseRef": "main",
      "filesChanged": 11,
      "additions": 968,
      "deletions": 13,
      "commits": 2,
      "labels": [
        "agents",
        "size: L"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "package.json",
        "pnpm-lock.yaml",
        "src/agents/auth-profiles/constants.ts",
        "src/agents/cli-backends.ts",
        "src/agents/cli-runner.ts",
        "src/agents/copilot-runner.test.ts",
        "src/agents/copilot-runner.ts",
        "src/agents/copilot-sdk.test.ts",
        "src/agents/copilot-sdk.ts",
        "src/agents/model-selection.ts",
        "src/providers/github-copilot-models.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17284.diff",
      "totalScore": 72,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "981 lines changed (968+/13-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "tag-assistant (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "The PR introduces a new feature by adding GitHub Copilot SDK as a CLI backend. The description is detailed, explaining the problem, solution, and changes. It also highlights what remains unchanged and links related PRs. The change type is correctly identified as a feature. The scope touches auth/tokens and integrations, which are potential areas of risk. The user-visible changes are clearly outlined, including model support and authentication requirements. The security impact is acknowledged, although the description is cut off. The file list indicates significant changes, including new files for copilot-runner and copilot-sdk, as well as modifications to existing agent-related files. The risk is medium due to the integration of a new SDK and the potential security implications of invoking Copilot. A thorough security review is recommended.",
      "duplicateGroup": 7
    },
    {
      "number": 17454,
      "title": "feat(matrix): support device verification via recovery key",
      "body": "## Summary\r\n\r\n- **Problem:** While Matrix E2EE bots could participate in some encrypted conversations, device verification was impossible in OpenClaw, creating trust issues and poor UX. Messages could be flagged due to unverified devices, and certain user/admin settings would prevent interacting with unverified devices completely. Bots also couldn't restore encrypted message history from backup.\r\n- **Why it matters:** Unverified device warnings undermine user trust and make bots appear insecure or compromised. In security-conscious environments, users may ignore or distrust unverified bot messages, limiting bot utility in E2EE channels.\r\n- **What changed:** Added complete Matrix device verification workflow via recovery key, including secret storage decryption, cross-signing key restoration, device signing, and encrypted backup restoration. Multi-account support allows managing multiple Matrix identities with independent verification states. Verified bots now send trusted messages without warnings.\r\n- **What did NOT change (scope boundary):** Interactive device verification flows (QR code, emoji comparison), manual secret storage setup, or backup creation. This PR only handles verification/restoration using an existing recovery key from Element/another client.\r\n\r\n## Change Type (select all)\r\n\r\n- [ ] Bug fix\r\n- [x] Feature\r\n- [ ] Refactor\r\n- [ ] Docs\r\n- [ ] Security hardening\r\n- [ ] Chore/infra\r\n\r\n## Scope (select all touched areas)\r\n\r\n- [x] Gateway / orchestration\r\n- [ ] Skills / tool execution\r\n- [ ] Auth / tokens\r\n- [ ] Memory / storage\r\n- [x] Integrations\r\n- [x] API / contracts\r\n- [x] UI / DX\r\n- [ ] CI/CD / infra\r\n\r\n## Linked Issue/PR\r\n\r\n- Closes #7649, #15706, and probably many other duplicated issues\r\n\r\n## User-visible / Behavior Changes\r\n\r\n**New CLI Commands:**\r\n- `openclaw matrix verify status` - Show device verification status for a Matrix account\r\n- `openclaw matrix verify recovery-key <key>` - Verify device using recovery key\r\n- Both commands support `--account <id>` for multi-account setups\r\n- JSON output via `--json` flag\r\n\r\n**Gateway RPC Methods:**\r\n- `matrix.verify.recoveryKey` - Verify device and restore encrypted backups\r\n- `matrix.verify.status` - Get current verification state\r\n\r\n**Configuration:**\r\n- No config changes required; works with existing `channels.matrix.accounts` multi-account setup\r\n- E2EE must be enabled: `channels.matrix.encryption: true`\r\n\r\n**Behavior:**\r\n- Verified devices can now read encrypted room history\r\n- Devices remain verified across restarts (state persisted per account)\r\n- Backup restoration happens automatically during verification (if available)\r\n- Bot-SDK limitation: backup restoration requires Element for full functionality\r\n\r\n## Security Impact (required)\r\n\r\n- New permissions/capabilities? `Yes`\r\n- Secrets/tokens handling changed? `Yes`\r\n- New/changed network calls? `Yes`\r\n- Command/tool execution surface changed? `No`\r\n- Data access scope changed? `Yes`\r\n\r\n**Explanation:**\r\n\r\n**New Capabilities:**\r\n- Decrypts secret storage using recovery key (PBKDF2 key derivation + AES-CTR)\r\n- Accesses Matrix account's encrypted cross-signing keys (master, self-signing, user-signing)\r\n- Signs device with cross-signing keys to establish trust\r\n- Downloads and decrypts encrypted message backup from homeserver\r\n\r\n**Risk + Mitigation:**\r\n\r\n1. **Recovery key exposure in CLI arguments:**\r\n   - Risk: Shell history/process listing exposure\r\n   - Mitigation: Supports `--file` flag to read from file, warns when using env var, CLI help encourages secure patterns\r\n\r\n2. **Decrypted keys in memory:**\r\n   - Risk: Cross-signing private keys held in memory during verification\r\n   - Mitigation: Keys only loaded during verification operation, not retained long-term; Node.js memory isolation\r\n\r\n3. **Verification state persistence:**\r\n   - Risk: Verification timestamp/backup version stored in per-account SQLite DB\r\n   - Mitigation: No sensitive keys persisted; only verification metadata; DB stored in standard OpenClaw paths with OS-level permissions\r\n\r\n4. **Homeserver API calls:**\r\n   - Risk: New API calls to fetch secret storage, backup versions, backup keys\r\n   - Mitigation: All calls use existing authenticated Matrix client; follows matrix-js-sdk patterns; proper error handling for API failures\r\n\r\n## Repro + Verification\r\n\r\n### Environment\r\n\r\n- OS: macOS 14 (tested), Linux (tested)\r\n- Runtime/container: Node.js 22+\r\n- Model/provider: N/A (Matrix integration)\r\n- Integration/channel: Matrix (matrix-js-sdk)\r\n- Relevant config (redacted):\r\n```json\r\n{\r\n  \"channels\": {\r\n    \"matrix\": {\r\n      \"enabled\": true,\r\n      \"homeserver\": \"https://matrix.example.com\",\r\n      \"encryption\": true,\r\n      \"accounts\": {\r\n        \"main\": {\r\n          \"name\": \"Main Bot\",\r\n          \"accessToken\": \"syt_...\"\r\n        },\r\n        \"work\": {\r\n          \"name\": \"Work Bot\",\r\n          \"accessToken\": \"syt_...\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### Steps\r\n\r\n**Single Account:**\r\n1. Configure Matrix channel with E2EE enabled\r\n2. Obtain recovery key from Matrix client such as Element (Settings \u2192 Security \u2192 Key Backup)\r\n3. Run `openclaw matrix verify recovery-key \"AbCd ... 6789\"`\r\n4. Run `openclaw matrix verify status` to confirm verification\r\n5. Send encrypted message to bot's room\r\n6. Verify bot can read and respond to encrypted messages\r\n\r\n**Multi-Account:**\r\n1. Configure multiple Matrix accounts in config\r\n2. Run `openclaw matrix verify status --account main` (shows unconfigured)\r\n3. Run `openclaw matrix verify recovery-key <key> --account main`\r\n4. Run `openclaw matrix verify status --account work` (still unconfigured)\r\n5. Verify each account has independent verification state\r\n\r\n### Expected\r\n\r\n- Device verification succeeds with valid recovery key\r\n- Bot can decrypt incoming encrypted messages\r\n- Encrypted backup restored (if available)\r\n- Status shows \"Verified \u2713\" with device ID and backup info\r\n- Multi-account setups maintain separate verification states\r\n\r\n### Actual\r\n\r\n- All expected behaviors confirmed \u2713\r\n- Helpful error messages when account not configured\r\n- Clean JSON output for scripting/automation\r\n\r\n## Evidence\r\n\r\n- [x] Failing test/log before + passing after\r\n- [x] Trace/log snippets\r\n- [x] Screenshot/recording\r\n- [ ] Perf numbers (if relevant)\r\n<img width=\"884\" height=\"132\" alt=\"image\" src=\"https://github.com/user-attachments/assets/da1584a9-eca7-4f38-aff3-8c26d1fc484f\" />\r\n\r\n\r\n**Test Coverage:**\r\n- 65 new tests across 4 test suites\r\n- Unit tests: crypto utils, secret storage, backup restoration, device signing\r\n- Integration tests: multi-account verification, account isolation, handler lifecycle\r\n- CLI tests: command parsing, output formatting, error handling\r\n- All tests passing (146/150 total; 4 pre-existing failures unrelated to this work)\r\n\r\n**Code Coverage:**\r\n- Registry: >95% (multi-account handler management)\r\n- Handler: >90% (verification workflow)\r\n- CLI: >90% (command parsing, output formatting)\r\n\r\n## Human Verification (required)\r\n\r\nWhat you personally verified (not just CI), and how:\r\n\r\n**Verified scenarios:**\r\n- Single-account verification with recovery key from Element\r\n- Multi-account setup with two Matrix identities\r\n- Status command shows correct verification state per account\r\n- Helpful error messages when account not found\r\n- Bot successfully reads encrypted messages after verification\r\n- Verification state persists across gateway restarts\r\n- JSON output mode for both commands\r\n\r\n**Edge cases checked:**\r\n- Invalid recovery key format (shows clear error)\r\n- Account not configured (shows troubleshooting steps)\r\n- No default account (CLI requires explicit `--account`)\r\n- Missing E2EE configuration (clear error message)\r\n- Backup available but not restored (shows bot-SDK limitation note)\r\n\r\n**What I did NOT verify:**\r\n- Windows platform (matrix-js-sdk should work, but not manually tested)\r\n- Homeserver federation edge cases\r\n- Large backup restoration (>1000 keys)\r\n- Concurrent verification requests across accounts\r\n- Recovery key rotation scenarios\r\n\r\n## Compatibility / Migration\r\n\r\n- Backward compatible? `Yes`\r\n- Config/env changes? `No`\r\n- Migration needed? `No`\r\n\r\n**Details:**\r\n- Works with existing `channels.matrix.accounts` multi-account configuration\r\n- No config migration required\r\n- Verification is opt-in; existing deployments work unchanged\r\n- Single-account setups use `default` account ID automatically\r\n- Graceful degradation: if handler not available, shows \"not configured\" status\r\n\r\n## Failure Recovery (if this breaks)\r\n\r\n**How to disable/revert this change quickly:**\r\n- Remove recovery key from environment/files\r\n- Verification state is stored per-account in `~/.openclaw/extensions/matrix/<accountId>/verification.db`\r\n- To reset: `rm ~/.openclaw/extensions/matrix/*/verification.db` and restart gateway\r\n\r\n**Files/config to restore:**\r\n- No config changes needed to disable\r\n- To fully revert: checkout previous commit and rebuild\r\n\r\n**Known bad symptoms reviewers should watch for:**\r\n- Bot unable to read encrypted messages \u2192 Check verification status with `openclaw matrix verify status`\r\n- \"Account not found\" errors \u2192 Ensure account ID matches config, E2EE enabled\r\n- Verification succeeds but messages still encrypted \u2192 Backup restoration may require Element client\r\n- Memory leaks during verification \u2192 Monitor Node.js heap (unlikely, keys only held during operation)\r\n\r\n## Risks and Mitigations\r\n\r\n- **Risk:** Recovery key exposure via CLI arguments or shell history\r\n  - **Mitigation:** CLI supports `--file` flag, warns on env var usage, documentation encourages secure file-based approach\r\n\r\n- **Risk:** Verification state desync if multiple gateways run concurrently\r\n  - **Mitigation:** Verification state stored per-process; gateway runs as singleton by design; multi-gateway setups should use separate config/accounts\r\n\r\n- **Risk:** Bot-SDK limitations prevent full backup restoration\r\n  - **Mitigation:** User-visible note in CLI output; documented in Matrix channel docs; verification still establishes trust even without full backup restore\r\n\r\n- **Risk:** Breaking changes to matrix-js-sdk encryption APIs\r\n  - **Mitigation:** Uses stable matrix-js-sdk APIs; extensive test coverage will catch API changes; crypto implementation follows Element's patterns\r\n\r\n## AI usage\r\n- This PR was created with the assistance of AI\r\n- I've manually tested as much as I could locally and in my instance, including both success and failure paths\r\n- I do understand what the code does\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds complete Matrix device verification via recovery key, enabling bots to participate in encrypted conversations as verified devices. The implementation covers Base58 key decoding, Matrix SSSS (Secure Secret Storage and Sharing) decryption, cross-signing key restoration, Ed25519 device signing, and encrypted backup restoration. Multi-account support allows independent verification states per Matrix identity.\n\n- **Crypto implementation** is solid: proper HKDF key derivation, HMAC-SHA256 MAC verification with constant-time comparison (`timingSafeEqual`), and AES-256-CTR decryption follow the Matrix spec correctly\n- **Key material cleanup issue**: on error paths in `handler.ts`, the recovery key and cross-signing private keys are not zeroed out \u2014 only the happy path runs `.fill(0)`. This should use a `finally` block to ensure cleanup in all cases\n- **Canonical JSON sorting**: `canonicalJsonStringify` in `device-signing.ts` uses `localeCompare()` instead of codepoint comparison for key sorting. Works for current ASCII-only keys but deviates from the Matrix spec\n- **Architecture**: follows existing extension patterns \u2014 gateway methods registered via `api.registerGatewayMethod()`, CLI commands use `callGatewayFromCli` with proper progress indicators, state persistence uses file locking via `proper-lockfile`\n- **Backup restoration** is a documented no-op due to bot-SDK limitations \u2014 clearly communicated in code, logs, and user-facing CLI output\n- **Test coverage** is thorough with 65 new tests covering crypto, storage, multi-account, and CLI layers\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge with one security improvement recommended for key material cleanup on error paths.\n- The cryptographic implementation is well-structured and follows Matrix spec correctly. The one concern is that sensitive key material (recovery key, cross-signing private keys) is not zeroed on error paths in the verification handler, which is a security best practice gap. The rest of the code is clean with thorough test coverage, proper error handling, and good architecture that follows existing codebase patterns.\n- `extensions/matrix/src/matrix/recovery-key/handler.ts` needs attention for the key zeroing issue on error paths.\n\n<sub>Last reviewed commit: 01d3d78</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(3/5) Reply to the agent's comments like \"Can you suggest a fix for this @greptileai?\" or ask follow-up questions!</sub>\n\n<!-- /greptile_comment -->",
      "author": "kylerm42",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:39:41Z",
      "updatedAt": "2026-02-15T19:45:14Z",
      "headRef": "feat/matrix-device-verification-recovery-key",
      "baseRef": "main",
      "filesChanged": 31,
      "additions": 6428,
      "deletions": 16,
      "commits": 1,
      "labels": [
        "docs",
        "channel: matrix",
        "app: web-ui",
        "gateway",
        "cli",
        "size: XL"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        7649
      ],
      "changedFiles": [
        "docs/channels/matrix.md",
        "extensions/matrix/index.ts",
        "extensions/matrix/package.json",
        "extensions/matrix/src/matrix/monitor/index.ts",
        "extensions/matrix/src/matrix/probe.ts",
        "extensions/matrix/src/matrix/recovery-key/backup.test.ts",
        "extensions/matrix/src/matrix/recovery-key/backup.ts",
        "extensions/matrix/src/matrix/recovery-key/constants.ts",
        "extensions/matrix/src/matrix/recovery-key/crypto-utils.test.ts",
        "extensions/matrix/src/matrix/recovery-key/crypto-utils.ts",
        "extensions/matrix/src/matrix/recovery-key/device-signing.test.ts",
        "extensions/matrix/src/matrix/recovery-key/device-signing.ts",
        "extensions/matrix/src/matrix/recovery-key/handler.test.ts",
        "extensions/matrix/src/matrix/recovery-key/handler.ts",
        "extensions/matrix/src/matrix/recovery-key/index.ts",
        "extensions/matrix/src/matrix/recovery-key/multi-account-e2e.test.ts",
        "extensions/matrix/src/matrix/recovery-key/registry.test.ts",
        "extensions/matrix/src/matrix/recovery-key/registry.ts",
        "extensions/matrix/src/matrix/recovery-key/secret-storage.test.ts",
        "extensions/matrix/src/matrix/recovery-key/secret-storage.ts",
        "extensions/matrix/src/matrix/recovery-key/store.test.ts",
        "extensions/matrix/src/matrix/recovery-key/store.ts",
        "extensions/matrix/src/matrix/recovery-key/types.ts",
        "src/cli/matrix-cli-output.test.ts",
        "src/cli/matrix-cli.test.ts",
        "src/cli/matrix-cli.ts",
        "src/cli/program/command-registry.ts",
        "src/gateway/protocol/index.ts",
        "src/gateway/protocol/schema.ts",
        "src/gateway/protocol/schema/matrix.ts",
        "src/gateway/server-methods.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17454.diff",
      "totalScore": 71,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "6444 lines changed (6428+/16-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "kylerm42 (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #7649"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Comprehensive feature implementation with good test coverage and clear documentation. The risk is medium due to the complexity of E2EE and the potential for security vulnerabilities if not implemented correctly. The PR addresses a significant usability issue and includes multi-account support, which adds complexity but also value. The scope touches many areas, increasing the potential for integration issues. The lack of interactive verification flows simplifies the initial implementation but might limit adoption in some scenarios."
    },
    {
      "number": 17459,
      "title": "feat(cron): support multiple schedules and priority guardrails",
      "body": "# OpenClaw Cron: Stability + Feature Update Notes\r\n\r\nThis document summarizes the implemented work for roadmap priorities:\r\n\r\n- `1` Cron stability fixes\r\n- `2` Cron enhancements (multi-schedule, per-job timeout hardening, isolated announce reliability)\r\n- `3` Security, orchestration, and memory-quality guardrails\r\n\r\n## Priority 1: Stability Fixes\r\n\r\n### 1) Windows cron store write resilience (`EBUSY`/`EPERM`/`ENOTEMPTY`)\r\n\r\n- Added atomic rename retry with backoff for cron store writes.\r\n- Added temp-file cleanup in `finally` to avoid leftover `.tmp` files on failures.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/store.ts`\r\n- `openclaw/src/cron/store.test.ts`\r\n\r\n### 2) Timer re-arm and spin-loop prevention improvements\r\n\r\n- `nextWakeAtMs` now ignores jobs currently marked `runningAtMs`.\r\n- When all enabled jobs are blocked by `runningAtMs`, scheduler now arms a maintenance tick (60s) instead of skipping/spinning.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/service/jobs.ts`\r\n- `openclaw/src/cron/service/timer.ts`\r\n- `openclaw/src/cron/service.rearm-timer-when-running.test.ts`\r\n\r\n## Priority 2: Enhancements\r\n\r\n### 1) Multi-schedule support per job (`schedules[]`)\r\n\r\n- Added support for multiple schedules on a single job while preserving backward compatibility with `schedule`.\r\n- `nextRunAtMs` now resolves to the earliest next run across all configured schedules.\r\n- Update path supports patching `schedules[]`.\r\n- Store migration/normalization keeps `schedule` and `schedules[0]` in sync for compatibility.\r\n- Protocol schema now accepts `schedules[]` in add/update payloads.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/types.ts`\r\n- `openclaw/src/cron/service/jobs.ts`\r\n- `openclaw/src/cron/service/ops.ts`\r\n- `openclaw/src/cron/service/store.ts`\r\n- `openclaw/src/cron/normalize.ts`\r\n- `openclaw/src/gateway/protocol/schema/cron.ts`\r\n- `openclaw/src/cron/service.issue-regressions.test.ts`\r\n- `openclaw/src/cron/normalize.test.ts`\r\n\r\n### 2) Per-job timeout hardening\r\n\r\n- Added timeout normalization/clamping in timer execution path:\r\n  - minimum: 1 second\r\n  - maximum cap: 24 hours\r\n  - default fallback remains 10 minutes when unset/invalid\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/service/timer.ts`\r\n\r\n### 3) Isolated announce reliability fallback\r\n\r\n- When subagent announce flow fails, isolated cron now attempts one direct outbound fallback delivery before failing.\r\n- This improves reliability for cases where announce orchestration fails but direct delivery can still succeed.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/cron/isolated-agent/run.ts`\r\n\r\n## Priority 3: Security + Intelligence Guardrails\r\n\r\n### 1) Secrets manager integration (`op://` and `vault://`)\r\n\r\n- Added config-time secret URI resolution support:\r\n  - `op://...` via `op read <ref>`\r\n  - `vault://path#field` via `vault kv get -field=<field> <path>`\r\n- Resolution runs during config load, after `${ENV}` substitution.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/config/secret-resolver.ts`\r\n- `openclaw/src/config/io.ts`\r\n- `openclaw/src/config/secret-resolver.test.ts`\r\n\r\n### 2) Membrane-style tool boundary enforcement\r\n\r\n- Added optional pre-tool-call membrane checks:\r\n  - hard deny specific tools\r\n  - deny exec calls containing blocked command substrings\r\n- Denials include explicit membrane tags in block reasons.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/agents/pi-tools.before-tool-call.ts`\r\n- `openclaw/src/agents/pi-tools.ts`\r\n- `openclaw/src/config/types.tools.ts`\r\n- `openclaw/src/config/zod-schema.agent-runtime.ts`\r\n- `openclaw/src/agents/pi-tools.before-tool-call.e2e.test.ts`\r\n\r\n### 3) Smart model routing (simple vs complex messages)\r\n\r\n- Added optional per-agent routing config to select cheaper model for simple tasks and stronger model for complex tasks.\r\n- Integrated into isolated cron agent-turn model selection path.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/agents/model-routing.ts`\r\n- `openclaw/src/agents/model-routing.test.ts`\r\n- `openclaw/src/config/types.agent-defaults.ts`\r\n- `openclaw/src/config/zod-schema.agent-defaults.ts`\r\n- `openclaw/src/cron/isolated-agent/run.ts`\r\n\r\n### 4) Fact-check gate for session-memory hook writes\r\n\r\n- Added optional hook-level fact-check thresholds before writing session memory snapshots.\r\n- Can require minimum user/assistant evidence before persisting.\r\n\r\nFiles:\r\n\r\n- `openclaw/src/hooks/bundled/session-memory/handler.ts`\r\n- `openclaw/src/hooks/bundled/session-memory/handler.test.ts`\r\n\r\n## Validation\r\n\r\nExecuted targeted tests:\r\n\r\n```powershell\r\npnpm -C openclaw test:fast -- `\r\n  src/cron/store.test.ts `\r\n  src/cron/service.rearm-timer-when-running.test.ts `\r\n  src/cron/service.issue-13992-regression.test.ts `\r\n  src/cron/service.issue-16156-list-skips-cron.test.ts `\r\n  src/cron/service.issue-regressions.test.ts\r\n```\r\n\r\n```powershell\r\npnpm -C openclaw test:fast -- `\r\n  src/cron/service.issue-regressions.test.ts `\r\n  src/cron/normalize.test.ts `\r\n  src/cron/store.test.ts `\r\n  src/cron/service.store-migration.test.ts `\r\n  src/cron/service.store.migration.test.ts `\r\n  src/cron/service.delivery-plan.test.ts\r\n```\r\n\r\nAll passed in the latest run.\r\n\r\nAdditional priority-3 verification:\r\n\r\n```powershell\r\npnpm -C openclaw test:fast -- `\r\n  src/config/secret-resolver.test.ts `\r\n  src/hooks/bundled/session-memory/handler.test.ts `\r\n  src/agents/model-routing.test.ts\r\n```\r\n\r\n```powershell\r\npnpm -C openclaw exec vitest run --config vitest.e2e.config.ts `\r\n  src/agents/pi-tools.before-tool-call.e2e.test.ts\r\n```\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR implements comprehensive cron system improvements across three areas: stability fixes, feature enhancements, and security guardrails.\n\n**Priority 1 - Stability Fixes:**\n- Atomic rename retry logic with exponential backoff for Windows file-lock races (`EBUSY`/`EPERM`/`ENOTEMPTY`)\n- Timer re-arm improvements to prevent scheduler deadlock when jobs are blocked by `runningAtMs` markers\n- Added 60s maintenance tick when all enabled jobs are running to avoid spin-loops\n\n**Priority 2 - Feature Enhancements:**\n- Multi-schedule support per job with backward-compatible migration (keeps `schedule` and `schedules[0]` in sync)\n- Per-job timeout normalization with 1s minimum and 24h maximum safety cap\n- Isolated announce fallback that attempts direct delivery when subagent announce flow fails\n- Telegram poll support with answer caching and system event integration\n\n**Priority 3 - Security & Intelligence Guardrails:**\n- Secrets manager integration for `op://` (1Password) and `vault://` (HashiCorp Vault) URIs\n- Membrane-style tool boundary enforcement with configurable deny lists for tools and command substrings\n- Smart model routing to select cheaper models for simple tasks vs complex tasks\n- Fact-check gate for session-memory hook writes requiring minimum message thresholds\n\nThe implementation includes comprehensive test coverage and proper migration/normalization logic to maintain backward compatibility.\n\n<h3>Confidence Score: 4/5</h3>\n\n- Safe to merge with minor considerations around scope and testing\n- The PR includes well-tested stability fixes and features with comprehensive test coverage. The multi-schedule implementation properly maintains backward compatibility through migration logic. Security features use standard subprocess execution patterns. Score reflects broad scope mixing unrelated features (Telegram polls alongside cron fixes) and the inherent complexity of scheduler state management, though tests demonstrate correctness.\n- No files require special attention\n\n<sub>Last reviewed commit: 086efd4</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(3/5) Reply to the agent's comments like \"Can you suggest a fix for this @greptileai?\" or ask follow-up questions!</sub>\n\n<!-- /greptile_comment -->",
      "author": "akyourowngames",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:45:20Z",
      "updatedAt": "2026-02-15T19:55:50Z",
      "headRef": "feat/cron-multi-schedule",
      "baseRef": "main",
      "filesChanged": 51,
      "additions": 1955,
      "deletions": 382,
      "commits": 13,
      "labels": [
        "docs",
        "channel: telegram",
        "app: web-ui",
        "gateway",
        "scripts",
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "CRON_STABILIZATION_AND_FEATURES_README.md",
        "README.md",
        "docs/gateway/configuration-examples.md",
        "docs/gateway/configuration.md",
        "package.json",
        "pnpm-lock.yaml",
        "scripts/run-skill-scan.ts",
        "skills/poll-confirmation/SKILL.md",
        "src/agents/model-routing.test.ts",
        "src/agents/model-routing.ts",
        "src/agents/pi-tools.before-tool-call.e2e.test.ts",
        "src/agents/pi-tools.before-tool-call.ts",
        "src/agents/pi-tools.ts",
        "src/agents/tools/message-tool.e2e.test.ts",
        "src/agents/tools/message-tool.ts",
        "src/agents/tools/telegram-actions.ts",
        "src/channels/plugins/actions/telegram.test.ts",
        "src/channels/plugins/actions/telegram.ts",
        "src/channels/plugins/outbound/telegram.test.ts",
        "src/channels/plugins/outbound/telegram.ts",
        "src/config/io.ts",
        "src/config/secret-resolver.test.ts",
        "src/config/secret-resolver.ts",
        "src/config/types.agent-defaults.ts",
        "src/config/types.tools.ts",
        "src/config/zod-schema.agent-defaults.ts",
        "src/config/zod-schema.agent-runtime.ts",
        "src/cron/isolated-agent/run.ts",
        "src/cron/normalize.test.ts",
        "src/cron/normalize.ts",
        "src/cron/service.issue-regressions.test.ts",
        "src/cron/service.rearm-timer-when-running.test.ts",
        "src/cron/service/jobs.ts",
        "src/cron/service/ops.ts",
        "src/cron/service/store.ts",
        "src/cron/service/timer.ts",
        "src/cron/store.test.ts",
        "src/cron/store.ts",
        "src/cron/types.ts",
        "src/gateway/protocol/schema/cron.ts",
        "src/hooks/bundled/session-memory/handler.test.ts",
        "src/hooks/bundled/session-memory/handler.ts",
        "src/telegram/allowed-updates.test.ts",
        "src/telegram/allowed-updates.ts",
        "src/telegram/bot.ts",
        "src/telegram/bot/helpers.test.ts",
        "src/telegram/bot/helpers.ts",
        "src/telegram/poll-answer-cache.test.ts",
        "src/telegram/poll-answer-cache.ts",
        "src/telegram/send.poll.test.ts",
        "src/telegram/send.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17459.diff",
      "totalScore": 70,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "2337 lines changed (1955+/382-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "akyourowngames (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "The PR addresses stability, enhancements, and guardrails for the cron service. It includes fixes for Windows write resilience and timer re-arming, along with new features like multi-schedule support and per-job timeout hardening. The documentation is thorough, and the inclusion of tests is a positive sign. The risk is medium due to the scope of changes and the potential for regressions in a critical component like the cron service, especially with the introduction of multi-schedule support and store migrations. The large number of files touched also increases the risk.",
      "duplicateGroup": 0
    },
    {
      "number": 17012,
      "title": "Add French documentation (README, index, getting-started)",
      "body": "## Summary\r\n\r\n- Problem: Documentation is currently English-only, limiting accessibility for French-speaking users.\r\n- Why it matters: Expanding language support helps grow the community and makes OpenClaw easier to adopt for non-English speakers.\r\n- What changed:\r\n    - Added `docs/fr/` directory structure.\r\n    - Added `README.fr.md`: Full translation of the main README.\r\n    - Added `docs/fr/index.md`: Translation of the documentation homepage.\r\n    - Added `docs/fr/start/getting-started.md`: Translation of the Getting Started guide.\r\n- What did NOT change (scope boundary): No code changes, no changes to existing English documentation.\r\n\r\n## Change Type (select all)\r\n\r\n- [ ] Bug fix\r\n- [ ] Feature\r\n- [ ] Refactor\r\n- [x] Docs\r\n- [ ] Security hardening\r\n- [ ] Chore/infra\r\n\r\n## Scope (select all touched areas)\r\n\r\n- [ ] Gateway / orchestration\r\n- [ ] Skills / tool execution\r\n- [ ] Auth / tokens\r\n- [ ] Memory / storage\r\n- [ ] Integrations\r\n- [ ] API / contracts\r\n- [x] UI / DX\r\n- [ ] CI/CD / infra\r\n\r\n## Linked Issue/PR\r\n\r\n- Closes #\r\n- Related #\r\n\r\n## User-visible / Behavior Changes\r\n\r\n- New documentation files available in French under `docs/fr/`.\r\n- New `README.fr.md` file in the root directory.\r\n\r\n## Security Impact (required)\r\n\r\n- New permissions/capabilities? (`No`)\r\n- Secrets/tokens handling changed? (`No`)\r\n- New/changed network calls? (`No`)\r\n- Command/tool execution surface changed? (`No`)\r\n- Data access scope changed? (`No`)\r\n- If any `Yes`, explain risk + mitigation: None\r\n\r\n## Repro + Verification\r\n\r\n### Environment\r\n\r\n- OS: macOS\r\n- Runtime/container: N/A (Documentation only)\r\n- Model/provider: N/A\r\n- Integration/channel (if any): N/A\r\n- Relevant config (redacted): N/A\r\n\r\n### Steps\r\n\r\n1. Checkout the branch `french-docs`.\r\n2. Open `README.fr.md`.\r\n3. Navigate to `docs/fr/index.md` and `docs/fr/start/getting-started.md`.\r\n\r\n### Expected\r\n\r\n- Content should be in French and accurately reflect the original English documentation.\r\n\r\n### Actual\r\n\r\n- Content is translated into French.\r\n\r\n## Evidence\r\n\r\nAttach at least one:\r\n\r\n- [ ] Failing test/log before + passing after\r\n- [ ] Trace/log snippets\r\n- [x] Screenshot/recording (See file contents)\r\n- [ ] Perf numbers (if relevant)\r\n\r\n## Human Verification (required)\r\n\r\nWhat you personally verified (not just CI), and how:\r\n\r\n- Verified scenarios: Checked translation accuracy against English originals for README, index, and getting-started guide.\r\n- Edge cases checked: Verified relative links and formatting in markdown files.\r\n- What you did **not** verify: Did not verify every single link target (assumed English links are valid).\r\n\r\n## Compatibility / Migration\r\n\r\n- Backward compatible? (`Yes`)\r\n- Config/env changes? (`No`)\r\n- Migration needed? (`No`)\r\n- If yes, exact upgrade steps: N/A\r\n\r\n## Failure Recovery (if this breaks)\r\n\r\n- How to disable/revert this change quickly: Revert the PR.\r\n- Files/config to restore: Delete added files.\r\n- Known bad symptoms reviewers should watch for: Broken links or typos in French text.\r\n\r\n## Risks and Mitigations\r\n\r\nList only real risks for this PR. Add/remove entries as needed. If none, write `None`.\r\n\r\n- Risk: Translation errors or outdated information if English docs change rapidly.\r\n  - Mitigation: Community review and future updates to keep in sync.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdded French translations for core documentation files (`README.fr.md`, `docs/fr/index.md`, `docs/fr/start/getting-started.md`). The translations are comprehensive and accurately reflect the English originals. All links point to English documentation URLs (appropriate for a translation PR). Found one minor typo (\"Semurit\u00e9\" instead of \"S\u00e9curit\u00e9\").\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- Documentation-only changes with no code modifications, minimal impact on existing functionality, and only one minor typo found\n- No files require special attention - straightforward documentation translation with one typo to fix\n\n<sub>Last reviewed commit: 50b9afa</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "rnnpeng",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T09:47:58Z",
      "updatedAt": "2026-02-15T19:53:23Z",
      "headRef": "french-docs",
      "baseRef": "main",
      "filesChanged": 7,
      "additions": 900,
      "deletions": 23,
      "commits": 7,
      "labels": [
        "docs",
        "channel: whatsapp-web",
        "scripts",
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        ".github/workflows/formal-conformance.yml",
        "README.fr.md",
        "docs/fr/index.md",
        "docs/fr/start/getting-started.md",
        "scripts/test-parallel.mjs",
        "src/web/media.test.ts",
        "src/web/media.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17012.diff",
      "totalScore": 70,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "923 lines changed (900+/23-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "rnnpeng (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "low",
      "llmReason": "The PR adds French documentation, which improves accessibility. The description is thorough, including what changed, what didn't, and how to verify the changes. The security impact is explicitly addressed. The only minor deduction is due to the presence of unrelated files in the diff (formal-conformance.yml, test-parallel.mjs, media.test.ts, media.ts), which should ideally be in separate PRs to keep changes focused."
    },
    {
      "number": 17429,
      "title": "feat: default Claude models to anthropic-messages API for Copilot",
      "body": "## Summary\n\n- **Problem:** Copilot Claude models were defaulting to `openai-responses` API, which translates thinking blocks through the OpenAI-compatible format and loses real Anthropic cryptographic signatures. This caused HTTP 400 errors (`Invalid signature in thinking block`) on multi-turn conversations.\n- **Why it matters:** This is the ROOT FIX for the thinking signature issue. Previous PRs in this chain added safety nets; this PR eliminates the problem at the source.\n- **What changed:** Claude models (`claude-*`) now default to `anthropic-messages` API instead of `openai-responses`. GitHub Copilot exposes both `/chat/completions` (OpenAI) and `/v1/messages` (Anthropic Messages API) at the same base URL. pi-ai already has native `github-copilot` support in its anthropic provider (Bearer auth, Copilot dynamic headers, interleaved-thinking beta).\n- **What did NOT change:** Non-Claude models (GPT, Gemini, O-series) continue using `openai-responses`. No changes to auth, endpoints, or provider config.\n\n## Change Type (select all)\n\n- [x] Feature\n\n## Scope (select all touched areas)\n\n- [x] Integrations\n\n## Linked Issue/PR\n\n- Depends on #17284, #17427, #17428\n- Related #12006 (jackheuberger's complementary approach)\n\n## User-visible / Behavior Changes\n\n- Claude models via Copilot now use the Anthropic Messages API, providing:\n  - Proper extended thinking with real cryptographic signatures\n  - No more HTTP 400 errors on multi-turn tool conversations\n  - Thinking blocks preserved correctly across turns\n- Non-Claude models are unchanged\n\n## Security Impact (required)\n\n- New permissions/capabilities? `No`\n- Secrets/tokens handling changed? `No`\n- New/changed network calls? `Yes` - Claude models now hit `/v1/messages` instead of `/chat/completions` at the same Copilot base URL. This matches what VS Code's Copilot Chat extension does.\n- Command/tool execution surface changed? `No`\n- Data access scope changed? `No`\n- Risk + mitigation: The `/v1/messages` endpoint is an existing Copilot API surface. VS Code already uses it for Claude models. pi-ai's anthropic provider handles the github-copilot auth flow (Bearer token, Copilot dynamic headers).\n\n## Repro + Verification\n\n### Environment\n\n- OS: macOS\n- Runtime: Node 22+\n- Model/provider: github-copilot with Claude models (opus-4.6, opus-4.6-fast, sonnet-4, etc.)\n\n### Steps\n\n1. Configure openclaw with `github-copilot` provider and a Claude model\n2. Send a message that triggers reasoning/thinking\n3. Continue the conversation with tool calls\n\n### Expected\n\n- Thinking blocks have real cryptographic signatures\n- Multi-turn conversations work without HTTP 400 errors\n- Extended thinking is preserved across turns\n\n### Actual\n\n- Confirmed working in live gateway testing\n\n## Evidence\n\n- [x] Failing test/log before + passing after\n  - Updated `github-copilot-models.test.ts`: new tests for API type selection\n  - Updated `github-copilot-sdk.test.ts`: new test for Claude anthropic-messages\n  - All 34 provider tests passing\n\n## Human Verification (required)\n\n- Verified: Live gateway testing with Claude opus-4.6 via Copilot - multi-turn tool conversations work\n- Verified: VS Code Copilot Chat extension source confirms it uses `/v1/messages` for Claude\n- Edge cases: Non-Claude models still get openai-responses, unknown models get openai-responses\n- Not verified: Every Claude model variant individually\n\n## Compatibility / Migration\n\n- Backward compatible? `Yes` - existing user config overrides still work\n- Config/env changes? `No` - this changes the code default; user config can still override\n- Migration needed? `No`\n\n## Failure Recovery (if this breaks)\n\n- How to disable: Override per-model with `\"api\": \"openai-responses\"` in user config\n- Known bad symptoms: If Copilot stops supporting `/v1/messages`, Claude models would fail to connect (unlikely - VS Code depends on this endpoint)\n\n## Risks and Mitigations\n\n- Risk: Copilot could change or remove the `/v1/messages` endpoint\n  - Mitigation: VS Code's Copilot Chat extension depends on this endpoint for all Claude interactions - it's a stable API surface\n\n---\n\n> **Stacked PR chain:** #17284 > #17427 > #17428 > **this PR**\n>\n> Review incremental changes: compare fix/copilot-thinking-signature...feat/copilot-anthropic-messages\n\n### Discovery Details\n\nInvestigation of VS Code's Copilot Chat extension (`github.copilot-chat`) revealed:\n\n1. **Dual API surface:** Copilot exposes both `/chat/completions` (OpenAI format) and `/v1/messages` (Anthropic Messages API) at the same base URL (`https://api.githubcopilot.com` or enterprise equivalent)\n\n2. **VS Code's approach:** For Claude models, VS Code uses `ChatMessages` request type which routes to `capiMessagesURL = ${_capiBaseUrl}/v1/messages`, getting proper `thinking_delta` + `signature_delta` SSE events with real cryptographic signatures\n\n3. **pi-ai support:** The anthropic provider in pi-ai already has a dedicated `github-copilot` code path that:\n   - Uses Bearer auth via `authToken` (not API key)\n   - Attaches Copilot dynamic headers\n   - Enables `interleaved-thinking` beta\n   - Handles `thinking_delta`/`signature_delta` events properly\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR routes Claude models through the native Anthropic Messages API (`/v1/messages`) instead of OpenAI-compatible `/chat/completions` when using the GitHub Copilot provider. This eliminates HTTP 400 errors caused by invalid thinking block signatures in multi-turn conversations \u2014 the root fix for the thinking signature issue.\n\nKey changes:\n- `buildCopilotModelDefinition` and `buildCopilotModelDefinitionFromSdk` now assign `anthropic-messages` API for `claude-*` models, while non-Claude models continue using `openai-responses`\n- New `@github/copilot-sdk` integration: SDK-based auth detection, model discovery, and a CLI agent backend (`copilot-cli`) with full session lifecycle management\n- Added `stripCompletionsReasoningFieldSignatures` to sanitize thinking blocks where pi-ai stored reasoning field names as signatures \u2014 a safety net for the OpenAI-to-Anthropic proxy path\n- SDK-managed auth flow added to login, provider detection, and token resolution paths\n- Comprehensive test coverage across all new modules (models, SDK wrapper, runner, transcript policy, reasoning block stripping)\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge after addressing the hardcoded magic string issue; the core API routing change is well-motivated and tested.\n- The primary feature \u2014 routing Claude models to `anthropic-messages` \u2014 is clean, well-reasoned, and backed by comprehensive tests. Two issues found: (1) a hardcoded `\"sdk-managed\"` string in `github-copilot-auth.ts` that should use the `SDK_MANAGED_TOKEN` constant to avoid a potential auth path mismatch, and (2) `maxTokens` (output limit) is mapped from the SDK's `max_prompt_tokens` (input limit) which is semantically incorrect. The first is a real correctness risk; the second could lead to unexpected output token limits. The rest of the changes (transcript policy, reasoning block stripping, CLI backend routing) are solid.\n- `src/providers/github-copilot-auth.ts` (hardcoded magic string instead of constant), `src/providers/github-copilot-sdk.ts` (maxTokens mapped from wrong SDK field)\n\n<sub>Last reviewed commit: 9fbc0c8</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "tag-assistant",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:00:47Z",
      "updatedAt": "2026-02-15T19:25:01Z",
      "headRef": "feat/copilot-anthropic-messages",
      "baseRef": "main",
      "filesChanged": 25,
      "additions": 2047,
      "deletions": 28,
      "commits": 8,
      "labels": [
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "package.json",
        "pnpm-lock.yaml",
        "src/agents/auth-profiles/constants.ts",
        "src/agents/cli-backends.ts",
        "src/agents/cli-runner.ts",
        "src/agents/copilot-runner.test.ts",
        "src/agents/copilot-runner.ts",
        "src/agents/copilot-sdk.test.ts",
        "src/agents/copilot-sdk.ts",
        "src/agents/model-selection.ts",
        "src/agents/models-config.providers.ts",
        "src/agents/pi-embedded-helpers.strip-completions-reasoning.test.ts",
        "src/agents/pi-embedded-helpers.ts",
        "src/agents/pi-embedded-helpers/openai.ts",
        "src/agents/pi-embedded-runner/compact.ts",
        "src/agents/pi-embedded-runner/google.ts",
        "src/agents/pi-embedded-runner/run.ts",
        "src/agents/transcript-policy.test.ts",
        "src/agents/transcript-policy.ts",
        "src/providers/github-copilot-auth.ts",
        "src/providers/github-copilot-models.test.ts",
        "src/providers/github-copilot-models.ts",
        "src/providers/github-copilot-sdk.test.ts",
        "src/providers/github-copilot-sdk.ts",
        "src/providers/github-copilot-token.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17429.diff",
      "totalScore": 70,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "2075 lines changed (2047+/28-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "tag-assistant (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "This PR addresses a critical bug causing HTTP 400 errors with Claude models in Copilot. The change involves switching the API endpoint for Claude models to the Anthropic Messages API, which resolves signature issues and improves multi-turn conversation handling. The PR includes comprehensive testing and considers security implications. The risk is medium due to the network call change and the dependency on other PRs. Thorough testing and monitoring after deployment are recommended.",
      "duplicateGroup": 7
    },
    {
      "number": 17333,
      "title": "feat: enhanced GitHub Copilot integration \u2014 SDK provider, CLI backend, and thinking signature fix",
      "body": "## Summary\n\n- **Problem:** OpenClaw's existing Copilot support lacks SDK-based auth/model discovery, CLI backend support, and has a critical bug where multi-turn conversations crash with HTTP 400 when Claude models replay thinking blocks with field-name-as-signature through the `openai-completions` API.\n- **Why it matters:** Users leveraging GitHub Copilot as a model provider (Claude Opus 4.6, GPT-5.3, etc.) get proper token management, automatic model discovery, CLI-mode support, and reliable multi-turn conversations without crashes.\n- **What changed:** (1) Full Copilot SDK provider with auth and model discovery, (2) Copilot CLI backend for terminal usage, (3) Sanitizer that strips thinking blocks with fake signatures before they poison future turns.\n- **What did NOT change:** No modifications to existing Copilot provider behavior \u2014 these are additive enhancements. Direct Anthropic/OpenAI/Google API paths are untouched.\n\n## Change Type (select all)\n\n- [x] Bug fix\n- [x] Feature\n\n## Scope (select all touched areas)\n\n- [x] Auth / tokens\n- [x] Integrations\n- [x] API / contracts\n\n## Linked Issue/PR\n\n- Related openclaw/openclaw#17284 (CLI backend \u2014 standalone PR)\n- Related openclaw/openclaw#14371 (Claude Opus 4.6 Fast model support)\n- Related #2 (Copilot SDK tracking issue)\n\n## Commits\n\n1. **feat: add GitHub Copilot SDK as CLI backend** \u2014 Copilot credentials, SDK wrapper, CLI runner with streaming + tool call support (22 tests)\n2. **feat: add Copilot SDK provider for auth and model discovery** \u2014 Full provider registration, token management, auto model discovery (31 tests)\n3. **fix: strip thinking blocks with field-name-as-signature** \u2014 Sanitizer + transcript policy for the openai-completions thinking signature bug (15 tests)\n\n## User-visible / Behavior Changes\n\n- New provider `github-copilot` available for model configuration with SDK-based auth\n- Copilot models (Claude Opus 4.6, GPT-5.3, etc.) auto-discovered from the API\n- `copilot` CLI backend available for terminal usage\n- Multi-turn conversations with Claude models via Copilot no longer crash with \"Invalid signature in thinking block\" errors\n- New `stripCompletionsReasoningFieldSignatures` transcript policy flag \u2014 enabled automatically for non-native providers using `openai-completions`\n\n## Security Impact (required)\n\n- New permissions/capabilities? Yes \u2014 Copilot SDK auth reads/refreshes tokens from GitHub\n- Secrets/tokens handling changed? Yes \u2014 new Copilot token management flow\n- New/changed network calls? Yes \u2014 calls to Copilot API for auth and model discovery\n- Command/tool execution surface changed? No\n- Data access scope changed? No\n- Risk + mitigation: Token handling follows existing auth profile patterns. Tokens stored in standard credential store, not logged. API calls use HTTPS only.\n\n## Evidence\n\n68 tests passing across 6 test files. Live-tested all models: Claude Opus 4.6 \u2705, 4.6 Fast \u2705, 4.6 1M \u2705, GPT-5.3 Codex \u2705\n\n## Human Verification (required)\n\n- Verified: Multi-turn conversations with all Copilot Claude models, thinking block replay, fallback chain, CLI backend streaming\n- Edge cases: Real signatures preserved (not stripped), non-Copilot providers unaffected, mixed thinking/non-thinking turns\n- Not verified: Windows, Docker sandbox mode\n\n## Compatibility / Migration\n\n- Backward compatible? Yes\n- Config/env changes? Yes \u2014 new optional `github-copilot` provider config\n- Migration needed? No\n\n## Failure Recovery (if this breaks)\n\n- Remove `github-copilot` provider from config, switch to another provider\n- Known symptoms: Auth failures if token expires (auto-refreshes)\n\n## Risks and Mitigations\n\n- Risk: Copilot API changes model IDs or auth flow\n  - Mitigation: SDK-based discovery adapts automatically\n- Risk: Thinking signature stripping too aggressive\n  - Mitigation: Only targets field-name patterns, real cryptographic signatures preserved. Policy only activates for non-native providers.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds three features: (1) a Copilot SDK provider for auth and model discovery, (2) a Copilot CLI backend for terminal usage, and (3) a sanitizer that strips thinking blocks with fake field-name-as-signature from `openai-completions` sessions.\n\nThe changes are well-structured and additive \u2014 existing provider paths are untouched. Tests are thorough (68 tests across 6 files). Key findings:\n\n- **Bug: `max_prompt_tokens` mapped to `maxTokens`** \u2014 In `buildCopilotModelDefinitionFromSdk`, the SDK's `max_prompt_tokens` (input limit) is mapped to `maxTokens` (output limit). This will inflate the `max_output_tokens` sent to the API for SDK-discovered models.\n- **SDK-managed auth gap in REST runner path** \u2014 When auth is SDK-managed but no `GH_TOKEN`/`GITHUB_TOKEN` env var exists, both `run.ts` and `compact.ts` silently skip setting the API key. The comment says the SDK handles auth, but the SDK is only involved in the CLI backend path \u2014 the REST runner needs a bearer token.\n- **Shared client startup failure not recoverable** \u2014 In `ensureCopilotSdkClient`, a rejected `client.start()` promise is cached forever; subsequent calls return the same rejection with no retry mechanism.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR has a confirmed semantic bug in model token mapping and a silent auth failure path that should be resolved before merging.\n- Score of 2 reflects: (1) a definite logic bug where `max_prompt_tokens` is mapped to `maxTokens` (max output tokens), which will cause incorrect API parameters for SDK-discovered models; (2) a silent auth failure in the REST runner path when SDK-managed auth has no env token fallback; and (3) a non-recoverable shared client state on startup failure. The thinking block sanitizer and CLI backend additions look correct.\n- `src/providers/github-copilot-sdk.ts` (token mapping bug + client lifecycle), `src/agents/pi-embedded-runner/run.ts` and `src/agents/pi-embedded-runner/compact.ts` (silent auth gap)\n\n<sub>Last reviewed commit: 798c57a</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(4/5) You can add custom instructions or style guidelines for the agent [here](https://app.greptile.com/review/github)!</sub>\n\n<!-- /greptile_comment -->",
      "author": "tag-assistant",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T17:16:53Z",
      "updatedAt": "2026-02-15T19:24:53Z",
      "headRef": "copilot",
      "baseRef": "main",
      "filesChanged": 25,
      "additions": 2047,
      "deletions": 28,
      "commits": 8,
      "labels": [
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "package.json",
        "pnpm-lock.yaml",
        "src/agents/auth-profiles/constants.ts",
        "src/agents/cli-backends.ts",
        "src/agents/cli-runner.ts",
        "src/agents/copilot-runner.test.ts",
        "src/agents/copilot-runner.ts",
        "src/agents/copilot-sdk.test.ts",
        "src/agents/copilot-sdk.ts",
        "src/agents/model-selection.ts",
        "src/agents/models-config.providers.ts",
        "src/agents/pi-embedded-helpers.strip-completions-reasoning.test.ts",
        "src/agents/pi-embedded-helpers.ts",
        "src/agents/pi-embedded-helpers/openai.ts",
        "src/agents/pi-embedded-runner/compact.ts",
        "src/agents/pi-embedded-runner/google.ts",
        "src/agents/pi-embedded-runner/run.ts",
        "src/agents/transcript-policy.test.ts",
        "src/agents/transcript-policy.ts",
        "src/providers/github-copilot-auth.ts",
        "src/providers/github-copilot-models.test.ts",
        "src/providers/github-copilot-models.ts",
        "src/providers/github-copilot-sdk.test.ts",
        "src/providers/github-copilot-sdk.ts",
        "src/providers/github-copilot-token.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17333.diff",
      "totalScore": 70,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "2075 lines changed (2047+/28-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "tag-assistant (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "This PR introduces significant new functionality (GitHub Copilot integration) with SDK-based auth, CLI backend support, and a bug fix. The description is thorough, including the problem, solution, and scope. The commits are well-organized and include tests. The risk is medium because it touches auth, integrations, and the API, requiring careful review and testing to ensure stability and security. The inclusion of tests (22+31+15) is a strong positive indicator.",
      "duplicateGroup": 7
    },
    {
      "number": 8427,
      "title": "[FEATURE] feat(spool): add spool event dispatch system with shared agent turn infrastructure",
      "body": "## Summary\n\nAdds the **spool event dispatch system** \u2014 a file-based queue for running agent turns asynchronously with retry logic, expiration, and dead-letter handling.\n\n> **Discussion:** https://github.com/openclaw/openclaw/discussions/12036\n\n### Why Spool?\n\nIn multi-agent setups \u2014 such as the [Mission Control pattern](https://www.sitegpt.ai/blog/building-mission-control-ai-agent-squad) where 10+ agents collaborate as a team \u2014 each agent wakes on a fixed cron schedule (e.g. every 15 minutes) to poll for work. This heartbeat approach has clear limitations: agents burn API credits on empty polls, work sits idle for up to 15 minutes, and nothing survives a gateway restart.\n\nThe spool system shifts from **polling to event-driven dispatch**: instead of agents asking \"is there work?\", work is queued and pushed to agents when it arrives.\n\nSpecifically, the spool enables:\n- **Async agent execution** \u2014 Queue agent turns without blocking\n- **Reliability** \u2014 Automatic retries with configurable limits\n- **Persistence** \u2014 Events survive gateway restarts\n- **Observability** \u2014 Dead-letter queue for failed events\n\n### What's Included\n\n**Spool event system** (`src/spool/`)\n- Event types with priority levels (high/normal/low/background)\n- File-based persistence with JSON schema validation  \n- Retry logic with configurable max retries and expiration\n- Dead-letter queue for failed events\n- Chokidar-based watcher with debouncing\n\n**CLI commands**\n- `spool enqueue` \u2014 queue agent turn events\n- `spool status` \u2014 view queue and dead-letter status\n\n**Gateway integration**\n- Spool watcher starts/stops with gateway lifecycle\n- Processes existing events on startup\n\n### Implementation Detail: Shared Agent Turn Infrastructure\n\nTo avoid duplicating the ~450-line agent turn execution logic between cron and spool, we extracted it into a shared module (`src/agents/isolated-turn/`). Both cron and spool now use thin wrappers (~60-70 lines each) that convert their source-specific params to a generic `IsolatedAgentTurnParams` interface.\n\n```\nsrc/agents/isolated-turn/       # Shared infrastructure\n  \u251c\u2500\u2500 run.ts                    # runIsolatedAgentTurn() - core logic\n  \u251c\u2500\u2500 types.ts                  # IsolatedAgentTurnSource: \"cron\" | \"spool\"\n  \u2514\u2500\u2500 helpers.ts, session.ts, delivery-target.ts\n\nsrc/cron/isolated-agent/run.ts  # Thin wrapper: CronJob \u2192 params\nsrc/spool/isolated-agent/run.ts # Thin wrapper: SpoolEvent \u2192 params\n```\n\n## Test Plan\n\n- [x] All existing cron tests pass (52 tests)\n- [x] New shared isolated-turn tests (19 tests)\n- [x] New spool tests (68 tests)\n- [x] Type checking passes (`pnpm tsgo`)\n- [x] CI checks pass",
      "author": "mcaxtr",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-04T01:31:27Z",
      "updatedAt": "2026-02-15T19:24:50Z",
      "headRef": "feature/spool-event-dispatch",
      "baseRef": "main",
      "filesChanged": 46,
      "additions": 4973,
      "deletions": 0,
      "commits": 5,
      "labels": [
        "gateway",
        "cli",
        "agents",
        "size: XL",
        "trusted-contributor",
        "experienced-contributor"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/agents/isolated-turn/delivery-target.ts",
        "src/agents/isolated-turn/helpers.test.ts",
        "src/agents/isolated-turn/helpers.ts",
        "src/agents/isolated-turn/index.ts",
        "src/agents/isolated-turn/run.ts",
        "src/agents/isolated-turn/session.test.ts",
        "src/agents/isolated-turn/session.ts",
        "src/agents/isolated-turn/types.ts",
        "src/cli/program/register.subclis.ts",
        "src/cli/spool-cli.ts",
        "src/cli/spool-cli/enqueue.ts",
        "src/cli/spool-cli/register.ts",
        "src/cli/spool-cli/status.ts",
        "src/config/types.openclaw.ts",
        "src/config/types.spool.ts",
        "src/config/types.ts",
        "src/config/zod-schema.ts",
        "src/gateway/config-reload.ts",
        "src/gateway/server-close.ts",
        "src/gateway/server-methods-list.ts",
        "src/gateway/server-reload-handlers.ts",
        "src/gateway/server-spool.ts",
        "src/gateway/server.impl.ts",
        "src/spool/dead-letter.test.ts",
        "src/spool/dead-letter.ts",
        "src/spool/dispatcher.test.ts",
        "src/spool/dispatcher.ts",
        "src/spool/index.ts",
        "src/spool/isolated-agent/index.ts",
        "src/spool/isolated-agent/run.test.ts",
        "src/spool/isolated-agent/run.ts",
        "src/spool/paths.test.ts",
        "src/spool/paths.ts",
        "src/spool/reader.test.ts",
        "src/spool/reader.ts",
        "src/spool/schema.test.ts",
        "src/spool/schema.ts",
        "src/spool/types.test.ts",
        "src/spool/types.ts",
        "src/spool/watcher.concurrent-events.test.ts",
        "src/spool/watcher.dead-letter.test.ts",
        "src/spool/watcher.lifecycle.test.ts",
        "src/spool/watcher.processes-existing.test.ts",
        "src/spool/watcher.ts",
        "src/spool/writer.test.ts",
        "src/spool/writer.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/8427.diff",
      "totalScore": 70,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "4973 lines changed (4973+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "mcaxtr (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No issue ref, contributor bonus -1"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Comprehensive feature with good documentation and testing. The risk is medium due to the complexity of the new spool system and its integration with the existing gateway. Thorough review and testing are crucial to ensure stability and prevent unexpected issues.",
      "duplicateGroup": 0
    },
    {
      "number": 15209,
      "title": "feat(irc): support self-signed TLS certificates via fingerprint pinning and insecure mode",
      "body": "## Summary\r\n\r\n- Add `tlsInsecure` option to skip all TLS certificate verification for IRC connections (encrypted but no cert validation)\r\n- Add `tlsFingerprints` option to pin connections to specific SHA-256 certificate fingerprints, allowing self-signed certs while still validating identity\r\n- Add connection-level logging throughout the IRC client for easier debugging of TLS and connection issues\r\n- Fix missing TLS options (`tlsInsecure`, `tlsFingerprints`) not being forwarded on transient send and probe connections\r\n\r\n## Motivation\r\n\r\nUsers connecting to IRC servers (or bouncers) with self-signed or private CA certificates had no way to establish TLS connections \u2014 Node.js rejects untrusted certificates by default. Fingerprint pinning provides a secure alternative to fully disabling verification.\r\n\r\n## Changes\r\n\r\n- **`extensions/irc/src/client.ts`** \u2014 Accept `tlsInsecure` and `tlsFingerprints` options; set `rejectUnauthorized: false` when either is present; validate peer fingerprint on `secureConnect` when pinning; add `log` callback for connection lifecycle events\r\n- **`extensions/irc/src/accounts.ts`** \u2014 Resolve `tlsInsecure` (with `IRC_TLS_INSECURE` env var fallback) and `tlsFingerprints` from config\r\n- **`extensions/irc/src/monitor.ts`**, **`send.ts`**, **`probe.ts`** \u2014 Forward the new TLS options to `connectIrcClient`\r\n- **`extensions/irc/src/channel.ts`** \u2014 Emit security warning when `tlsInsecure` is enabled\r\n- **`extensions/irc/src/config-schema.ts`**, **`types.ts`** \u2014 Add schema and type definitions\r\n- **`src/config/types.irc.ts`**, **`src/config/zod-schema.providers-core.ts`** \u2014 Add core config types and validation\r\n- **`docs/channels/irc.md`** \u2014 Document both options with examples and fingerprint retrieval instructions\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR adds IRC TLS options to support self-signed certs: `tlsInsecure` (disable verification) and `tlsFingerprints` (SHA-256 fingerprint pinning). It wires these options through account resolution, config schemas/types (extension + core), and forwards them into monitor/probe/transient send connections. It also adds connection lifecycle logging to the IRC client and monitor.\n\nOne issue to address before merge: the fingerprint validation currently happens on `secureConnect`, but the client sends IRC authentication commands in the socket `connect` handler. For TLS pinning, this can send credentials before the fingerprint check runs, which undermines the security goal of pinning.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR should not merge until the TLS fingerprint pinning handshake ordering is fixed.\n- Fingerprint pinning is meant to prevent MITM, but the current implementation validates the fingerprint on `secureConnect` while sending PASS/NICK/USER on `connect`, which can run before validation and leak credentials. Once that ordering is corrected, the rest of the changes are straightforward schema/type plumbing and logging.\n- extensions/irc/src/client.ts\n\n<sub>Last reviewed commit: 4584cb1</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "ryands",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-13T05:14:50Z",
      "updatedAt": "2026-02-15T19:16:58Z",
      "headRef": "irc-tls-fingerprints-and-insecure",
      "baseRef": "main",
      "filesChanged": 11,
      "additions": 152,
      "deletions": 0,
      "commits": 3,
      "labels": [
        "docs",
        "channel: irc",
        "size: S"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "docs/channels/irc.md",
        "extensions/irc/src/accounts.ts",
        "extensions/irc/src/channel.ts",
        "extensions/irc/src/client.ts",
        "extensions/irc/src/config-schema.ts",
        "extensions/irc/src/monitor.ts",
        "extensions/irc/src/probe.ts",
        "extensions/irc/src/send.ts",
        "extensions/irc/src/types.ts",
        "src/config/types.irc.ts",
        "src/config/zod-schema.providers-core.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/15209.diff",
      "totalScore": 70,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "152 lines changed (152+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "ryands (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Adds insecure TLS option, which is inherently risky. Fingerprint pinning is a good addition, but the insecure option needs careful consideration and prominent warnings. Good documentation and logging additions. Completeness seems high, covering config, types, and documentation."
    },
    {
      "number": 13691,
      "title": "feat: Production-ready MCP client plugin",
      "body": "## \ud83d\ude80 Production-Ready MCP Client Plugin\n\nComplete implementation of Model Context Protocol (MCP) client support for OpenClaw, enabling seamless integration with any MCP-compliant server.\n\n### \u2705 All Features Implemented (14/14 - 100%)\n\n#### P0 (Critical) - 6/6 \u2705\n- \u2705 **Auto `ext_` prefix** - Prevents collisions with native OpenClaw tools\n- \u2705 **MCP-to-MCP collision detection** - Graceful failure on duplicate tool names\n- \u2705 **Pre-flight command validation** - No more uncaught ENOENT exceptions\n- \u2705 **Error isolation** - One bad server doesn't crash the gateway\n- \u2705 **Tool discovery** - `/mcp` command lists all available tools\n- \u2705 **Graceful degradation** - System continues with partial failures (e.g., 3/4 servers)\n\n#### P1 (Should Have) - 4/4 \u2705\n- \u2705 **Comprehensive config validation** - Validates server name, command, args, env, toolPrefix\n- \u2705 **Health monitoring** - Automatic health checks every 60 seconds with auto-restart\n- \u2705 **Resource cleanup** - No zombie processes, proper SIGTERM handling\n- \u2705 **Test suite** - 13 test cases covering validation, prefixes, error handling\n\n#### P2 (Nice to Have) - 4/4 \u2705\n- \u2705 **Rate limiting** - Per-server concurrent and per-minute limits\n- \u2705 **Metrics & observability** - `/mcp-metrics` command for real-time monitoring\n- \u2705 **Protocol completeness** - Full support for tools, resources, and prompts\n- \u2705 **Hot reload** - `/mcp-reload` for adding/removing/restarting servers without downtime\n\n---\n\n### \ud83d\udce6 Deliverables\n\n| File | Lines | Description |\n|------|-------|-------------|\n| `index.ts` | 995 | Production-ready implementation |\n| `index.test.ts` | 219 | 13 comprehensive test cases |\n| `README.md` | 666 | Complete documentation |\n| `IMPLEMENTATION-SUMMARY.md` | 272 | Development journey & lessons |\n| **Total** | **~2,150** | **Fully documented & tested** |\n\n---\n\n### \ud83e\uddea Testing & Validation\n\n- \u2705 **Crash-tested** with invalid configurations (8+ iterations)\n- \u2705 **Error isolation verified** - 3/4 servers working scenario tested\n- \u2705 **Zombie process cleanup** - Confirmed no orphaned processes\n- \u2705 **Production deployment** - Currently running with 51 tools loaded\n\n**Test Results:**\n```\n\u2705 skyline: 31 tools loaded\n\u2705 hello: 3 tools loaded  \n\u2705 memory: 17 tools (+ 1 resource + 3 prompts)\n\u274c broken: Command not found (graceful failure)\n\u2192 Result: 3/4 servers working, gateway stable\n```\n\n---\n\n### \ud83c\udfaf Production Status\n\n**Currently deployed and verified:**\n- 3 MCP servers connected (skyline, hello, memory)\n- 51 tools available\n- 1 resource, 3 prompts discovered\n- Zero crashes since deployment\n- Zero zombie processes\n- Auto-recovery working (health checks active)\n\n---\n\n### \ud83d\udcd6 Documentation Highlights\n\n#### Quick Start\n```json\n{\n  \"plugins\": {\n    \"entries\": {\n      \"mcp-client\": {\n        \"enabled\": true,\n        \"config\": {\n          \"servers\": {\n            \"filesystem\": {\n              \"command\": \"mcp-server-filesystem\",\n              \"args\": [\"/path/to/dir\"],\n              \"autoReconnect\": true\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n#### Commands\n- `/mcp` - Show all connected servers and their tools\n- `/mcp-metrics` - Real-time performance metrics\n- `/mcp-reload --restart=serverName` - Hot reload individual servers\n\n#### Rate Limiting Example\n```json\n{\n  \"rateLimit\": {\n    \"maxConcurrent\": 10,\n    \"maxPerMinute\": 60\n  }\n}\n```\n\n---\n\n### \ud83d\udd0d Technical Highlights\n\n**Error Isolation Architecture:**\n- Pre-flight command existence check (prevents spawn errors)\n- Per-server try/catch with continue (one failure \u2260 total crash)\n- Graceful degradation (N/M servers working)\n\n**Health Monitoring:**\n- 60-second health check intervals\n- 3-strike unhealthy detection\n- Auto-restart on failure (configurable)\n- Metrics tracking (calls/min, latency, failures)\n\n**Resource Management:**\n- SIGTERM/SIGINT/exit cleanup handlers\n- Process lifecycle tracking\n- Pending call cleanup on shutdown\n- No zombie processes (verified in production)\n\n---\n\n### \ud83d\udcca Comparison with Claude Desktop\n\n| Feature | Claude Desktop | OpenClaw MCP Plugin |\n|---------|---------------|---------------------|\n| Multiple servers | \u2705 | \u2705 |\n| Tool execution | \u2705 | \u2705 |\n| Resources | \u2705 | \u2705 |\n| Prompts | \u2705 | \u2705 |\n| Auto-reconnect | \u274c | \u2705 |\n| Health monitoring | \u274c | \u2705 |\n| Rate limiting | \u274c | \u2705 |\n| Hot reload | \u274c | \u2705 |\n| Metrics | \u274c | \u2705 |\n\n---\n\n### \ud83c\udf93 Lessons Learned (Documented)\n\n1. **Node.js ChildProcess gotchas** - spawn() errors fire asynchronously; pre-flight validation prevents race conditions\n2. **TypeScript cache issues** - Must clear `~/.cache/tsx` after edits\n3. **Error isolation challenges** - Try/catch doesn't work for async event emitters; validate inputs first\n4. **Zombie process prevention** - Requires explicit SIGTERM handlers\n\nFull development journey documented in `IMPLEMENTATION-SUMMARY.md`.\n\n---\n\n### \u2705 Ready to Merge\n\n- All P0/P1/P2 features complete (14/14)\n- Comprehensive test coverage\n- Production-tested and deployed\n- Fully documented with examples\n- Zero breaking changes (pure addition)\n\n**Status:** Production Ready \ud83d\ude80\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nThis PR adds a production-ready MCP (Model Context Protocol) client plugin that enables OpenClaw to connect to external MCP servers and expose their tools. The implementation includes comprehensive error handling, health monitoring, rate limiting, and hot reload capabilities.\n\n**Key changes:**\n- New `extensions/mcp-client/` plugin with multi-server support, automatic `ext_` prefixing, error isolation, and graceful degradation\n- Support for tools, resources, and prompts from MCP servers with health checks and auto-reconnect\n- Commands: `/mcp` (status), `/mcp-metrics` (monitoring), `/mcp-reload` (hot reload)\n- Added 3 new TTS providers (Chatterbox, Piper, Kokoro) with OpenAI-compatible APIs\n- Added Whisper audio transcription provider\n- Mumble voice chat extension (merged from upstream)\n\n**Issues found:**\n- Command injection vulnerability in pre-flight check (line 134 in `index.ts`)\n- Dead code: unused `checkCommandExists` method\n- Documentation mismatch in `openclaw.plugin.json` for `toolPrefix` default value\n\nThe MCP client implementation follows good patterns for production readiness (error isolation, health monitoring, cleanup handlers), but the command injection issue is a critical security vulnerability that must be fixed before merging.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR has a critical command injection vulnerability that must be fixed\n- Score reflects one critical security issue (command injection on line 134) that could allow arbitrary command execution if an attacker controls the MCP server configuration. The implementation is otherwise well-structured with good production practices, but the security vulnerability blocks merge readiness. Additional minor issues include dead code and documentation mismatch.\n- Pay close attention to `extensions/mcp-client/index.ts` line 134 - the command injection vulnerability must be resolved before merge\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "emadomedher",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-10T21:47:50Z",
      "updatedAt": "2026-02-15T19:46:06Z",
      "headRef": "main",
      "baseRef": "main",
      "filesChanged": 24,
      "additions": 15362,
      "deletions": 13,
      "commits": 21,
      "labels": [
        "agents",
        "size: XL"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "extensions/mcp-client/IMPLEMENTATION-SUMMARY.md",
        "extensions/mcp-client/README.md",
        "extensions/mcp-client/index.test.ts",
        "extensions/mcp-client/index.ts",
        "extensions/mcp-client/openclaw.plugin.json",
        "extensions/mcp-client/package.json",
        "extensions/mumble/README.md",
        "extensions/mumble/openclaw.plugin.json",
        "extensions/mumble/package-lock.json",
        "extensions/mumble/package.json",
        "extensions/mumble/src/index.ts",
        "extensions/mumble/src/opus-audio-pipeline.ts",
        "extensions/mumble/src/types.d.ts",
        "extensions/mumble/src/varint-reader.ts",
        "extensions/mumble/src/voice-chat-client.ts",
        "extensions/mumble/tsconfig.json",
        "src/agents/tools/web-search.ts",
        "src/config/types.tts.ts",
        "src/config/zod-schema.agent-runtime.ts",
        "src/config/zod-schema.core.ts",
        "src/media-understanding/providers/index.ts",
        "src/media-understanding/providers/whisper/audio.ts",
        "src/media-understanding/providers/whisper/index.ts",
        "src/tts/tts.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/13691.diff",
      "totalScore": 69,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 30,
          "weight": 0.1,
          "reason": "15375 lines changed (15362+/13-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "emadomedher (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 90,
      "llmRisk": "medium",
      "llmReason": "The PR implements a complete and well-tested feature with comprehensive documentation. The self-assessment is thorough and includes details on testing and error handling. The risk is medium due to the size of the code change and the potential for unforeseen issues in a production environment, despite the extensive testing. Also, there are changes in other files besides the MCP client, which increases the risk."
    },
    {
      "number": 17448,
      "title": "ui: make tool cards collapsible with inline expansion",
      "body": "## Summary\n\nReduces visual clutter from tool calls in the Control UI chat while maintaining full access to tool output.\n\n## Changes\n\n- **Compact tool cards by default** \u2014 Shows only header (tool name + icon) instead of 120px cards\n- **Inline expansion** \u2014 Long outputs collapsed with 'Show output' toggle using native `<details>` element\n- **Short outputs inline** \u2014 Outputs <80 chars shown directly beneath header\n- **Size indicator** \u2014 Shows output length (e.g., '1.2 KB', '340 chars') in collapsed state\n- **Sidebar preserved** \u2014 'Open' button still available for full-screen view\n- **Image improvements** \u2014 Responsive grid layout for multiple image attachments\n\n## Before/After\n\nBefore: Tool cards always showed ~120px of content, cluttering the chat when many tools were called.\n\nAfter: Tool cards show just the header by default. Click 'Show output' to expand inline, or 'Open' for sidebar view.\n\n## Files Changed\n\n- `ui/src/styles/chat/tool-cards.css` \u2014 Redesigned styles for compact/collapsible cards\n- `ui/src/ui/chat/tool-cards.ts` \u2014 New rendering with `<details>` expansion\n- `ui/src/ui/chat/tool-helpers.ts` \u2014 Added `formatOutputLength()` helper\n- `ui/src/ui/chat/grouped-render.ts` \u2014 Use new group rendering\n\n## Testing\n\n1. `pnpm ui:build`\n2. Start gateway and open Control UI\n3. Send messages that trigger tool calls\n4. Verify tool cards are compact and expand correctly\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR redesigns tool cards in the Control UI chat from fixed-height 120px cards to a compact, collapsible design using native `<details>/<summary>` elements. Short outputs (< 80 chars) display inline, empty results show a compact \"Completed\" card, and longer outputs are collapsed behind a \"Show output\" toggle with a size indicator. A new `renderToolCardsGroup` function groups multiple tool cards with proper spacing.\n\n- **Visual bug**: The \"Open\" sidebar `<button>` in the expandable card path is missing CSS resets (`background: none; border: none; padding: 0`) \u2014 it will render with browser-default button styling\n- The `formatOutputLength` helper uses character count thresholds but labels results as \"KB\"/\"MB\" (byte units), which is slightly misleading for multi-byte content\n- Dead CSS remains for `.chat-tool-card__preview` and `.chat-tool-collapse-toggle` classes that are no longer rendered by the templates\n- `getTruncatedPreview` in `tool-helpers.ts` is no longer imported by production code but is still exported and tested\n\n<h3>Confidence Score: 3/5</h3>\n\n- UI-only change with one visual rendering bug that should be fixed before merge\n- The button reset issue will cause the \"Open\" button to render with browser-default styling on every expandable tool card, which is the most common card type (any output > 80 chars). This is a user-visible bug. The remaining issues are minor (dead CSS, misleading units) and don't affect functionality.\n- Pay close attention to `ui/src/styles/chat/tool-cards.css` \u2014 the `.chat-tool-card__action` rule needs button resets for the new `<button>` element\n\n<sub>Last reviewed commit: 213b452</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "karimStekelenburg",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:26:51Z",
      "updatedAt": "2026-02-15T19:30:13Z",
      "headRef": "ui/collapsible-tool-cards",
      "baseRef": "main",
      "filesChanged": 4,
      "additions": 338,
      "deletions": 90,
      "commits": 1,
      "labels": [
        "app: web-ui",
        "size: M"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "ui/src/styles/chat/tool-cards.css",
        "ui/src/ui/chat/grouped-render.ts",
        "ui/src/ui/chat/tool-cards.ts",
        "ui/src/ui/chat/tool-helpers.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17448.diff",
      "totalScore": 69,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "428 lines changed (338+/90-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "karimStekelenburg (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "low",
      "llmReason": "The PR introduces a valuable UI improvement by making tool cards collapsible, reducing visual clutter. The changes are well-described, and the testing instructions are clear. The greptile summary highlights a minor CSS issue, which should be addressed before merging. Overall, the risk is low as the changes are mostly UI-related and the testing steps are straightforward."
    },
    {
      "number": 17449,
      "title": "feat(extension): add cost-guard \u2014 budget enforcement and cost alerts",
      "body": "## Summary\n\n- **New extension** `cost-guard` that monitors API costs in real time and enforces budget limits\n- Listens to `model.usage` diagnostic events via `onDiagnosticEvent()` (same pattern as `diagnostics-otel`)\n- In-memory tracker accumulates spend per provider, per day/month\n- `before_agent_start` hook injects budget warnings into agent context when approaching limits\n- `message_sending` hook blocks responses when budget exceeded (configurable hard stop)\n- `/cost` slash command shows current spend and budget status\n- Configurable: daily/monthly budgets, warning threshold, per-provider caps\n\n## Motivation\n\nMultiple community members have reported unexpected high API costs:\n- $100/month on Gemini API\n- $40 in a single morning on OpenAI\n\nThe codebase has excellent cost tracking infrastructure (diagnostic events, session-cost-usage) but **zero enforcement** \u2014 costs are calculated and emitted but never checked against any budget.\n\nThis extension fills that gap by adding a lightweight enforcement layer via the existing plugin system.\n\n## Configuration\n\n```yaml\n# openclaw.yaml\nplugins:\n  cost-guard:\n    dailyBudgetUsd: 5.0        # Default: $5/day\n    monthlyBudgetUsd: 50.0     # Default: $50/month\n    warningThreshold: 0.8      # Alert at 80% of budget\n    hardStop: true              # Block responses when exceeded\n    providerLimits:             # Optional per-provider caps\n      anthropic:\n        dailyUsd: 3.0\n      openai:\n        dailyUsd: 2.0\n```\n\n## Files\n\n| File | Purpose |\n|------|---------|\n| `extensions/cost-guard/index.ts` | Plugin entry point \u2014 registers service, hooks, command |\n| `extensions/cost-guard/package.json` | Package metadata |\n| `extensions/cost-guard/src/config.ts` | Config schema with validation and UI hints |\n| `extensions/cost-guard/src/tracker.ts` | In-memory cost accumulator with budget checking |\n| `extensions/cost-guard/src/service.ts` | Service subscribing to diagnostic events |\n| `extensions/cost-guard/src/format.ts` | USD formatting and summary display |\n\n## Change Type (select all)\n\n- [ ] Bug fix\n- [x] Feature\n- [ ] Refactor\n- [ ] Docs\n- [ ] Security hardening\n- [ ] Chore/infra\n\n## Scope (select all touched areas)\n\n- [ ] Gateway / orchestration\n- [ ] Skills / tool execution\n- [ ] Auth / tokens\n- [ ] Memory / storage\n- [x] Integrations\n- [ ] API / contracts\n- [ ] UI / DX\n- [ ] CI/CD / infra\n\n## Linked Issue/PR\n\n- Related #12299 (programmatic cost access)\n- Related #8485 (token/cost display)\n- Related #14779 (plugin hooks for cost management)\n- Related #9812 (agent-level rate limiting)\n\n## User-visible / Behavior Changes\n\nNew `/cost` command available when extension is enabled. Budget warnings injected into agent context. Optional hard stop when budget exceeded.\n\n## Security Impact\n\nNo security impact. Extension only reads diagnostic events (read-only) and uses standard plugin hooks. No new API keys, no external network calls, no file system writes.\n\n## Repro + Verification\n\n1. Enable the `cost-guard` extension in config\n2. Send messages that trigger API calls\n3. Use `/cost` to verify spend tracking\n4. Observe budget warnings in logs at 80% threshold\n5. Verify hard stop blocks responses when budget exceeded\n\n### Environment\n\n- OS: macOS (Apple Silicon)\n- Runtime: Node.js v22.22.0\n- TypeScript: passes `tsc --noEmit`\n- Formatting: passes `oxfmt --check`\n\n## Human Verification (required)\n\n- Verified TypeScript compilation passes with zero errors\n- Verified oxfmt formatting passes\n- Reviewed all plugin-sdk imports match exported members\n- Cross-referenced hook signatures against `src/plugins/types.ts`\n- Followed `diagnostics-otel` pattern for service + event subscription\n- Followed `memory-lancedb` pattern for config schema + hooks + commands\n\n## Risks and Mitigations\n\n- **In-memory tracker resets on restart**: Acceptable since historical costs are already stored in `session-cost-usage.ts`. The tracker only needs real-time data for enforcement.\n- **costUsd may be undefined**: Gracefully handled \u2014 entries with missing cost are ignored.\n\n## Test plan\n\n- [ ] TypeScript compilation passes\n- [ ] oxfmt formatting passes\n- [ ] CI checks pass\n- [ ] Extension loads without errors\n- [ ] `/cost` command returns formatted output\n- [ ] Budget warnings appear in logs at threshold\n- [ ] Hard stop blocks messages when exceeded\n\n\ud83e\udd16 Generated with [Claude Code](https://claude.com/claude-code)\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nNew `cost-guard` extension that monitors API costs in real time and enforces configurable budget limits. It subscribes to `model.usage` diagnostic events, accumulates spend in-memory per provider/day/month, injects budget warnings into agent context via `before_agent_start`, optionally blocks responses via `message_sending` when budgets are exceeded, and exposes a `/cost` command. The implementation closely follows established extension patterns (`diagnostics-otel` for service/event subscription, `memory-lancedb` for config schema).\n\n- The `before_agent_start` hook always reports the daily budget in exceeded/warning messages, even when only the monthly budget triggered the status \u2014 this will show misleading information to users.\n- The `setInterval` used for periodic pruning is missing `.unref()`, which will keep the Node.js process alive even after all other work is done (the `nostr` extension handles this correctly).\n- `checkBudget()` is called on every diagnostic event and makes 4 redundant full-array filter passes \u2014 caching the filtered results within the method would improve efficiency.\n\n<h3>Confidence Score: 3/5</h3>\n\n- This PR is safe to merge with low risk, but has a user-facing logic bug in budget status messaging that should be fixed first.\n- The extension follows established patterns well and the core budget enforcement logic is correct. However, the exceeded/warning messages always reference the daily budget even when the monthly budget triggered the alert, which will confuse users. The missing `.unref()` on the prune timer could prevent clean process shutdown. No security concerns \u2014 the extension is read-only and makes no external calls.\n- `extensions/cost-guard/index.ts` (misleading budget messages), `extensions/cost-guard/src/service.ts` (missing timer unref)\n\n<sub>Last reviewed commit: 3b2d123</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "miloudbelarebia",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:27:17Z",
      "updatedAt": "2026-02-15T19:55:21Z",
      "headRef": "feat/cost-guard-extension",
      "baseRef": "main",
      "filesChanged": 6,
      "additions": 715,
      "deletions": 0,
      "commits": 2,
      "labels": [
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "extensions/cost-guard/index.ts",
        "extensions/cost-guard/package.json",
        "extensions/cost-guard/src/config.ts",
        "extensions/cost-guard/src/format.ts",
        "extensions/cost-guard/src/service.ts",
        "extensions/cost-guard/src/tracker.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17449.diff",
      "totalScore": 68,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "715 lines changed (715+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "miloudbelarebia (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "Good feature with clear motivation and configuration.  The in-memory tracker is a potential concern for long-running processes or high-volume usage, as it could lead to memory issues.  Also, the lack of tests is a significant omission.  The risk is medium because the impact of a bug is likely limited to cost overruns, but the lack of tests increases the likelihood of such bugs."
    },
    {
      "number": 17357,
      "title": "feat(telegram): implement telegram poll action,persistent answer routing, fixed some vulnerabilities ",
      "body": "# Openclaw Contribution\r\n\r\nThis file summarizes the changes made to the Openclaw project.\r\n\r\n## Vulnerability Fix\r\n\r\nA medium-severity vulnerability was identified in the `request` package. This package was a transitive dependency of the `matrix` extension. The `request` package is deprecated and has a known Server-Side Request Forgery (SSRF) vulnerability (GHSA-p8p7-x288-28g6).\r\n\r\nTo mitigate this vulnerability, the `request` package was replaced with the `got` package using a `pnpm` override in the root `package.json` file.\r\n\r\n### Verification\r\n\r\nThe following steps were taken to verify the fix:\r\n\r\n1.  **Tests:** The extension test suite was run to ensure that the change did not break any existing functionality. All tests passed.\r\n2.  **Audit:** `pnpm audit` was run after the change to confirm that the vulnerability was no longer present. The audit reported no vulnerabilities.\r\n\r\n\r\n\r\n## Telegram Poll Plugin Verification\r\n\r\nUse these steps to verify the Telegram poll plugin flow end-to-end.\r\n\r\n### 1. Configure Telegram and start gateway\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw config set channels.telegram.botToken \"<YOUR_BOT_TOKEN>\"\r\nopenclaw config set channels.telegram.enabled true\r\npnpm dev\r\n```\r\n\r\n### 2. Check channel health\r\n\r\nIn a second terminal:\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw channels status --probe\r\n```\r\n\r\nExpected: Telegram account is configured/enabled/connected.\r\n\r\n### 3. Send a basic poll from CLI\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat_id_or_telegram:chat_id>\" --poll-question \"Lunch?\" --poll-option \"Pizza\" --poll-option \"Sushi\"\r\n```\r\n\r\nExpected: poll appears in Telegram chat.\r\n\r\n### 4. Verify Telegram poll options\r\n\r\nSilent delivery:\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Silent test?\" --poll-option \"A\" --poll-option \"B\" --silent\r\n```\r\n\r\nDuration in seconds (valid range 5-600):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Duration?\" --poll-option \"A\" --poll-option \"B\" --poll-duration-seconds 60\r\n```\r\n\r\nAnonymous poll:\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Anon?\" --poll-option \"Yes\" --poll-option \"No\" --poll-anonymous\r\n```\r\n\r\nPublic poll (if exposed in your CLI surface):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Public?\" --poll-option \"Yes\" --poll-option \"No\" --poll-public\r\n```\r\n\r\n### 5. Vote in Telegram and confirm inbound handling\r\n\r\n1. Vote on the poll in Telegram.\r\n2. Confirm bot sends an acknowledgement message (\"Got it. You selected: ...\").\r\n3. Confirm poll-answer event is routed into OpenClaw session/system events.\r\n\r\n### 6. Check logs for handler errors\r\n\r\nLook at gateway logs and ensure there are no poll handler errors such as:\r\n\r\n`telegram poll answer handler failed`\r\n\r\n### 7. Negative validation checks\r\n\r\nOne option only (should fail):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Bad\" --poll-option \"OnlyOne\"\r\n```\r\n\r\nExpected: validation error requiring at least two options.\r\n\r\nOut-of-range duration (should fail):\r\n\r\n```powershell\r\ncd openclaw\r\nopenclaw message poll --channel telegram --target \"<chat>\" --poll-question \"Bad duration\" --poll-option \"A\" --poll-option \"B\" --poll-duration-seconds 601\r\n```\r\n\r\nExpected: validation error for duration range.\r\n\r\n### 8. Optional local test suite verification\r\n\r\n```powershell\r\ncd openclaw\r\npnpm -s vitest run src/telegram/send.poll.test.ts src/telegram/allowed-updates.test.ts src/telegram/poll-answer-cache.test.ts src/channels/plugins/actions/telegram.test.ts src/channels/plugins/outbound/telegram.test.ts\r\npnpm -s tsc -p tsconfig.json --noEmit\r\n```\r\n\r\n\r\nsuccessfully created one and one poll cast feature, for agent, where agent have access to what user casted!!\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nThis PR adds Telegram poll action support (send polls, receive poll answers, route answers back to agent sessions), changes the default stream mode from `\"partial\"` to `\"off\"`, changes the default poll anonymity from anonymous to public, and overrides the deprecated `request` package with `got` to fix an SSRF vulnerability.\n\n- **Poll action flow**: New `sendPoll` action wired through action adapter \u2192 telegram-actions \u2192 `sendPollTelegram`. Poll answers are received via a new `poll_answer` bot handler, cached in an in-memory store with TTL, and routed as system events to the originating session. Acknowledgement messages are sent back to the chat.\n- **`durationHours` conversion bug**: The `durationHours` \u2192 seconds conversion (`hours * 3600`) always produces values \u22653600, which always exceeds Telegram's 600-second `open_period` limit. This makes `durationHours` unusable with a confusing error message. The previous behavior had a clearer rejection.\n- **`request` \u2192 `got` override risk**: The pnpm override `\"request\": \"npm:got@^11.8.3\"` replaces a callback-based HTTP library with a promise-based one that has an incompatible API. `request-promise` (used by `@vector-im/matrix-bot-sdk`) wraps `request`'s callback interface and will likely fail at runtime. This needs verification or an alternative approach.\n- **Stream mode default change**: `resolveTelegramStreamMode` now defaults to `\"off\"` instead of `\"partial\"`, aligning with the repo guideline against streaming to external messaging surfaces. This is a behavioral change for users who haven't explicitly configured `streamMode`.\n- **Poll anonymity default**: Polls now default to `is_anonymous: false` (public votes) instead of Telegram's default of `true`. This is intentional per commit message but diverges from Telegram's API default.\n\n<h3>Confidence Score: 2/5</h3>\n\n- This PR has two issues that need attention: the `request` \u2192 `got` override may break the matrix extension at runtime, and the `durationHours` conversion is logically broken.\n- Score of 2 reflects two concrete issues: (1) the `request` \u2192 `got` pnpm override replaces a callback-based API with an incompatible promise-based API, which will break `request-promise` used by the matrix bot SDK at runtime; (2) the `durationHours` conversion always produces out-of-range values for Telegram's 5-600s limit, making the parameter unusable with a misleading error. The core poll feature implementation is well-structured and follows existing patterns, but these two issues need resolution before merge.\n- `package.json` (request \u2192 got override compatibility), `src/telegram/send.ts` (durationHours conversion logic)\n\n<sub>Last reviewed commit: 5be3ccb</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "akyourowngames",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T17:43:56Z",
      "updatedAt": "2026-02-15T19:45:54Z",
      "headRef": "main",
      "baseRef": "main",
      "filesChanged": 20,
      "additions": 761,
      "deletions": 265,
      "commits": 11,
      "labels": [
        "channel: telegram",
        "scripts",
        "agents",
        "size: L"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "package.json",
        "pnpm-lock.yaml",
        "scripts/run-skill-scan.ts",
        "skills/poll-confirmation/SKILL.md",
        "src/agents/tools/message-tool.e2e.test.ts",
        "src/agents/tools/message-tool.ts",
        "src/agents/tools/telegram-actions.ts",
        "src/channels/plugins/actions/telegram.test.ts",
        "src/channels/plugins/actions/telegram.ts",
        "src/channels/plugins/outbound/telegram.test.ts",
        "src/channels/plugins/outbound/telegram.ts",
        "src/telegram/allowed-updates.test.ts",
        "src/telegram/allowed-updates.ts",
        "src/telegram/bot.ts",
        "src/telegram/bot/helpers.test.ts",
        "src/telegram/bot/helpers.ts",
        "src/telegram/poll-answer-cache.test.ts",
        "src/telegram/poll-answer-cache.ts",
        "src/telegram/send.poll.test.ts",
        "src/telegram/send.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17357.diff",
      "totalScore": 68,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "1026 lines changed (761+/265-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "akyourowngames (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 85,
      "llmRisk": "medium",
      "llmReason": "The PR addresses a medium-severity vulnerability and introduces a new feature (Telegram poll plugin). The vulnerability fix seems well-handled with verification steps. The new feature includes verification steps and tests. The risk is medium due to the introduction of new functionality and potential unforeseen issues with the Telegram integration, despite the provided tests and verification steps. The large number of files changed also contributes to the medium risk.",
      "duplicateGroup": 4
    },
    {
      "number": 17438,
      "title": "feat(whatsapp): add blockFrom support for sender blocklisting",
      "body": "## Summary\r\n\r\nAdd `blockFrom` array to WhatsApp config that rejects matching senders before any other access control check.\r\n\r\n- **Problem:** No way to block specific senders while keeping `dmPolicy: \"open\"`.\r\n- **Why it matters:** Users running open DM policies (e.g. for lead generation) need to block specific numbers without switching to allowlist mode.\r\n- **What changed:** Added `blockFrom` to WhatsApp schema, types, account resolver, and access control. Blocked senders are rejected at the gateway level with zero token usage.\r\n- **What did NOT change:** No changes to existing `allowFrom`, `dmPolicy`, or `groupPolicy` behavior.\r\n\r\n## Change Type\r\n\r\n- [x] Feature\r\n\r\n## User-visible / Behavior Changes\r\n\r\nNew optional config field `channels.whatsapp.blockFrom` accepts an array of E.164 phone numbers. Messages from blocked senders are silently rejected before any other access check.\r\n\r\n## Backward compatible\r\n\r\nYes - `blockFrom` is optional and defaults to undefined.\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdds a new `blockFrom` config field to WhatsApp that rejects matching senders before any other access control check. The implementation touches the Zod schema, TypeScript types, account resolver, and access control logic.\n\n- **Type mismatch**: `blockFrom` was added to `WhatsAppConfig` (root-level) but is missing from `WhatsAppAccountConfig` (per-account type), creating a type error in the account resolver (`accountCfg?.blockFrom`). The Zod schema is correct (shared schema covers both levels), but the TypeScript type is out of sync.\n- **No tests**: No test coverage was added for the `blockFrom` behavior. Existing `access-control.test.ts` covers pairing and dmPolicy scenarios, but has no `blockFrom` test cases for DMs or groups.\n- The access control logic itself is sound \u2014 `blockFrom` is checked early (before dmPolicy/allowFrom), normalization is consistent, and both DM and group senders are handled.\n\n<h3>Confidence Score: 3/5</h3>\n\n- The feature logic is correct but a missing type definition will cause a TypeScript compilation error for per-account blockFrom.\n- Score of 3 reflects a real type error (blockFrom missing from WhatsAppAccountConfig) that would break TypeScript compilation when per-account blockFrom is used, plus the absence of any test coverage for the new feature. The core access control logic is sound and the Zod schema is correct.\n- `src/config/types.whatsapp.ts` needs `blockFrom` added to `WhatsAppAccountConfig` to match the Zod schema and fix the type error in the account resolver.\n\n<sub>Last reviewed commit: 7d29a2f</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "johnautomationsnl",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:11:27Z",
      "updatedAt": "2026-02-15T19:24:39Z",
      "headRef": "feat/whatsapp-blockfrom",
      "baseRef": "main",
      "filesChanged": 4,
      "additions": 21,
      "deletions": 0,
      "commits": 1,
      "labels": [
        "channel: whatsapp-web",
        "size: XS"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/config/types.whatsapp.ts",
        "src/config/zod-schema.providers-whatsapp.ts",
        "src/web/accounts.ts",
        "src/web/inbound/access-control.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17438.diff",
      "totalScore": 66,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "21 lines changed (21+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "johnautomationsnl (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 75,
      "llmRisk": "medium",
      "llmReason": "New feature with good description and backward compatibility. However, missing tests and a type mismatch between WhatsAppConfig and WhatsAppAccountConfig (identified by Greptile) introduce risk. The core logic seems sound, but these issues need addressing before merging."
    },
    {
      "number": 13075,
      "title": "[Feature]: Add Gemini (Google Search grounding) as web_search provider",
      "body": "## Summary\n\nAdds `\"gemini\"` as a web_search provider alongside Brave, Perplexity, and Grok, using Gemini's built-in [Google Search grounding](https://ai.google.dev/gemini-api/docs/grounding). Also adds **auto-detection** of search providers when no explicit `provider` is configured.\n\nCloses #13074\n\n## What changed\n\n### `src/agents/tools/web-search.ts`\n- New `runGeminiSearch()` \u2014 calls Gemini `generateContent` with `tools: [{ google_search: {} }]`\n- `resolveRedirectUrl()` \u2014 resolves Google grounding redirect URLs to direct URLs via parallel HEAD requests (5s timeout, graceful fallback)\n- Gemini config resolution helpers (`resolveGeminiConfig`, `resolveGeminiApiKey`, `resolveGeminiModel`)\n- Updated `runWebSearch()`, `createWebSearchTool()`, `missingSearchKeyPayload()`, `resolveSearchProvider()` to handle the gemini provider path\n- **Auto-detection:** When no explicit `provider` is set, checks for available API keys in priority order: Brave \u2192 Gemini \u2192 Perplexity \u2192 Grok. Falls back to Brave if none found.\n- **Security:** API key stripped from error messages (`key=***`) to prevent leakage in logs \u2014 Gemini REST API requires key as query parameter (no Bearer token alternative without ADC)\n\n### Config types & validation\n- `types.tools.ts` \u2014 added `\"gemini\"` to provider union, added `gemini` config block\n- `zod-schema.agent-runtime.ts` \u2014 added `\"gemini\"` to zod validation, added gemini schema\n- `schema.ts` \u2014 updated provider description string\n\n### Tests\n- 2 new config validation tests (gemini with config, gemini with defaults)\n- 8 new auto-detection tests (per-provider detection, priority order, explicit override, fallback)\n- All existing + new tests passing (11 total)\n\n### Docs\n- `docs/tools/web.md` \u2014 added Auto-detection section documenting priority order and fallback behavior\n\n## Config\n\n```json5\n{\n  tools: {\n    web: {\n      search: {\n        provider: \"gemini\",           // optional \u2014 auto-detected from available keys\n        gemini: {\n          apiKey: \"...\",              // optional if GEMINI_API_KEY env var is set\n          model: \"gemini-2.5-flash\"   // optional, this is the default\n        }\n      }\n    }\n  }\n}\n```\n\n### Auto-detection\n\nWhen no `provider` is explicitly set, OpenClaw checks for available API keys in this order:\n\n1. **Brave** \u2014 `BRAVE_API_KEY` env var or `search.apiKey` config\n2. **Gemini** \u2014 `GEMINI_API_KEY` env var or `search.gemini.apiKey` config\n3. **Perplexity** \u2014 `PERPLEXITY_API_KEY` / `OPENROUTER_API_KEY` env var or `search.perplexity.apiKey` config\n4. **Grok** \u2014 `XAI_API_KEY` env var or `search.grok.apiKey` config\n\nIf no keys are found, falls back to Brave (existing behavior).\n\n## Testing\n- [x] `pnpm check` passes (lint + format)\n- [x] Unit tests pass (11/11)\n- [x] Live tested against Gemini API \u2014 grounding returns content + citations with resolved URLs\n- [x] Self-review completed \u2014 found and fixed API key leakage in error messages before finalizing\n- [x] AI-assisted (Claude Opus 4.6 via OpenClaw) \u2014 fully reviewed and understood\n\n## Design decisions\n- **URL resolution:** Gemini grounding returns citations through `vertexaisearch.cloud.google.com/grounding-api-redirect/...` redirects. We resolve these to direct URLs via parallel HEAD requests (5s timeout, graceful fallback to redirect URL on failure). This adds latency but gives the agent usable URLs.\n- **API key in query string:** Gemini REST API requires this (no header alternative without ADC). We strip `key=...` from error messages to prevent log leakage.\n- **Default model:** `gemini-2.5-flash` \u2014 fast, cheap, supports grounding.\n- **Auto-detection priority:** Brave first (most common existing setup), then Gemini, Perplexity, Grok. Explicit `provider` config always overrides auto-detection.\n\n## Related\n- #5775 (Grok provider \u2014 similar pattern)\n- #11399 (Extensible providers)\n\n<!-- greptile_comment -->\n\n<h2>Greptile Overview</h2>\n\n<h3>Greptile Summary</h3>\n\nAdds Gemini as a web search provider with Google Search grounding capability, alongside existing Brave, Perplexity, and Grok providers. Implements auto-detection of search providers based on available API keys when no explicit `provider` is configured.\n\n**Key changes:**\n- New `runGeminiSearch()` function calling Gemini's `generateContent` API with Google Search grounding tool\n- URL resolution helper (`resolveRedirectUrl()`) to convert Google grounding redirect URLs to direct URLs via parallel HEAD requests (5s timeout, graceful fallback)\n- Auto-detection logic checking API keys in priority order: Brave \u2192 Gemini \u2192 Perplexity \u2192 Grok, with fallback to Brave\n- Configuration schema updates across types, zod validation, and documentation\n- Security: API key redaction in error messages to prevent log leakage (Gemini REST API requires key as query param)\n- Comprehensive test coverage (11 tests total: 3 config validation, 8 auto-detection scenarios)\n\n**Implementation follows existing patterns:**\n- Consistent with Grok/Perplexity provider structure\n- Proper `externalContent` metadata included\n- API keys marked as sensitive in zod schema\n- Config help and labels added for new Gemini fields\n- Documentation updated with setup instructions and auto-detection behavior\n\nAll previously reported issues from review threads have been addressed (error message redaction, JSON parse guards, config schema entries).\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge with minimal risk\n- Implementation is thorough and follows established patterns in the codebase. All previously identified issues (API key leakage, JSON parse guards, missing config entries) have been addressed. The code includes proper error handling, security measures (API key redaction), comprehensive test coverage (11/11 passing), and maintains consistency with existing provider implementations. Auto-detection logic is well-tested with 8 test cases covering priority order and fallback behavior.\n- No files require special attention\n\n<sub>Last reviewed commit: cfca253</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "akoscz",
      "authorAssociation": "CONTRIBUTOR",
      "createdAt": "2026-02-10T03:10:57Z",
      "updatedAt": "2026-02-15T19:24:34Z",
      "headRef": "feature/gemini-web-search",
      "baseRef": "main",
      "filesChanged": 7,
      "additions": 449,
      "deletions": 15,
      "commits": 10,
      "labels": [
        "docs",
        "agents",
        "size: M"
      ],
      "ciStatus": "failure",
      "hasIssueRef": true,
      "issueNumbers": [
        13074
      ],
      "changedFiles": [
        "docs/tools/web.md",
        "src/agents/tools/web-search.ts",
        "src/config/config.web-search-provider.test.ts",
        "src/config/schema.help.ts",
        "src/config/schema.labels.ts",
        "src/config/types.tools.ts",
        "src/config/zod-schema.agent-runtime.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/13075.diff",
      "totalScore": 65,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "464 lines changed (449+/15-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 70,
          "weight": 0.15,
          "reason": "akoscz (CONTRIBUTOR)"
        },
        {
          "name": "issue_ref",
          "score": 90,
          "weight": 0.1,
          "reason": "References: #13074"
        },
        {
          "name": "spam",
          "score": 100,
          "weight": 0.15,
          "reason": "No spam signals"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked"
    },
    {
      "number": 17392,
      "title": "Add testing infrastructure and expand gateway OAuth scopes",
      "body": "## Summary\n\nThis PR includes two major feature additions:\n1. **Intelligent Model Routing** - Cost-optimized provider selection (NEW \u2b50)\n2. Testing infrastructure and expanded gateway OAuth scopes\n\n---\n\n# \ud83c\udd95 Feature 1: Intelligent Model Routing for Cost Optimization\n\nImplements intelligent model/provider routing to automatically prefer local (vLLM, Ollama) and free-tier providers over expensive APIs, significantly reducing operational costs while maintaining capability requirements.\n\n## Key Benefits\n\n- **\ud83d\udcb0 Cost Reduction**: Automatically prefers zero-cost local providers (vLLM, Ollama) and free-tier APIs\n- **\ud83c\udfaf Smart Ranking**: 5-tier classification system (LOCAL \u2192 FREE_TIER \u2192 LOW_COST \u2192 MEDIUM_COST \u2192 HIGH_COST)\n- **\ud83d\udd12 Capability Assurance**: Validates reasoning, streaming, vision, and context window requirements\n- **\ud83d\udd04 Graceful Fallback**: Automatic failover to next-best provider on errors\n- **\u2699\ufe0f Opt-in**: Disabled by default, full backward compatibility\n- **\ud83d\udcca Observable**: Debug logging shows ranking decisions\n\n## Implementation\n\n### New Modules\n\n- **`src/agents/model-tiers.ts`**: Provider tier classification and cost calculation\n- **`src/agents/model-requirements.ts`**: Capability requirement validation\n- **`src/agents/model-scoring.ts`**: Scoring algorithm with tier/cost/capability weighting\n- **`src/agents/model-fallback.ts`**: Enhanced with intelligent ranking integration\n\n### Scoring Algorithm\n\n```\nscore = (4 - tier) \u00d7 1000          // Tier weight (4000 for LOCAL \u2192 0 for HIGH_COST)\n      - averageCost                // Cost penalty within tier\n      + (reasoning ? 50 : 0)       // Bonus for reasoning capability\n      + (local ? 100 : 0)          // Extra bonus for local providers\n```\n\n### Configuration Example\n\n```yaml\nmodels:\n  routing:\n    enabled: true              # Default: false (opt-in)\n    preferLocal: true          # Default: true\n    requireReasoning: false    # Default: false\n    requireStreaming: true     # Default: true\n\n  providers:\n    vllm:\n      baseUrl: \"http://127.0.0.1:8000/v1\"\n      models:\n        - id: \"deepseek-r1\"\n          reasoning: true\n          cost: { input: 0, output: 0 }\n    \n    anthropic:\n      baseUrl: \"https://api.anthropic.com/v1/messages\"\n      models:\n        - id: \"claude-opus-4-6\"\n          cost: { input: 150, output: 750 }\n```\n\n**Expected behavior**: vLLM tried first (LOCAL, score ~4000), falls back to Anthropic (MEDIUM_COST, score ~2000) on failure.\n\n## Testing Coverage\n\n\u2705 **48 new tests added** (all passing):\n- 15 unit tests for tier classification\n- 16 unit tests for requirement validation  \n- 10 unit tests for scoring algorithm\n- 7 integration tests for intelligent ranking\n\n\u2705 **Full regression coverage**: All existing tests pass, no new failures\n\n## Backward Compatibility\n\n- \u2705 **Opt-in**: `routing.enabled` defaults to `false`\n- \u2705 **Optional parameter**: New `requirements` parameter is optional\n- \u2705 **No breaking changes**: All existing code works unchanged\n- \u2705 **Respects overrides**: User model selection bypasses routing\n\n---\n\n# Feature 2: Testing Infrastructure and Gateway OAuth Scopes\n\n## Changes\n\n### 1. Playwright E2E Testing Infrastructure\n\n**Rationale:** OpenClaw's control UI had no automated end-to-end tests. Manual testing of UI interactions is time-consuming and error-prone.\n\n**Implementation:**\n- Added `playwright.config.ts` with automatic dev server management\n- Created initial test suite in `e2e/chat.spec.ts`\n- Added npm scripts: `test:e2e:playwright` and `test:e2e:playwright:ui`\n\n### 2. Expanded Gateway OAuth Scopes\n\n**Rationale:** The control UI was requesting only 3 scopes, causing \"missing scope: operator.read\" errors.\n\n**Implementation:** Added three missing scopes to `ui/src/ui/gateway.ts`:\n- `operator.read` - Read-only operations\n- `operator.write` - Write operations  \n- `operator.talk.secrets` - Access sensitive talk configuration\n\n### 3. Chat Send Debug Logging\n\nAdded `handleSend()` wrapper function that logs connection status, draft presence, and attachment count for debugging.\n\n### 4. Disable Treeshaking for Plugin SDK\n\nSet `treeshake: false` in `tsdown.config.ts` to ensure all documented exports are available to external plugins.\n\n## Migration Notes\n\n**For users with existing paired devices:**\n\n```bash\nopenclaw devices rotate --device <device-id> --role operator \\\n  --scope operator.admin \\\n  --scope operator.read \\\n  --scope operator.write \\\n  --scope operator.talk.secrets\n```\n\n---\n\n\ud83e\udd16 This PR includes comprehensive test coverage and maintains full backward compatibility for both features.",
      "author": "jordanhubbard",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T18:16:42Z",
      "updatedAt": "2026-02-15T19:17:25Z",
      "headRef": "feature/testing-and-scope-improvements",
      "baseRef": "main",
      "filesChanged": 18,
      "additions": 1416,
      "deletions": 9,
      "commits": 5,
      "labels": [
        "app: web-ui",
        "agents",
        "size: XL"
      ],
      "ciStatus": "pending",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "e2e/chat.spec.ts",
        "package.json",
        "playwright.config.ts",
        "pnpm-lock.yaml",
        "src/agents/model-fallback.intelligent-ranking.test.ts",
        "src/agents/model-fallback.ts",
        "src/agents/model-requirements.test.ts",
        "src/agents/model-requirements.ts",
        "src/agents/model-scoring.test.ts",
        "src/agents/model-scoring.ts",
        "src/agents/model-tiers.test.ts",
        "src/agents/model-tiers.ts",
        "src/auto-reply/reply/agent-runner-execution.ts",
        "src/config/types.models.ts",
        "src/config/zod-schema.core.ts",
        "tsdown.config.ts",
        "ui/src/ui/gateway.ts",
        "ui/src/ui/views/chat.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17392.diff",
      "totalScore": 65,
      "signals": [
        {
          "name": "ci_status",
          "score": 50,
          "weight": 0.2,
          "reason": "CI: pending"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "1425 lines changed (1416+/9-)"
        },
        {
          "name": "commit_quality",
          "score": 50,
          "weight": 0.05,
          "reason": "Non-standard title"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "jordanhubbard (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 75,
      "llmRisk": "medium",
      "llmReason": "The PR introduces a significant new feature (Intelligent Model Routing) with detailed explanations and benefits. The scoring algorithm and configuration example are helpful. However, the lack of specific details on the testing infrastructure and OAuth scope changes, combined with the complexity of the new feature, introduces a medium risk. More comprehensive testing and security review are recommended.",
      "duplicateGroup": 6
    },
    {
      "number": 17441,
      "title": "feat(telegram): add poll action support",
      "body": "## Summary\nWire up `sendPoll` action for Telegram provider using existing `sendPollTelegram` infrastructure.\n\n## Changes\n- Add `polls` to `TelegramActionConfig` type (`src/config/types.telegram.ts`)\n- Add poll action to telegram actions router - `listActions` + `handleAction` (`src/channels/plugins/actions/telegram.ts`)\n- Add `sendPoll` handler to `handleTelegramAction` (`src/agents/tools/telegram-actions.ts`)\n\n## Features\n- Question with 2-10 options (Telegram limit)\n- Multi-select support (`pollMulti`)\n- Duration/timeout\n- Anonymous mode\n- Forum topic threading\n- Silent sends\n\n## Usage\n```yaml\nchannels:\n  telegram:\n    actions:\n      polls: true  # Enable poll support\n```\n\nThen use via message tool:\n```\nmessage action:poll to:CHAT_ID pollQuestion:\"Which option?\" pollOption:[\"A\",\"B\",\"C\"]\n```\n\n## Testing\nVerified TypeScript compiles without poll-related errors (other errors are missing dependencies in dev environment).\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nWires up `sendPoll` action for the Telegram channel by adding a `polls` gate to `TelegramActionConfig`, registering the \"poll\" action in the actions router, and adding a `sendPoll` handler in `handleTelegramAction` that delegates to the existing `sendPollTelegram` infrastructure.\n\n- Adds `polls?: boolean` to `TelegramActionConfig` type\n- Registers \"poll\" in `listActions` with a `gate(\"polls\")` check (enabled by default, consistent with Discord)\n- Implements poll parameter parsing in the router: question, options, multi-select, duration, threading, silent, anonymous\n- Normalizes poll input via shared `normalizePollInput` (validates 2-10 options for Telegram)\n- Adds `sendPoll` handler in `telegram-actions.ts` that resolves token, validates the action gate, and delegates to `sendPollTelegram`\n- No tests were added for the new poll action handler or router branch; existing tests in `send.poll.test.ts` cover only the lower-level `sendPollTelegram` function\n\n<h3>Confidence Score: 4/5</h3>\n\n- This PR is safe to merge \u2014 it follows established patterns and delegates to well-tested existing infrastructure.\n- Score of 4 reflects that the code is well-structured, follows existing action patterns (sendMessage, sendSticker), and reuses the shared `normalizePollInput` and `sendPollTelegram` infrastructure. The only concern is the lack of test coverage for the new router and handler code paths. No logical bugs or security issues were found.\n- No files require special attention \u2014 all changes follow established patterns. `src/channels/plugins/actions/telegram.ts` has a minor style inconsistency (reading `threadId` as string vs number) but it's functionally correct.\n\n<sub>Last reviewed commit: a6f2d24</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "iacosta3994",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T19:21:31Z",
      "updatedAt": "2026-02-15T19:25:28Z",
      "headRef": "feature/telegram-poll-support",
      "baseRef": "main",
      "filesChanged": 3,
      "additions": 82,
      "deletions": 0,
      "commits": 1,
      "labels": [
        "agents",
        "size: S"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/agents/tools/telegram-actions.ts",
        "src/channels/plugins/actions/telegram.ts",
        "src/config/types.telegram.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17441.diff",
      "totalScore": 64,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 100,
          "weight": 0.1,
          "reason": "82 lines changed (82+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "iacosta3994 (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 75,
      "llmRisk": "medium",
      "llmReason": "The PR adds a new feature (Telegram poll support) with good documentation and usage examples. The code changes seem well-structured and leverage existing infrastructure. However, the lack of specific tests for the new action handler and router branch is a concern. While existing tests cover the underlying `sendPollTelegram` function, integration tests are needed to ensure the entire flow works correctly. The risk is medium because the core functionality is likely working, but edge cases or integration issues might exist due to the missing tests.",
      "duplicateGroup": 4
    },
    {
      "number": 17361,
      "title": "feat(channels): add Tuitui (\u63a8\u63a8) channel support",
      "body": "## Summary\r\n\r\nDescribe the problem and fix in 2\u20135 bullets:\r\n\r\n- Problem:\r\n- \u9700\u8981\u63a5\u5165 360 \u96c6\u56e2\u5185\u63a8\u63a8 IM \u673a\u5668\u4eba\u3002\r\n- Why it matters:\r\n- What changed:\u65b0\u589e\u63a8\u63a8 channel \u63d2\u4ef6\uff08extensions/tuitui\uff09\uff0c\u652f\u6301\u53d1\u6d88\u606f\u3001\u6536\u6d88\u606f webhook\u3001\u914d\u5bf9\u4e0e\u914d\u7f6e\uff1b\u8865\u5145\u6587\u6863\u4e0e labeler\u3002\r\n- What did NOT change (scope boundary):\u6838\u5fc3 gateway/CLI \u884c\u4e3a\u4e0d\u53d8\uff0c\u4ec5\u65b0\u589e\u63d2\u4ef6\u4e0e\u914d\u7f6e\u9879\u3002\r\n\r\n## Change Type (select all)\r\n\r\n- [ ] Bug fix\r\n- [ \u2705] Feature\r\n- [ ] Refactor\r\n- [ ] Docs\r\n- [ ] Security hardening\r\n- [ ] Chore/infra\r\n\r\n## Scope (select all touched areas)\r\n\r\n- [ ] Gateway / orchestration\r\n- [ ] Skills / tool execution\r\n- [ ] Auth / tokens\r\n- [ ] Memory / storage\r\n- [ ] Integrations\r\n- [ ] API / contracts\r\n- [ ] UI / DX\r\n- [ ] CI/CD / infra\r\n\r\n## Linked Issue/PR\r\n\r\n- Closes #\r\n- Related #\r\n\r\n## User-visible / Behavior Changes\r\n\r\nList user-visible changes (including defaults/config).  \r\nIf none, write `None`.\r\n\r\n## Security Impact (required)\r\n\r\n- New permissions/capabilities? (`Yes/No`)\r\n- Secrets/tokens handling changed? (`Yes/No`)\r\n- New/changed network calls? (`Yes/No`)\r\n- Command/tool execution surface changed? (`Yes/No`)\r\n- Data access scope changed? (`Yes/No`)\r\n- If any `Yes`, explain risk + mitigation:\r\n\r\n## Repro + Verification\r\n\r\n### Environment\r\n\r\n- OS:\r\n- Runtime/container:\r\n- Model/provider:\r\n- Integration/channel (if any):\r\n- Relevant config (redacted):\r\n\r\n### Steps\r\n\r\n1.\r\n2.\r\n3.\r\n\r\n### Expected\r\n\r\n-\r\n\r\n### Actual\r\n\r\n-\r\n\r\n## Evidence\r\n\r\nAttach at least one:\r\n\r\n- [ ] Failing test/log before + passing after\r\n- [ ] Trace/log snippets\r\n- [ ] Screenshot/recording\r\n- [ ] Perf numbers (if relevant)\r\n\r\n## Human Verification (required)\r\n\r\nWhat you personally verified (not just CI), and how:\r\n\r\n- Verified scenarios:\r\n- Edge cases checked:\r\n- What you did **not** verify:\r\n\r\n## Compatibility / Migration\r\n\r\n- Backward compatible? (`Yes/No`)\r\n- Config/env changes? (`Yes/No`)\r\n- Migration needed? (`Yes/No`)\r\n- If yes, exact upgrade steps:\r\n\r\n## Failure Recovery (if this breaks)\r\n\r\n- How to disable/revert this change quickly:\r\n- Files/config to restore:\r\n- Known bad symptoms reviewers should watch for:\r\n\r\n## Risks and Mitigations\r\n\r\nList only real risks for this PR. Add/remove entries as needed. If none, write `None`.\r\n\r\n- Risk:\r\n  - Mitigation:\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nAdds a new channel plugin for Tuitui (\u63a8\u63a8), a 360 Group internal IM bot platform. The extension follows the established plugin architecture with webhook-based inbound messages, outbound text sending, pairing, onboarding, and multi-account support.\n\n- **Critical: Pairing flow is broken** \u2014 `isSenderAllowed` in `webhook.ts` only checks `account.config.allowFrom` and ignores the pairing store (`storeAllowFrom`). Users who complete pairing will remain blocked because the store is never consulted for DM authorization. Every other channel extension passes the combined allowlist to the sender check.\n- **Token parsing bug** \u2014 `input.token.split(\":\")` in `channel.ts:223` silently truncates secrets containing colons. Should use `indexOf`/`slice` to split only on the first colon.\n- **Malformed `package.json`** \u2014 The `dependencies` block has incorrect indentation (2 spaces instead of 4 for the entry, 0 instead of 2 for closing brace), inconsistent with other extensions like zalo.\n\n<h3>Confidence Score: 2/5</h3>\n\n- The pairing flow bug will cause DM messages from paired users to be rejected, breaking a core user-facing feature.\n- Score of 2 reflects a critical logic bug in the webhook's sender authorization (`isSenderAllowed` ignores the pairing store), which breaks the default `dmPolicy: \"pairing\"` flow. A secondary issue with token parsing could silently truncate secrets containing colons. The rest of the plugin follows established patterns well.\n- Pay close attention to `extensions/tuitui/src/webhook.ts` (broken pairing allowlist check) and `extensions/tuitui/src/channel.ts` (token split bug in `applyAccountConfig`).\n\n<sub>Last reviewed commit: 7f5e253</sub>\n\n<!-- greptile_other_comments_section -->\n\n<sub>(2/5) Greptile learns from your feedback when you react with thumbs up/down!</sub>\n\n<!-- /greptile_comment -->",
      "author": "haomehaode",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T17:49:36Z",
      "updatedAt": "2026-02-15T19:16:37Z",
      "headRef": "main",
      "baseRef": "main",
      "filesChanged": 20,
      "additions": 1828,
      "deletions": 0,
      "commits": 3,
      "labels": [
        "docs",
        "size: XL"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        ".github/labeler.yml",
        "docs/channels/tuitui.md",
        "extensions/tuitui/index.ts",
        "extensions/tuitui/openclaw.plugin.json",
        "extensions/tuitui/package.json",
        "extensions/tuitui/src/accounts.ts",
        "extensions/tuitui/src/actions.ts",
        "extensions/tuitui/src/api.ts",
        "extensions/tuitui/src/channel.ts",
        "extensions/tuitui/src/config-schema.ts",
        "extensions/tuitui/src/credentials.ts",
        "extensions/tuitui/src/monitor.ts",
        "extensions/tuitui/src/onboarding.ts",
        "extensions/tuitui/src/probe.ts",
        "extensions/tuitui/src/runtime.ts",
        "extensions/tuitui/src/send.ts",
        "extensions/tuitui/src/status-issues.ts",
        "extensions/tuitui/src/types.ts",
        "extensions/tuitui/src/webhook.ts",
        "pnpm-lock.yaml"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17361.diff",
      "totalScore": 59,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 60,
          "weight": 0.1,
          "reason": "1828 lines changed (1828+/0-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "haomehaode (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked",
      "llmScore": 70,
      "llmRisk": "medium",
      "llmReason": "The PR introduces a new feature (Tuitui channel support) with associated documentation and labeler updates. The description is adequate, outlining the problem, fix, and scope.  However, the 'Repro + Verification' section is incomplete, lacking specific steps, expected/actual results, and evidence.  The security impact section is not fully answered. The large number of new files suggests a significant addition, increasing the risk if not thoroughly tested.  The lack of detailed verification steps and security analysis makes it difficult to assess the completeness and potential risks fully."
    },
    {
      "number": 17425,
      "title": "fix(gateway): auto-approve scope/role upgrades for already-paired devices",
      "body": "## Problem\n\nWhen a CLI version upgrade introduces new scopes (e.g. `operator.approvals`, `operator.pairing`), already-paired devices are rejected with **\"pairing required\"** because their paired entry lacks the new scopes.\n\nFor **LAN-bound gateways** (`gateway.bind: \"lan\"`), this creates an unrecoverable deadlock:\n\n1. The CLI requests new scopes during the handshake\n2. The gateway creates a scope-upgrade pairing request with `silent: false` (non-loopback)\n3. The pairing request requires manual approval via `openclaw devices approve`\n4. But `openclaw devices approve` itself needs to connect to the gateway\u2026\n5. \u2026which also fails with \"pairing required\" (same scope mismatch)\n\nThe only workaround is manually editing `~/.openclaw/devices/paired.json` to add the missing scopes \u2014 not something users should need to do.\n\n## Root Cause\n\nThe `requirePairing()` closure in the WebSocket handshake handler sets `silent: isLocalClient`, meaning auto-approval only happens for loopback connections. Scope/role upgrades for already-paired remote devices are treated the same as brand-new device pairing requests, even though the device identity has already been cryptographically verified.\n\n## Fix\n\nSet `silent: true` for scope-upgrade and role-upgrade pairing requests when the connecting device is already paired (`_paired != null`). At this point:\n\n- The device public key has been verified against the paired record\n- The device signature has been validated\n- The device token (if present) has been verified\n\nAuto-approving the upgrade is safe because the device is already trusted. This matches the existing behavior for loopback connections and simply extends it to cover the LAN-bound case.\n\n**New device pairing** (`reason: \"not-paired\"`) still requires explicit approval for non-local connections, preserving the existing security model.\n\n## Changes\n\n- `src/gateway/server/ws-connection/message-handler.ts`: Compute `silent` based on both `isLocalClient` and whether this is an upgrade for an already-paired device\n- Added `reason` to the auto-approval log message for observability\n\n<!-- greptile_comment -->\n\n<h3>Greptile Summary</h3>\n\nFixes a deadlock for LAN-bound gateways (`gateway.bind: \"lan\"`) where CLI version upgrades introducing new scopes (e.g. `operator.approvals`, `operator.pairing`) would reject already-paired devices with \"pairing required\" \u2014 but the CLI command to approve the pairing itself required those same scopes, making recovery impossible without manual file editing.\n\n- Auto-approves (`silent: true`) scope-upgrade and role-upgrade pairing requests for devices that are already paired and cryptographically verified, extending the existing loopback auto-approval behavior to cover LAN-bound connections\n- New device pairing (`reason: \"not-paired\"`) still requires explicit manual approval for non-local connections, preserving the security model\n- Adds `reason` to the auto-approval log message for better observability\n\n<h3>Confidence Score: 5/5</h3>\n\n- This PR is safe to merge \u2014 it extends existing auto-approval to a well-guarded, already-authenticated code path.\n- The change is minimal and well-scoped (8 added lines, 2 modified). The security invariant is preserved: auto-approval only triggers when (1) the device is already in the paired list with a matching public key, AND (2) the device has passed Ed25519 signature verification, nonce validation, and device ID derivation checks. New device pairing for non-local connections still requires manual approval. The logic correctly uses the existing `_paired` parameter (which is only passed for upgrade reasons, not for `not-paired`) to gate the behavior.\n- No files require special attention.\n\n<sub>Last reviewed commit: e42fc2f</sub>\n\n<!-- greptile_other_comments_section -->\n\n<!-- /greptile_comment -->",
      "author": "sauerdaniel",
      "authorAssociation": "NONE",
      "createdAt": "2026-02-15T18:59:18Z",
      "updatedAt": "2026-02-15T19:18:22Z",
      "headRef": "fix/auto-approve-paired-device-scope-upgrade",
      "baseRef": "main",
      "filesChanged": 1,
      "additions": 10,
      "deletions": 2,
      "commits": 1,
      "labels": [
        "gateway",
        "size: XS"
      ],
      "ciStatus": "failure",
      "hasIssueRef": false,
      "issueNumbers": [],
      "changedFiles": [
        "src/gateway/server/ws-connection/message-handler.ts"
      ],
      "diffUrl": "https://github.com/openclaw/openclaw/pull/17425.diff",
      "totalScore": 43,
      "signals": [
        {
          "name": "ci_status",
          "score": 10,
          "weight": 0.2,
          "reason": "CI: failure"
        },
        {
          "name": "diff_size",
          "score": 70,
          "weight": 0.1,
          "reason": "12 lines changed (10+/2-)"
        },
        {
          "name": "commit_quality",
          "score": 90,
          "weight": 0.05,
          "reason": "Conventional commit format"
        },
        {
          "name": "contributor",
          "score": 30,
          "weight": 0.15,
          "reason": "sauerdaniel (NONE)"
        },
        {
          "name": "issue_ref",
          "score": 30,
          "weight": 0.1,
          "reason": "No issue reference"
        },
        {
          "name": "spam",
          "score": 75,
          "weight": 0.15,
          "reason": "No issue ref"
        }
      ],
      "isSpam": false,
      "spamReasons": [],
      "visionAlignment": "unchecked"
    }
  ],
  "summary": "Scanned 50 PRs in openclaw/openclaw. 0 flagged as spam. 9 duplicate clusters found. Top PR: #17463 (85/100) \u2014 fix: write config files with explicit 0o600 mode instead of post-write chmod"
}